<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Held Orders - Staff Dashboard</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="staff.css">
    <script>
        // Immediate Sidebar State Initialization
        (function () {
            const html = document.documentElement;
            html.classList.add('initializing');

            const sidebarState = localStorage.getItem('sidebarActive');
            if (sidebarState === 'true' && window.innerWidth >= 992) {
                html.classList.add('sidebar-active');
            }

            // Auth Guard (Staff/Cashier version)
            try {
                const role = localStorage.getItem('loggedInRole');
                if (role !== 'staff' && role !== 'cashier') {
                    window.location.href = 'index.html';
                }
            } catch (e) {
                window.location.href = 'index.html';
            }
        })();
    </script>
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-black fixed-top shadow">
        <div class="container-fluid">
            <!-- Sidebar Toggle (Mobile) -->
            <button class="sidebar-toggle mt-1 me-2" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>

            <!-- Mobile User Menu Toggle -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#headerNav">
                <span class="fas fa-ellipsis-v"></span>
            </button>

            <!-- Nav Items -->
            <div class="collapse navbar-collapse" id="headerNav">
                <ul class="navbar-nav ms-auto">
                    <!-- User Dropdown -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>John Doe
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end shadow border-0 animate__animated animate__fadeIn">
                            <li><a class="dropdown-item" href="staff-account.html"><i
                                        class="fas fa-user-cog me-2 text-maroon"></i>Account</a></li>
                            <li><a class="dropdown-item" href="staff-activity.html"><i
                                        class="fas fa-history me-2 text-maroon"></i>Activity Log</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item text-danger" href="#" id="logoutBtn"><i
                                        class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="dashboard-layout">
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-branding">
                <button class="sidebar-toggle in-sidebar" id="sidebarToggleInternal">
                    <i class="fas fa-bars"></i>
                </button>
                <a href="staff-dashboard.html" class="sidebar-brand-group">
                    <img src="resources/ethans logo.jpg" alt="Logo">
                    <span class="pos-label">POS</span>
                </a>
            </div>
            <div class="sidebar-nav">
                <div class="sidebar-section-title">Operations</div>
                <a href="staff-menu.html" class="sidebar-link">
                    <i class="fas fa-utensils"></i>Menu Sales
                </a>
                <a href="staff-held-orders.html" class="sidebar-link active">
                    <i class="fas fa-pause-circle"></i>Held Orders
                </a>
                <a href="staff-ingredients.html" class="sidebar-link">
                    <i class="fas fa-boxes"></i>Ingredients
                </a>
                <a href="staff-receipts.html" class="sidebar-link">
                    <i class="fas fa-receipt"></i>Receipts
                </a>

                <div class="sidebar-divider"></div>
                <div class="sidebar-section-title">Account</div>
                <a href="staff-account.html" class="sidebar-link">
                    <i class="fas fa-user-cog"></i>Account Settings
                </a>
                <a href="staff-activity.html" class="sidebar-link">
                    <i class="fas fa-history"></i>My Activity
                </a>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <div class="container-fluid p-4">
                <!-- Page Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="h3 mb-1"><i class="fas fa-pause-circle me-2 text-maroon"></i>Held Orders</h1>
                        <p class="text-muted mb-0">Manage orders on hold and adjust expiration times</p>
                    </div>
                    <div>
                        <button class="btn btn-outline-secondary" onclick="loadHeldOrders()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3 col-sm-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 bg-warning bg-opacity-10 p-3 rounded">
                                        <i class="fas fa-clock fa-2x text-warning"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="text-muted mb-1">Active Orders</h6>
                                        <h3 class="mb-0" id="activeOrdersCount">0</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 bg-danger bg-opacity-10 p-3 rounded">
                                        <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="text-muted mb-1">Expiring Soon</h6>
                                        <h3 class="mb-0" id="expiringSoonCount">0</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 bg-success bg-opacity-10 p-3 rounded">
                                        <i class="fas fa-check-circle fa-2x text-success"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="text-muted mb-1">Restored Today</h6>
                                        <h3 class="mb-0" id="restoredTodayCount">0</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 bg-secondary bg-opacity-10 p-3 rounded">
                                        <i class="fas fa-times-circle fa-2x text-secondary"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="text-muted mb-1">Expired/Cancelled</h6>
                                        <h3 class="mb-0" id="expiredCount">0</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Held Orders Table -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white py-3">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Held Orders List</h5>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
                                    <input type="text" class="form-control" id="heldOrderSearch" placeholder="Search by reference or customer...">
                                    <select class="form-select" id="statusFilter" style="max-width: 150px;">
                                        <option value="all">All Status</option>
                                        <option value="active" selected>Active</option>
                                        <option value="restored">Restored</option>
                                        <option value="expired">Expired</option>
                                        <option value="cancelled">Cancelled</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="heldOrdersTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Reference</th>
                                        <th>Customer</th>
                                        <th>Order Type</th>
                                        <th>Items</th>
                                        <th>Total</th>
                                        <th>Created</th>
                                        <th>Expires</th>
                                        <th>Status</th>
                                        <th class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="heldOrdersTableBody">
                                    <tr>
                                        <td colspan="9" class="text-center py-4">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Loading held orders...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Extend Expiry Modal -->
    <div class="modal fade" id="extendExpiryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title"><i class="fas fa-clock me-2"></i>Extend Expiry Time</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="extendOrderId">
                    <div class="mb-3">
                        <label class="form-label">Current Expiry</label>
                        <input type="text" class="form-control" id="currentExpiry" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Extend By (hours)</label>
                        <select class="form-select" id="extendHours">
                            <option value="1">1 hour</option>
                            <option value="2">2 hours</option>
                            <option value="3">3 hours</option>
                            <option value="5" selected>5 hours</option>
                            <option value="12">12 hours</option>
                            <option value="24">24 hours</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">New Expiry Time</label>
                        <input type="text" class="form-control" id="newExpiry" readonly>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning text-white" id="confirmExtendBtn">
                        <i class="fas fa-clock me-1"></i>Extend Expiry
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Order Details Modal -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="fas fa-info-circle me-2"></i>Order Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="orderDetailsBody">
                    <!-- Content loaded dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery for AJAX -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <!-- SweetAlert2 for nicer alerts and confirmations -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Custom JS -->
    <script src="main.js"></script>
    <script src="staff.js"></script>

    <script>
        // Held Orders Page Logic
        let allHeldOrders = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadHeldOrders();

            // Search and filter listeners
            document.getElementById('heldOrderSearch')?.addEventListener('input', filterHeldOrders);
            document.getElementById('statusFilter')?.addEventListener('change', filterHeldOrders);

            // Extend hours change listener
            document.getElementById('extendHours')?.addEventListener('change', updateNewExpiry);

            // Confirm extend button
            document.getElementById('confirmExtendBtn')?.addEventListener('click', confirmExtendExpiry);
        });

        async function loadHeldOrders() {
            const tbody = document.getElementById('heldOrdersTableBody');
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="9" class="text-center py-4"><i class="fas fa-spinner fa-spin me-2"></i>Loading held orders...</td></tr>';

            try {
                allHeldOrders = await heldOrdersDB.show();
                updateStats();
                filterHeldOrders();
            } catch (err) {
                console.error('Failed to load held orders:', err);
                tbody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Failed to load held orders</td></tr>';
            }
        }

        function updateStats() {
            const now = new Date();
            const today = new Date().toISOString().split('T')[0];
            const oneHourFromNow = new Date(now.getTime() + 60 * 60 * 1000);

            const activeOrders = allHeldOrders.filter(o => o.status === 'active');
            const expiringSoon = activeOrders.filter(o => new Date(o.expires_at) <= oneHourFromNow);
            const restoredToday = allHeldOrders.filter(o => o.status === 'restored' && o.restored_at?.startsWith(today));
            const expiredOrCancelled = allHeldOrders.filter(o => o.status === 'expired' || o.status === 'cancelled');

            document.getElementById('activeOrdersCount').textContent = activeOrders.length;
            document.getElementById('expiringSoonCount').textContent = expiringSoon.length;
            document.getElementById('restoredTodayCount').textContent = restoredToday.length;
            document.getElementById('expiredCount').textContent = expiredOrCancelled.length;
        }

        function filterHeldOrders() {
            const search = document.getElementById('heldOrderSearch')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('statusFilter')?.value || 'active';

            const filtered = allHeldOrders.filter(order => {
                const matchesSearch = order.hold_ref.toLowerCase().includes(search) ||
                                      (order.customer_name || '').toLowerCase().includes(search);
                const matchesStatus = statusFilter === 'all' || order.status === statusFilter;
                return matchesSearch && matchesStatus;
            });

            displayHeldOrders(filtered);
        }

        function displayHeldOrders(orders) {
            const tbody = document.getElementById('heldOrdersTableBody');
            if (!tbody) return;

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-muted"><i class="fas fa-inbox fa-2x mb-2 d-block"></i>No held orders found</td></tr>';
                return;
            }

            const now = new Date();

            tbody.innerHTML = orders.map(order => {
                const createdAt = new Date(order.created_at);
                const expiresAt = new Date(order.expires_at);
                const isExpired = expiresAt <= now && order.status === 'active';
                const isExpiringSoon = !isExpired && expiresAt <= new Date(now.getTime() + 60 * 60 * 1000) && order.status === 'active';

                // Parse items
                let items = [];
                try { items = JSON.parse(order.items_json || '[]'); } catch(e) {}
                const totalItems = items.reduce((acc, item) => acc + (item.quantity || 1), 0);

                let statusBadge = '';
                switch(order.status) {
                    case 'active':
                        statusBadge = isExpired ? '<span class="badge bg-danger">Expired</span>' :
                                      isExpiringSoon ? '<span class="badge bg-warning text-dark">Expiring Soon</span>' :
                                      '<span class="badge bg-success">Active</span>';
                        break;
                    case 'restored':
                        statusBadge = '<span class="badge bg-info">Restored</span>';
                        break;
                    case 'expired':
                        statusBadge = '<span class="badge bg-secondary">Expired</span>';
                        break;
                    case 'cancelled':
                        statusBadge = '<span class="badge bg-dark">Cancelled</span>';
                        break;
                }

                const canTakeAction = order.status === 'active';

                return `
                    <tr class="${isExpired ? 'table-danger' : isExpiringSoon ? 'table-warning' : ''}">
                        <td><strong>${order.hold_ref}</strong></td>
                        <td>${order.customer_name || 'Walk-in Customer'}</td>
                        <td><span class="badge ${order.order_type === 'dine-in' ? 'bg-primary' : 'bg-secondary'}">${order.order_type === 'dine-in' ? 'Dine-in' : 'Walk-in'}</span></td>
                        <td>${totalItems} item(s)</td>
                        <td><strong>P${parseFloat(order.total_amount).toFixed(2)}</strong></td>
                        <td>${createdAt.toLocaleString()}</td>
                        <td>${expiresAt.toLocaleString()}</td>
                        <td>${statusBadge}</td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" onclick="viewOrderDetails(${order.id})" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${canTakeAction ? `
                                    <button class="btn btn-outline-success" onclick="restoreOrder(${order.id})" title="Restore to Cart">
                                        <i class="fas fa-redo"></i>
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="openExtendModal(${order.id})" title="Extend Expiry">
                                        <i class="fas fa-clock"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="cancelOrder(${order.id})" title="Cancel Order">
                                        <i class="fas fa-times"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function viewOrderDetails(orderId) {
            const order = allHeldOrders.find(o => o.id === orderId);
            if (!order) return;

            let items = [];
            try { items = JSON.parse(order.items_json || '[]'); } catch(e) {}

            const detailsHtml = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="border-bottom pb-2 mb-3">Order Information</h6>
                        <p><strong>Reference:</strong> ${order.hold_ref}</p>
                        <p><strong>Customer:</strong> ${order.customer_name || 'Walk-in Customer'}</p>
                        <p><strong>Order Type:</strong> ${order.order_type === 'dine-in' ? 'Dine-in' : 'Walk-in'}</p>
                        <p><strong>Status:</strong> ${order.status.charAt(0).toUpperCase() + order.status.slice(1)}</p>
                        <p><strong>Created:</strong> ${new Date(order.created_at).toLocaleString()}</p>
                        <p><strong>Expires:</strong> ${new Date(order.expires_at).toLocaleString()}</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="border-bottom pb-2 mb-3">Pricing</h6>
                        <p><strong>Subtotal:</strong> P${parseFloat(order.subtotal).toFixed(2)}</p>
                        ${parseFloat(order.discount_amount) > 0 ? `<p class="text-danger"><strong>Discount:</strong> -P${parseFloat(order.discount_amount).toFixed(2)} (${order.discount_percent}%)</p>` : ''}
                        ${order.coupon_code ? `<p><strong>Coupon:</strong> ${order.coupon_code} (-P${parseFloat(order.coupon_value).toFixed(2)})</p>` : ''}
                        <p><strong>Taxes (12%):</strong> P${parseFloat(order.taxes).toFixed(2)}</p>
                        <hr>
                        <p class="h5"><strong>Total:</strong> P${parseFloat(order.total_amount).toFixed(2)}</p>
                    </div>
                </div>
                <hr>
                <h6 class="border-bottom pb-2 mb-3">Items</h6>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th class="text-center">Qty</th>
                            <th class="text-end">Price</th>
                            <th class="text-end">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(item => `
                            <tr>
                                <td>${item.name}</td>
                                <td class="text-center">${item.quantity}</td>
                                <td class="text-end">P${parseFloat(item.price).toFixed(2)}</td>
                                <td class="text-end">P${(parseFloat(item.price) * item.quantity).toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('orderDetailsBody').innerHTML = detailsHtml;
            new bootstrap.Modal(document.getElementById('orderDetailsModal')).show();
        }

        async function restoreOrder(orderId) {
            const order = allHeldOrders.find(o => o.id === orderId);
            if (!order) return;

            const result = await Swal.fire({
                title: 'Restore Order?',
                text: `This will restore ${order.hold_ref} to your active cart. Any items currently in cart will be replaced.`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                confirmButtonText: 'Restore to Cart'
            });

            if (!result.isConfirmed) return;

            // Redirect to menu page with order ID in URL
            window.location.href = `staff-menu.html?restore=${orderId}`;
        }

        function openExtendModal(orderId) {
            const order = allHeldOrders.find(o => o.id === orderId);
            if (!order) return;

            document.getElementById('extendOrderId').value = orderId;
            document.getElementById('currentExpiry').value = new Date(order.expires_at).toLocaleString();
            updateNewExpiry();

            new bootstrap.Modal(document.getElementById('extendExpiryModal')).show();
        }

        function updateNewExpiry() {
            const orderId = document.getElementById('extendOrderId').value;
            const order = allHeldOrders.find(o => o.id == orderId);
            const hours = parseInt(document.getElementById('extendHours').value) || 5;

            if (order) {
                const currentExpiry = new Date(order.expires_at);
                const newExpiry = new Date(currentExpiry.getTime() + hours * 60 * 60 * 1000);
                document.getElementById('newExpiry').value = newExpiry.toLocaleString();
            }
        }

        async function confirmExtendExpiry() {
            const orderId = document.getElementById('extendOrderId').value;
            const hours = parseInt(document.getElementById('extendHours').value) || 5;
            const order = allHeldOrders.find(o => o.id == orderId);

            if (!order) return;

            const newExpiry = new Date(new Date(order.expires_at).getTime() + hours * 60 * 60 * 1000);

            try {
                await heldOrdersDB.edit({
                    id: orderId,
                    expires_at: newExpiry.toISOString()
                });

                bootstrap.Modal.getInstance(document.getElementById('extendExpiryModal')).hide();
                Swal.fire('Success', `Expiry time extended by ${hours} hours.`, 'success');
                loadHeldOrders();
                logStaffActivity('Extended Hold Expiry', `${order.hold_ref} - Extended by ${hours} hours`, 'Success');
            } catch (err) {
                console.error('Failed to extend expiry:', err);
                Swal.fire('Error', 'Failed to extend expiry time.', 'error');
            }
        }

        async function cancelOrder(orderId) {
            const order = allHeldOrders.find(o => o.id === orderId);
            if (!order) return;

            const result = await Swal.fire({
                title: 'Cancel Held Order?',
                text: `This will permanently cancel ${order.hold_ref}. This action cannot be undone.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Yes, Cancel Order'
            });

            if (!result.isConfirmed) return;

            try {
                await heldOrdersDB.edit({
                    id: orderId,
                    status: 'cancelled'
                });

                Swal.fire('Cancelled', 'The held order has been cancelled.', 'success');
                loadHeldOrders();
                logStaffActivity('Cancelled Held Order', order.hold_ref, 'Success');
            } catch (err) {
                console.error('Failed to cancel order:', err);
                Swal.fire('Error', 'Failed to cancel order.', 'error');
            }
        }
    </script>
</body>

</html>
