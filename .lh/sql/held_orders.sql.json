{
    "sourceFile": "sql/held_orders.sql",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1772359264558,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1772359264558,
            "name": "Commit-0",
            "content": "-- ============================================\r\n-- Held Orders Table\r\n-- Stores orders on hold with expiration\r\n-- ============================================\r\n\r\n-- Create sequence for held_orders\r\nCREATE SEQUENCE IF NOT EXISTS held_orders_id_seq;\r\n\r\n-- Create held_orders table\r\nCREATE TABLE IF NOT EXISTS public.held_orders (\r\n    id integer NOT NULL DEFAULT nextval('held_orders_id_seq'::regclass),\r\n    hold_ref character varying NOT NULL, -- e.g., HOLD-1234567890\r\n    customer_name character varying DEFAULT 'Walk-in Customer',\r\n    order_type character varying DEFAULT 'walk-in', -- 'dine-in' or 'walk-in'\r\n    items_json text NOT NULL, -- JSON array of cart items\r\n    subtotal numeric DEFAULT 0,\r\n    discount_amount numeric DEFAULT 0,\r\n    discount_percent numeric DEFAULT 0,\r\n    coupon_code character varying,\r\n    coupon_value numeric DEFAULT 0,\r\n    taxes numeric DEFAULT 0,\r\n    total_amount numeric DEFAULT 0,\r\n    staff_id integer,\r\n    notes text,\r\n    created_at timestamp without time zone DEFAULT now(),\r\n    expires_at timestamp without time zone NOT NULL, -- default 5 hours from creation\r\n    status character varying DEFAULT 'active', -- 'active', 'restored', 'expired', 'cancelled'\r\n    restored_at timestamp without time zone,\r\n    restored_by integer,\r\n    CONSTRAINT held_orders_pkey PRIMARY KEY (id),\r\n    CONSTRAINT held_orders_staff_id_fkey FOREIGN KEY (staff_id) REFERENCES public.users(id),\r\n    CONSTRAINT held_orders_restored_by_fkey FOREIGN KEY (restored_by) REFERENCES public.users(id)\r\n);\r\n\r\n-- Create index for faster lookups\r\nCREATE INDEX IF NOT EXISTS idx_held_orders_status ON public.held_orders(status);\r\nCREATE INDEX IF NOT EXISTS idx_held_orders_expires_at ON public.held_orders(expires_at);\r\nCREATE INDEX IF NOT EXISTS idx_held_orders_staff_id ON public.held_orders(staff_id);\r\n\r\n-- ============================================\r\n-- Update sales table to include more details\r\n-- ============================================\r\n\r\n-- Add customer_name and order_type columns to sales table\r\nALTER TABLE public.sales ADD COLUMN IF NOT EXISTS customer_name character varying DEFAULT 'Walk-in Customer';\r\nALTER TABLE public.sales ADD COLUMN IF NOT EXISTS order_type character varying DEFAULT 'walk-in';\r\nALTER TABLE public.sales ADD COLUMN IF NOT EXISTS discount_amount numeric DEFAULT 0;\r\nALTER TABLE public.sales ADD COLUMN IF NOT EXISTS discount_percent numeric DEFAULT 0;\r\nALTER TABLE public.sales ADD COLUMN IF NOT EXISTS coupon_code character varying;\r\nALTER TABLE public.sales ADD COLUMN IF NOT EXISTS coupon_value numeric DEFAULT 0;\r\nALTER TABLE public.sales ADD COLUMN IF NOT EXISTS taxes numeric DEFAULT 0;\r\nALTER TABLE public.sales ADD COLUMN IF NOT EXISTS subtotal numeric DEFAULT 0;\r\n\r\n-- ============================================\r\n-- Update sale_items table to include price\r\n-- ============================================\r\n\r\nALTER TABLE public.sale_items ADD COLUMN IF NOT EXISTS unit_price numeric DEFAULT 0;\r\nALTER TABLE public.sale_items ADD COLUMN IF NOT EXISTS item_name character varying;\r\nALTER TABLE public.sale_items ADD COLUMN IF NOT EXISTS category_name character varying;\r\n\r\n-- ============================================\r\n-- System Settings for Discount/Coupon Toggle\r\n-- ============================================\r\n\r\n-- Insert or update all system settings (UPSERT)\r\nINSERT INTO public.system_settings (key, value, updated_at) VALUES \r\n    -- Restaurant Profile\r\n    ('restaurant_name', 'Ethan''s Caffe & Restaurant', NOW()),\r\n    ('restaurant_address', '123 Street Block, City Name', NOW()),\r\n    ('restaurant_contact', '+63 123 456 7890', NOW()),\r\n    ('restaurant_tin', '000-111-222-333', NOW()),\r\n    \r\n    -- POS/Cashier Settings\r\n    ('enable_discount', 'true', NOW()),\r\n    ('enable_coupon', 'true', NOW()),\r\n    ('hold_order_expiry_hours', '5', NOW()),\r\n    ('auto_print_receipt', 'false', NOW()),\r\n    \r\n    -- Inventory Settings\r\n    ('low_stock_threshold', '10', NOW()),\r\n    ('expiry_warning_days', '7', NOW()),\r\n    \r\n    -- Notification Settings\r\n    ('enable_email_notifications', 'false', NOW()),\r\n    \r\n    -- Refund/Void Settings\r\n    ('allow_partial_refund', 'true', NOW()),\r\n    ('refund_time_limit_hours', '24', NOW()),\r\n    ('require_reason_for_void', 'true', NOW()),\r\n    \r\n    -- Transaction Settings\r\n    ('tax_rate', '12', NOW()),\r\n    ('currency_symbol', 'P', NOW()),\r\n    ('auto_logout_minutes', '30', NOW()),\r\n    ('require_manager_void', 'true', NOW()),\r\n    ('allow_order_modification', 'true', NOW())\r\nON CONFLICT (key) DO UPDATE SET value = EXCLUDED.value, updated_at = NOW();\r\n"
        }
    ]
}