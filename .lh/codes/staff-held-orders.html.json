{
    "sourceFile": "codes/staff-held-orders.html",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1772359264564,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1772359264564,
            "name": "Commit-0",
            "content": "<!DOCTYPE html>\r\n<html lang=\"en\">\r\n\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    <title>Held Orders - Staff Dashboard</title>\r\n\r\n    <!-- Bootstrap 5 CSS -->\r\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\r\n    <!-- Font Awesome -->\r\n    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css\">\r\n    <!-- Animate.css -->\r\n    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css\">\r\n\r\n    <!-- Custom CSS -->\r\n    <link rel=\"stylesheet\" href=\"style.css\">\r\n    <link rel=\"stylesheet\" href=\"staff.css\">\r\n    <script>\r\n        // Immediate Sidebar State Initialization\r\n        (function () {\r\n            const html = document.documentElement;\r\n            html.classList.add('initializing');\r\n\r\n            const sidebarState = localStorage.getItem('sidebarActive');\r\n            if (sidebarState === 'true' && window.innerWidth >= 992) {\r\n                html.classList.add('sidebar-active');\r\n            }\r\n\r\n            // Auth Guard (Staff/Cashier version)\r\n            try {\r\n                const role = localStorage.getItem('loggedInRole');\r\n                if (role !== 'staff' && role !== 'cashier') {\r\n                    window.location.href = 'index.html';\r\n                }\r\n            } catch (e) {\r\n                window.location.href = 'index.html';\r\n            }\r\n        })();\r\n    </script>\r\n</head>\r\n\r\n<body>\r\n    <!-- Navigation Bar -->\r\n    <nav class=\"navbar navbar-expand-lg navbar-dark bg-black fixed-top shadow\">\r\n        <div class=\"container-fluid\">\r\n            <!-- Sidebar Toggle (Mobile) -->\r\n            <button class=\"sidebar-toggle mt-1 me-2\" id=\"sidebarToggle\">\r\n                <i class=\"fas fa-bars\"></i>\r\n            </button>\r\n\r\n            <!-- Mobile User Menu Toggle -->\r\n            <button class=\"navbar-toggler\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#headerNav\">\r\n                <span class=\"fas fa-ellipsis-v\"></span>\r\n            </button>\r\n\r\n            <!-- Nav Items -->\r\n            <div class=\"collapse navbar-collapse\" id=\"headerNav\">\r\n                <ul class=\"navbar-nav ms-auto\">\r\n                    <!-- User Dropdown -->\r\n                    <li class=\"nav-item dropdown\">\r\n                        <a class=\"nav-link dropdown-toggle\" href=\"#\" role=\"button\" data-bs-toggle=\"dropdown\">\r\n                            <i class=\"fas fa-user-circle me-1\"></i>John Doe\r\n                        </a>\r\n                        <ul class=\"dropdown-menu dropdown-menu-end shadow border-0 animate__animated animate__fadeIn\">\r\n                            <li><a class=\"dropdown-item\" href=\"staff-account.html\"><i\r\n                                        class=\"fas fa-user-cog me-2 text-maroon\"></i>Account</a></li>\r\n                            <li><a class=\"dropdown-item\" href=\"staff-activity.html\"><i\r\n                                        class=\"fas fa-history me-2 text-maroon\"></i>Activity Log</a></li>\r\n                            <li>\r\n                                <hr class=\"dropdown-divider\">\r\n                            </li>\r\n                            <li><a class=\"dropdown-item text-danger\" href=\"#\" id=\"logoutBtn\"><i\r\n                                        class=\"fas fa-sign-out-alt me-2\"></i>Logout</a></li>\r\n                        </ul>\r\n                    </li>\r\n                </ul>\r\n            </div>\r\n        </div>\r\n    </nav>\r\n\r\n    <div class=\"dashboard-layout\">\r\n        <!-- Sidebar Navigation -->\r\n        <aside class=\"sidebar\" id=\"sidebar\">\r\n            <div class=\"sidebar-branding\">\r\n                <button class=\"sidebar-toggle in-sidebar\" id=\"sidebarToggleInternal\">\r\n                    <i class=\"fas fa-bars\"></i>\r\n                </button>\r\n                <a href=\"staff-dashboard.html\" class=\"sidebar-brand-group\">\r\n                    <img src=\"resources/ethans logo.jpg\" alt=\"Logo\">\r\n                    <span class=\"pos-label\">POS</span>\r\n                </a>\r\n            </div>\r\n            <div class=\"sidebar-nav\">\r\n                <div class=\"sidebar-section-title\">Operations</div>\r\n                <a href=\"staff-menu.html\" class=\"sidebar-link\">\r\n                    <i class=\"fas fa-utensils\"></i>Menu Sales\r\n                </a>\r\n                <a href=\"staff-held-orders.html\" class=\"sidebar-link active\">\r\n                    <i class=\"fas fa-pause-circle\"></i>Held Orders\r\n                </a>\r\n                <a href=\"staff-ingredients.html\" class=\"sidebar-link\">\r\n                    <i class=\"fas fa-boxes\"></i>Ingredients\r\n                </a>\r\n                <a href=\"staff-receipts.html\" class=\"sidebar-link\">\r\n                    <i class=\"fas fa-receipt\"></i>Receipts\r\n                </a>\r\n\r\n                <div class=\"sidebar-divider\"></div>\r\n                <div class=\"sidebar-section-title\">Account</div>\r\n                <a href=\"staff-account.html\" class=\"sidebar-link\">\r\n                    <i class=\"fas fa-user-cog\"></i>Account Settings\r\n                </a>\r\n                <a href=\"staff-activity.html\" class=\"sidebar-link\">\r\n                    <i class=\"fas fa-history\"></i>My Activity\r\n                </a>\r\n            </div>\r\n        </aside>\r\n\r\n        <!-- Main Content Area -->\r\n        <main class=\"main-content\">\r\n            <div class=\"container-fluid p-4\">\r\n                <!-- Page Header -->\r\n                <div class=\"d-flex justify-content-between align-items-center mb-4\">\r\n                    <div>\r\n                        <h1 class=\"h3 mb-1\"><i class=\"fas fa-pause-circle me-2 text-maroon\"></i>Held Orders</h1>\r\n                        <p class=\"text-muted mb-0\">Manage orders on hold and adjust expiration times</p>\r\n                    </div>\r\n                    <div>\r\n                        <button class=\"btn btn-outline-secondary\" onclick=\"loadHeldOrders()\">\r\n                            <i class=\"fas fa-sync-alt me-1\"></i>Refresh\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- Stats Cards -->\r\n                <div class=\"row g-3 mb-4\">\r\n                    <div class=\"col-md-3 col-sm-6\">\r\n                        <div class=\"card border-0 shadow-sm h-100\">\r\n                            <div class=\"card-body\">\r\n                                <div class=\"d-flex align-items-center\">\r\n                                    <div class=\"flex-shrink-0 bg-warning bg-opacity-10 p-3 rounded\">\r\n                                        <i class=\"fas fa-clock fa-2x text-warning\"></i>\r\n                                    </div>\r\n                                    <div class=\"flex-grow-1 ms-3\">\r\n                                        <h6 class=\"text-muted mb-1\">Active Orders</h6>\r\n                                        <h3 class=\"mb-0\" id=\"activeOrdersCount\">0</h3>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"col-md-3 col-sm-6\">\r\n                        <div class=\"card border-0 shadow-sm h-100\">\r\n                            <div class=\"card-body\">\r\n                                <div class=\"d-flex align-items-center\">\r\n                                    <div class=\"flex-shrink-0 bg-danger bg-opacity-10 p-3 rounded\">\r\n                                        <i class=\"fas fa-exclamation-triangle fa-2x text-danger\"></i>\r\n                                    </div>\r\n                                    <div class=\"flex-grow-1 ms-3\">\r\n                                        <h6 class=\"text-muted mb-1\">Expiring Soon</h6>\r\n                                        <h3 class=\"mb-0\" id=\"expiringSoonCount\">0</h3>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"col-md-3 col-sm-6\">\r\n                        <div class=\"card border-0 shadow-sm h-100\">\r\n                            <div class=\"card-body\">\r\n                                <div class=\"d-flex align-items-center\">\r\n                                    <div class=\"flex-shrink-0 bg-success bg-opacity-10 p-3 rounded\">\r\n                                        <i class=\"fas fa-check-circle fa-2x text-success\"></i>\r\n                                    </div>\r\n                                    <div class=\"flex-grow-1 ms-3\">\r\n                                        <h6 class=\"text-muted mb-1\">Restored Today</h6>\r\n                                        <h3 class=\"mb-0\" id=\"restoredTodayCount\">0</h3>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"col-md-3 col-sm-6\">\r\n                        <div class=\"card border-0 shadow-sm h-100\">\r\n                            <div class=\"card-body\">\r\n                                <div class=\"d-flex align-items-center\">\r\n                                    <div class=\"flex-shrink-0 bg-secondary bg-opacity-10 p-3 rounded\">\r\n                                        <i class=\"fas fa-times-circle fa-2x text-secondary\"></i>\r\n                                    </div>\r\n                                    <div class=\"flex-grow-1 ms-3\">\r\n                                        <h6 class=\"text-muted mb-1\">Expired/Cancelled</h6>\r\n                                        <h3 class=\"mb-0\" id=\"expiredCount\">0</h3>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- Held Orders Table -->\r\n                <div class=\"card border-0 shadow-sm\">\r\n                    <div class=\"card-header bg-white py-3\">\r\n                        <div class=\"row align-items-center\">\r\n                            <div class=\"col-md-6\">\r\n                                <h5 class=\"mb-0\"><i class=\"fas fa-list me-2\"></i>Held Orders List</h5>\r\n                            </div>\r\n                            <div class=\"col-md-6\">\r\n                                <div class=\"input-group\">\r\n                                    <span class=\"input-group-text bg-white\"><i class=\"fas fa-search text-muted\"></i></span>\r\n                                    <input type=\"text\" class=\"form-control\" id=\"heldOrderSearch\" placeholder=\"Search by reference or customer...\">\r\n                                    <select class=\"form-select\" id=\"statusFilter\" style=\"max-width: 150px;\">\r\n                                        <option value=\"all\">All Status</option>\r\n                                        <option value=\"active\" selected>Active</option>\r\n                                        <option value=\"restored\">Restored</option>\r\n                                        <option value=\"expired\">Expired</option>\r\n                                        <option value=\"cancelled\">Cancelled</option>\r\n                                    </select>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"card-body p-0\">\r\n                        <div class=\"table-responsive\">\r\n                            <table class=\"table table-hover mb-0\" id=\"heldOrdersTable\">\r\n                                <thead class=\"table-light\">\r\n                                    <tr>\r\n                                        <th>Reference</th>\r\n                                        <th>Customer</th>\r\n                                        <th>Order Type</th>\r\n                                        <th>Items</th>\r\n                                        <th>Total</th>\r\n                                        <th>Created</th>\r\n                                        <th>Expires</th>\r\n                                        <th>Status</th>\r\n                                        <th class=\"text-center\">Actions</th>\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody id=\"heldOrdersTableBody\">\r\n                                    <tr>\r\n                                        <td colspan=\"9\" class=\"text-center py-4\">\r\n                                            <i class=\"fas fa-spinner fa-spin me-2\"></i>Loading held orders...\r\n                                        </td>\r\n                                    </tr>\r\n                                </tbody>\r\n                            </table>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </main>\r\n    </div>\r\n\r\n    <!-- Extend Expiry Modal -->\r\n    <div class=\"modal fade\" id=\"extendExpiryModal\" tabindex=\"-1\">\r\n        <div class=\"modal-dialog\">\r\n            <div class=\"modal-content\">\r\n                <div class=\"modal-header bg-warning text-white\">\r\n                    <h5 class=\"modal-title\"><i class=\"fas fa-clock me-2\"></i>Extend Expiry Time</h5>\r\n                    <button type=\"button\" class=\"btn-close btn-close-white\" data-bs-dismiss=\"modal\"></button>\r\n                </div>\r\n                <div class=\"modal-body\">\r\n                    <input type=\"hidden\" id=\"extendOrderId\">\r\n                    <div class=\"mb-3\">\r\n                        <label class=\"form-label\">Current Expiry</label>\r\n                        <input type=\"text\" class=\"form-control\" id=\"currentExpiry\" readonly>\r\n                    </div>\r\n                    <div class=\"mb-3\">\r\n                        <label class=\"form-label\">Extend By (hours)</label>\r\n                        <select class=\"form-select\" id=\"extendHours\">\r\n                            <option value=\"1\">1 hour</option>\r\n                            <option value=\"2\">2 hours</option>\r\n                            <option value=\"3\">3 hours</option>\r\n                            <option value=\"5\" selected>5 hours</option>\r\n                            <option value=\"12\">12 hours</option>\r\n                            <option value=\"24\">24 hours</option>\r\n                        </select>\r\n                    </div>\r\n                    <div class=\"mb-3\">\r\n                        <label class=\"form-label\">New Expiry Time</label>\r\n                        <input type=\"text\" class=\"form-control\" id=\"newExpiry\" readonly>\r\n                    </div>\r\n                </div>\r\n                <div class=\"modal-footer\">\r\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancel</button>\r\n                    <button type=\"button\" class=\"btn btn-warning text-white\" id=\"confirmExtendBtn\">\r\n                        <i class=\"fas fa-clock me-1\"></i>Extend Expiry\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- View Order Details Modal -->\r\n    <div class=\"modal fade\" id=\"orderDetailsModal\" tabindex=\"-1\">\r\n        <div class=\"modal-dialog modal-lg\">\r\n            <div class=\"modal-content\">\r\n                <div class=\"modal-header bg-dark text-white\">\r\n                    <h5 class=\"modal-title\"><i class=\"fas fa-info-circle me-2\"></i>Order Details</h5>\r\n                    <button type=\"button\" class=\"btn-close btn-close-white\" data-bs-dismiss=\"modal\"></button>\r\n                </div>\r\n                <div class=\"modal-body\" id=\"orderDetailsBody\">\r\n                    <!-- Content loaded dynamically -->\r\n                </div>\r\n                <div class=\"modal-footer\">\r\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Close</button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- Bootstrap 5 JS Bundle with Popper -->\r\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js\"></script>\r\n    <!-- jQuery for AJAX -->\r\n    <script src=\"https://code.jquery.com/jquery-3.6.4.min.js\"></script>\r\n    <!-- SweetAlert2 for nicer alerts and confirmations -->\r\n    <script src=\"https://cdn.jsdelivr.net/npm/sweetalert2@11\"></script>\r\n\r\n    <!-- Custom JS -->\r\n    <script src=\"main.js\"></script>\r\n    <script src=\"staff.js\"></script>\r\n\r\n    <script>\r\n        // Held Orders Page Logic\r\n        let allHeldOrders = [];\r\n\r\n        document.addEventListener('DOMContentLoaded', function() {\r\n            loadHeldOrders();\r\n\r\n            // Search and filter listeners\r\n            document.getElementById('heldOrderSearch')?.addEventListener('input', filterHeldOrders);\r\n            document.getElementById('statusFilter')?.addEventListener('change', filterHeldOrders);\r\n\r\n            // Extend hours change listener\r\n            document.getElementById('extendHours')?.addEventListener('change', updateNewExpiry);\r\n\r\n            // Confirm extend button\r\n            document.getElementById('confirmExtendBtn')?.addEventListener('click', confirmExtendExpiry);\r\n        });\r\n\r\n        async function loadHeldOrders() {\r\n            const tbody = document.getElementById('heldOrdersTableBody');\r\n            if (!tbody) return;\r\n\r\n            tbody.innerHTML = '<tr><td colspan=\"9\" class=\"text-center py-4\"><i class=\"fas fa-spinner fa-spin me-2\"></i>Loading held orders...</td></tr>';\r\n\r\n            try {\r\n                allHeldOrders = await heldOrdersDB.show();\r\n                updateStats();\r\n                filterHeldOrders();\r\n            } catch (err) {\r\n                console.error('Failed to load held orders:', err);\r\n                tbody.innerHTML = '<tr><td colspan=\"9\" class=\"text-center py-4 text-danger\"><i class=\"fas fa-exclamation-triangle me-2\"></i>Failed to load held orders</td></tr>';\r\n            }\r\n        }\r\n\r\n        function updateStats() {\r\n            const now = new Date();\r\n            const today = new Date().toISOString().split('T')[0];\r\n            const oneHourFromNow = new Date(now.getTime() + 60 * 60 * 1000);\r\n\r\n            const activeOrders = allHeldOrders.filter(o => o.status === 'active');\r\n            const expiringSoon = activeOrders.filter(o => new Date(o.expires_at) <= oneHourFromNow);\r\n            const restoredToday = allHeldOrders.filter(o => o.status === 'restored' && o.restored_at?.startsWith(today));\r\n            const expiredOrCancelled = allHeldOrders.filter(o => o.status === 'expired' || o.status === 'cancelled');\r\n\r\n            document.getElementById('activeOrdersCount').textContent = activeOrders.length;\r\n            document.getElementById('expiringSoonCount').textContent = expiringSoon.length;\r\n            document.getElementById('restoredTodayCount').textContent = restoredToday.length;\r\n            document.getElementById('expiredCount').textContent = expiredOrCancelled.length;\r\n        }\r\n\r\n        function filterHeldOrders() {\r\n            const search = document.getElementById('heldOrderSearch')?.value.toLowerCase() || '';\r\n            const statusFilter = document.getElementById('statusFilter')?.value || 'active';\r\n\r\n            const filtered = allHeldOrders.filter(order => {\r\n                const matchesSearch = order.hold_ref.toLowerCase().includes(search) ||\r\n                                      (order.customer_name || '').toLowerCase().includes(search);\r\n                const matchesStatus = statusFilter === 'all' || order.status === statusFilter;\r\n                return matchesSearch && matchesStatus;\r\n            });\r\n\r\n            displayHeldOrders(filtered);\r\n        }\r\n\r\n        function displayHeldOrders(orders) {\r\n            const tbody = document.getElementById('heldOrdersTableBody');\r\n            if (!tbody) return;\r\n\r\n            if (orders.length === 0) {\r\n                tbody.innerHTML = '<tr><td colspan=\"9\" class=\"text-center py-4 text-muted\"><i class=\"fas fa-inbox fa-2x mb-2 d-block\"></i>No held orders found</td></tr>';\r\n                return;\r\n            }\r\n\r\n            const now = new Date();\r\n\r\n            tbody.innerHTML = orders.map(order => {\r\n                const createdAt = new Date(order.created_at);\r\n                const expiresAt = new Date(order.expires_at);\r\n                const isExpired = expiresAt <= now && order.status === 'active';\r\n                const isExpiringSoon = !isExpired && expiresAt <= new Date(now.getTime() + 60 * 60 * 1000) && order.status === 'active';\r\n\r\n                // Parse items\r\n                let items = [];\r\n                try { items = JSON.parse(order.items_json || '[]'); } catch(e) {}\r\n                const totalItems = items.reduce((acc, item) => acc + (item.quantity || 1), 0);\r\n\r\n                let statusBadge = '';\r\n                switch(order.status) {\r\n                    case 'active':\r\n                        statusBadge = isExpired ? '<span class=\"badge bg-danger\">Expired</span>' :\r\n                                      isExpiringSoon ? '<span class=\"badge bg-warning text-dark\">Expiring Soon</span>' :\r\n                                      '<span class=\"badge bg-success\">Active</span>';\r\n                        break;\r\n                    case 'restored':\r\n                        statusBadge = '<span class=\"badge bg-info\">Restored</span>';\r\n                        break;\r\n                    case 'expired':\r\n                        statusBadge = '<span class=\"badge bg-secondary\">Expired</span>';\r\n                        break;\r\n                    case 'cancelled':\r\n                        statusBadge = '<span class=\"badge bg-dark\">Cancelled</span>';\r\n                        break;\r\n                }\r\n\r\n                const canTakeAction = order.status === 'active';\r\n\r\n                return `\r\n                    <tr class=\"${isExpired ? 'table-danger' : isExpiringSoon ? 'table-warning' : ''}\">\r\n                        <td><strong>${order.hold_ref}</strong></td>\r\n                        <td>${order.customer_name || 'Walk-in Customer'}</td>\r\n                        <td><span class=\"badge ${order.order_type === 'dine-in' ? 'bg-primary' : 'bg-secondary'}\">${order.order_type === 'dine-in' ? 'Dine-in' : 'Walk-in'}</span></td>\r\n                        <td>${totalItems} item(s)</td>\r\n                        <td><strong>P${parseFloat(order.total_amount).toFixed(2)}</strong></td>\r\n                        <td>${createdAt.toLocaleString()}</td>\r\n                        <td>${expiresAt.toLocaleString()}</td>\r\n                        <td>${statusBadge}</td>\r\n                        <td class=\"text-center\">\r\n                            <div class=\"btn-group btn-group-sm\">\r\n                                <button class=\"btn btn-outline-info\" onclick=\"viewOrderDetails(${order.id})\" title=\"View Details\">\r\n                                    <i class=\"fas fa-eye\"></i>\r\n                                </button>\r\n                                ${canTakeAction ? `\r\n                                    <button class=\"btn btn-outline-success\" onclick=\"restoreOrder(${order.id})\" title=\"Restore to Cart\">\r\n                                        <i class=\"fas fa-redo\"></i>\r\n                                    </button>\r\n                                    <button class=\"btn btn-outline-warning\" onclick=\"openExtendModal(${order.id})\" title=\"Extend Expiry\">\r\n                                        <i class=\"fas fa-clock\"></i>\r\n                                    </button>\r\n                                    <button class=\"btn btn-outline-danger\" onclick=\"cancelOrder(${order.id})\" title=\"Cancel Order\">\r\n                                        <i class=\"fas fa-times\"></i>\r\n                                    </button>\r\n                                ` : ''}\r\n                            </div>\r\n                        </td>\r\n                    </tr>\r\n                `;\r\n            }).join('');\r\n        }\r\n\r\n        function viewOrderDetails(orderId) {\r\n            const order = allHeldOrders.find(o => o.id === orderId);\r\n            if (!order) return;\r\n\r\n            let items = [];\r\n            try { items = JSON.parse(order.items_json || '[]'); } catch(e) {}\r\n\r\n            const detailsHtml = `\r\n                <div class=\"row\">\r\n                    <div class=\"col-md-6\">\r\n                        <h6 class=\"border-bottom pb-2 mb-3\">Order Information</h6>\r\n                        <p><strong>Reference:</strong> ${order.hold_ref}</p>\r\n                        <p><strong>Customer:</strong> ${order.customer_name || 'Walk-in Customer'}</p>\r\n                        <p><strong>Order Type:</strong> ${order.order_type === 'dine-in' ? 'Dine-in' : 'Walk-in'}</p>\r\n                        <p><strong>Status:</strong> ${order.status.charAt(0).toUpperCase() + order.status.slice(1)}</p>\r\n                        <p><strong>Created:</strong> ${new Date(order.created_at).toLocaleString()}</p>\r\n                        <p><strong>Expires:</strong> ${new Date(order.expires_at).toLocaleString()}</p>\r\n                    </div>\r\n                    <div class=\"col-md-6\">\r\n                        <h6 class=\"border-bottom pb-2 mb-3\">Pricing</h6>\r\n                        <p><strong>Subtotal:</strong> P${parseFloat(order.subtotal).toFixed(2)}</p>\r\n                        ${parseFloat(order.discount_amount) > 0 ? `<p class=\"text-danger\"><strong>Discount:</strong> -P${parseFloat(order.discount_amount).toFixed(2)} (${order.discount_percent}%)</p>` : ''}\r\n                        ${order.coupon_code ? `<p><strong>Coupon:</strong> ${order.coupon_code} (-P${parseFloat(order.coupon_value).toFixed(2)})</p>` : ''}\r\n                        <p><strong>Taxes (12%):</strong> P${parseFloat(order.taxes).toFixed(2)}</p>\r\n                        <hr>\r\n                        <p class=\"h5\"><strong>Total:</strong> P${parseFloat(order.total_amount).toFixed(2)}</p>\r\n                    </div>\r\n                </div>\r\n                <hr>\r\n                <h6 class=\"border-bottom pb-2 mb-3\">Items</h6>\r\n                <table class=\"table table-sm\">\r\n                    <thead>\r\n                        <tr>\r\n                            <th>Item</th>\r\n                            <th class=\"text-center\">Qty</th>\r\n                            <th class=\"text-end\">Price</th>\r\n                            <th class=\"text-end\">Subtotal</th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                        ${items.map(item => `\r\n                            <tr>\r\n                                <td>${item.name}</td>\r\n                                <td class=\"text-center\">${item.quantity}</td>\r\n                                <td class=\"text-end\">P${parseFloat(item.price).toFixed(2)}</td>\r\n                                <td class=\"text-end\">P${(parseFloat(item.price) * item.quantity).toFixed(2)}</td>\r\n                            </tr>\r\n                        `).join('')}\r\n                    </tbody>\r\n                </table>\r\n            `;\r\n\r\n            document.getElementById('orderDetailsBody').innerHTML = detailsHtml;\r\n            new bootstrap.Modal(document.getElementById('orderDetailsModal')).show();\r\n        }\r\n\r\n        async function restoreOrder(orderId) {\r\n            const order = allHeldOrders.find(o => o.id === orderId);\r\n            if (!order) return;\r\n\r\n            const result = await Swal.fire({\r\n                title: 'Restore Order?',\r\n                text: `This will restore ${order.hold_ref} to your active cart. Any items currently in cart will be replaced.`,\r\n                icon: 'question',\r\n                showCancelButton: true,\r\n                confirmButtonColor: '#28a745',\r\n                confirmButtonText: 'Restore to Cart'\r\n            });\r\n\r\n            if (!result.isConfirmed) return;\r\n\r\n            // Redirect to menu page with order ID in URL\r\n            window.location.href = `staff-menu.html?restore=${orderId}`;\r\n        }\r\n\r\n        function openExtendModal(orderId) {\r\n            const order = allHeldOrders.find(o => o.id === orderId);\r\n            if (!order) return;\r\n\r\n            document.getElementById('extendOrderId').value = orderId;\r\n            document.getElementById('currentExpiry').value = new Date(order.expires_at).toLocaleString();\r\n            updateNewExpiry();\r\n\r\n            new bootstrap.Modal(document.getElementById('extendExpiryModal')).show();\r\n        }\r\n\r\n        function updateNewExpiry() {\r\n            const orderId = document.getElementById('extendOrderId').value;\r\n            const order = allHeldOrders.find(o => o.id == orderId);\r\n            const hours = parseInt(document.getElementById('extendHours').value) || 5;\r\n\r\n            if (order) {\r\n                const currentExpiry = new Date(order.expires_at);\r\n                const newExpiry = new Date(currentExpiry.getTime() + hours * 60 * 60 * 1000);\r\n                document.getElementById('newExpiry').value = newExpiry.toLocaleString();\r\n            }\r\n        }\r\n\r\n        async function confirmExtendExpiry() {\r\n            const orderId = document.getElementById('extendOrderId').value;\r\n            const hours = parseInt(document.getElementById('extendHours').value) || 5;\r\n            const order = allHeldOrders.find(o => o.id == orderId);\r\n\r\n            if (!order) return;\r\n\r\n            const newExpiry = new Date(new Date(order.expires_at).getTime() + hours * 60 * 60 * 1000);\r\n\r\n            try {\r\n                await heldOrdersDB.edit({\r\n                    id: orderId,\r\n                    expires_at: newExpiry.toISOString()\r\n                });\r\n\r\n                bootstrap.Modal.getInstance(document.getElementById('extendExpiryModal')).hide();\r\n                Swal.fire('Success', `Expiry time extended by ${hours} hours.`, 'success');\r\n                loadHeldOrders();\r\n                logStaffActivity('Extended Hold Expiry', `${order.hold_ref} - Extended by ${hours} hours`, 'Success');\r\n            } catch (err) {\r\n                console.error('Failed to extend expiry:', err);\r\n                Swal.fire('Error', 'Failed to extend expiry time.', 'error');\r\n            }\r\n        }\r\n\r\n        async function cancelOrder(orderId) {\r\n            const order = allHeldOrders.find(o => o.id === orderId);\r\n            if (!order) return;\r\n\r\n            const result = await Swal.fire({\r\n                title: 'Cancel Held Order?',\r\n                text: `This will permanently cancel ${order.hold_ref}. This action cannot be undone.`,\r\n                icon: 'warning',\r\n                showCancelButton: true,\r\n                confirmButtonColor: '#d33',\r\n                confirmButtonText: 'Yes, Cancel Order'\r\n            });\r\n\r\n            if (!result.isConfirmed) return;\r\n\r\n            try {\r\n                await heldOrdersDB.edit({\r\n                    id: orderId,\r\n                    status: 'cancelled'\r\n                });\r\n\r\n                Swal.fire('Cancelled', 'The held order has been cancelled.', 'success');\r\n                loadHeldOrders();\r\n                logStaffActivity('Cancelled Held Order', order.hold_ref, 'Success');\r\n            } catch (err) {\r\n                console.error('Failed to cancel order:', err);\r\n                Swal.fire('Error', 'Failed to cancel order.', 'error');\r\n            }\r\n        }\r\n    </script>\r\n</body>\r\n\r\n</html>\r\n"
        }
    ]
}