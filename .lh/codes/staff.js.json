{
    "sourceFile": "codes/staff.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 12,
            "patches": [
                {
                    "date": 1771856401123,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1771857565861,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -56,17 +56,37 @@\n     const logoutBtn = document.getElementById('logoutBtn');\r\n     if (logoutBtn) {\r\n         logoutBtn.addEventListener('click', function (e) {\r\n             e.preventDefault();\r\n-            showConfirm('Are you sure you want to logout?', function () {\r\n-                localStorage.removeItem('loggedInRole');\r\n-                localStorage.removeItem('loggedInUser');\r\n-                window.location.href = 'index.html';\r\n-            });\r\n+            performStaffLogout();\r\n         });\r\n     }\r\n+\r\n+    // Additional logout button on account section (dashboard)\r\n+    const logoutBtnAccount = document.getElementById('logoutBtnAccount');\r\n+    if (logoutBtnAccount) {\r\n+        logoutBtnAccount.addEventListener('click', function (e) {\r\n+            e.preventDefault();\r\n+            performStaffLogout();\r\n+        });\r\n+    }\r\n }\r\n \r\n+/**\r\n+ * Perform staff logout with activity logging\r\n+ */\r\n+function performStaffLogout() {\r\n+    showConfirm('Are you sure you want to logout?', function () {\r\n+        // Log the logout activity before clearing\r\n+        const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n+        logStaffActivity('Logged out', 'User session terminated', 'Success', user.id);\r\n+        \r\n+        localStorage.removeItem('loggedInRole');\r\n+        localStorage.removeItem('loggedInUser');\r\n+        window.location.href = 'index.html';\r\n+    });\r\n+}\r\n+\r\n // Menu Sales Functions\r\n function initializeMenuFunctionality() {\r\n     // Category Tabs functionality\r\n     const categoryTabs = document.querySelectorAll('.btn-category');\r\n"
                },
                {
                    "date": 1771858078961,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -71,19 +71,29 @@\n     }\r\n }\r\n \r\n /**\r\n- * Perform staff logout with activity logging\r\n+ * Perform staff logout with activity logging and status update\r\n  */\r\n function performStaffLogout() {\r\n     showConfirm('Are you sure you want to logout?', function () {\r\n-        // Log the logout activity before clearing\r\n+        // Get user info before clearing\r\n         const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n+        \r\n+        // Log the logout activity\r\n         logStaffActivity('Logged out', 'User session terminated', 'Success', user.id);\r\n         \r\n-        localStorage.removeItem('loggedInRole');\r\n-        localStorage.removeItem('loggedInUser');\r\n-        window.location.href = 'index.html';\r\n+        // Mark user as inactive\r\n+        updateUserStatus(user.id, 'inactive').then(() => {\r\n+            localStorage.removeItem('loggedInRole');\r\n+            localStorage.removeItem('loggedInUser');\r\n+            window.location.href = 'index.html';\r\n+        }).catch(err => {\r\n+            console.error('Failed to update status, but proceeding with logout:', err);\r\n+            localStorage.removeItem('loggedInRole');\r\n+            localStorage.removeItem('loggedInUser');\r\n+            window.location.href = 'index.html';\r\n+        });\r\n     });\r\n }\r\n \r\n // Menu Sales Functions\r\n@@ -1012,5 +1022,35 @@\n         console.error(\"User data sync failed\", e);\r\n     }\r\n }\r\n \r\n+/**\r\n+ * Update user status (active/inactive) in database\r\n+ * @param {number} userId - User ID\r\n+ * @param {string} status - 'active' or 'inactive'\r\n+ * @returns {Promise} - Resolves when status is updated\r\n+ */\r\n+async function updateUserStatus(userId, status) {\r\n+    try {\r\n+        const response = await fetch('/php/user_status.php', {\r\n+            method: 'POST',\r\n+            headers: { 'Content-Type': 'application/json' },\r\n+            body: JSON.stringify({\r\n+                user_id: userId,\r\n+                status: status\r\n+            })\r\n+        });\r\n+\r\n+        if (!response.ok) {\r\n+            throw new Error(`HTTP error! status: ${response.status}`);\r\n+        }\r\n+\r\n+        const data = await response.json();\r\n+        console.log(`‚úÖ User ${userId} marked as ${status}:`, data);\r\n+        return data;\r\n+    } catch (error) {\r\n+        console.error(`‚ùå Failed to update user status:`, error);\r\n+        throw error;\r\n+    }\r\n+}\r\n+\r\n // showModalNotification and showConfirm are defined in main.js ‚Äî not duplicated here\r\n"
                },
                {
                    "date": 1771858695284,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -51,45 +51,46 @@\n     if (headerUserName && user.full_name) {\r\n         headerUserName.innerHTML = `<i class=\"fas fa-user-circle me-1\"></i>${user.full_name}`;\r\n     }\r\n \r\n-    // Logout button (global)\r\n-    const logoutBtn = document.getElementById('logoutBtn');\r\n-    if (logoutBtn) {\r\n-        logoutBtn.addEventListener('click', function (e) {\r\n-            e.preventDefault();\r\n-            performStaffLogout();\r\n-        });\r\n-    }\r\n-\r\n-    // Additional logout button on account section (dashboard)\r\n-    const logoutBtnAccount = document.getElementById('logoutBtnAccount');\r\n-    if (logoutBtnAccount) {\r\n-        logoutBtnAccount.addEventListener('click', function (e) {\r\n-            e.preventDefault();\r\n-            performStaffLogout();\r\n-        });\r\n-    }\r\n+    // Logout button (global) - Handle both navbar and account page versions\r\n+    const logoutButtons = document.querySelectorAll('#logoutBtn, #logoutBtnAccount');\r\n+    logoutButtons.forEach(logoutBtn => {\r\n+        if (logoutBtn) {\r\n+            logoutBtn.addEventListener('click', function (e) {\r\n+                e.preventDefault();\r\n+                e.stopPropagation();\r\n+                performStaffLogout();\r\n+            });\r\n+        }\r\n+    });\r\n }\r\n \r\n /**\r\n  * Perform staff logout with activity logging and status update\r\n  */\r\n function performStaffLogout() {\r\n+    console.log('üîÑ Logout initiated - showing confirmation dialog');\r\n+    \r\n     showConfirm('Are you sure you want to logout?', function () {\r\n+        console.log('‚úÖ Logout confirmed by user');\r\n+        \r\n         // Get user info before clearing\r\n         const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n+        console.log('üìã User info retrieved:', user.id, user.full_name);\r\n         \r\n         // Log the logout activity\r\n-        logStaffActivity('Logged out', 'User session terminated', 'Success', user.id);\r\n+        logStaffActivity('Logged out', 'User session terminated', 'Success');\r\n         \r\n         // Mark user as inactive\r\n         updateUserStatus(user.id, 'inactive').then(() => {\r\n+            console.log('‚úÖ User marked as inactive');\r\n             localStorage.removeItem('loggedInRole');\r\n             localStorage.removeItem('loggedInUser');\r\n+            console.log('üîê Session cleared, redirecting to login...');\r\n             window.location.href = 'index.html';\r\n         }).catch(err => {\r\n-            console.error('Failed to update status, but proceeding with logout:', err);\r\n+            console.error('‚ùå Failed to update status, but proceeding with logout:', err);\r\n             localStorage.removeItem('loggedInRole');\r\n             localStorage.removeItem('loggedInUser');\r\n             window.location.href = 'index.html';\r\n         });\r\n"
                },
                {
                    "date": 1771859157837,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,177 +1,136 @@\n-// Staff Dashboard JavaScript - Updated for Multi-page support\r\n+// Staff Dashboard JavaScript - Fixed & Cleaned\r\n \r\n // Global variables\r\n let currentSaleItems = [];\r\n let currentSaleId = null;\r\n let allMenuItems = [];\r\n let allIngredients = [];\r\n let currentCustomer = null;\r\n-let currentDiscount = 0; // percentage\r\n+let currentDiscount = 0;\r\n let currentCoupon = null;\r\n \r\n // DOM Ready\r\n document.addEventListener('DOMContentLoaded', function () {\r\n-    // Initialize tooltips - only if bootstrap is available\r\n     if (typeof bootstrap !== 'undefined') {\r\n         const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle=\"tooltip\"]'));\r\n-        tooltipTriggerList.map(function (tooltipTriggerEl) {\r\n-            return new bootstrap.Tooltip(tooltipTriggerEl);\r\n-        });\r\n+        tooltipTriggerList.map(el => new bootstrap.Tooltip(el));\r\n     }\r\n \r\n-    // Initialize only the sections present on the current page\r\n     initializeCommonStaffFeatures();\r\n \r\n-    // Auto-initialize based on elements present\r\n-    if (document.getElementById('menuItemsGrid')) initializeMenuFunctionality();\r\n+    if (document.getElementById('menuItemsGrid'))                                       initializeMenuFunctionality();\r\n     if (document.getElementById('ingredientsListTable') || document.getElementById('ingredientsTable')) initializeIngredientsFunctionality();\r\n-    if (document.getElementById('recentReceipts')) initializeReceiptsFunctionality();\r\n-    if (document.getElementById('changePasswordForm')) initializeAccountFunctionality();\r\n-    if (document.getElementById('activityLogTable')) initializeActivityLogFunctionality();\r\n+    if (document.getElementById('recentReceipts'))                                      initializeReceiptsFunctionality();\r\n+    if (document.getElementById('changePasswordForm'))                                  initializeAccountFunctionality();\r\n+    if (document.getElementById('activityLogTable'))                                    initializeActivityLogFunctionality();\r\n \r\n-    // Start background sync\r\n-    setInterval(refreshUserData, 15000); // 15 seconds\r\n+    // Only poll user data on pages that show user info\r\n+    if (document.querySelector('.navbar .dropdown-toggle')) {\r\n+        setInterval(refreshUserData, 15000);\r\n+    }\r\n });\r\n \r\n-// // Aliases for compatibility with separate pages\r\n-// // const loadMenuItems = () => initializeMenuFunctionality();\r\n-// const loadMenuItemsData = () => loadMenuItems();\r\n-// // const loadIngredients = () => initializeIngredientsFunctionality();\r\n-// const loadIngredientsData = () => loadIngredients();\r\n-const loadReceipts = () => initializeReceiptsFunctionality();\r\n-// const loadRecentReceipts = () => initializeReceiptsFunctionality();\r\n-// const loadAccountInfo = () => initializeAccountFunctionality();\r\n-// const loadActivityLog = () => initializeActivityLogFunctionality();\r\n+// ‚îÄ‚îÄ‚îÄ Common ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n \r\n-// Common features for all staff pages\r\n function initializeCommonStaffFeatures() {\r\n-    // Update logged in user name in header\r\n     const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n     const headerUserName = document.querySelector('.navbar .dropdown-toggle');\r\n     if (headerUserName && user.full_name) {\r\n         headerUserName.innerHTML = `<i class=\"fas fa-user-circle me-1\"></i>${user.full_name}`;\r\n     }\r\n \r\n-    // Logout button (global) - Handle both navbar and account page versions\r\n-    const logoutButtons = document.querySelectorAll('#logoutBtn, #logoutBtnAccount');\r\n-    logoutButtons.forEach(logoutBtn => {\r\n-        if (logoutBtn) {\r\n-            logoutBtn.addEventListener('click', function (e) {\r\n-                e.preventDefault();\r\n-                e.stopPropagation();\r\n-                performStaffLogout();\r\n-            });\r\n-        }\r\n+    document.querySelectorAll('#logoutBtn, #logoutBtnAccount').forEach(btn => {\r\n+        btn.addEventListener('click', function (e) {\r\n+            e.preventDefault();\r\n+            e.stopPropagation();\r\n+            performStaffLogout();\r\n+        });\r\n     });\r\n }\r\n \r\n-/**\r\n- * Perform staff logout with activity logging and status update\r\n- */\r\n function performStaffLogout() {\r\n-    console.log('üîÑ Logout initiated - showing confirmation dialog');\r\n-    \r\n     showConfirm('Are you sure you want to logout?', function () {\r\n-        console.log('‚úÖ Logout confirmed by user');\r\n-        \r\n-        // Get user info before clearing\r\n         const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n-        console.log('üìã User info retrieved:', user.id, user.full_name);\r\n-        \r\n-        // Log the logout activity\r\n+\r\n         logStaffActivity('Logged out', 'User session terminated', 'Success');\r\n-        \r\n-        // Mark user as inactive\r\n-        updateUserStatus(user.id, 'inactive').then(() => {\r\n-            console.log('‚úÖ User marked as inactive');\r\n-            localStorage.removeItem('loggedInRole');\r\n-            localStorage.removeItem('loggedInUser');\r\n-            console.log('üîê Session cleared, redirecting to login...');\r\n-            window.location.href = 'index.html';\r\n-        }).catch(err => {\r\n-            console.error('‚ùå Failed to update status, but proceeding with logout:', err);\r\n-            localStorage.removeItem('loggedInRole');\r\n-            localStorage.removeItem('loggedInUser');\r\n-            window.location.href = 'index.html';\r\n-        });\r\n+\r\n+        updateUserStatus(user.id, 'inactive')\r\n+            .catch(err => console.error('Failed to update status on logout:', err))\r\n+            .finally(() => {\r\n+                localStorage.removeItem('loggedInRole');\r\n+                localStorage.removeItem('loggedInUser');\r\n+                window.location.href = 'index.html';\r\n+            });\r\n     });\r\n }\r\n \r\n-// Menu Sales Functions\r\n-function initializeMenuFunctionality() {\r\n-    // Category Tabs functionality\r\n-    const categoryTabs = document.querySelectorAll('.btn-category');\r\n-    categoryTabs.forEach(tab => {\r\n-        tab.addEventListener('click', function () {\r\n-            categoryTabs.forEach(t => t.classList.remove('active'));\r\n-            this.classList.add('active');\r\n-            filterMenuItems();\r\n-        });\r\n-    });\r\n+// ‚îÄ‚îÄ‚îÄ Activity Logging (single authoritative version ‚Äî async/DB) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n \r\n-    // Search functionality\r\n-    const menuSearch = document.getElementById('menuSearch');\r\n-    if (menuSearch) {\r\n-        menuSearch.addEventListener('input', filterMenuItems);\r\n-    }\r\n+async function logStaffActivity(action, reference = 'N/A', status = 'Success') {\r\n+    const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n+    if (!user.id) return;\r\n \r\n-    // Cart action buttons\r\n-    const clearSaleBtn = document.getElementById('clearSaleBtn');\r\n-    if (clearSaleBtn) {\r\n-        clearSaleBtn.addEventListener('click', function () {\r\n-            showConfirm('Are you sure you want to clear the cart?', clearCurrentSale);\r\n+    try {\r\n+        await fetch('/php/app.php', {\r\n+            method: 'POST',\r\n+            headers: { 'Content-Type': 'application/json' },\r\n+            body: JSON.stringify({\r\n+                table: 'activity_logs',\r\n+                user_id: user.id,\r\n+                role_label: user.role_name || 'Staff',\r\n+                action,\r\n+                reference,\r\n+                status,\r\n+                ip_address: '127.0.0.1',\r\n+                created_at: new Date().toISOString().slice(0, 19).replace('T', ' ')\r\n+            })\r\n         });\r\n-    }\r\n \r\n-    const checkoutBtn = document.getElementById('checkoutBtn');\r\n-    if (checkoutBtn) {\r\n-        checkoutBtn.addEventListener('click', function () {\r\n-            processCheckout();\r\n-        });\r\n+        if (document.getElementById('activityLogTable')) {\r\n+            loadActivityLog();\r\n+        }\r\n+    } catch (e) {\r\n+        console.error('Failed to log activity:', e);\r\n     }\r\n+}\r\n \r\n-    // New POS Feature Buttons\r\n-    const selectCustomerBtn = document.getElementById('selectCustomerBtn');\r\n-    if (selectCustomerBtn) {\r\n-        selectCustomerBtn.addEventListener('click', selectCustomer);\r\n-    }\r\n+// ‚îÄ‚îÄ‚îÄ Menu / POS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n \r\n-    const discountBtn = document.getElementById('discountBtn');\r\n-    if (discountBtn) {\r\n-        discountBtn.addEventListener('click', applyDiscount);\r\n-    }\r\n+function initializeMenuFunctionality() {\r\n+    document.querySelectorAll('.btn-category').forEach(tab => {\r\n+        tab.addEventListener('click', function () {\r\n+            document.querySelectorAll('.btn-category').forEach(t => t.classList.remove('active'));\r\n+            this.classList.add('active');\r\n+            filterMenuItems();\r\n+        });\r\n+    });\r\n \r\n-    const couponBtn = document.getElementById('couponBtn');\r\n-    if (couponBtn) {\r\n-        couponBtn.addEventListener('click', applyCoupon);\r\n-    }\r\n+    document.getElementById('menuSearch')?.addEventListener('input', filterMenuItems);\r\n \r\n-    const holdOrderBtn = document.getElementById('holdOrderBtn');\r\n-    if (holdOrderBtn) {\r\n-        holdOrderBtn.addEventListener('click', holdOrder);\r\n-    }\r\n+    document.getElementById('clearSaleBtn')?.addEventListener('click', () =>\r\n+        showConfirm('Are you sure you want to clear the cart?', clearCurrentSale)\r\n+    );\r\n+    document.getElementById('checkoutBtn')?.addEventListener('click', processCheckout);\r\n+    document.getElementById('selectCustomerBtn')?.addEventListener('click', selectCustomer);\r\n+    document.getElementById('discountBtn')?.addEventListener('click', applyDiscount);\r\n+    document.getElementById('couponBtn')?.addEventListener('click', applyCoupon);\r\n+    document.getElementById('holdOrderBtn')?.addEventListener('click', holdOrder);\r\n+    document.getElementById('returnOrderBtn')?.addEventListener('click', handleReturn);\r\n \r\n-    const returnOrderBtn = document.getElementById('returnOrderBtn');\r\n-    if (returnOrderBtn) {\r\n-        returnOrderBtn.addEventListener('click', handleReturn);\r\n-    }\r\n-\r\n-    // Load initial data\r\n     loadMenuItems();\r\n     updateSaleDisplay();\r\n }\r\n \r\n-// POS Feature Implementations\r\n function selectCustomer() {\r\n     Swal.fire({\r\n         title: 'Select Customer',\r\n         input: 'text',\r\n         inputLabel: 'Enter Customer Name',\r\n         inputPlaceholder: 'Search or add new customer...',\r\n         showCancelButton: true,\r\n         confirmButtonColor: '#800000',\r\n-    }).then((result) => {\r\n+    }).then(result => {\r\n         if (result.isConfirmed && result.value) {\r\n             currentCustomer = result.value;\r\n             showModalNotification(`Customer \"${currentCustomer}\" selected.`, 'success', 'Customer Selected');\r\n             updateSaleDisplay();\r\n@@ -188,9 +147,9 @@\n         inputPlaceholder: '0',\r\n         inputAttributes: { min: 0, max: 100 },\r\n         showCancelButton: true,\r\n         confirmButtonColor: '#800000',\r\n-    }).then((result) => {\r\n+    }).then(result => {\r\n         if (result.isConfirmed) {\r\n             currentDiscount = parseFloat(result.value) || 0;\r\n             updateSaleDisplay();\r\n             logStaffActivity('Applied Discount', `${currentDiscount}%`, 'Success');\r\n@@ -205,23 +164,24 @@\n         inputLabel: 'Enter Coupon Code',\r\n         inputPlaceholder: 'SAVE10, FREE50, etc.',\r\n         showCancelButton: true,\r\n         confirmButtonColor: '#800000',\r\n-    }).then((result) => {\r\n-        if (result.isConfirmed) {\r\n-            const code = result.value.toUpperCase();\r\n-            if (code === 'SAVE10') {\r\n-                currentCoupon = { code: 'SAVE10', type: 'percentage', value: 10 };\r\n-                showModalNotification('Coupon \"SAVE10\" (10% Off) applied!', 'success', 'Coupon Applied');\r\n-            } else if (code === 'FREE50') {\r\n-                currentCoupon = { code: 'FREE50', type: 'fixed', value: 50 };\r\n-                showModalNotification('Coupon \"FREE50\" (P50 Off) applied!', 'success', 'Coupon Applied');\r\n-            } else {\r\n-                Swal.fire('Invalid Coupon', 'The coupon code entered is not valid.', 'error');\r\n-                return;\r\n-            }\r\n+    }).then(result => {\r\n+        if (!result.isConfirmed) return;\r\n+\r\n+        const code = result.value.toUpperCase();\r\n+        const coupons = {\r\n+            SAVE10: { code: 'SAVE10', type: 'percentage', value: 10, label: '10% Off' },\r\n+            FREE50: { code: 'FREE50', type: 'fixed',      value: 50, label: 'P50 Off' },\r\n+        };\r\n+\r\n+        if (coupons[code]) {\r\n+            currentCoupon = coupons[code];\r\n+            showModalNotification(`Coupon \"${code}\" (${coupons[code].label}) applied!`, 'success', 'Coupon Applied');\r\n             updateSaleDisplay();\r\n             logStaffActivity('Applied Coupon', code, 'Success');\r\n+        } else {\r\n+            Swal.fire('Invalid Coupon', 'The coupon code entered is not valid.', 'error');\r\n         }\r\n     });\r\n }\r\n \r\n@@ -230,9 +190,9 @@\n         Swal.fire('Error', 'Cart is empty. Nothing to hold.', 'error');\r\n         return;\r\n     }\r\n \r\n-    const heldOrders = JSON.parse(localStorage.getItem('heldOrders')) || [];\r\n+    const heldOrders = JSON.parse(localStorage.getItem('heldOrders') || '[]');\r\n     const newHold = {\r\n         id: 'HOLD-' + Date.now(),\r\n         timestamp: Date.now(),\r\n         items: [...currentSaleItems],\r\n@@ -249,120 +209,104 @@\n     clearCurrentSale();\r\n }\r\n \r\n function handleReturn() {\r\n-    // Show recent sales to select for return\r\n-    const sales = JSON.parse(localStorage.getItem('sales')) || [];\r\n+    const sales = JSON.parse(localStorage.getItem('sales') || '[]');\r\n     if (sales.length === 0) {\r\n         Swal.fire('No Transactions', 'No recent transactions found to return.', 'info');\r\n         return;\r\n     }\r\n \r\n     const inputOptions = {};\r\n     sales.slice(0, 10).forEach(s => {\r\n-        inputOptions[s.id] = `${s.id} - P${s.total.toFixed(2)} (${s.time})`;\r\n+        inputOptions[s.id] = `${s.id} - P${parseFloat(s.total).toFixed(2)} (${s.time})`;\r\n     });\r\n \r\n     Swal.fire({\r\n         title: 'Select Transaction to Return',\r\n         input: 'select',\r\n-        inputOptions: inputOptions,\r\n+        inputOptions,\r\n         inputPlaceholder: 'Select a receipt...',\r\n         showCancelButton: true,\r\n         confirmButtonColor: '#800000',\r\n-    }).then((result) => {\r\n-        if (result.isConfirmed && result.value) {\r\n-            const saleId = result.value;\r\n-            Swal.fire({\r\n-                title: 'Confirm Return',\r\n-                text: `Are you sure you want to process a return for ${saleId}?`,\r\n-                icon: 'warning',\r\n-                showCancelButton: true,\r\n-                confirmButtonColor: '#d33',\r\n-                confirmButtonText: 'Yes, Return'\r\n-            }).then((confirm) => {\r\n-                if (confirm.isConfirmed) {\r\n-                    // Logic to mark as returned or remove\r\n-                    let updatedSales = sales.filter(s => s.id !== saleId);\r\n-                    localStorage.setItem('sales', JSON.stringify(updatedSales));\r\n-                    showModalNotification('Transaction successfully returned and voided.', 'success', 'Return Processed');\r\n-                    logStaffActivity('Processed Return', saleId, 'Success');\r\n-                }\r\n-            });\r\n-        }\r\n+    }).then(result => {\r\n+        if (!result.isConfirmed || !result.value) return;\r\n+\r\n+        const saleId = result.value;\r\n+        Swal.fire({\r\n+            title: 'Confirm Return',\r\n+            text: `Are you sure you want to process a return for ${saleId}?`,\r\n+            icon: 'warning',\r\n+            showCancelButton: true,\r\n+            confirmButtonColor: '#d33',\r\n+            confirmButtonText: 'Yes, Return'\r\n+        }).then(confirm => {\r\n+            if (confirm.isConfirmed) {\r\n+                const updated = sales.filter(s => s.id !== saleId);\r\n+                localStorage.setItem('sales', JSON.stringify(updated));\r\n+                showModalNotification('Transaction successfully returned and voided.', 'success', 'Return Processed');\r\n+                logStaffActivity('Processed Return', saleId, 'Success');\r\n+            }\r\n+        });\r\n     });\r\n }\r\n \r\n function loadMenuItems() {\r\n     const menuGrid = document.getElementById('menuItemsGrid');\r\n     if (!menuGrid) return;\r\n \r\n-    // Show loading\r\n     menuGrid.innerHTML = '<div class=\"col-12 text-center py-5\"><div class=\"loading-spinner\"></div><p class=\"mt-2\">Fetching menu from system...</p></div>';\r\n \r\n-    // Simulate real-time fetch from Admin/DB\r\n     setTimeout(() => {\r\n-        // Try to load from \"adminMenuItems\" (synced from admin) if available\r\n-        const savedMenu = JSON.parse(localStorage.getItem('adminMenuItems'));\r\n+        const savedMenu = JSON.parse(localStorage.getItem('adminMenuItems') || 'null');\r\n \r\n-        if (savedMenu && savedMenu.length > 0) {\r\n-            allMenuItems = savedMenu;\r\n-        } else {\r\n-            // Default demo items if none in storage\r\n-            allMenuItems = [\r\n-                { id: 1, name: 'Beef Steak', category: 'Main Course', price: 450, image: 'https://images.unsplash.com/photo-1600891964092-4316c288032e?w=400&h=300&fit=crop', available: true },\r\n-                { id: 2, name: 'Chicken Curry', category: 'Main Course', price: 320, image: 'https://images.unsplash.com/photo-1603894584373-5ac82b2ae398?w=400&h=300&fit=crop', available: true },\r\n-                { id: 3, name: 'Vegetable Salad', category: 'Appetizer', price: 180, image: 'https://images.unsplash.com/photo-1540420773420-3366772f4999?w=400&h=300&fit=crop', available: true },\r\n-                { id: 4, name: 'Garlic Bread', category: 'Appetizer', price: 120, image: 'https://images.unsplash.com/photo-1573140247632-f8fd74997d5c?w=400&h=300&fit=crop', available: true },\r\n-                { id: 5, name: 'French Fries', category: 'Side Dish', price: 95, image: 'https://images.unsplash.com/photo-1576107232684-1279f390859f?w=400&h=300&fit=crop', available: true },\r\n-                { id: 6, name: 'Pasta Carbonara', category: 'Main Course', price: 280, image: 'https://images.unsplash.com/photo-1598866594230-a7c12756260f?w=400&h=300&fit=crop', available: true },\r\n-                { id: 7, name: 'Chocolate Cake', category: 'Dessert', price: 150, image: 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=400&h=300&fit=crop', available: true },\r\n-                { id: 8, name: 'Fruit Shake', category: 'Beverage', price: 85, image: 'https://images.unsplash.com/photo-1544145945-f904253d0c71?w=400&h=300&fit=crop', available: true }\r\n-            ];\r\n-            localStorage.setItem('adminMenuItems', JSON.stringify(allMenuItems));\r\n-        }\r\n+        allMenuItems = (savedMenu && savedMenu.length > 0) ? savedMenu : [\r\n+            { id: 1, name: 'Beef Steak',       category: 'Main Course', price: 450, image: 'https://images.unsplash.com/photo-1600891964092-4316c288032e?w=400&h=300&fit=crop', available: true },\r\n+            { id: 2, name: 'Chicken Curry',     category: 'Main Course', price: 320, image: 'https://images.unsplash.com/photo-1603894584373-5ac82b2ae398?w=400&h=300&fit=crop', available: true },\r\n+            { id: 3, name: 'Vegetable Salad',   category: 'Appetizer',   price: 180, image: 'https://images.unsplash.com/photo-1540420773420-3366772f4999?w=400&h=300&fit=crop', available: true },\r\n+            { id: 4, name: 'Garlic Bread',      category: 'Appetizer',   price: 120, image: 'https://images.unsplash.com/photo-1573140247632-f8fd74997d5c?w=400&h=300&fit=crop', available: true },\r\n+            { id: 5, name: 'French Fries',      category: 'Side Dish',   price: 95,  image: 'https://images.unsplash.com/photo-1576107232684-1279f390859f?w=400&h=300&fit=crop', available: true },\r\n+            { id: 6, name: 'Pasta Carbonara',   category: 'Main Course', price: 280, image: 'https://images.unsplash.com/photo-1598866594230-a7c12756260f?w=400&h=300&fit=crop', available: true },\r\n+            { id: 7, name: 'Chocolate Cake',    category: 'Dessert',     price: 150, image: 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=400&h=300&fit=crop', available: true },\r\n+            { id: 8, name: 'Fruit Shake',       category: 'Beverage',    price: 85,  image: 'https://images.unsplash.com/photo-1544145945-f904253d0c71?w=400&h=300&fit=crop', available: true }\r\n+        ];\r\n \r\n+        if (!savedMenu) localStorage.setItem('adminMenuItems', JSON.stringify(allMenuItems));\r\n+\r\n         displayMenuItems(allMenuItems);\r\n     }, 600);\r\n }\r\n \r\n function displayMenuItems(items) {\r\n     const menuGrid = document.getElementById('menuItemsGrid');\r\n     if (!menuGrid) return;\r\n \r\n-    menuGrid.innerHTML = '';\r\n-\r\n     if (items.length === 0) {\r\n         menuGrid.innerHTML = '<div class=\"col-12 text-center py-5\"><i class=\"fas fa-search fa-3x text-muted mb-3\"></i><p class=\"text-muted\">No items found matching your filter</p></div>';\r\n         return;\r\n     }\r\n \r\n-    items.forEach(item => {\r\n-        const col = document.createElement('div');\r\n-        col.className = 'col-6 col-md-4 col-lg-3 mb-3';\r\n-\r\n+    menuGrid.innerHTML = items.map(item => {\r\n         const imgSrc = item.image || 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400&h=300&fit=crop';\r\n-\r\n-        col.innerHTML = `\r\n-            <div class=\"menu-item-card\" data-id=\"${item.id}\" onclick=\"addItemToSale(${item.id})\">\r\n-                <div class=\"menu-item-img-container\">\r\n-                    <img src=\"${imgSrc}\" alt=\"${item.name}\" class=\"menu-item-img\">\r\n-                    <div class=\"price-tag\">P${parseFloat(item.price).toFixed(2)}</div>\r\n+        return `\r\n+            <div class=\"col-6 col-md-4 col-lg-3 mb-3\">\r\n+                <div class=\"menu-item-card\" data-id=\"${item.id}\" onclick=\"addItemToSale(${item.id})\">\r\n+                    <div class=\"menu-item-img-container\">\r\n+                        <img src=\"${imgSrc}\" alt=\"${item.name}\" class=\"menu-item-img\">\r\n+                        <div class=\"price-tag\">P${parseFloat(item.price).toFixed(2)}</div>\r\n+                    </div>\r\n+                    <div class=\"p-2 text-center\">\r\n+                        <div class=\"fw-bold mb-0 text-truncate\" style=\"font-size:0.85rem\">${item.name}</div>\r\n+                    </div>\r\n                 </div>\r\n-                <div class=\"p-2 text-center\">\r\n-                    <div class=\"fw-bold mb-0 text-truncate\" style=\"font-size: 0.85rem\">${item.name}</div>\r\n-                </div>\r\n-            </div>\r\n-        `;\r\n-\r\n-        menuGrid.appendChild(col);\r\n-    });\r\n+            </div>`;\r\n+    }).join('');\r\n }\r\n \r\n function filterMenuItems() {\r\n     const searchTerm = document.getElementById('menuSearch')?.value.toLowerCase() || '';\r\n-    const activeTab = document.querySelector('.btn-category.active');\r\n-    const category = activeTab ? activeTab.getAttribute('data-category') : 'All';\r\n+    const activeTab  = document.querySelector('.btn-category.active');\r\n+    const category   = activeTab ? activeTab.getAttribute('data-category') : 'All';\r\n \r\n     const filtered = allMenuItems.filter(item =>\r\n         item.name.toLowerCase().includes(searchTerm) &&\r\n         (category === 'All' || item.category === category)\r\n@@ -373,114 +317,93 @@\n function addItemToSale(itemId) {\r\n     const product = allMenuItems.find(item => item.id == itemId);\r\n     if (!product) return;\r\n \r\n-    const existingItem = currentSaleItems.find(item => item.id == itemId);\r\n-    if (existingItem) {\r\n-        existingItem.quantity += 1;\r\n+    const existing = currentSaleItems.find(item => item.id == itemId);\r\n+    if (existing) {\r\n+        existing.quantity += 1;\r\n     } else {\r\n-        currentSaleItems.push({\r\n-            id: product.id,\r\n-            name: product.name,\r\n-            price: product.price,\r\n-            img: product.image,\r\n-            quantity: 1\r\n-        });\r\n+        currentSaleItems.push({ id: product.id, name: product.name, price: product.price, img: product.image, quantity: 1 });\r\n     }\r\n+\r\n     updateSaleDisplay();\r\n \r\n-    // Tiny toast or visual feedback\r\n     const card = document.querySelector(`.menu-item-card[data-id=\"${itemId}\"]`);\r\n     if (card) {\r\n         card.classList.add('animate-add');\r\n         setTimeout(() => card.classList.remove('animate-add'), 400);\r\n     }\r\n }\r\n \r\n+function calcTotals() {\r\n+    const subtotal = currentSaleItems.reduce((acc, item) => acc + item.price * item.quantity, 0);\r\n+\r\n+    let discountAmount = subtotal * (currentDiscount / 100);\r\n+    if (currentCoupon) {\r\n+        discountAmount += currentCoupon.type === 'percentage'\r\n+            ? subtotal * (currentCoupon.value / 100)\r\n+            : currentCoupon.value;\r\n+    }\r\n+\r\n+    const discountedSubtotal = Math.max(0, subtotal - discountAmount);\r\n+    const taxes = discountedSubtotal * 0.12;\r\n+    const total = discountedSubtotal + taxes;\r\n+\r\n+    return { subtotal, discountAmount, taxes, total };\r\n+}\r\n+\r\n function updateSaleDisplay() {\r\n-    const container = document.getElementById('cartItemsList');\r\n-    const subtotalEl = document.getElementById('cartSubtotal');\r\n-    const taxEl = document.getElementById('cartTaxes');\r\n-    const totalEl = document.getElementById('cartTotal');\r\n+    const container   = document.getElementById('cartItemsList');\r\n+    const subtotalEl  = document.getElementById('cartSubtotal');\r\n+    const taxEl       = document.getElementById('cartTaxes');\r\n+    const totalEl     = document.getElementById('cartTotal');\r\n     const cartCountEl = document.getElementById('cartCount');\r\n     const checkoutBtn = document.getElementById('checkoutBtn');\r\n \r\n     if (!container) return;\r\n \r\n-    // Update Customer Display in Sidebar if exists\r\n     const customerDisplay = document.querySelector('.customer-name-display');\r\n-    if (customerDisplay) {\r\n-        customerDisplay.textContent = currentCustomer || 'Walk-in Customer';\r\n-    }\r\n+    if (customerDisplay) customerDisplay.textContent = currentCustomer || 'Walk-in Customer';\r\n \r\n     if (currentSaleItems.length === 0) {\r\n         container.innerHTML = `<div class=\"text-center py-5 empty-cart-msg\"><p class=\"text-muted\">No items in cart</p></div>`;\r\n         subtotalEl.textContent = 'P0.00';\r\n-        taxEl.textContent = 'P0.00';\r\n-        totalEl.textContent = 'P0.00';\r\n+        taxEl.textContent      = 'P0.00';\r\n+        totalEl.textContent    = 'P0.00';\r\n         cartCountEl.textContent = '0';\r\n-        checkoutBtn.disabled = true;\r\n+        checkoutBtn.disabled   = true;\r\n         return;\r\n     }\r\n \r\n-    let subtotal = 0;\r\n-    let itemsCount = 0;\r\n-    let itemsHtml = '';\r\n+    const { subtotal, discountAmount, taxes, total } = calcTotals();\r\n+    const itemsCount = currentSaleItems.reduce((acc, item) => acc + item.quantity, 0);\r\n \r\n-    currentSaleItems.forEach((item, index) => {\r\n-        subtotal += item.price * item.quantity;\r\n-        itemsCount += item.quantity;\r\n-        itemsHtml += `\r\n-            <div class=\"cart-item\">\r\n-                <div class=\"cart-item-details\">\r\n-                    <span class=\"cart-item-name\">${item.name}</span>\r\n-                    <span class=\"cart-item-price\">P${(item.price * item.quantity).toFixed(2)}</span>\r\n-                </div>\r\n-                <div class=\"qty-controls\">\r\n-                    <button class=\"btn-qty\" onclick=\"changeQty(${index}, -1)\"><i class=\"fas fa-minus\"></i></button>\r\n-                    <span class=\"fw-bold mx-1\">${item.quantity}</span>\r\n-                    <button class=\"btn-qty\" onclick=\"changeQty(${index}, 1)\"><i class=\"fas fa-plus\"></i></button>\r\n-                    <button class=\"cart-item-remove ms-2\" onclick=\"removeSaleItem(${index})\"><i class=\"fas fa-trash-alt\"></i></button>\r\n-                </div>\r\n+    container.innerHTML = currentSaleItems.map((item, index) => `\r\n+        <div class=\"cart-item\">\r\n+            <div class=\"cart-item-details\">\r\n+                <span class=\"cart-item-name\">${item.name}</span>\r\n+                <span class=\"cart-item-price\">P${(item.price * item.quantity).toFixed(2)}</span>\r\n             </div>\r\n-        `;\r\n-    });\r\n+            <div class=\"qty-controls\">\r\n+                <button class=\"btn-qty\" onclick=\"changeQty(${index}, -1)\"><i class=\"fas fa-minus\"></i></button>\r\n+                <span class=\"fw-bold mx-1\">${item.quantity}</span>\r\n+                <button class=\"btn-qty\" onclick=\"changeQty(${index}, 1)\"><i class=\"fas fa-plus\"></i></button>\r\n+                <button class=\"cart-item-remove ms-2\" onclick=\"removeSaleItem(${index})\"><i class=\"fas fa-trash-alt\"></i></button>\r\n+            </div>\r\n+        </div>`\r\n+    ).join('');\r\n \r\n-    // Apply Discount\r\n-    let discountAmount = (subtotal * (currentDiscount / 100));\r\n-\r\n-    // Apply Coupon\r\n-    if (currentCoupon) {\r\n-        if (currentCoupon.type === 'percentage') {\r\n-            discountAmount += (subtotal * (currentCoupon.value / 100));\r\n-        } else {\r\n-            discountAmount += currentCoupon.value;\r\n-        }\r\n-    }\r\n-\r\n-    const discountedSubtotal = Math.max(0, subtotal - discountAmount);\r\n-    const taxes = discountedSubtotal * 0.12;\r\n-    const total = discountedSubtotal + taxes;\r\n-\r\n-    container.innerHTML = itemsHtml;\r\n-    subtotalEl.textContent = 'P' + subtotal.toFixed(2);\r\n-\r\n-    // Display Discounts if any\r\n-    if (discountAmount > 0) {\r\n-        subtotalEl.innerHTML += ` <span class=\"text-danger small\">( -P${discountAmount.toFixed(2)} )</span>`;\r\n-    }\r\n-\r\n-    taxEl.textContent = 'P' + taxes.toFixed(2);\r\n-    totalEl.textContent = 'P' + total.toFixed(2);\r\n+    subtotalEl.innerHTML = `P${subtotal.toFixed(2)}` +\r\n+        (discountAmount > 0 ? ` <span class=\"text-danger small\">(-P${discountAmount.toFixed(2)})</span>` : '');\r\n+    taxEl.textContent       = `P${taxes.toFixed(2)}`;\r\n+    totalEl.textContent     = `P${total.toFixed(2)}`;\r\n     cartCountEl.textContent = itemsCount;\r\n-    checkoutBtn.disabled = false;\r\n+    checkoutBtn.disabled    = false;\r\n }\r\n \r\n function changeQty(index, delta) {\r\n     currentSaleItems[index].quantity += delta;\r\n-    if (currentSaleItems[index].quantity <= 0) {\r\n-        currentSaleItems.splice(index, 1);\r\n-    }\r\n+    if (currentSaleItems[index].quantity <= 0) currentSaleItems.splice(index, 1);\r\n     updateSaleDisplay();\r\n }\r\n \r\n function removeSaleItem(index) {\r\n@@ -489,11 +412,11 @@\n }\r\n \r\n function clearCurrentSale() {\r\n     currentSaleItems = [];\r\n-    currentCustomer = null;\r\n-    currentDiscount = 0;\r\n-    currentCoupon = null;\r\n+    currentCustomer  = null;\r\n+    currentDiscount  = 0;\r\n+    currentCoupon    = null;\r\n     updateSaleDisplay();\r\n }\r\n \r\n function processCheckout() {\r\n@@ -506,552 +429,347 @@\n         showCancelButton: true,\r\n         confirmButtonColor: '#800000',\r\n         cancelButtonColor: '#6c757d',\r\n         confirmButtonText: 'Confirm'\r\n-    }).then((result) => {\r\n-        if (result.isConfirmed) {\r\n-            recordSale();\r\n-        }\r\n+    }).then(result => {\r\n+        if (result.isConfirmed) recordSale();\r\n     });\r\n }\r\n \r\n function recordSale() {\r\n-    const subtotal = currentSaleItems.reduce((acc, item) => acc + (item.price * item.quantity), 0);\r\n-    let discountAmt = (subtotal * (currentDiscount / 100));\r\n-    if (currentCoupon) {\r\n-        discountAmt += (currentCoupon.type === 'percentage' ? (subtotal * (currentCoupon.value / 100)) : currentCoupon.value);\r\n-    }\r\n-    const finalSubtotal = Math.max(0, subtotal - discountAmt);\r\n-    const taxes = finalSubtotal * 0.12;\r\n-    const total = finalSubtotal + taxes;\r\n+    const { subtotal, discountAmount, taxes, total } = calcTotals();\r\n \r\n     const newSale = {\r\n         id: 'SALE-' + Date.now(),\r\n         date: new Date().toISOString().split('T')[0],\r\n         time: new Date().toLocaleTimeString(),\r\n         timestamp: Date.now(),\r\n         items: [...currentSaleItems],\r\n-        subtotal: subtotal,\r\n-        discount: discountAmt,\r\n-        taxes: taxes,\r\n-        total: total,\r\n+        subtotal,\r\n+        discount: discountAmount,\r\n+        taxes,\r\n+        total,\r\n         customer: currentCustomer || 'Walk-in',\r\n-        staff: 'Staff Account'\r\n+        staff: JSON.parse(localStorage.getItem('loggedInUser') || '{}').full_name || 'Staff'\r\n     };\r\n \r\n-    // Save to sales history\r\n-    let sales = JSON.parse(localStorage.getItem('sales')) || [];\r\n-    sales.unshift(newSale); // Newest first\r\n+    const sales = JSON.parse(localStorage.getItem('sales') || '[]');\r\n+    sales.unshift(newSale);\r\n     localStorage.setItem('sales', JSON.stringify(sales));\r\n \r\n-    // Dedut ingredients (Simulated sync with inventory)\r\n-    updateIngredientsStock(currentSaleItems);\r\n-    logStaffActivity('Recorded Sale', `${newSale.id} - Total: P${newSale.total.toFixed(2)} - Customer: ${newSale.customer}`, 'Success');\r\n+    logStaffActivity('Recorded Sale', `${newSale.id} - Total: P${total.toFixed(2)} - Customer: ${newSale.customer}`, 'Success');\r\n \r\n     Swal.fire('Success!', 'Transaction recorded.', 'success');\r\n-\r\n     clearCurrentSale();\r\n }\r\n \r\n-// Real-time listener for Admin changes\r\n-window.addEventListener('storage', (e) => {\r\n-    if (e.key === 'adminMenuItems') {\r\n-        console.log(\"Admin updated menu, refreshing POS...\");\r\n-        loadMenuItems();\r\n-    }\r\n+// Sync menu when admin makes changes\r\n+window.addEventListener('storage', e => {\r\n+    if (e.key === 'adminMenuItems') loadMenuItems();\r\n });\r\n \r\n-function updateIngredientsStock(saleItems) {\r\n-    let ingredients = JSON.parse(localStorage.getItem('ingredients')) || [];\r\n-    let recipes = JSON.parse(localStorage.getItem('adminRecipes')) || [];\r\n+// ‚îÄ‚îÄ‚îÄ Ingredients ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n \r\n-    saleItems.forEach(saleItem => {\r\n-        // Find recipe for this menu item\r\n-        const recipe = recipes.find(r => r.menuItem === saleItem.name);\r\n-        if (recipe) {\r\n-            recipe.ingredients.forEach(recIng => {\r\n-                const ing = ingredients.find(i => i.name === recIng.name);\r\n-                if (ing) {\r\n-                    ing.quantity -= (recIng.qty * saleItem.quantity);\r\n-                    if (ing.quantity < 0) ing.quantity = 0;\r\n-                }\r\n-            });\r\n-        }\r\n-    });\r\n-\r\n-    localStorage.setItem('ingredients', JSON.stringify(ingredients));\r\n-}\r\n-\r\n-// Global Activity Logging - Connects to Admin's systemActivityLogs\r\n-function logStaffActivity(action, details, status) {\r\n-    let logs = [];\r\n-    try {\r\n-        const stored = localStorage.getItem('systemActivityLogs');\r\n-        if (stored) logs = JSON.parse(stored);\r\n-    } catch (e) { logs = []; }\r\n-\r\n-    const now = new Date();\r\n-    const pad = n => String(n).padStart(2, '0');\r\n-    const ts = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;\r\n-\r\n-    const newLog = {\r\n-        id: Date.now(),\r\n-        userName: 'Staff User', // Could be dynamic based on login\r\n-        action: action,\r\n-        reference: details,\r\n-        timestamp: ts,\r\n-        category: action.includes('Sale') || action.includes('Return') ? 'Sales' : 'Staff',\r\n-        ip: '192.168.1.10'\r\n-    };\r\n-\r\n-    logs.unshift(newLog);\r\n-    if (logs.length > 500) logs = logs.slice(0, 500);\r\n-    localStorage.setItem('systemActivityLogs', JSON.stringify(logs));\r\n-}\r\n-\r\n-// Ingredients Functions\r\n function initializeIngredientsFunctionality() {\r\n-    const searchInput = document.getElementById('ingredientSearch');\r\n-    if (searchInput) {\r\n-        searchInput.addEventListener('input', filterIngredients);\r\n-    }\r\n-\r\n-    const categoryFilter = document.getElementById('ingredientCategoryFilter');\r\n-    if (categoryFilter) {\r\n-        categoryFilter.addEventListener('change', filterIngredients);\r\n-    }\r\n-\r\n+    document.getElementById('ingredientSearch')?.addEventListener('input', filterIngredients);\r\n+    document.getElementById('ingredientCategoryFilter')?.addEventListener('change', filterIngredients);\r\n     loadIngredients();\r\n }\r\n \r\n function loadIngredients() {\r\n-    console.log(\"‚úÖ loadIngredients() called\");\r\n+    const tableElem = document.getElementById('ingredientsListTable') || document.getElementById('ingredientsTable');\r\n+    if (!tableElem) return;\r\n \r\n-    const tableElem =\r\n-        document.getElementById('ingredientsListTable') ||\r\n-        document.getElementById('ingredientsTable');\r\n-\r\n-    console.log(\"üîé Table element found:\", tableElem);\r\n-\r\n-    if (!tableElem) {\r\n-        console.warn(\"‚ùå Table element not found!\");\r\n-        return;\r\n-    }\r\n-\r\n     const tbody = tableElem.querySelector('tbody');\r\n-    console.log(\"üîé tbody:\", tbody);\r\n+    if (!tbody) return;\r\n \r\n-    if (!tbody) {\r\n-        console.warn(\"‚ùå tbody not found!\");\r\n-        return;\r\n-    }\r\n-\r\n     tbody.innerHTML = '<tr><td colspan=\"6\" class=\"text-center py-4\">Loading...</td></tr>';\r\n \r\n     setTimeout(() => {\r\n-        console.log(\"üì¶ Setting ingredient data\");\r\n-\r\n         allIngredients = [\r\n-            { id: 1, name: 'Beef', category: 'Meat', quantity: 15, unit: 'kg', status: 'Normal', minLevel: 5 },\r\n-            { id: 2, name: 'Chicken', category: 'Meat', quantity: 8, unit: 'kg', status: 'Low', minLevel: 10 },\r\n-            { id: 3, name: 'Onions', category: 'Vegetables', quantity: 3, unit: 'kg', status: 'Low', minLevel: 5 },\r\n-            { id: 4, name: 'Cheese', category: 'Dairy', quantity: 4, unit: 'kg', status: 'Low', minLevel: 5 },\r\n-            { id: 5, name: 'Garlic', category: 'Spices', quantity: 1, unit: 'kg', status: 'Low', minLevel: 2 },\r\n-            { id: 6, name: 'Cooking Oil', category: 'Supplies', quantity: 2, unit: 'L', status: 'Low', minLevel: 5 },\r\n-            { id: 7, name: 'Red Wine', category: 'Beverages', quantity: 1, unit: 'bottle', status: 'Low', minLevel: 3 }\r\n+            { id: 1, name: 'Beef',        category: 'Meat',       quantity: 15, unit: 'kg',     status: 'Normal', minLevel: 5  },\r\n+            { id: 2, name: 'Chicken',     category: 'Meat',       quantity: 8,  unit: 'kg',     status: 'Low',    minLevel: 10 },\r\n+            { id: 3, name: 'Onions',      category: 'Vegetables', quantity: 3,  unit: 'kg',     status: 'Low',    minLevel: 5  },\r\n+            { id: 4, name: 'Cheese',      category: 'Dairy',      quantity: 4,  unit: 'kg',     status: 'Low',    minLevel: 5  },\r\n+            { id: 5, name: 'Garlic',      category: 'Spices',     quantity: 1,  unit: 'kg',     status: 'Low',    minLevel: 2  },\r\n+            { id: 6, name: 'Cooking Oil', category: 'Supplies',   quantity: 2,  unit: 'L',      status: 'Low',    minLevel: 5  },\r\n+            { id: 7, name: 'Red Wine',    category: 'Beverages',  quantity: 1,  unit: 'bottle', status: 'Low',    minLevel: 3  }\r\n         ];\r\n-\r\n         displayIngredients(allIngredients);\r\n-\r\n     }, 500);\r\n }\r\n \r\n-\r\n function displayIngredients(ingredients) {\r\n     const tableElem = document.getElementById('ingredientsListTable') || document.getElementById('ingredientsTable');\r\n     if (!tableElem) return;\r\n \r\n-    const tbody = tableElem.getElementsByTagName('tbody')[0];\r\n+    const tbody = tableElem.querySelector('tbody');\r\n     if (!tbody) return;\r\n \r\n-    tbody.innerHTML = '';\r\n-    ingredients.forEach(ing => {\r\n-        const row = tbody.insertRow();\r\n-        row.innerHTML = `\r\n+    tbody.innerHTML = ingredients.map(ing => `\r\n+        <tr>\r\n             <td>${ing.name}</td>\r\n             <td>${ing.category}</td>\r\n             <td>${ing.quantity} ${ing.unit}</td>\r\n-            <td>${ing.minLevel || '-'}</td>\r\n+            <td>${ing.minLevel ?? '-'}</td>\r\n             <td><span class=\"badge ${ing.status === 'Normal' ? 'bg-success' : 'bg-warning'}\">${ing.status}</span></td>\r\n             <td><button class=\"btn btn-sm btn-outline-maroon\" onclick=\"showUpdateModal(${ing.id})\">Update</button></td>\r\n-        `;\r\n-    });\r\n+        </tr>`\r\n+    ).join('');\r\n }\r\n \r\n function showUpdateModal(id) {\r\n-    // Logic to show update modal\r\n-    const modal = new bootstrap.Modal(document.getElementById('updateQuantityModal') || document.getElementById('increaseQuantityModal'));\r\n-    modal.show();\r\n+    const modalEl = document.getElementById('updateQuantityModal') || document.getElementById('increaseQuantityModal');\r\n+    if (!modalEl) return;\r\n+    new bootstrap.Modal(modalEl).show();\r\n }\r\n \r\n function filterIngredients() {\r\n     const searchTerm = document.getElementById('ingredientSearch')?.value.toLowerCase() || '';\r\n-    const category = document.getElementById('ingredientCategoryFilter')?.value || '';\r\n+    const category   = document.getElementById('ingredientCategoryFilter')?.value || '';\r\n \r\n     const filtered = allIngredients.filter(ing =>\r\n         ing.name.toLowerCase().includes(searchTerm) &&\r\n         (category === '' || ing.category === category)\r\n     );\r\n     displayIngredients(filtered);\r\n }\r\n \r\n-// Receipts Functions\r\n+// ‚îÄ‚îÄ‚îÄ Receipts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n+\r\n function initializeReceiptsFunctionality() {\r\n     loadRecentReceipts();\r\n }\r\n \r\n function loadRecentReceipts() {\r\n     const container = document.getElementById('recentReceipts');\r\n     if (!container) return;\r\n-\r\n     container.innerHTML = '<a href=\"#\" class=\"list-group-item list-group-item-action\">No recent receipts</a>';\r\n }\r\n \r\n-// Account Functions\r\n+// ‚îÄ‚îÄ‚îÄ Account ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n+\r\n function initializeAccountFunctionality() {\r\n     loadAccountData();\r\n \r\n-    const editBtn = document.getElementById('editAccountBtn');\r\n-    const sendBtn = document.getElementById('sendAccountRequestBtn');\r\n+    document.getElementById('editAccountBtn')?.addEventListener('click', () => toggleAccountEdit());\r\n \r\n-    if (editBtn) {\r\n-        editBtn.addEventListener('click', function () {\r\n-            toggleAccountEdit();\r\n-        });\r\n-    }\r\n+    document.getElementById('sendAccountRequestBtn')?.addEventListener('click', async function () {\r\n+        const fullName    = document.getElementById('accFullName')?.value.trim();\r\n+        const email       = document.getElementById('accEmail')?.value.trim();\r\n+        const currentPass = document.getElementById('currentPass')?.value;\r\n+        const newPass     = document.getElementById('newPass')?.value;\r\n+        const confirmPass = document.getElementById('confirmPass')?.value;\r\n \r\n-    if (sendBtn) {\r\n-        sendBtn.addEventListener('click', async function () {\r\n-            const fullName = document.getElementById('accFullName').value.trim();\r\n-            const email = document.getElementById('accEmail').value.trim();\r\n-            const currentPass = document.getElementById('currentPass').value;\r\n-            const newPass = document.getElementById('newPass').value;\r\n-            const confirmPass = document.getElementById('confirmPass').value;\r\n+        if (fullName || email)                           await saveAccountInfo();\r\n+        if (currentPass || newPass || confirmPass)       await handlePasswordUpdate();\r\n \r\n-            // Determine what's being requested\r\n-            if (fullName || email) {\r\n-                await saveAccountInfo();\r\n-            }\r\n-\r\n-            if (currentPass || newPass || confirmPass) {\r\n-                await handlePasswordUpdate();\r\n-            }\r\n-\r\n-            // After sending, lock back\r\n-            toggleAccountEdit(false);\r\n-        });\r\n-    }\r\n+        toggleAccountEdit(false);\r\n+    });\r\n }\r\n \r\n function toggleAccountEdit(forceState) {\r\n     const editBtn = document.getElementById('editAccountBtn');\r\n     const sendBtn = document.getElementById('sendAccountRequestBtn');\r\n-    const inputs = document.querySelectorAll('#accountInfoForm input, #changePasswordForm input:not(#accUsername)');\r\n+    const inputs  = document.querySelectorAll('#accountInfoForm input, #changePasswordForm input:not(#accUsername)');\r\n \r\n     const isLocked = forceState !== undefined ? !forceState : editBtn.classList.contains('btn-outline-maroon');\r\n \r\n     if (isLocked) {\r\n-        // Unlock\r\n-        editBtn.classList.remove('btn-outline-maroon');\r\n-        editBtn.classList.add('btn-maroon');\r\n+        editBtn.classList.replace('btn-outline-maroon', 'btn-maroon');\r\n         editBtn.innerHTML = '<i class=\"fas fa-times me-1\"></i> Cancel';\r\n         sendBtn.classList.remove('d-none');\r\n-        inputs.forEach(input => {\r\n-            if (input.id !== 'accUsername') input.disabled = false;\r\n-        });\r\n+        inputs.forEach(input => { if (input.id !== 'accUsername') input.disabled = false; });\r\n     } else {\r\n-        // Lock\r\n-        editBtn.classList.add('btn-outline-maroon');\r\n-        editBtn.classList.remove('btn-maroon');\r\n+        editBtn.classList.replace('btn-maroon', 'btn-outline-maroon');\r\n         editBtn.innerHTML = '<i class=\"fas fa-edit me-1\"></i> Edit';\r\n         sendBtn.classList.add('d-none');\r\n         inputs.forEach(input => input.disabled = true);\r\n-        loadAccountData(); // Reset values\r\n-        document.getElementById('changePasswordForm').reset();\r\n+        loadAccountData();\r\n+        document.getElementById('changePasswordForm')?.reset();\r\n     }\r\n }\r\n \r\n function loadAccountData() {\r\n     const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n     if (!user.id) return;\r\n \r\n-    // Sidebar/Header Info\r\n-    const profFullName = document.getElementById('profFullName');\r\n-    if (profFullName) profFullName.textContent = user.full_name;\r\n+    const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };\r\n+    const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };\r\n \r\n-    const profRole = document.getElementById('profRole');\r\n-    if (profRole) profRole.textContent = user.role_name || 'Staff Member';\r\n+    set('profFullName', user.full_name);\r\n+    set('profRole', user.role_name || 'Staff Member');\r\n+    set('profEmployeeId', `STF-${String(user.id).padStart(5, '0')}`);\r\n+    set('profStatus', user.status || 'Active');\r\n+    set('profActivityName', user.full_name);\r\n \r\n-    const profEmployeeId = document.getElementById('profEmployeeId');\r\n-    if (profEmployeeId) profEmployeeId.textContent = `STF-${user.id.toString().padStart(5, '0')}`;\r\n-\r\n-    const profJoinDate = document.getElementById('profJoinDate');\r\n-    if (profJoinDate && user.created_at) {\r\n-        const date = new Date(user.created_at);\r\n-        const options = { year: 'numeric', month: 'long', day: 'numeric' };\r\n-        profJoinDate.textContent = date.toLocaleDateString(undefined, options);\r\n+    if (user.created_at) {\r\n+        set('profJoinDate', new Date(user.created_at).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' }));\r\n     }\r\n \r\n-    const profStatus = document.getElementById('profStatus');\r\n-    if (profStatus) {\r\n-        profStatus.innerHTML = `<i class=\"fas fa-check-circle me-2\"></i>${user.status || 'Active'}`;\r\n-    }\r\n-\r\n-    const profActivityName = document.getElementById('profActivityName');\r\n-    if (profActivityName) profActivityName.textContent = user.full_name;\r\n-\r\n-    // Form inputs\r\n-    const fullNameInput = document.getElementById('accFullName');\r\n-    if (fullNameInput) fullNameInput.value = user.full_name || '';\r\n-\r\n-    const usernameInput = document.getElementById('accUsername');\r\n-    if (usernameInput) usernameInput.value = user.username || '';\r\n-\r\n-    const emailInput = document.getElementById('accEmail');\r\n-    if (emailInput) emailInput.value = user.email || '';\r\n+    setVal('accFullName', user.full_name || '');\r\n+    setVal('accUsername', user.username || '');\r\n+    setVal('accEmail',    user.email    || '');\r\n }\r\n \r\n async function saveAccountInfo() {\r\n-    const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n-    const newFullName = document.getElementById('accFullName').value.trim();\r\n-    const newEmail = document.getElementById('accEmail').value.trim();\r\n+    const user     = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n+    const fullName = document.getElementById('accFullName')?.value.trim();\r\n+    const email    = document.getElementById('accEmail')?.value.trim();\r\n \r\n-    if (!newFullName) {\r\n+    if (!fullName) {\r\n         showModalNotification('Full Name is required', 'warning', 'Validation');\r\n         return;\r\n     }\r\n \r\n-    const payload = JSON.stringify({\r\n-        full_name: newFullName,\r\n-        email: newEmail\r\n-    });\r\n-\r\n     try {\r\n-        const res = await fetch(\\\"/php/app.php\\\", {\r\n-            method: \"POST\",\r\n-            headers: { \"Content-Type\": \"application/json\" },\r\n+        const res = await fetch('/php/app.php', {\r\n+            method: 'POST',\r\n+            headers: { 'Content-Type': 'application/json' },\r\n             body: JSON.stringify({\r\n                 table: 'requests_tbl',\r\n                 type: 'account_update',\r\n                 requester_id: user.id,\r\n-                payload: payload,\r\n+                payload: JSON.stringify({ full_name: fullName, email }),\r\n                 status: 'Pending',\r\n                 created_at: new Date().toISOString().slice(0, 19).replace('T', ' ')\r\n             })\r\n         });\r\n-\r\n         const data = await res.json();\r\n         if (data.error) throw new Error(data.error);\r\n \r\n         showModalNotification('Update request sent to administrator for approval.', 'success', 'Request Sent');\r\n-        logStaffActivity('Requested Account Update', `New Name: ${newFullName}`, 'Pending');\r\n+        logStaffActivity('Requested Account Update', `New Name: ${fullName}`, 'Pending');\r\n     } catch (err) {\r\n         console.error('Failed to send request:', err);\r\n         showModalNotification('Failed to send update request.', 'danger', 'Error');\r\n     }\r\n }\r\n \r\n async function handlePasswordUpdate() {\r\n-    const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n-    const currentPass = document.getElementById('currentPass').value;\r\n-    const newPass = document.getElementById('newPass').value;\r\n-    const confirmPass = document.getElementById('confirmPass').value;\r\n+    const user        = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n+    const currentPass = document.getElementById('currentPass')?.value;\r\n+    const newPass     = document.getElementById('newPass')?.value;\r\n+    const confirmPass = document.getElementById('confirmPass')?.value;\r\n \r\n     if (!currentPass || !newPass || !confirmPass) {\r\n         showModalNotification('Please fill in all password fields', 'warning', 'Validation');\r\n         return;\r\n     }\r\n-\r\n     if (newPass !== confirmPass) {\r\n         showModalNotification('New passwords do not match', 'warning', 'Validation');\r\n         return;\r\n     }\r\n-\r\n     if (newPass.length < 6) {\r\n         showModalNotification('Password must be at least 6 characters', 'warning', 'Validation');\r\n         return;\r\n     }\r\n \r\n-    const payload = JSON.stringify({\r\n-        current_password: currentPass,\r\n-        new_password: newPass\r\n-    });\r\n-\r\n     try {\r\n-        const res = await fetch(\"/php/app.php\", {\r\n-            method: \"POST\",\r\n-            headers: { \"Content-Type\": \"application/json\" },\r\n+        const res = await fetch('/php/app.php', {\r\n+            method: 'POST',\r\n+            headers: { 'Content-Type': 'application/json' },\r\n             body: JSON.stringify({\r\n                 table: 'requests_tbl',\r\n                 type: 'password_change',\r\n                 requester_id: user.id,\r\n-                payload: payload,\r\n+                payload: JSON.stringify({ current_password: currentPass, new_password: newPass }),\r\n                 status: 'Pending',\r\n                 created_at: new Date().toISOString().slice(0, 19).replace('T', ' ')\r\n             })\r\n         });\r\n-\r\n         const data = await res.json();\r\n         if (data.error) throw new Error(data.error);\r\n \r\n         showModalNotification('Password change request sent to administrator.', 'success', 'Request Sent');\r\n         logStaffActivity('Requested Password Change', '', 'Pending');\r\n-        document.getElementById('changePasswordForm').reset();\r\n+        document.getElementById('changePasswordForm')?.reset();\r\n     } catch (err) {\r\n         console.error('Failed to send request:', err);\r\n         showModalNotification('Failed to send request.', 'danger', 'Error');\r\n     }\r\n }\r\n \r\n-// Activity Log Functions\r\n+// ‚îÄ‚îÄ‚îÄ Activity Log ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n+\r\n function initializeActivityLogFunctionality() {\r\n     loadActivityLog();\r\n-    // Real-time updates for Activity Log\r\n-    setInterval(loadActivityLog, 10000); // Poll every 10 seconds\r\n+    setInterval(loadActivityLog, 10000);\r\n }\r\n \r\n-async function logStaffActivity(action, reference, status = 'Success') {\r\n-    const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n-    if (!user.id) return;\r\n-\r\n-    try {\r\n-        await fetch(\\\"/php/app.php\\\", {\r\n-            method: \"POST\",\r\n-            headers: { \"Content-Type\": \"application/json\" },\r\n-            body: JSON.stringify({\r\n-                table: 'activity_logs',\r\n-                user_id: user.id,\r\n-                role_label: user.role_name || 'Staff',\r\n-                action: action,\r\n-                reference: reference || 'N/A',\r\n-                status: status,\r\n-                ip_address: '127.0.0.1', // Placeholder or fetch if needed\r\n-                created_at: new Date().toISOString().slice(0, 19).replace('T', ' ')\r\n-            })\r\n-        });\r\n-        // If we are currently viewing the activity log, refresh it\r\n-        if (document.getElementById('activityLogTable')) {\r\n-            loadActivityLog();\r\n-        }\r\n-    } catch (e) {\r\n-        console.error(\"Failed to log activity:\", e);\r\n-    }\r\n-}\r\n-\r\n async function loadActivityLog() {\r\n     const tableElem = document.getElementById('activityLogTable');\r\n     if (!tableElem) return;\r\n \r\n-    const tbody = tableElem.getElementsByTagName('tbody')[0];\r\n+    const tbody = tableElem.querySelector('tbody');\r\n     if (!tbody) return;\r\n \r\n     const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n     if (!user.id) return;\r\n \r\n     try {\r\n-        const res = await fetch(`/php/app.php?table=activity_logs&user_id=${user.id}`);\r\n-        let logs = await res.json();\r\n+        const res  = await fetch(`/php/app.php?table=activity_logs&user_id=${user.id}`);\r\n+        const logs = await res.json();\r\n \r\n         if (!Array.isArray(logs)) {\r\n-            console.error(\"Invalid logs data:\", logs);\r\n+            console.error('Invalid logs data:', logs);\r\n             return;\r\n         }\r\n \r\n-        // Sort by date descending\r\n         logs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));\r\n \r\n-        if (logs.length === 0) {\r\n-            tbody.innerHTML = '<tr><td colspan=\"4\" class=\"text-center py-4\">No activity recorded yet.</td></tr>';\r\n-            return;\r\n-        }\r\n+        tbody.innerHTML = logs.length === 0\r\n+            ? '<tr><td colspan=\"4\" class=\"text-center py-4\">No activity recorded yet.</td></tr>'\r\n+            : logs.map(log => `\r\n+                <tr>\r\n+                    <td>${log.created_at}</td>\r\n+                    <td>${log.action}</td>\r\n+                    <td>${log.reference}</td>\r\n+                    <td>\r\n+                        <span class=\"badge ${log.status === 'Success' ? 'bg-success' : log.status === 'Pending' ? 'bg-warning' : 'bg-danger'}\">\r\n+                            ${log.status}\r\n+                        </span>\r\n+                    </td>\r\n+                </tr>`\r\n+            ).join('');\r\n \r\n-        tbody.innerHTML = logs.map(log => `\r\n-            <tr>\r\n-                <td>${log.created_at}</td>\r\n-                <td>${log.action}</td>\r\n-                <td>${log.reference}</td>\r\n-                <td>\r\n-                    <span class=\"badge ${log.status === 'Success' ? 'bg-success' : (log.status === 'Pending' ? 'bg-warning' : 'bg-danger')}\">\r\n-                        ${log.status}\r\n-                    </span>\r\n-                </td>\r\n-            </tr>\r\n-        `).join('');\r\n-\r\n     } catch (err) {\r\n         console.error('Failed to load activity logs:', err);\r\n     }\r\n }\r\n \r\n+// ‚îÄ‚îÄ‚îÄ User Sync ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n+\r\n async function refreshUserData() {\r\n     const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n     if (!user.id) return;\r\n \r\n     try {\r\n-        const res = await fetch(`/php/app.php?table=users&id=${user.id}`);\r\n+        const res   = await fetch(`/php/app.php?table=users&id=${user.id}`);\r\n         const users = await res.json();\r\n         const dbUser = Array.isArray(users) ? users[0] : users;\r\n \r\n-        if (dbUser && dbUser.id) {\r\n-            // Check if anything significant changed (full_name, email)\r\n-            if (dbUser.full_name !== user.full_name || dbUser.email !== user.email) {\r\n-                // Merge and update\r\n-                const updated = { ...user, ...dbUser };\r\n-                localStorage.setItem('loggedInUser', JSON.stringify(updated));\r\n+        if (dbUser?.id && (dbUser.full_name !== user.full_name || dbUser.email !== user.email)) {\r\n+            localStorage.setItem('loggedInUser', JSON.stringify({ ...user, ...dbUser }));\r\n \r\n-                // Refresh UI components\r\n-                const headerUserName = document.querySelector('.navbar .dropdown-toggle');\r\n-                if (headerUserName) {\r\n-                    headerUserName.innerHTML = `<i class=\"fas fa-user-circle me-1\"></i>${dbUser.full_name}`;\r\n-                }\r\n+            const headerUserName = document.querySelector('.navbar .dropdown-toggle');\r\n+            if (headerUserName) {\r\n+                headerUserName.innerHTML = `<i class=\"fas fa-user-circle me-1\"></i>${dbUser.full_name}`;\r\n+            }\r\n \r\n-                if (document.getElementById('accountInfoForm')) {\r\n-                    loadAccountData();\r\n-                }\r\n-            }\r\n+            if (document.getElementById('accountInfoForm')) loadAccountData();\r\n         }\r\n     } catch (e) {\r\n-        console.error(\"User data sync failed\", e);\r\n+        console.error('User data sync failed:', e);\r\n     }\r\n }\r\n \r\n-/**\r\n- * Update user status (active/inactive) in database\r\n- * @param {number} userId - User ID\r\n- * @param {string} status - 'active' or 'inactive'\r\n- * @returns {Promise} - Resolves when status is updated\r\n- */\r\n async function updateUserStatus(userId, status) {\r\n-    try {\r\n-        const response = await fetch('/php/user_status.php', {\r\n-            method: 'POST',\r\n-            headers: { 'Content-Type': 'application/json' },\r\n-            body: JSON.stringify({\r\n-                user_id: userId,\r\n-                status: status\r\n-            })\r\n-        });\r\n+    const response = await fetch('/php/user_status.php', {\r\n+        method: 'POST',\r\n+        headers: { 'Content-Type': 'application/json' },\r\n+        body: JSON.stringify({ user_id: userId, status })\r\n+    });\r\n \r\n-        if (!response.ok) {\r\n-            throw new Error(`HTTP error! status: ${response.status}`);\r\n-        }\r\n-\r\n-        const data = await response.json();\r\n-        console.log(`‚úÖ User ${userId} marked as ${status}:`, data);\r\n-        return data;\r\n-    } catch (error) {\r\n-        console.error(`‚ùå Failed to update user status:`, error);\r\n-        throw error;\r\n-    }\r\n-}\r\n-\r\n-// showModalNotification and showConfirm are defined in main.js ‚Äî not duplicated here\r\n+    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);\r\n+    return response.json();\r\n+}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1771860706709,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,10 +1,78 @@\n // Staff Dashboard JavaScript - Fixed & Cleaned\r\n \r\n+// API URL for database operations\r\n+const API_URL = \"/php/app.php\";\r\n+\r\n+// Database helper function\r\n+function createDB(table) {\r\n+    return {\r\n+        add: async (data) => {\r\n+            try {\r\n+                const res = await fetch(API_URL, {\r\n+                    method: \"POST\",\r\n+                    headers: { \"Content-Type\": \"application/json\" },\r\n+                    body: JSON.stringify({ ...data, table })\r\n+                });\r\n+                return await res.json();\r\n+            } catch (err) {\r\n+                console.error(`Add failed [${table}]:`, err);\r\n+                return { error: err.message };\r\n+            }\r\n+        },\r\n+        show: async (filters = {}) => {\r\n+            try {\r\n+                const params = new URLSearchParams({ ...filters, table }).toString();\r\n+                const res = await fetch(`${API_URL}?${params}`);\r\n+                return await res.json();\r\n+            } catch (err) {\r\n+                console.error(`Show failed [${table}]:`, err);\r\n+                return [];\r\n+            }\r\n+        },\r\n+        edit: async (data) => {\r\n+            try {\r\n+                const res = await fetch(API_URL, {\r\n+                    method: \"PUT\",\r\n+                    headers: { \"Content-Type\": \"application/json\" },\r\n+                    body: JSON.stringify({ ...data, table })\r\n+                });\r\n+                return await res.json();\r\n+            } catch (err) {\r\n+                console.error(`Edit failed [${table}]:`, err);\r\n+                return { error: err.message };\r\n+            }\r\n+        },\r\n+        delete: async (id) => {\r\n+            try {\r\n+                const res = await fetch(API_URL, {\r\n+                    method: \"DELETE\",\r\n+                    headers: { \"Content-Type\": \"application/json\" },\r\n+                    body: JSON.stringify({ id, table })\r\n+                });\r\n+                return await res.json();\r\n+            } catch (err) {\r\n+                console.error(`Delete failed [${table}]:`, err);\r\n+                return { error: err.message };\r\n+            }\r\n+        }\r\n+    };\r\n+}\r\n+\r\n+// Database objects for staff use\r\n+const menuCategoriesDB = createDB('menu_categories');\r\n+const menuItemsDB = createDB('menu_items');\r\n+const ingredientsDB = createDB('ingredients');\r\n+const salesDB = createDB('sales');\r\n+const saleItemsDB = createDB('sale_items');\r\n+const inventoryTransactionsDB = createDB('inventory_transactions');\r\n+const recipesDB = createDB('recipes');\r\n+\r\n // Global variables\r\n let currentSaleItems = [];\r\n let currentSaleId = null;\r\n let allMenuItems = [];\r\n+let allCategories = [];\r\n let allIngredients = [];\r\n let currentCustomer = null;\r\n let currentDiscount = 0;\r\n let currentCoupon = null;\r\n@@ -96,16 +164,8 @@\n \r\n // ‚îÄ‚îÄ‚îÄ Menu / POS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n \r\n function initializeMenuFunctionality() {\r\n-    document.querySelectorAll('.btn-category').forEach(tab => {\r\n-        tab.addEventListener('click', function () {\r\n-            document.querySelectorAll('.btn-category').forEach(t => t.classList.remove('active'));\r\n-            this.classList.add('active');\r\n-            filterMenuItems();\r\n-        });\r\n-    });\r\n-\r\n     document.getElementById('menuSearch')?.addEventListener('input', filterMenuItems);\r\n \r\n     document.getElementById('clearSaleBtn')?.addEventListener('click', () =>\r\n         showConfirm('Are you sure you want to clear the cart?', clearCurrentSale)\r\n@@ -116,12 +176,43 @@\n     document.getElementById('couponBtn')?.addEventListener('click', applyCoupon);\r\n     document.getElementById('holdOrderBtn')?.addEventListener('click', holdOrder);\r\n     document.getElementById('returnOrderBtn')?.addEventListener('click', handleReturn);\r\n \r\n+    // Load categories first, then menu items\r\n+    loadCategoryTabs();\r\n     loadMenuItems();\r\n     updateSaleDisplay();\r\n }\r\n \r\n+// Load category tabs from database\r\n+async function loadCategoryTabs() {\r\n+    const tabsContainer = document.getElementById('categoryTabs');\r\n+    if (!tabsContainer) return;\r\n+\r\n+    try {\r\n+        const categories = await menuCategoriesDB.show();\r\n+        allCategories = categories;\r\n+\r\n+        // Build HTML: \"All Products\" first, then DB categories\r\n+        let html = '<button class=\"btn btn-category active\" data-category=\"All\">All Products</button>';\r\n+        categories.forEach(cat => {\r\n+            html += `<button class=\"btn btn-category\" data-category=\"${cat.id}\">${cat.name}</button>`;\r\n+        });\r\n+        tabsContainer.innerHTML = html;\r\n+\r\n+        // Attach click listeners\r\n+        tabsContainer.querySelectorAll('.btn-category').forEach(tab => {\r\n+            tab.addEventListener('click', function () {\r\n+                tabsContainer.querySelectorAll('.btn-category').forEach(t => t.classList.remove('active'));\r\n+                this.classList.add('active');\r\n+                filterMenuItems();\r\n+            });\r\n+        });\r\n+    } catch (err) {\r\n+        console.error('Failed to load categories:', err);\r\n+    }\r\n+}\r\n+\r\n function selectCustomer() {\r\n     Swal.fire({\r\n         title: 'Select Customer',\r\n         input: 'text',\r\n@@ -249,32 +340,45 @@\n         });\r\n     });\r\n }\r\n \r\n-function loadMenuItems() {\r\n+async function loadMenuItems() {\r\n     const menuGrid = document.getElementById('menuItemsGrid');\r\n     if (!menuGrid) return;\r\n \r\n     menuGrid.innerHTML = '<div class=\"col-12 text-center py-5\"><div class=\"loading-spinner\"></div><p class=\"mt-2\">Fetching menu from system...</p></div>';\r\n \r\n-    setTimeout(() => {\r\n-        const savedMenu = JSON.parse(localStorage.getItem('adminMenuItems') || 'null');\r\n+    try {\r\n+        const [menuItems, categories] = await Promise.all([\r\n+            menuItemsDB.show(),\r\n+            menuCategoriesDB.show()\r\n+        ]);\r\n \r\n-        allMenuItems = (savedMenu && savedMenu.length > 0) ? savedMenu : [\r\n-            { id: 1, name: 'Beef Steak',       category: 'Main Course', price: 450, image: 'https://images.unsplash.com/photo-1600891964092-4316c288032e?w=400&h=300&fit=crop', available: true },\r\n-            { id: 2, name: 'Chicken Curry',     category: 'Main Course', price: 320, image: 'https://images.unsplash.com/photo-1603894584373-5ac82b2ae398?w=400&h=300&fit=crop', available: true },\r\n-            { id: 3, name: 'Vegetable Salad',   category: 'Appetizer',   price: 180, image: 'https://images.unsplash.com/photo-1540420773420-3366772f4999?w=400&h=300&fit=crop', available: true },\r\n-            { id: 4, name: 'Garlic Bread',      category: 'Appetizer',   price: 120, image: 'https://images.unsplash.com/photo-1573140247632-f8fd74997d5c?w=400&h=300&fit=crop', available: true },\r\n-            { id: 5, name: 'French Fries',      category: 'Side Dish',   price: 95,  image: 'https://images.unsplash.com/photo-1576107232684-1279f390859f?w=400&h=300&fit=crop', available: true },\r\n-            { id: 6, name: 'Pasta Carbonara',   category: 'Main Course', price: 280, image: 'https://images.unsplash.com/photo-1598866594230-a7c12756260f?w=400&h=300&fit=crop', available: true },\r\n-            { id: 7, name: 'Chocolate Cake',    category: 'Dessert',     price: 150, image: 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=400&h=300&fit=crop', available: true },\r\n-            { id: 8, name: 'Fruit Shake',       category: 'Beverage',    price: 85,  image: 'https://images.unsplash.com/photo-1544145945-f904253d0c71?w=400&h=300&fit=crop', available: true }\r\n-        ];\r\n+        // Create category lookup map\r\n+        const categoryMap = {};\r\n+        categories.forEach(cat => {\r\n+            categoryMap[cat.id] = cat.name;\r\n+        });\r\n \r\n-        if (!savedMenu) localStorage.setItem('adminMenuItems', JSON.stringify(allMenuItems));\r\n+        // Transform DB items to include category_name and filter only active items\r\n+        allMenuItems = menuItems\r\n+            .filter(item => item.status === 'Active' || item.status === 'active')\r\n+            .map(item => ({\r\n+                id: item.id,\r\n+                name: item.name,\r\n+                category_id: item.category_id,\r\n+                category: categoryMap[item.category_id] || 'Uncategorized',\r\n+                price: parseFloat(item.price_reference) || 0,\r\n+                image: item.image_path || 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400&h=300&fit=crop',\r\n+                description: item.description || '',\r\n+                available: true\r\n+            }));\r\n \r\n         displayMenuItems(allMenuItems);\r\n-    }, 600);\r\n+    } catch (err) {\r\n+        console.error('Failed to load menu items:', err);\r\n+        menuGrid.innerHTML = '<div class=\"col-12 text-center py-5\"><i class=\"fas fa-exclamation-circle fa-3x text-danger mb-3\"></i><p class=\"text-muted\">Failed to load menu items</p></div>';\r\n+    }\r\n }\r\n \r\n function displayMenuItems(items) {\r\n     const menuGrid = document.getElementById('menuItemsGrid');\r\n@@ -304,14 +408,17 @@\n \r\n function filterMenuItems() {\r\n     const searchTerm = document.getElementById('menuSearch')?.value.toLowerCase() || '';\r\n     const activeTab  = document.querySelector('.btn-category.active');\r\n-    const category   = activeTab ? activeTab.getAttribute('data-category') : 'All';\r\n+    const categoryValue = activeTab ? activeTab.getAttribute('data-category') : 'All';\r\n \r\n-    const filtered = allMenuItems.filter(item =>\r\n-        item.name.toLowerCase().includes(searchTerm) &&\r\n-        (category === 'All' || item.category === category)\r\n-    );\r\n+    const filtered = allMenuItems.filter(item => {\r\n+        const matchesSearch = item.name.toLowerCase().includes(searchTerm);\r\n+        const matchesCategory = categoryValue === 'All' || \r\n+            item.category_id == categoryValue || \r\n+            item.category === categoryValue;\r\n+        return matchesSearch && matchesCategory;\r\n+    });\r\n     displayMenuItems(filtered);\r\n }\r\n \r\n function addItemToSale(itemId) {\r\n"
                },
                {
                    "date": 1771861930318,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -61,8 +61,10 @@\n // Database objects for staff use\r\n const menuCategoriesDB = createDB('menu_categories');\r\n const menuItemsDB = createDB('menu_items');\r\n const ingredientsDB = createDB('ingredients');\r\n+const ingredientCategoriesDB = createDB('ingredient_categories');\r\n+const unitsDB = createDB('units');\r\n const salesDB = createDB('sales');\r\n const saleItemsDB = createDB('sale_items');\r\n const inventoryTransactionsDB = createDB('inventory_transactions');\r\n const recipesDB = createDB('recipes');\r\n@@ -578,34 +580,88 @@\n \r\n function initializeIngredientsFunctionality() {\r\n     document.getElementById('ingredientSearch')?.addEventListener('input', filterIngredients);\r\n     document.getElementById('ingredientCategoryFilter')?.addEventListener('change', filterIngredients);\r\n+    \r\n+    // Save update button listener\r\n+    const saveBtn = document.getElementById('confirmQuantityUpdate');\r\n+    if (saveBtn) {\r\n+        saveBtn.addEventListener('click', saveIngredientUpdate);\r\n+    }\r\n+    \r\n     loadIngredients();\r\n }\r\n \r\n-function loadIngredients() {\r\n+async function loadIngredients() {\r\n     const tableElem = document.getElementById('ingredientsListTable') || document.getElementById('ingredientsTable');\r\n     if (!tableElem) return;\r\n \r\n     const tbody = tableElem.querySelector('tbody');\r\n     if (!tbody) return;\r\n \r\n-    tbody.innerHTML = '<tr><td colspan=\"6\" class=\"text-center py-4\">Loading...</td></tr>';\r\n+    tbody.innerHTML = '<tr><td colspan=\"6\" class=\"text-center py-4\"><i class=\"fas fa-spinner fa-spin me-2\"></i>Loading ingredients...</td></tr>';\r\n \r\n-    setTimeout(() => {\r\n-        allIngredients = [\r\n-            { id: 1, name: 'Beef',        category: 'Meat',       quantity: 15, unit: 'kg',     status: 'Normal', minLevel: 5  },\r\n-            { id: 2, name: 'Chicken',     category: 'Meat',       quantity: 8,  unit: 'kg',     status: 'Low',    minLevel: 10 },\r\n-            { id: 3, name: 'Onions',      category: 'Vegetables', quantity: 3,  unit: 'kg',     status: 'Low',    minLevel: 5  },\r\n-            { id: 4, name: 'Cheese',      category: 'Dairy',      quantity: 4,  unit: 'kg',     status: 'Low',    minLevel: 5  },\r\n-            { id: 5, name: 'Garlic',      category: 'Spices',     quantity: 1,  unit: 'kg',     status: 'Low',    minLevel: 2  },\r\n-            { id: 6, name: 'Cooking Oil', category: 'Supplies',   quantity: 2,  unit: 'L',      status: 'Low',    minLevel: 5  },\r\n-            { id: 7, name: 'Red Wine',    category: 'Beverages',  quantity: 1,  unit: 'bottle', status: 'Low',    minLevel: 3  }\r\n-        ];\r\n+    try {\r\n+        // Fetch ingredients, categories, and units from database\r\n+        const [ingredients, categories, units] = await Promise.all([\r\n+            ingredientsDB.show(),\r\n+            ingredientCategoriesDB.show(),\r\n+            unitsDB.show()\r\n+        ]);\r\n+\r\n+        // Create lookup maps\r\n+        const categoryMap = {};\r\n+        categories.forEach(cat => { categoryMap[cat.id] = cat.name; });\r\n+\r\n+        const unitMap = {};\r\n+        units.forEach(unit => { unitMap[unit.id] = unit.abbreviation || unit.name; });\r\n+\r\n+        // Map ingredients with proper display info\r\n+        allIngredients = ingredients.map(ing => {\r\n+            const qty = parseFloat(ing.current_quantity) || 0;\r\n+            const threshold = parseFloat(ing.low_stock_threshold) || 0;\r\n+            const status = qty <= threshold ? 'Low' : 'Normal';\r\n+\r\n+            return {\r\n+                id: ing.id,\r\n+                name: ing.name,\r\n+                category: categoryMap[ing.category_id] || 'Uncategorized',\r\n+                category_id: ing.category_id,\r\n+                quantity: qty,\r\n+                unit: unitMap[ing.unit_id] || '',\r\n+                unit_id: ing.unit_id,\r\n+                status: status,\r\n+                minLevel: threshold\r\n+            };\r\n+        });\r\n+\r\n         displayIngredients(allIngredients);\r\n-    }, 500);\r\n+        populateCategoryFilter(categories);\r\n+\r\n+    } catch (error) {\r\n+        console.error('Failed to load ingredients:', error);\r\n+        tbody.innerHTML = '<tr><td colspan=\"6\" class=\"text-center py-4 text-danger\"><i class=\"fas fa-exclamation-triangle me-2\"></i>Failed to load ingredients</td></tr>';\r\n+    }\r\n }\r\n \r\n+/**\r\n+ * Populate the category filter dropdown with database categories\r\n+ */\r\n+function populateCategoryFilter(categories) {\r\n+    const filterSelect = document.getElementById('ingredientCategoryFilter');\r\n+    if (!filterSelect) return;\r\n+\r\n+    // Keep the \"All Categories\" option\r\n+    filterSelect.innerHTML = '<option value=\"\">All Categories</option>';\r\n+\r\n+    categories.forEach(cat => {\r\n+        const option = document.createElement('option');\r\n+        option.value = cat.name;\r\n+        option.textContent = cat.name;\r\n+        filterSelect.appendChild(option);\r\n+    });\r\n+}\r\n+\r\n function displayIngredients(ingredients) {\r\n     const tableElem = document.getElementById('ingredientsListTable') || document.getElementById('ingredientsTable');\r\n     if (!tableElem) return;\r\n \r\n@@ -623,14 +679,128 @@\n         </tr>`\r\n     ).join('');\r\n }\r\n \r\n+// Track currently editing ingredient\r\n+let currentEditingIngredient = null;\r\n+\r\n function showUpdateModal(id) {\r\n     const modalEl = document.getElementById('updateQuantityModal') || document.getElementById('increaseQuantityModal');\r\n     if (!modalEl) return;\r\n-    new bootstrap.Modal(modalEl).show();\r\n+\r\n+    // Find the ingredient from our loaded data\r\n+    const ingredient = allIngredients.find(ing => ing.id === id);\r\n+    if (!ingredient) {\r\n+        console.error('Ingredient not found:', id);\r\n+        return;\r\n+    }\r\n+\r\n+    currentEditingIngredient = ingredient;\r\n+\r\n+    // Populate modal with ingredient data\r\n+    const nameEl = document.getElementById('updateIngName');\r\n+    const currentStockEl = document.getElementById('currentStockDisplay');\r\n+    const unitEl = document.getElementById('stockUnitDisplay');\r\n+    const quantityInput = document.getElementById('updateQuantity');\r\n+\r\n+    if (nameEl) nameEl.textContent = ingredient.name;\r\n+    if (currentStockEl) currentStockEl.textContent = ingredient.quantity;\r\n+    if (unitEl) unitEl.textContent = ingredient.unit;\r\n+    if (quantityInput) quantityInput.value = '';\r\n+\r\n+    // Reset radio buttons\r\n+    const increaseRadio = document.getElementById('increase');\r\n+    if (increaseRadio) increaseRadio.checked = true;\r\n+\r\n+    const modal = new bootstrap.Modal(modalEl);\r\n+    modal.show();\r\n }\r\n \r\n+/**\r\n+ * Save updated ingredient quantity to database\r\n+ */\r\n+async function saveIngredientUpdate() {\r\n+    if (!currentEditingIngredient) {\r\n+        showModalNotification('No ingredient selected', 'warning', 'Error');\r\n+        return;\r\n+    }\r\n+\r\n+    const quantityInput = document.getElementById('updateAmount');\r\n+    const changeQty = parseFloat(quantityInput?.value) || 0;\r\n+\r\n+    if (changeQty <= 0) {\r\n+        showModalNotification('Please enter a valid quantity', 'warning', 'Validation Error');\r\n+        return;\r\n+    }\r\n+\r\n+    const isIncrease = document.getElementById('increase')?.checked;\r\n+    const reason = document.getElementById('updateReason')?.value || 'Manual adjustment';\r\n+    const prevQty = currentEditingIngredient.quantity;\r\n+    const newQty = isIncrease ? prevQty + changeQty : prevQty - changeQty;\r\n+\r\n+    if (newQty < 0) {\r\n+        showModalNotification('Cannot reduce below zero', 'warning', 'Validation Error');\r\n+        return;\r\n+    }\r\n+\r\n+    // Show loading state\r\n+    const saveBtn = document.getElementById('confirmQuantityUpdate');\r\n+    const originalText = saveBtn ? saveBtn.innerHTML : '';\r\n+    if (saveBtn) {\r\n+        saveBtn.disabled = true;\r\n+        saveBtn.innerHTML = '<i class=\"fas fa-spinner fa-spin me-1\"></i> Saving...';\r\n+    }\r\n+\r\n+    try {\r\n+        // Update ingredient in database\r\n+        await ingredientsDB.edit({\r\n+            id: currentEditingIngredient.id,\r\n+            current_quantity: newQty,\r\n+            updated_at: new Date().toISOString().slice(0, 19).replace('T', ' ')\r\n+        });\r\n+\r\n+        // Log the transaction\r\n+        const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n+        await inventoryTransactionsDB.add({\r\n+            ingredient_id: currentEditingIngredient.id,\r\n+            change_qty: isIncrease ? changeQty : -changeQty,\r\n+            transaction_type: isIncrease ? 'restock' : 'usage',\r\n+            reason: reason,\r\n+            performed_by: user.id || null,\r\n+            prev_qty: prevQty,\r\n+            new_qty: newQty,\r\n+            timestamp: new Date().toISOString().slice(0, 19).replace('T', ' ')\r\n+        });\r\n+\r\n+        // Close modal\r\n+        const modalEl = document.getElementById('updateQuantityModal');\r\n+        const modal = bootstrap.Modal.getInstance(modalEl);\r\n+        if (modal) modal.hide();\r\n+\r\n+        showModalNotification(\r\n+            `${currentEditingIngredient.name} updated: ${prevQty} ‚Üí ${newQty} ${currentEditingIngredient.unit}`,\r\n+            'success',\r\n+            'Stock Updated'\r\n+        );\r\n+\r\n+        // Log activity\r\n+        logStaffActivity('inventory', `Updated ${currentEditingIngredient.name}: ${isIncrease ? '+' : '-'}${changeQty} ${currentEditingIngredient.unit} (${reason})`);\r\n+\r\n+        // Reload ingredients\r\n+        loadIngredients();\r\n+\r\n+    } catch (error) {\r\n+        console.error('Failed to update ingredient:', error);\r\n+        showModalNotification('Failed to update stock: ' + error.message, 'error', 'Update Error');\r\n+    } finally {\r\n+        // Restore button state\r\n+        if (saveBtn) {\r\n+            saveBtn.disabled = false;\r\n+            saveBtn.innerHTML = originalText || 'Save Update';\r\n+        }\r\n+    }\r\n+}\r\n+\r\n function filterIngredients() {\r\n     const searchTerm = document.getElementById('ingredientSearch')?.value.toLowerCase() || '';\r\n     const category   = document.getElementById('ingredientCategoryFilter')?.value || '';\r\n \r\n"
                },
                {
                    "date": 1771862130131,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -668,23 +668,124 @@\n     const tbody = tableElem.querySelector('tbody');\r\n     if (!tbody) return;\r\n \r\n     tbody.innerHTML = ingredients.map(ing => `\r\n-        <tr>\r\n-            <td>${ing.name}</td>\r\n-            <td>${ing.category}</td>\r\n-            <td>${ing.quantity} ${ing.unit}</td>\r\n-            <td>${ing.minLevel ?? '-'}</td>\r\n-            <td><span class=\"badge ${ing.status === 'Normal' ? 'bg-success' : 'bg-warning'}\">${ing.status}</span></td>\r\n-            <td><button class=\"btn btn-sm btn-outline-maroon\" onclick=\"showUpdateModal(${ing.id})\">Update</button></td>\r\n+        <tr class=\"${ing.status === 'Low' ? 'table-warning' : ''}\">\r\n+            <td><strong>${ing.name}</strong></td>\r\n+            <td><span class=\"badge bg-secondary\">${ing.category}</span></td>\r\n+            <td>\r\n+                <span class=\"fw-bold ${ing.status === 'Low' ? 'text-danger' : 'text-success'}\">${ing.quantity}</span> \r\n+                <small class=\"text-muted\">${ing.unit}</small>\r\n+            </td>\r\n+            <td><small class=\"text-muted\">${ing.minLevel ?? '-'} ${ing.unit}</small></td>\r\n+            <td>\r\n+                <span class=\"badge ${ing.status === 'Normal' ? 'bg-success' : 'bg-warning text-dark'}\">\r\n+                    <i class=\"fas ${ing.status === 'Normal' ? 'fa-check-circle' : 'fa-exclamation-triangle'} me-1\"></i>${ing.status}\r\n+                </span>\r\n+            </td>\r\n+            <td>\r\n+                <div class=\"btn-group btn-group-sm\" role=\"group\">\r\n+                    <button class=\"btn btn-success\" onclick=\"showRestockModal(${ing.id})\" title=\"Restock\">\r\n+                        <i class=\"fas fa-plus\"></i>\r\n+                    </button>\r\n+                    <button class=\"btn btn-warning text-dark\" onclick=\"showUsageModal(${ing.id})\" title=\"Record Usage\">\r\n+                        <i class=\"fas fa-minus\"></i>\r\n+                    </button>\r\n+                    <button class=\"btn btn-outline-secondary\" onclick=\"showIngredientHistory(${ing.id})\" title=\"View History\">\r\n+                        <i class=\"fas fa-history\"></i>\r\n+                    </button>\r\n+                </div>\r\n+            </td>\r\n         </tr>`\r\n     ).join('');\r\n+\r\n+    // Update total count if element exists\r\n+    const totalCount = document.getElementById('ingredientsTotalCount');\r\n+    if (totalCount) {\r\n+        totalCount.textContent = `${ingredients.length} ingredients`;\r\n+    }\r\n }\r\n \r\n // Track currently editing ingredient\r\n let currentEditingIngredient = null;\r\n+let currentUpdateType = 'restock'; // 'restock' or 'usage'\r\n \r\n-function showUpdateModal(id) {\r\n+/**\r\n+ * Show modal for restocking (adding) inventory\r\n+ */\r\n+function showRestockModal(id) {\r\n+    currentUpdateType = 'restock';\r\n+    showUpdateModal(id, 'restock');\r\n+}\r\n+\r\n+/**\r\n+ * Show modal for recording usage (removing) inventory\r\n+ */\r\n+function showUsageModal(id) {\r\n+    currentUpdateType = 'usage';\r\n+    showUpdateModal(id, 'usage');\r\n+}\r\n+\r\n+/**\r\n+ * Show ingredient transaction history\r\n+ */\r\n+async function showIngredientHistory(id) {\r\n+    const ingredient = allIngredients.find(ing => ing.id === id);\r\n+    if (!ingredient) return;\r\n+\r\n+    try {\r\n+        // Fetch transactions for this ingredient\r\n+        const transactions = await inventoryTransactionsDB.show({ ingredient_id: id });\r\n+        \r\n+        let historyHtml = '';\r\n+        if (transactions && transactions.length > 0) {\r\n+            historyHtml = transactions.slice(-10).reverse().map(t => {\r\n+                const isPositive = parseFloat(t.change_qty) > 0;\r\n+                const date = new Date(t.timestamp).toLocaleDateString();\r\n+                const time = new Date(t.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});\r\n+                return `\r\n+                    <div class=\"d-flex justify-content-between align-items-center border-bottom py-2\">\r\n+                        <div>\r\n+                            <span class=\"badge ${isPositive ? 'bg-success' : 'bg-danger'} me-2\">\r\n+                                ${isPositive ? '+' : ''}${t.change_qty}\r\n+                            </span>\r\n+                            <small class=\"text-muted\">${t.reason || t.transaction_type}</small>\r\n+                        </div>\r\n+                        <small class=\"text-muted\">${date} ${time}</small>\r\n+                    </div>\r\n+                `;\r\n+            }).join('');\r\n+        } else {\r\n+            historyHtml = '<p class=\"text-muted text-center py-3\">No transaction history</p>';\r\n+        }\r\n+\r\n+        // Use SweetAlert2 to show history\r\n+        Swal.fire({\r\n+            title: `<i class=\"fas fa-history me-2\"></i>${ingredient.name}`,\r\n+            html: `\r\n+                <div class=\"text-start\">\r\n+                    <p class=\"mb-2\">\r\n+                        <strong>Current Stock:</strong> ${ingredient.quantity} ${ingredient.unit}<br>\r\n+                        <strong>Min Level:</strong> ${ingredient.minLevel} ${ingredient.unit}\r\n+                    </p>\r\n+                    <hr>\r\n+                    <h6>Recent Transactions:</h6>\r\n+                    <div style=\"max-height: 250px; overflow-y: auto;\">\r\n+                        ${historyHtml}\r\n+                    </div>\r\n+                </div>\r\n+            `,\r\n+            width: 500,\r\n+            showCloseButton: true,\r\n+            showConfirmButton: false\r\n+        });\r\n+    } catch (error) {\r\n+        console.error('Failed to load history:', error);\r\n+        showModalNotification('Failed to load transaction history', 'error', 'Error');\r\n+    }\r\n+}\r\n+\r\n+function showUpdateModal(id, type = 'restock') {\r\n     const modalEl = document.getElementById('updateQuantityModal') || document.getElementById('increaseQuantityModal');\r\n     if (!modalEl) return;\r\n \r\n     // Find the ingredient from our loaded data\r\n@@ -694,24 +795,43 @@\n         return;\r\n     }\r\n \r\n     currentEditingIngredient = ingredient;\r\n+    currentUpdateType = type;\r\n \r\n     // Populate modal with ingredient data\r\n     const nameEl = document.getElementById('updateIngName');\r\n     const currentStockEl = document.getElementById('currentStockDisplay');\r\n     const unitEl = document.getElementById('stockUnitDisplay');\r\n-    const quantityInput = document.getElementById('updateQuantity');\r\n+    const amountInput = document.getElementById('updateAmount');\r\n+    const unitTextEl = document.querySelector('.unit-text');\r\n \r\n     if (nameEl) nameEl.textContent = ingredient.name;\r\n     if (currentStockEl) currentStockEl.textContent = ingredient.quantity;\r\n     if (unitEl) unitEl.textContent = ingredient.unit;\r\n-    if (quantityInput) quantityInput.value = '';\r\n+    if (unitTextEl) unitTextEl.textContent = ingredient.unit;\r\n+    if (amountInput) amountInput.value = '1.00';\r\n \r\n-    // Reset radio buttons\r\n+    // Set the correct radio button based on type\r\n     const increaseRadio = document.getElementById('increase');\r\n-    if (increaseRadio) increaseRadio.checked = true;\r\n+    const decreaseRadio = document.getElementById('decrease');\r\n+    \r\n+    if (type === 'restock' && increaseRadio) {\r\n+        increaseRadio.checked = true;\r\n+    } else if (type === 'usage' && decreaseRadio) {\r\n+        decreaseRadio.checked = true;\r\n+    }\r\n \r\n+    // Update modal title based on type\r\n+    const modalTitle = modalEl.querySelector('.modal-title');\r\n+    if (modalTitle) {\r\n+        if (type === 'restock') {\r\n+            modalTitle.innerHTML = '<i class=\"fas fa-plus-circle me-2\"></i>Restock Inventory';\r\n+        } else {\r\n+            modalTitle.innerHTML = '<i class=\"fas fa-minus-circle me-2\"></i>Record Usage';\r\n+        }\r\n+    }\r\n+\r\n     const modal = new bootstrap.Modal(modalEl);\r\n     modal.show();\r\n }\r\n \r\n"
                },
                {
                    "date": 1771914953973,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,26 @@\n // Staff Dashboard JavaScript - Fixed & Cleaned\r\n \r\n-// API URL for database operations\r\n-const API_URL = \"/php/app.php\";\r\n+// API URL for database operations (relative path works on any server)\r\n+const API_URL = \"php/app.php\";\r\n \r\n+// Loading modal helper functions\r\n+function showLoadingModal(message = 'Loading data...') {\r\n+    if (window.Swal) {\r\n+        Swal.fire({\r\n+            title: message,\r\n+            html: '<div class=\"d-flex justify-content-center\"><div class=\"spinner-border text-primary\" role=\"status\"><span class=\"visually-hidden\">Loading...</span></div></div>',\r\n+            allowOutsideClick: false,\r\n+            showConfirmButton: false,\r\n+            didOpen: () => { Swal.showLoading(); }\r\n+        });\r\n+    }\r\n+}\r\n+\r\n+function hideLoadingModal() {\r\n+    if (window.Swal) Swal.close();\r\n+}\r\n+\r\n // Database helper function\r\n function createDB(table) {\r\n     return {\r\n         add: async (data) => {\r\n@@ -140,9 +157,9 @@\n     const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n     if (!user.id) return;\r\n \r\n     try {\r\n-        await fetch('/php/app.php', {\r\n+        await fetch(API_URL, {\r\n             method: 'POST',\r\n             headers: { 'Content-Type': 'application/json' },\r\n             body: JSON.stringify({\r\n                 table: 'activity_logs',\r\n@@ -150,9 +167,9 @@\n                 role_label: user.role_name || 'Staff',\r\n                 action,\r\n                 reference,\r\n                 status,\r\n-                ip_address: '127.0.0.1',\r\n+                ip_address: window.location.hostname,\r\n                 created_at: new Date().toISOString().slice(0, 19).replace('T', ' ')\r\n             })\r\n         });\r\n \r\n@@ -348,8 +365,10 @@\n     if (!menuGrid) return;\r\n \r\n     menuGrid.innerHTML = '<div class=\"col-12 text-center py-5\"><div class=\"loading-spinner\"></div><p class=\"mt-2\">Fetching menu from system...</p></div>';\r\n \r\n+    showLoadingModal('Loading menu items...');\r\n+\r\n     try {\r\n         const [menuItems, categories] = await Promise.all([\r\n             menuItemsDB.show(),\r\n             menuCategoriesDB.show()\r\n@@ -363,23 +382,32 @@\n \r\n         // Transform DB items to include category_name and filter only active items\r\n         allMenuItems = menuItems\r\n             .filter(item => item.status === 'Active' || item.status === 'active')\r\n-            .map(item => ({\r\n-                id: item.id,\r\n-                name: item.name,\r\n-                category_id: item.category_id,\r\n-                category: categoryMap[item.category_id] || 'Uncategorized',\r\n-                price: parseFloat(item.price_reference) || 0,\r\n-                image: item.image_path || 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400&h=300&fit=crop',\r\n-                description: item.description || '',\r\n-                available: true\r\n-            }));\r\n+            .map(item => {\r\n+                // Fix image path - handle both absolute and relative paths\r\n+                let imgPath = item.image_path || '';\r\n+                if (imgPath.startsWith('/')) {\r\n+                    imgPath = imgPath.substring(1); // Remove leading slash\r\n+                }\r\n+                return {\r\n+                    id: item.id,\r\n+                    name: item.name,\r\n+                    category_id: item.category_id,\r\n+                    category: categoryMap[item.category_id] || 'Uncategorized',\r\n+                    price: parseFloat(item.price_reference) || 0,\r\n+                    image: imgPath || 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400&h=300&fit=crop',\r\n+                    description: item.description || '',\r\n+                    available: true\r\n+                };\r\n+            });\r\n \r\n         displayMenuItems(allMenuItems);\r\n     } catch (err) {\r\n         console.error('Failed to load menu items:', err);\r\n         menuGrid.innerHTML = '<div class=\"col-12 text-center py-5\"><i class=\"fas fa-exclamation-circle fa-3x text-danger mb-3\"></i><p class=\"text-muted\">Failed to load menu items</p></div>';\r\n+    } finally {\r\n+        hideLoadingModal();\r\n     }\r\n }\r\n \r\n function displayMenuItems(items) {\r\n@@ -599,8 +627,10 @@\n     if (!tbody) return;\r\n \r\n     tbody.innerHTML = '<tr><td colspan=\"6\" class=\"text-center py-4\"><i class=\"fas fa-spinner fa-spin me-2\"></i>Loading ingredients...</td></tr>';\r\n \r\n+    showLoadingModal('Loading ingredients...');\r\n+\r\n     try {\r\n         // Fetch ingredients, categories, and units from database\r\n         const [ingredients, categories, units] = await Promise.all([\r\n             ingredientsDB.show(),\r\n@@ -639,8 +669,10 @@\n \r\n     } catch (error) {\r\n         console.error('Failed to load ingredients:', error);\r\n         tbody.innerHTML = '<tr><td colspan=\"6\" class=\"text-center py-4 text-danger\"><i class=\"fas fa-exclamation-triangle me-2\"></i>Failed to load ingredients</td></tr>';\r\n+    } finally {\r\n+        hideLoadingModal();\r\n     }\r\n }\r\n \r\n /**\r\n@@ -1018,9 +1050,9 @@\n         return;\r\n     }\r\n \r\n     try {\r\n-        const res = await fetch('/php/app.php', {\r\n+        const res = await fetch(API_URL, {\r\n             method: 'POST',\r\n             headers: { 'Content-Type': 'application/json' },\r\n             body: JSON.stringify({\r\n                 table: 'requests_tbl',\r\n@@ -1061,9 +1093,9 @@\n         return;\r\n     }\r\n \r\n     try {\r\n-        const res = await fetch('/php/app.php', {\r\n+        const res = await fetch(API_URL, {\r\n             method: 'POST',\r\n             headers: { 'Content-Type': 'application/json' },\r\n             body: JSON.stringify({\r\n                 table: 'requests_tbl',\r\n@@ -1103,9 +1135,9 @@\n     const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n     if (!user.id) return;\r\n \r\n     try {\r\n-        const res  = await fetch(`/php/app.php?table=activity_logs&user_id=${user.id}`);\r\n+        const res  = await fetch(`${API_URL}?table=activity_logs&user_id=${user.id}`);\r\n         const logs = await res.json();\r\n \r\n         if (!Array.isArray(logs)) {\r\n             console.error('Invalid logs data:', logs);\r\n@@ -1140,9 +1172,9 @@\n     const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n     if (!user.id) return;\r\n \r\n     try {\r\n-        const res   = await fetch(`/php/app.php?table=users&id=${user.id}`);\r\n+        const res   = await fetch(`${API_URL}?table=users&id=${user.id}`);\r\n         const users = await res.json();\r\n         const dbUser = Array.isArray(users) ? users[0] : users;\r\n \r\n         if (dbUser?.id && (dbUser.full_name !== user.full_name || dbUser.email !== user.email)) {\r\n@@ -1160,9 +1192,9 @@\n     }\r\n }\r\n \r\n async function updateUserStatus(userId, status) {\r\n-    const response = await fetch('/php/user_status.php', {\r\n+    const response = await fetch('php/user_status.php', {\r\n         method: 'POST',\r\n         headers: { 'Content-Type': 'application/json' },\r\n         body: JSON.stringify({ user_id: userId, status })\r\n     });\r\n"
                },
                {
                    "date": 1771916210697,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,9 +7,8 @@\n function showLoadingModal(message = 'Loading data...') {\r\n     if (window.Swal) {\r\n         Swal.fire({\r\n             title: message,\r\n-            html: '<div class=\"d-flex justify-content-center\"><div class=\"spinner-border text-primary\" role=\"status\"><span class=\"visually-hidden\">Loading...</span></div></div>',\r\n             allowOutsideClick: false,\r\n             showConfirmButton: false,\r\n             didOpen: () => { Swal.showLoading(); }\r\n         });\r\n"
                },
                {
                    "date": 1772347294756,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -134,20 +134,26 @@\n     });\r\n }\r\n \r\n function performStaffLogout() {\r\n-    showConfirm('Are you sure you want to logout?', function () {\r\n-        const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n-\r\n-        logStaffActivity('Logged out', 'User session terminated', 'Success');\r\n-\r\n-        updateUserStatus(user.id, 'inactive')\r\n-            .catch(err => console.error('Failed to update status on logout:', err))\r\n-            .finally(() => {\r\n-                localStorage.removeItem('loggedInRole');\r\n-                localStorage.removeItem('loggedInUser');\r\n-                window.location.href = 'index.html';\r\n+    showConfirm('Are you sure you want to logout?', async function () {\r\n+        try {\r\n+            // Call server-side logout to destroy session\r\n+            const response = await fetch('php/logout.php', {\r\n+                method: 'POST',\r\n+                credentials: 'include'\r\n             });\r\n+            const result = await response.json();\r\n+            console.log('üîê Server logout result:', result);\r\n+        } catch (err) {\r\n+            console.error('‚ùå Server logout failed, proceeding with local cleanup:', err);\r\n+        }\r\n+        \r\n+        // Clear local storage\r\n+        localStorage.removeItem('loggedInRole');\r\n+        localStorage.removeItem('loggedInUser');\r\n+        localStorage.removeItem('loggedInUserId');\r\n+        window.location.href = 'index.html';\r\n     });\r\n }\r\n \r\n // ‚îÄ‚îÄ‚îÄ Activity Logging (single authoritative version ‚Äî async/DB) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n"
                },
                {
                    "date": 1772359265018,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,8 +1,9 @@\n // Staff Dashboard JavaScript - Fixed & Cleaned\r\n \r\n // API URL for database operations (relative path works on any server)\r\n const API_URL = \"php/app.php\";\r\n+const NOTIFICATIONS_API = 'php/notifications.php';\r\n \r\n // Loading modal helper functions\r\n function showLoadingModal(message = 'Loading data...') {\r\n     if (window.Swal) {\r\n@@ -83,8 +84,10 @@\n const salesDB = createDB('sales');\r\n const saleItemsDB = createDB('sale_items');\r\n const inventoryTransactionsDB = createDB('inventory_transactions');\r\n const recipesDB = createDB('recipes');\r\n+const heldOrdersDB = createDB('held_orders');\r\n+const systemSettingsDB = createDB('system_settings');\r\n \r\n // Global variables\r\n let currentSaleItems = [];\r\n let currentSaleId = null;\r\n@@ -93,9 +96,34 @@\n let allIngredients = [];\r\n let currentCustomer = null;\r\n let currentDiscount = 0;\r\n let currentCoupon = null;\r\n+let currentOrderType = 'walk-in';\r\n+let systemSettings = {};\r\n \r\n+/**\r\n+ * Create a notification for admin to track staff actions\r\n+ */\r\n+async function createNotification(userId, actionType, targetTable, targetId, description, reason = null) {\r\n+    try {\r\n+        const response = await fetch(NOTIFICATIONS_API, {\r\n+            method: 'POST',\r\n+            headers: { 'Content-Type': 'application/json' },\r\n+            body: JSON.stringify({\r\n+                user_id: userId,\r\n+                action_type: actionType,\r\n+                target_table: targetTable,\r\n+                target_id: targetId,\r\n+                description: description,\r\n+                reason: reason\r\n+            })\r\n+        });\r\n+        return await response.json();\r\n+    } catch (error) {\r\n+        console.error('Failed to create notification:', error);\r\n+    }\r\n+}\r\n+\r\n // DOM Ready\r\n document.addEventListener('DOMContentLoaded', function () {\r\n     if (typeof bootstrap !== 'undefined') {\r\n         const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle=\"tooltip\"]'));\r\n@@ -105,9 +133,9 @@\n     initializeCommonStaffFeatures();\r\n \r\n     if (document.getElementById('menuItemsGrid'))                                       initializeMenuFunctionality();\r\n     if (document.getElementById('ingredientsListTable') || document.getElementById('ingredientsTable')) initializeIngredientsFunctionality();\r\n-    if (document.getElementById('recentReceipts'))                                      initializeReceiptsFunctionality();\r\n+    if (document.getElementById('recentReceipts') || document.getElementById('receiptsList')) initializeReceiptsFunctionality();\r\n     if (document.getElementById('changePasswordForm'))                                  initializeAccountFunctionality();\r\n     if (document.getElementById('activityLogTable'))                                    initializeActivityLogFunctionality();\r\n \r\n     // Only poll user data on pages that show user info\r\n@@ -200,14 +228,115 @@\n     document.getElementById('couponBtn')?.addEventListener('click', applyCoupon);\r\n     document.getElementById('holdOrderBtn')?.addEventListener('click', holdOrder);\r\n     document.getElementById('returnOrderBtn')?.addEventListener('click', handleReturn);\r\n \r\n+    // Order type toggle listeners\r\n+    document.querySelectorAll('input[name=\"orderType\"]').forEach(radio => {\r\n+        radio.addEventListener('change', function() {\r\n+            currentOrderType = this.value;\r\n+        });\r\n+    });\r\n+\r\n+    // Load system settings for discount/coupon visibility\r\n+    loadSystemSettings();\r\n+\r\n     // Load categories first, then menu items\r\n     loadCategoryTabs();\r\n     loadMenuItems();\r\n     updateSaleDisplay();\r\n+\r\n+    // Check for restore parameter in URL (from held orders page)\r\n+    checkRestoreFromURL();\r\n }\r\n \r\n+// Check URL for restore parameter and restore held order\r\n+async function checkRestoreFromURL() {\r\n+    const urlParams = new URLSearchParams(window.location.search);\r\n+    const restoreId = urlParams.get('restore');\r\n+\r\n+    if (!restoreId) return;\r\n+\r\n+    // Clear URL parameter\r\n+    window.history.replaceState({}, document.title, window.location.pathname);\r\n+\r\n+    showLoadingModal('Restoring held order...');\r\n+\r\n+    try {\r\n+        const allHeldOrders = await heldOrdersDB.show();\r\n+        const order = allHeldOrders.find(o => o.id == restoreId);\r\n+\r\n+        if (!order) {\r\n+            hideLoadingModal();\r\n+            Swal.fire('Error', 'Held order not found.', 'error');\r\n+            return;\r\n+        }\r\n+\r\n+        // Restore cart from held order\r\n+        currentSaleItems = JSON.parse(order.items_json || '[]');\r\n+        currentCustomer = order.customer_name !== 'Walk-in Customer' ? order.customer_name : null;\r\n+        currentDiscount = parseFloat(order.discount_percent) || 0;\r\n+        currentOrderType = order.order_type || 'walk-in';\r\n+\r\n+        // Update order type toggle\r\n+        const orderTypeRadio = document.querySelector(`input[name=\"orderType\"][value=\"${currentOrderType}\"]`);\r\n+        if (orderTypeRadio) orderTypeRadio.checked = true;\r\n+\r\n+        // Restore coupon if present\r\n+        if (order.coupon_code) {\r\n+            currentCoupon = {\r\n+                code: order.coupon_code,\r\n+                value: parseFloat(order.coupon_value) || 0,\r\n+                type: 'fixed',\r\n+                label: `${getCurrency()}${parseFloat(order.coupon_value).toFixed(2)} Off`\r\n+            };\r\n+        } else {\r\n+            currentCoupon = null;\r\n+        }\r\n+\r\n+        // Mark held order as restored\r\n+        const staffUser = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n+        await heldOrdersDB.edit({\r\n+            id: order.id,\r\n+            status: 'restored',\r\n+            restored_at: new Date().toISOString(),\r\n+            restored_by: staffUser.id || null\r\n+        });\r\n+\r\n+        hideLoadingModal();\r\n+        updateSaleDisplay();\r\n+        showModalNotification(`Order ${order.hold_ref} restored to cart.`, 'success', 'Order Restored');\r\n+        logStaffActivity('Restored Held Order', order.hold_ref, 'Success');\r\n+\r\n+    } catch (err) {\r\n+        hideLoadingModal();\r\n+        console.error('Failed to restore held order:', err);\r\n+        Swal.fire('Error', 'Failed to restore held order.', 'error');\r\n+    }\r\n+}\r\n+\r\n+// Load system settings from database\r\n+async function loadSystemSettings() {\r\n+    try {\r\n+        const settings = await systemSettingsDB.show();\r\n+        settings.forEach(s => {\r\n+            systemSettings[s.key] = s.value;\r\n+        });\r\n+\r\n+        // Hide/show discount and coupon buttons based on settings\r\n+        const discountBtn = document.getElementById('discountBtn');\r\n+        const couponBtn = document.getElementById('couponBtn');\r\n+\r\n+        if (discountBtn && systemSettings.enable_discount === 'false') {\r\n+            discountBtn.style.display = 'none';\r\n+        }\r\n+        if (couponBtn && systemSettings.enable_coupon === 'false') {\r\n+            couponBtn.style.display = 'none';\r\n+        }\r\n+    } catch (err) {\r\n+        console.error('Failed to load system settings:', err);\r\n+    }\r\n+}\r\n+\r\n // Load category tabs from database\r\n async function loadCategoryTabs() {\r\n     const tabsContainer = document.getElementById('categoryTabs');\r\n     if (!tabsContainer) return;\r\n@@ -285,9 +414,9 @@\n \r\n         const code = result.value.toUpperCase();\r\n         const coupons = {\r\n             SAVE10: { code: 'SAVE10', type: 'percentage', value: 10, label: '10% Off' },\r\n-            FREE50: { code: 'FREE50', type: 'fixed',      value: 50, label: 'P50 Off' },\r\n+            FREE50: { code: 'FREE50', type: 'fixed',      value: 50, label: `${getCurrency()}50 Off` },\r\n         };\r\n \r\n         if (coupons[code]) {\r\n             currentCoupon = coupons[code];\r\n@@ -299,71 +428,134 @@\n         }\r\n     });\r\n }\r\n \r\n-function holdOrder() {\r\n+async function holdOrder() {\r\n     if (currentSaleItems.length === 0) {\r\n         Swal.fire('Error', 'Cart is empty. Nothing to hold.', 'error');\r\n         return;\r\n     }\r\n \r\n-    const heldOrders = JSON.parse(localStorage.getItem('heldOrders') || '[]');\r\n-    const newHold = {\r\n-        id: 'HOLD-' + Date.now(),\r\n-        timestamp: Date.now(),\r\n-        items: [...currentSaleItems],\r\n-        customer: currentCustomer,\r\n-        discount: currentDiscount,\r\n-        coupon: currentCoupon\r\n+    const { subtotal, discountAmount, taxes, total } = calcTotals();\r\n+    const expiryHours = parseInt(systemSettings.hold_order_expiry_hours) || 5;\r\n+    const expiresAt = new Date(Date.now() + expiryHours * 60 * 60 * 1000).toISOString();\r\n+    const staffUser = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n+\r\n+    const holdData = {\r\n+        hold_ref: 'HOLD-' + Date.now(),\r\n+        customer_name: currentCustomer || 'Walk-in Customer',\r\n+        order_type: currentOrderType,\r\n+        items_json: JSON.stringify(currentSaleItems),\r\n+        subtotal: subtotal,\r\n+        discount_amount: discountAmount,\r\n+        discount_percent: currentDiscount,\r\n+        coupon_code: currentCoupon?.code || null,\r\n+        coupon_value: currentCoupon?.value || 0,\r\n+        taxes: taxes,\r\n+        total_amount: total,\r\n+        staff_id: staffUser.id || null,\r\n+        expires_at: expiresAt,\r\n+        status: 'active'\r\n     };\r\n \r\n-    heldOrders.push(newHold);\r\n-    localStorage.setItem('heldOrders', JSON.stringify(heldOrders));\r\n+    showLoadingModal('Holding order...');\r\n \r\n-    showModalNotification('Order has been put on hold.', 'info', 'Order Held');\r\n-    logStaffActivity('Held Order', newHold.id, 'Success');\r\n-    clearCurrentSale();\r\n-}\r\n+    try {\r\n+        const result = await heldOrdersDB.add(holdData);\r\n+        hideLoadingModal();\r\n \r\n-function handleReturn() {\r\n-    const sales = JSON.parse(localStorage.getItem('sales') || '[]');\r\n-    if (sales.length === 0) {\r\n-        Swal.fire('No Transactions', 'No recent transactions found to return.', 'info');\r\n-        return;\r\n+        if (result.error) {\r\n+            Swal.fire('Error', result.error, 'error');\r\n+            return;\r\n+        }\r\n+\r\n+        showModalNotification(`Order held until ${new Date(expiresAt).toLocaleTimeString()}. Expires in ${expiryHours} hours.`, 'info', 'Order Held');\r\n+        logStaffActivity('Held Order', holdData.hold_ref, 'Success');\r\n+        clearCurrentSale();\r\n+    } catch (err) {\r\n+        hideLoadingModal();\r\n+        console.error('Failed to hold order:', err);\r\n+        Swal.fire('Error', 'Failed to hold order. Please try again.', 'error');\r\n     }\r\n+}\r\n \r\n-    const inputOptions = {};\r\n-    sales.slice(0, 10).forEach(s => {\r\n-        inputOptions[s.id] = `${s.id} - P${parseFloat(s.total).toFixed(2)} (${s.time})`;\r\n-    });\r\n+async function handleReturn() {\r\n+    showLoadingModal('Loading held orders...');\r\n \r\n-    Swal.fire({\r\n-        title: 'Select Transaction to Return',\r\n-        input: 'select',\r\n-        inputOptions,\r\n-        inputPlaceholder: 'Select a receipt...',\r\n-        showCancelButton: true,\r\n-        confirmButtonColor: '#800000',\r\n-    }).then(result => {\r\n-        if (!result.isConfirmed || !result.value) return;\r\n+    try {\r\n+        // Get active held orders only\r\n+        const allHeldOrders = await heldOrdersDB.show();\r\n+        const activeOrders = allHeldOrders.filter(o => o.status === 'active');\r\n+        hideLoadingModal();\r\n \r\n-        const saleId = result.value;\r\n-        Swal.fire({\r\n-            title: 'Confirm Return',\r\n-            text: `Are you sure you want to process a return for ${saleId}?`,\r\n-            icon: 'warning',\r\n+        if (activeOrders.length === 0) {\r\n+            Swal.fire('No Held Orders', 'No active held orders found to restore.', 'info');\r\n+            return;\r\n+        }\r\n+\r\n+        // Build select options\r\n+        const inputOptions = {};\r\n+        activeOrders.forEach(order => {\r\n+            const createdAt = new Date(order.created_at).toLocaleTimeString();\r\n+            const expiresAt = new Date(order.expires_at).toLocaleTimeString();\r\n+            inputOptions[order.id] = `${order.hold_ref} - ${order.customer_name} - ${getCurrency()}${parseFloat(order.total_amount).toFixed(2)} (Created: ${createdAt})`;\r\n+        });\r\n+\r\n+        const result = await Swal.fire({\r\n+            title: 'Restore Held Order',\r\n+            input: 'select',\r\n+            inputOptions,\r\n+            inputPlaceholder: 'Select an order to restore...',\r\n             showCancelButton: true,\r\n-            confirmButtonColor: '#d33',\r\n-            confirmButtonText: 'Yes, Return'\r\n-        }).then(confirm => {\r\n-            if (confirm.isConfirmed) {\r\n-                const updated = sales.filter(s => s.id !== saleId);\r\n-                localStorage.setItem('sales', JSON.stringify(updated));\r\n-                showModalNotification('Transaction successfully returned and voided.', 'success', 'Return Processed');\r\n-                logStaffActivity('Processed Return', saleId, 'Success');\r\n-            }\r\n+            confirmButtonColor: '#800000',\r\n+            confirmButtonText: 'Restore to Cart'\r\n         });\r\n-    });\r\n+\r\n+        if (!result.isConfirmed || !result.value) return;\r\n+\r\n+        const selectedOrder = activeOrders.find(o => o.id == result.value);\r\n+        if (!selectedOrder) return;\r\n+\r\n+        // Restore cart from held order\r\n+        currentSaleItems = JSON.parse(selectedOrder.items_json || '[]');\r\n+        currentCustomer = selectedOrder.customer_name !== 'Walk-in Customer' ? selectedOrder.customer_name : null;\r\n+        currentDiscount = parseFloat(selectedOrder.discount_percent) || 0;\r\n+        currentOrderType = selectedOrder.order_type || 'walk-in';\r\n+\r\n+        // Update order type toggle\r\n+        const orderTypeRadio = document.querySelector(`input[name=\"orderType\"][value=\"${currentOrderType}\"]`);\r\n+        if (orderTypeRadio) orderTypeRadio.checked = true;\r\n+\r\n+        // Restore coupon if present\r\n+        if (selectedOrder.coupon_code) {\r\n+            currentCoupon = {\r\n+                code: selectedOrder.coupon_code,\r\n+                value: parseFloat(selectedOrder.coupon_value) || 0,\r\n+                type: 'fixed', // Simplified for restoration\r\n+                label: `${getCurrency()}${parseFloat(selectedOrder.coupon_value).toFixed(2)} Off`\r\n+            };\r\n+        } else {\r\n+            currentCoupon = null;\r\n+        }\r\n+\r\n+        // Mark held order as restored\r\n+        const staffUser = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n+        await heldOrdersDB.edit({\r\n+            id: selectedOrder.id,\r\n+            status: 'restored',\r\n+            restored_at: new Date().toISOString(),\r\n+            restored_by: staffUser.id || null\r\n+        });\r\n+\r\n+        updateSaleDisplay();\r\n+        showModalNotification('Order restored to cart.', 'success', 'Order Restored');\r\n+        logStaffActivity('Restored Held Order', selectedOrder.hold_ref, 'Success');\r\n+\r\n+    } catch (err) {\r\n+        hideLoadingModal();\r\n+        console.error('Failed to restore held order:', err);\r\n+        Swal.fire('Error', 'Failed to load held orders. Please try again.', 'error');\r\n+    }\r\n }\r\n \r\n async function loadMenuItems() {\r\n     const menuGrid = document.getElementById('menuItemsGrid');\r\n@@ -430,9 +622,9 @@\n             <div class=\"col-6 col-md-4 col-lg-3 mb-3\">\r\n                 <div class=\"menu-item-card\" data-id=\"${item.id}\" onclick=\"addItemToSale(${item.id})\">\r\n                     <div class=\"menu-item-img-container\">\r\n                         <img src=\"${imgSrc}\" alt=\"${item.name}\" class=\"menu-item-img\">\r\n-                        <div class=\"price-tag\">P${parseFloat(item.price).toFixed(2)}</div>\r\n+                        <div class=\"price-tag\">${getCurrency()}${parseFloat(item.price).toFixed(2)}</div>\r\n                     </div>\r\n                     <div class=\"p-2 text-center\">\r\n                         <div class=\"fw-bold mb-0 text-truncate\" style=\"font-size:0.85rem\">${item.name}</div>\r\n                     </div>\r\n@@ -475,8 +667,23 @@\n         setTimeout(() => card.classList.remove('animate-add'), 400);\r\n     }\r\n }\r\n \r\n+// Get tax rate from system settings (default 12%)\r\n+function getTaxRate() {\r\n+    return parseFloat(systemSettings.tax_rate) || 12;\r\n+}\r\n+\r\n+// Get currency symbol from system settings (default 'P')\r\n+function getCurrency() {\r\n+    return systemSettings.currency_symbol || 'P';\r\n+}\r\n+\r\n+// Format currency with symbol\r\n+function formatCurrency(amount) {\r\n+    return `${getCurrency()}${parseFloat(amount).toFixed(2)}`;\r\n+}\r\n+\r\n function calcTotals() {\r\n     const subtotal = currentSaleItems.reduce((acc, item) => acc + item.price * item.quantity, 0);\r\n \r\n     let discountAmount = subtotal * (currentDiscount / 100);\r\n@@ -486,12 +693,13 @@\n             : currentCoupon.value;\r\n     }\r\n \r\n     const discountedSubtotal = Math.max(0, subtotal - discountAmount);\r\n-    const taxes = discountedSubtotal * 0.12;\r\n+    const taxRate = getTaxRate() / 100; // Convert percentage to decimal\r\n+    const taxes = discountedSubtotal * taxRate;\r\n     const total = discountedSubtotal + taxes;\r\n \r\n-    return { subtotal, discountAmount, taxes, total };\r\n+    return { subtotal, discountAmount, taxes, total, taxRate: getTaxRate() };\r\n }\r\n \r\n function updateSaleDisplay() {\r\n     const container   = document.getElementById('cartItemsList');\r\n@@ -505,26 +713,28 @@\n \r\n     const customerDisplay = document.querySelector('.customer-name-display');\r\n     if (customerDisplay) customerDisplay.textContent = currentCustomer || 'Walk-in Customer';\r\n \r\n+    const currency = getCurrency();\r\n+    \r\n     if (currentSaleItems.length === 0) {\r\n         container.innerHTML = `<div class=\"text-center py-5 empty-cart-msg\"><p class=\"text-muted\">No items in cart</p></div>`;\r\n-        subtotalEl.textContent = 'P0.00';\r\n-        taxEl.textContent      = 'P0.00';\r\n-        totalEl.textContent    = 'P0.00';\r\n+        subtotalEl.textContent = `${currency}0.00`;\r\n+        taxEl.textContent      = `${currency}0.00`;\r\n+        totalEl.textContent    = `${currency}0.00`;\r\n         cartCountEl.textContent = '0';\r\n         checkoutBtn.disabled   = true;\r\n         return;\r\n     }\r\n \r\n-    const { subtotal, discountAmount, taxes, total } = calcTotals();\r\n+    const { subtotal, discountAmount, taxes, total, taxRate } = calcTotals();\r\n     const itemsCount = currentSaleItems.reduce((acc, item) => acc + item.quantity, 0);\r\n \r\n     container.innerHTML = currentSaleItems.map((item, index) => `\r\n         <div class=\"cart-item\">\r\n             <div class=\"cart-item-details\">\r\n                 <span class=\"cart-item-name\">${item.name}</span>\r\n-                <span class=\"cart-item-price\">P${(item.price * item.quantity).toFixed(2)}</span>\r\n+                <span class=\"cart-item-price\">${currency}${(item.price * item.quantity).toFixed(2)}</span>\r\n             </div>\r\n             <div class=\"qty-controls\">\r\n                 <button class=\"btn-qty\" onclick=\"changeQty(${index}, -1)\"><i class=\"fas fa-minus\"></i></button>\r\n                 <span class=\"fw-bold mx-1\">${item.quantity}</span>\r\n@@ -533,14 +743,18 @@\n             </div>\r\n         </div>`\r\n     ).join('');\r\n \r\n-    subtotalEl.innerHTML = `P${subtotal.toFixed(2)}` +\r\n-        (discountAmount > 0 ? ` <span class=\"text-danger small\">(-P${discountAmount.toFixed(2)})</span>` : '');\r\n-    taxEl.textContent       = `P${taxes.toFixed(2)}`;\r\n-    totalEl.textContent     = `P${total.toFixed(2)}`;\r\n+    subtotalEl.innerHTML = `${currency}${subtotal.toFixed(2)}` +\r\n+        (discountAmount > 0 ? ` <span class=\"text-danger small\">(-${currency}${discountAmount.toFixed(2)})</span>` : '');\r\n+    taxEl.textContent       = `${currency}${taxes.toFixed(2)}`;\r\n+    totalEl.textContent     = `${currency}${total.toFixed(2)}`;\r\n     cartCountEl.textContent = itemsCount;\r\n     checkoutBtn.disabled    = false;\r\n+    \r\n+    // Update tax label with current rate\r\n+    const taxLabel = document.querySelector('#cartTaxes')?.closest('.d-flex')?.querySelector('.text-muted');\r\n+    if (taxLabel) taxLabel.textContent = `Taxes (${taxRate}%)`;\r\n }\r\n \r\n function changeQty(index, delta) {\r\n     currentSaleItems[index].quantity += delta;\r\n@@ -557,54 +771,386 @@\n     currentSaleItems = [];\r\n     currentCustomer  = null;\r\n     currentDiscount  = 0;\r\n     currentCoupon    = null;\r\n+    currentOrderType = 'walk-in';\r\n+    \r\n+    // Reset order type toggle\r\n+    const walkInRadio = document.getElementById('orderTypeWalkIn');\r\n+    if (walkInRadio) walkInRadio.checked = true;\r\n+    \r\n     updateSaleDisplay();\r\n }\r\n \r\n function processCheckout() {\r\n     if (currentSaleItems.length === 0) return;\r\n \r\n+    const { subtotal, discountAmount, taxes, total } = calcTotals();\r\n+\r\n     Swal.fire({\r\n         title: 'Confirm Checkout',\r\n-        text: `Total Amount: ${document.getElementById('cartTotal').textContent}`,\r\n+        html: `\r\n+            <div class=\"text-start\">\r\n+                <p><strong>Customer:</strong> ${currentCustomer || 'Walk-in Customer'}</p>\r\n+                <p><strong>Order Type:</strong> ${currentOrderType === 'dine-in' ? 'Dine-in' : 'Walk-in'}</p>\r\n+                <p><strong>Items:</strong> ${currentSaleItems.length}</p>\r\n+                <hr>\r\n+                <p class=\"h4 text-center\"><strong>Total: ${getCurrency()}${total.toFixed(2)}</strong></p>\r\n+            </div>\r\n+        `,\r\n         icon: 'question',\r\n         showCancelButton: true,\r\n         confirmButtonColor: '#800000',\r\n         cancelButtonColor: '#6c757d',\r\n-        confirmButtonText: 'Confirm'\r\n+        confirmButtonText: 'Confirm & Complete'\r\n     }).then(result => {\r\n         if (result.isConfirmed) recordSale();\r\n     });\r\n }\r\n \r\n-function recordSale() {\r\n-    const { subtotal, discountAmount, taxes, total } = calcTotals();\r\n+async function recordSale() {\r\n+    const { subtotal, discountAmount, taxes, total, taxRate } = calcTotals();\r\n+    const staffUser = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n+    const receiptNo = 'SALE-' + Date.now();\r\n \r\n-    const newSale = {\r\n-        id: 'SALE-' + Date.now(),\r\n-        date: new Date().toISOString().split('T')[0],\r\n-        time: new Date().toLocaleTimeString(),\r\n-        timestamp: Date.now(),\r\n-        items: [...currentSaleItems],\r\n-        subtotal,\r\n-        discount: discountAmount,\r\n-        taxes,\r\n-        total,\r\n-        customer: currentCustomer || 'Walk-in',\r\n-        staff: JSON.parse(localStorage.getItem('loggedInUser') || '{}').full_name || 'Staff'\r\n-    };\r\n+    showLoadingModal('Processing transaction...');\r\n \r\n-    const sales = JSON.parse(localStorage.getItem('sales') || '[]');\r\n-    sales.unshift(newSale);\r\n-    localStorage.setItem('sales', JSON.stringify(sales));\r\n+    try {\r\n+        // Create sale record in database\r\n+        const saleData = {\r\n+            receipt_no: receiptNo,\r\n+            sale_datetime: new Date().toISOString(),\r\n+            staff_id: staffUser.id || null,\r\n+            total_items: currentSaleItems.reduce((acc, item) => acc + item.quantity, 0),\r\n+            total_amount: total,\r\n+            subtotal: subtotal,\r\n+            discount_amount: discountAmount,\r\n+            discount_percent: currentDiscount,\r\n+            coupon_code: currentCoupon?.code || null,\r\n+            coupon_value: currentCoupon?.value || 0,\r\n+            taxes: taxes,\r\n+            customer_name: currentCustomer || 'Walk-in Customer',\r\n+            order_type: currentOrderType,\r\n+            status: 'completed',\r\n+            created_at: new Date().toISOString()\r\n+        };\r\n \r\n-    logStaffActivity('Recorded Sale', `${newSale.id} - Total: P${total.toFixed(2)} - Customer: ${newSale.customer}`, 'Success');\r\n+        const saleResult = await salesDB.add(saleData);\r\n+        \r\n+        if (saleResult.error) {\r\n+            hideLoadingModal();\r\n+            Swal.fire('Error', saleResult.error, 'error');\r\n+            return;\r\n+        }\r\n \r\n-    Swal.fire('Success!', 'Transaction recorded.', 'success');\r\n-    clearCurrentSale();\r\n+        // Get the sale ID from result\r\n+        const saleId = saleResult.id || saleResult[0]?.id;\r\n+\r\n+        // Save sale items if we have a sale ID\r\n+        if (saleId) {\r\n+            for (const item of currentSaleItems) {\r\n+                const itemCategory = allMenuItems.find(m => m.id === item.id)?.category || 'Uncategorized';\r\n+                await saleItemsDB.add({\r\n+                    sale_id: saleId,\r\n+                    menu_item_id: item.id,\r\n+                    quantity: item.quantity,\r\n+                    unit_price: item.price,\r\n+                    item_name: item.name,\r\n+                    category_name: itemCategory\r\n+                });\r\n+            }\r\n+\r\n+            // Deduct ingredients from inventory based on recipes\r\n+            await deductIngredients(currentSaleItems);\r\n+        }\r\n+\r\n+        hideLoadingModal();\r\n+\r\n+        logStaffActivity('Recorded Sale', `${receiptNo} - Total: ${getCurrency()}${total.toFixed(2)} - Customer: ${saleData.customer_name}`, 'Success');\r\n+\r\n+        // Show receipt modal with print option\r\n+        showReceiptModal({\r\n+            receiptNo,\r\n+            saleDateTime: new Date().toLocaleString(),\r\n+            customer: currentCustomer || 'Walk-in Customer',\r\n+            orderType: currentOrderType,\r\n+            items: [...currentSaleItems],\r\n+            subtotal,\r\n+            discountAmount,\r\n+            taxes,\r\n+            total,\r\n+            taxRate,\r\n+            staff: staffUser.full_name || 'Staff'\r\n+        });\r\n+\r\n+    } catch (err) {\r\n+        hideLoadingModal();\r\n+        console.error('Failed to record sale:', err);\r\n+        Swal.fire('Error', 'Failed to process transaction. Please try again.', 'error');\r\n+    }\r\n }\r\n \r\n+// Deduct ingredients from inventory based on recipes\r\n+async function deductIngredients(saleItems) {\r\n+    try {\r\n+        for (const item of saleItems) {\r\n+            // Get recipes for this menu item\r\n+            const recipes = await recipesDB.show({ menu_item_id: item.id });\r\n+            \r\n+            for (const recipe of recipes) {\r\n+                const ingredient = allIngredients.find(i => i.id === recipe.ingredient_id);\r\n+                if (!ingredient) continue;\r\n+\r\n+                const deductQty = (parseFloat(recipe.qty_per_sale) || 0) * item.quantity;\r\n+                const newQty = Math.max(0, ingredient.quantity - deductQty);\r\n+\r\n+                // Update ingredient quantity\r\n+                await ingredientsDB.edit({\r\n+                    id: recipe.ingredient_id,\r\n+                    current_quantity: newQty,\r\n+                    updated_at: new Date().toISOString()\r\n+                });\r\n+\r\n+                // Log inventory transaction\r\n+                const staffUser = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n+                await inventoryTransactionsDB.add({\r\n+                    ingredient_id: recipe.ingredient_id,\r\n+                    change_qty: -deductQty,\r\n+                    transaction_type: 'Sale Deduction',\r\n+                    reason: `Sold ${item.quantity}x ${item.name}`,\r\n+                    performed_by: staffUser.id || null,\r\n+                    prev_qty: ingredient.quantity,\r\n+                    new_qty: newQty,\r\n+                    timestamp: new Date().toISOString()\r\n+                });\r\n+            }\r\n+        }\r\n+    } catch (err) {\r\n+        console.error('Failed to deduct ingredients:', err);\r\n+    }\r\n+}\r\n+\r\n+// Show receipt modal with print option\r\n+function showReceiptModal(receiptData) {\r\n+    const { receiptNo, saleDateTime, customer, orderType, items, subtotal, discountAmount, taxes, total, staff, taxRate } = receiptData;\r\n+    const currency = getCurrency();\r\n+    const displayTaxRate = taxRate || getTaxRate();\r\n+\r\n+    // Build items list HTML\r\n+    let itemsHtml = items.map(item => {\r\n+        const itemCategory = allMenuItems.find(m => m.id === item.id)?.category || '';\r\n+        return `\r\n+            <tr>\r\n+                <td>${item.name}<br><small class=\"text-muted\">${itemCategory}</small></td>\r\n+                <td class=\"text-center\">${item.quantity}</td>\r\n+                <td class=\"text-end\">${currency}${(item.price * item.quantity).toFixed(2)}</td>\r\n+            </tr>\r\n+        `;\r\n+    }).join('');\r\n+\r\n+    const receiptHtml = `\r\n+        <div id=\"receiptContent\" style=\"font-family: 'Courier New', monospace; max-width: 300px; margin: 0 auto; padding: 15px; border: 1px dashed #000;\">\r\n+            <div class=\"text-center mb-3\">\r\n+                <h5 class=\"mb-1\"><strong>ETHAN'S CAFE</strong></h5>\r\n+                <small>Receipt #${receiptNo}</small><br>\r\n+                <small>${saleDateTime}</small>\r\n+            </div>\r\n+            \r\n+            <div class=\"mb-2\">\r\n+                <small><strong>Customer:</strong> ${customer}</small><br>\r\n+                <small><strong>Order Type:</strong> ${orderType === 'dine-in' ? 'Dine-in' : 'Walk-in'}</small><br>\r\n+                <small><strong>Staff:</strong> ${staff}</small>\r\n+            </div>\r\n+            \r\n+            <hr style=\"border-style: dashed;\">\r\n+            \r\n+            <table class=\"w-100\" style=\"font-size: 0.85rem;\">\r\n+                <thead>\r\n+                    <tr>\r\n+                        <th class=\"text-start\">Item</th>\r\n+                        <th class=\"text-center\">Qty</th>\r\n+                        <th class=\"text-end\">Amount</th>\r\n+                    </tr>\r\n+                </thead>\r\n+                <tbody>\r\n+                    ${itemsHtml}\r\n+                </tbody>\r\n+            </table>\r\n+            \r\n+            <hr style=\"border-style: dashed;\">\r\n+            \r\n+            <div style=\"font-size: 0.85rem;\">\r\n+                <div class=\"d-flex justify-content-between\">\r\n+                    <span>Subtotal:</span>\r\n+                    <span>${currency}${subtotal.toFixed(2)}</span>\r\n+                </div>\r\n+                ${discountAmount > 0 ? `\r\n+                <div class=\"d-flex justify-content-between text-danger\">\r\n+                    <span>Discount:</span>\r\n+                    <span>-${currency}${discountAmount.toFixed(2)}</span>\r\n+                </div>` : ''}\r\n+                <div class=\"d-flex justify-content-between\">\r\n+                    <span>Tax (${displayTaxRate}%):</span>\r\n+                    <span>${currency}${taxes.toFixed(2)}</span>\r\n+                </div>\r\n+                <hr style=\"border-style: dashed;\">\r\n+                <div class=\"d-flex justify-content-between fw-bold\" style=\"font-size: 1.1rem;\">\r\n+                    <span>TOTAL:</span>\r\n+                    <span>${currency}${total.toFixed(2)}</span>\r\n+                </div>\r\n+            </div>\r\n+            \r\n+            <div class=\"text-center mt-3\" style=\"border-top: 2px dashed #000; border-bottom: 2px dashed #000; padding: 8px 0; margin: 10px 0;\">\r\n+                <strong>‚úÇ - - - CUT HERE - - - ‚úÇ</strong>\r\n+            </div>\r\n+            \r\n+            <div class=\"text-center\" style=\"font-size: 0.75rem;\">\r\n+                <p class=\"mb-1\"><strong>KITCHEN COPY</strong></p>\r\n+                <p class=\"mb-1\">Order #${receiptNo.replace('SALE-', '')}</p>\r\n+                <p class=\"mb-0\">${orderType === 'dine-in' ? 'ü™ë DINE-IN' : 'üö∂ WALK-IN'}</p>\r\n+                ${items.map(item => `<p class=\"mb-0\">${item.quantity}x ${item.name}</p>`).join('')}\r\n+            </div>\r\n+            \r\n+            <div class=\"text-center mt-3\">\r\n+                <small>Thank you for dining with us!</small>\r\n+            </div>\r\n+        </div>\r\n+    `;\r\n+\r\n+    // Check if auto-print is enabled\r\n+    if (systemSettings.auto_print_receipt === 'true') {\r\n+        // Auto print without showing modal\r\n+        const tempDiv = document.createElement('div');\r\n+        tempDiv.innerHTML = receiptHtml;\r\n+        document.body.appendChild(tempDiv);\r\n+        printReceiptFromElement(tempDiv.querySelector('#receiptContent'));\r\n+        document.body.removeChild(tempDiv);\r\n+        \r\n+        Swal.fire({\r\n+            icon: 'success',\r\n+            title: 'Transaction Complete',\r\n+            text: 'Receipt sent to printer automatically.',\r\n+            timer: 2000,\r\n+            showConfirmButton: false\r\n+        });\r\n+        clearCurrentSale();\r\n+        return;\r\n+    }\r\n+\r\n+    Swal.fire({\r\n+        title: 'Transaction Complete',\r\n+        html: receiptHtml,\r\n+        width: '400px',\r\n+        showCancelButton: true,\r\n+        confirmButtonColor: '#800000',\r\n+        cancelButtonColor: '#6c757d',\r\n+        confirmButtonText: '<i class=\"fas fa-print me-2\"></i>Print Receipt',\r\n+        cancelButtonText: 'Close'\r\n+    }).then(result => {\r\n+        if (result.isConfirmed) {\r\n+            printReceipt();\r\n+        }\r\n+        clearCurrentSale();\r\n+    });\r\n+}\r\n+\r\n+// Print receipt function\r\n+function printReceipt() {\r\n+    const receiptContent = document.getElementById('receiptContent');\r\n+    if (!receiptContent) return;\r\n+\r\n+    const printWindow = window.open('', '_blank', 'width=400,height=600');\r\n+    printWindow.document.write(`\r\n+        <!DOCTYPE html>\r\n+        <html>\r\n+        <head>\r\n+            <title>Receipt</title>\r\n+            <style>\r\n+                body { font-family: 'Courier New', monospace; padding: 10px; margin: 0; }\r\n+                table { width: 100%; border-collapse: collapse; }\r\n+                th, td { padding: 4px 0; }\r\n+                .text-center { text-align: center; }\r\n+                .text-end { text-align: right; }\r\n+                .text-start { text-align: left; }\r\n+                .d-flex { display: flex; }\r\n+                .justify-content-between { justify-content: space-between; }\r\n+                .fw-bold { font-weight: bold; }\r\n+                .text-muted { color: #666; }\r\n+                .text-danger { color: red; }\r\n+                hr { border: none; border-top: 1px dashed #000; margin: 8px 0; }\r\n+                .mb-0 { margin-bottom: 0; }\r\n+                .mb-1 { margin-bottom: 4px; }\r\n+                .mb-2 { margin-bottom: 8px; }\r\n+                .mb-3 { margin-bottom: 12px; }\r\n+                .mt-3 { margin-top: 12px; }\r\n+                small { font-size: 0.85em; }\r\n+                @media print {\r\n+                    body { -webkit-print-color-adjust: exact; }\r\n+                }\r\n+            </style>\r\n+        </head>\r\n+        <body>\r\n+            ${receiptContent.innerHTML}\r\n+            <script>\r\n+                window.onload = function() {\r\n+                    window.print();\r\n+                    window.onafterprint = function() { window.close(); };\r\n+                };\r\n+            </script>\r\n+        </body>\r\n+        </html>\r\n+    `);\r\n+    printWindow.document.close();\r\n+}\r\n+\r\n+// Print receipt from an element (for auto-print feature)\r\n+function printReceiptFromElement(element) {\r\n+    if (!element) return;\r\n+\r\n+    const printWindow = window.open('', '_blank', 'width=400,height=600');\r\n+    printWindow.document.write(`\r\n+        <!DOCTYPE html>\r\n+        <html>\r\n+        <head>\r\n+            <title>Receipt</title>\r\n+            <style>\r\n+                body { font-family: 'Courier New', monospace; padding: 10px; margin: 0; }\r\n+                table { width: 100%; border-collapse: collapse; }\r\n+                th, td { padding: 4px 0; }\r\n+                .text-center { text-align: center; }\r\n+                .text-end { text-align: right; }\r\n+                .text-start { text-align: left; }\r\n+                .d-flex { display: flex; }\r\n+                .justify-content-between { justify-content: space-between; }\r\n+                .fw-bold { font-weight: bold; }\r\n+                .text-muted { color: #666; }\r\n+                .text-danger { color: red; }\r\n+                hr { border: none; border-top: 1px dashed #000; margin: 8px 0; }\r\n+                .mb-0 { margin-bottom: 0; }\r\n+                .mb-1 { margin-bottom: 4px; }\r\n+                .mb-2 { margin-bottom: 8px; }\r\n+                .mb-3 { margin-bottom: 12px; }\r\n+                .mt-3 { margin-top: 12px; }\r\n+                small { font-size: 0.85em; }\r\n+                @media print {\r\n+                    body { -webkit-print-color-adjust: exact; }\r\n+                }\r\n+            </style>\r\n+        </head>\r\n+        <body>\r\n+            ${element.innerHTML}\r\n+            <script>\r\n+                window.onload = function() {\r\n+                    window.print();\r\n+                    window.onafterprint = function() { window.close(); };\r\n+                };\r\n+            </script>\r\n+        </body>\r\n+        </html>\r\n+    `);\r\n+    printWindow.document.close();\r\n+}\r\n+\r\n // Sync menu when admin makes changes\r\n window.addEventListener('storage', e => {\r\n     if (e.key === 'adminMenuItems') loadMenuItems();\r\n });\r\n@@ -927,8 +1473,13 @@\n             new_qty: newQty,\r\n             timestamp: new Date().toISOString().slice(0, 19).replace('T', ' ')\r\n         });\r\n \r\n+        // Create notification for admin\r\n+        const actionType = isIncrease ? 'restock' : 'usage';\r\n+        const description = `${isIncrease ? 'Restocked' : 'Used'} ${currentEditingIngredient.name}: ${isIncrease ? '+' : '-'}${changeQty} ${currentEditingIngredient.unit} (${prevQty} ‚Üí ${newQty})`;\r\n+        await createNotification(user.id, actionType, 'ingredients', currentEditingIngredient.id, description, reason);\r\n+\r\n         // Close modal\r\n         const modalEl = document.getElementById('updateQuantityModal');\r\n         const modal = bootstrap.Modal.getInstance(modalEl);\r\n         if (modal) modal.hide();\r\n@@ -968,19 +1519,714 @@\n     displayIngredients(filtered);\r\n }\r\n \r\n // ‚îÄ‚îÄ‚îÄ Receipts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n+let allSales = [];\r\n+let currentSelectedSale = null;\r\n \r\n function initializeReceiptsFunctionality() {\r\n+    // Load system settings for refund/void rules\r\n+    loadSystemSettings();\r\n+    \r\n+    // Load receipts list (for staff-receipts.html)\r\n+    if (document.getElementById('receiptsList')) {\r\n+        loadReceiptsList();\r\n+        \r\n+        // Filter button\r\n+        document.getElementById('filterReceipts')?.addEventListener('click', filterReceipts);\r\n+        \r\n+        // Set default dates\r\n+        const dateFrom = document.getElementById('receiptDateFrom');\r\n+        const dateTo = document.getElementById('receiptDateTo');\r\n+        if (dateFrom && dateTo) {\r\n+            const today = new Date().toISOString().split('T')[0];\r\n+            dateFrom.value = today;\r\n+            dateTo.value = today;\r\n+        }\r\n+        \r\n+        // Print receipt button\r\n+        document.getElementById('printReceiptBtn')?.addEventListener('click', printReceipt);\r\n+        \r\n+        // Initialize refund/void modal (action buttons are per-row in table)\r\n+        initializeTransactionEditModal();\r\n+    }\r\n+    \r\n+    // Load recent receipts sidebar (for dashboard)\r\n     loadRecentReceipts();\r\n }\r\n \r\n+async function loadReceiptsList() {\r\n+    const container = document.getElementById('receiptsList');\r\n+    if (!container) return;\r\n+    \r\n+    container.innerHTML = `\r\n+        <div class=\"text-center py-5\">\r\n+            <div class=\"spinner-border text-maroon\" role=\"status\"></div>\r\n+            <p class=\"mt-2 text-muted\">Loading transactions...</p>\r\n+        </div>\r\n+    `;\r\n+    \r\n+    try {\r\n+        // Load from database\r\n+        const dbSales = await salesDB.show();\r\n+        const saleItems = await saleItemsDB.show();\r\n+        const menuItems = await menuItemsDB.show();\r\n+        \r\n+        // Map sale items to sales\r\n+        allSales = (Array.isArray(dbSales) ? dbSales : []).map(sale => {\r\n+            const items = saleItems.filter(si => si.sale_id === sale.id).map(si => {\r\n+                const menuItem = menuItems.find(mi => mi.id === si.menu_item_id);\r\n+                return {\r\n+                    name: menuItem?.name || si.item_name || 'Unknown Item',\r\n+                    quantity: si.quantity,\r\n+                    price: parseFloat(si.price),\r\n+                    subtotal: parseFloat(si.subtotal)\r\n+                };\r\n+            });\r\n+            \r\n+            const saleDate = new Date(sale.sale_date || sale.created_at);\r\n+            return {\r\n+                id: sale.id,\r\n+                date: saleDate.toLocaleDateString(),\r\n+                time: saleDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),\r\n+                timestamp: saleDate.getTime(),\r\n+                total: parseFloat(sale.total_amount),\r\n+                staff: sale.staff_name || 'Staff',\r\n+                items: items,\r\n+                status: sale.status || 'completed',\r\n+                adjusted_total: sale.adjusted_total ? parseFloat(sale.adjusted_total) : null,\r\n+                adjustment_reason: sale.adjustment_reason\r\n+            };\r\n+        });\r\n+        \r\n+        // Also load from localStorage as fallback\r\n+        const localSales = JSON.parse(localStorage.getItem('sales') || '[]');\r\n+        localSales.forEach(ls => {\r\n+            if (!allSales.find(s => s.id === ls.id)) {\r\n+                allSales.push(ls);\r\n+            }\r\n+        });\r\n+        \r\n+        displayReceipts(allSales);\r\n+    } catch (error) {\r\n+        console.error('Failed to load receipts:', error);\r\n+        container.innerHTML = `\r\n+            <tr>\r\n+                <td colspan=\"6\" class=\"text-center py-5 text-danger\">\r\n+                    <i class=\"fas fa-exclamation-circle fa-2x mb-2\"></i>\r\n+                    <p class=\"mb-0\">Failed to load transactions</p>\r\n+                </td>\r\n+            </tr>\r\n+        `;\r\n+    }\r\n+}\r\n+\r\n+function displayReceipts(sales) {\r\n+    const container = document.getElementById('receiptsList');\r\n+    if (!container) return;\r\n+    \r\n+    if (sales.length === 0) {\r\n+        container.innerHTML = `\r\n+            <tr>\r\n+                <td colspan=\"6\" class=\"text-center py-5\">\r\n+                    <i class=\"fas fa-receipt fa-3x text-muted mb-3\"></i>\r\n+                    <p class=\"text-muted mb-0\">No transactions found</p>\r\n+                </td>\r\n+            </tr>\r\n+        `;\r\n+        return;\r\n+    }\r\n+    \r\n+    // Sort by date descending\r\n+    const sorted = [...sales].sort((a, b) => b.timestamp - a.timestamp);\r\n+    \r\n+    container.innerHTML = sorted.map(sale => {\r\n+        let statusBadge = '<span class=\"badge bg-success\">Completed</span>';\r\n+        let rowClass = '';\r\n+        let totalClass = '';\r\n+        \r\n+        if (sale.status === 'voided') {\r\n+            statusBadge = '<span class=\"badge bg-dark\">VOIDED</span>';\r\n+            rowClass = 'table-secondary';\r\n+            totalClass = 'text-decoration-line-through text-muted';\r\n+        } else if (sale.status === 'refunded') {\r\n+            statusBadge = '<span class=\"badge bg-warning text-dark\">REFUNDED</span>';\r\n+            rowClass = 'table-warning';\r\n+            totalClass = 'text-decoration-line-through text-muted';\r\n+        } else if (sale.status === 'partial_refund') {\r\n+            statusBadge = '<span class=\"badge bg-info\">PARTIAL</span>';\r\n+            rowClass = 'table-info';\r\n+        }\r\n+        \r\n+        // Calculate display total based on status\r\n+        let displayTotal = parseFloat(sale.total) || 0;\r\n+        if (sale.status === 'voided' || sale.status === 'refunded') {\r\n+            displayTotal = 0;\r\n+        } else if (sale.status === 'partial_refund' && sale.adjusted_total !== null && sale.adjusted_total !== undefined) {\r\n+            displayTotal = parseFloat(sale.adjusted_total);\r\n+        }\r\n+        \r\n+        const itemsPreview = sale.items.slice(0, 2).map(i => i.name).join(', ') + (sale.items.length > 2 ? '...' : '');\r\n+        \r\n+        // Disable refund/void button if already processed\r\n+        const isProcessed = sale.status === 'voided' || sale.status === 'refunded';\r\n+        const actionBtnDisabled = isProcessed ? 'disabled' : '';\r\n+        const actionBtnTitle = isProcessed ? 'Already processed' : 'Refund or Void';\r\n+        \r\n+        return `\r\n+            <tr class=\"${rowClass} receipt-row\" style=\"cursor: pointer;\" data-sale-id=\"${sale.id}\">\r\n+                <td onclick=\"selectReceipt('${sale.id}')\">#${sale.id}</td>\r\n+                <td onclick=\"selectReceipt('${sale.id}')\">${sale.time}</td>\r\n+                <td onclick=\"selectReceipt('${sale.id}')\"><small>${itemsPreview}</small></td>\r\n+                <td onclick=\"selectReceipt('${sale.id}')\" class=\"fw-bold ${totalClass}\">‚Ç±${displayTotal.toFixed(2)}</td>\r\n+                <td onclick=\"selectReceipt('${sale.id}')\">${statusBadge}</td>\r\n+                <td>\r\n+                    <button class=\"btn btn-sm btn-outline-warning\" onclick=\"openRefundVoidModalById('${sale.id}')\" ${actionBtnDisabled} title=\"${actionBtnTitle}\">\r\n+                        <i class=\"fas fa-undo\"></i>\r\n+                    </button>\r\n+                </td>\r\n+            </tr>\r\n+        `;\r\n+    }).join('');\r\n+}\r\n+\r\n+function filterReceipts() {\r\n+    const dateFrom = document.getElementById('receiptDateFrom')?.value;\r\n+    const dateTo = document.getElementById('receiptDateTo')?.value;\r\n+    \r\n+    if (!dateFrom || !dateTo) {\r\n+        displayReceipts(allSales);\r\n+        return;\r\n+    }\r\n+    \r\n+    const fromDate = new Date(dateFrom);\r\n+    fromDate.setHours(0, 0, 0, 0);\r\n+    const toDate = new Date(dateTo);\r\n+    toDate.setHours(23, 59, 59, 999);\r\n+    \r\n+    const filtered = allSales.filter(sale => {\r\n+        const saleDate = new Date(sale.timestamp);\r\n+        return saleDate >= fromDate && saleDate <= toDate;\r\n+    });\r\n+    \r\n+    displayReceipts(filtered);\r\n+}\r\n+\r\n+function selectReceipt(saleId) {\r\n+    const sale = allSales.find(s => String(s.id) === String(saleId));\r\n+    if (!sale) return;\r\n+    \r\n+    currentSelectedSale = sale;\r\n+    \r\n+    // Render receipt preview\r\n+    const preview = document.getElementById('receiptPreview');\r\n+    if (preview) {\r\n+        let statusText = '';\r\n+        if (sale.status === 'voided') {\r\n+            statusText = '<div class=\"text-center text-danger fw-bold mb-2\">*** VOIDED ***</div>';\r\n+        } else if (sale.status === 'refunded') {\r\n+            statusText = '<div class=\"text-center text-warning fw-bold mb-2\">*** REFUNDED ***</div>';\r\n+        } else if (sale.status === 'partial_refund') {\r\n+            statusText = '<div class=\"text-center text-info fw-bold mb-2\">*** PARTIAL REFUND ***</div>';\r\n+        }\r\n+        \r\n+        const itemsHtml = sale.items.map(item => {\r\n+            const subtotal = parseFloat(item.subtotal) || (parseFloat(item.price) * (item.quantity || 1)) || 0;\r\n+            return `\r\n+                <div class=\"d-flex justify-content-between\">\r\n+                    <span>${item.name || 'Unknown'} x${item.quantity || 1}</span>\r\n+                    <span>‚Ç±${subtotal.toFixed(2)}</span>\r\n+                </div>\r\n+            `;\r\n+        }).join('');\r\n+        \r\n+        // Calculate display total based on status\r\n+        const originalTotal = parseFloat(sale.total) || 0;\r\n+        let displayTotal = originalTotal;\r\n+        if (sale.status === 'voided' || sale.status === 'refunded') {\r\n+            displayTotal = 0;\r\n+        } else if (sale.status === 'partial_refund' && sale.adjusted_total !== null && sale.adjusted_total !== undefined) {\r\n+            displayTotal = parseFloat(sale.adjusted_total);\r\n+        }\r\n+        \r\n+        // Calculate refund amount for partial\r\n+        const refundedAmount = originalTotal - displayTotal;\r\n+        \r\n+        preview.innerHTML = `\r\n+            <div class=\"text-center mb-3\">\r\n+                <strong>ETHAN'S CAFE</strong><br>\r\n+                <small>Receipt #${sale.id}</small>\r\n+            </div>\r\n+            ${statusText}\r\n+            <hr class=\"my-2\">\r\n+            <small class=\"text-muted\">${sale.date} ${sale.time}</small>\r\n+            <hr class=\"my-2\">\r\n+            ${itemsHtml}\r\n+            <hr class=\"my-2\">\r\n+            ${sale.status === 'partial_refund' ? `\r\n+                <div class=\"d-flex justify-content-between text-muted\">\r\n+                    <span>Original Total</span>\r\n+                    <span>‚Ç±${originalTotal.toFixed(2)}</span>\r\n+                </div>\r\n+                <div class=\"d-flex justify-content-between text-danger\">\r\n+                    <span>Refunded</span>\r\n+                    <span>-‚Ç±${refundedAmount.toFixed(2)}</span>\r\n+                </div>\r\n+            ` : ''}\r\n+            <div class=\"d-flex justify-content-between fw-bold ${sale.status === 'voided' || sale.status === 'refunded' ? 'text-decoration-line-through text-muted' : ''}\">\r\n+                <span>${sale.status === 'partial_refund' ? 'ADJUSTED TOTAL' : 'TOTAL'}</span>\r\n+                <span>‚Ç±${displayTotal.toFixed(2)}</span>\r\n+            </div>\r\n+            ${sale.adjustment_reason ? '<div class=\"mt-2 small text-muted\"><strong>Reason:</strong> ' + sale.adjustment_reason + '</div>' : ''}\r\n+            <hr class=\"my-2\">\r\n+            <div class=\"text-center small\">\r\n+                <span>Staff: ${sale.staff}</span>\r\n+            </div>\r\n+        `;\r\n+    }\r\n+    \r\n+    // Enable action buttons\r\n+    document.getElementById('printReceiptBtn')?.removeAttribute('disabled');\r\n+    document.getElementById('newSaleFromReceiptBtn')?.removeAttribute('disabled');\r\n+    \r\n+    // Highlight selected row in table\r\n+    document.querySelectorAll('#receiptsList tr.receipt-row').forEach(row => {\r\n+        row.classList.remove('table-primary');\r\n+        if (row.dataset.saleId === String(saleId)) {\r\n+            row.classList.add('table-primary');\r\n+        }\r\n+    });\r\n+}\r\n+\r\n+/**\r\n+ * Open refund/void modal by sale ID (called from table action button)\r\n+ */\r\n+function openRefundVoidModalById(saleId) {\r\n+    const sale = allSales.find(s => String(s.id) === String(saleId));\r\n+    if (!sale) {\r\n+        showModalNotification('Transaction not found', 'error', 'Error');\r\n+        return;\r\n+    }\r\n+    \r\n+    currentSelectedSale = sale;\r\n+    openRefundVoidModal();\r\n+}\r\n+\r\n+function printReceipt() {\r\n+    if (!currentSelectedSale) return;\r\n+    \r\n+    const sale = currentSelectedSale;\r\n+    const originalTotal = parseFloat(sale.total) || 0;\r\n+    \r\n+    // Calculate display total based on status\r\n+    let displayTotal = originalTotal;\r\n+    if (sale.status === 'voided' || sale.status === 'refunded') {\r\n+        displayTotal = 0;\r\n+    } else if (sale.status === 'partial_refund' && sale.adjusted_total !== null && sale.adjusted_total !== undefined) {\r\n+        displayTotal = parseFloat(sale.adjusted_total);\r\n+    }\r\n+    \r\n+    const itemsHtml = sale.items.map(item => {\r\n+        const subtotal = parseFloat(item.subtotal) || (parseFloat(item.price) * (item.quantity || 1)) || 0;\r\n+        return `\r\n+            <tr>\r\n+                <td>${item.name || 'Unknown'}</td>\r\n+                <td class=\"text-center\">${item.quantity || 1}</td>\r\n+                <td class=\"text-end\">‚Ç±${subtotal.toFixed(2)}</td>\r\n+            </tr>\r\n+        `;\r\n+    }).join('');\r\n+    \r\n+    const printWindow = window.open('', '_blank', 'width=400,height=600');\r\n+    printWindow.document.write(`\r\n+        <!DOCTYPE html>\r\n+        <html>\r\n+        <head>\r\n+            <title>Receipt #${sale.id}</title>\r\n+            <style>\r\n+                body { font-family: 'Courier New', monospace; font-size: 12px; max-width: 300px; margin: 0 auto; padding: 20px; }\r\n+                .header { text-align: center; margin-bottom: 15px; }\r\n+                .divider { border-top: 1px dashed #000; margin: 10px 0; }\r\n+                table { width: 100%; }\r\n+                .total { font-weight: bold; font-size: 14px; }\r\n+                .voided { text-decoration: line-through; color: #999; }\r\n+                .status { text-align: center; font-weight: bold; margin: 10px 0; }\r\n+                .status.voided { color: red; }\r\n+                .status.refunded { color: orange; }\r\n+            </style>\r\n+        </head>\r\n+        <body>\r\n+            <div class=\"header\">\r\n+                <strong>ETHAN'S CAFE</strong><br>\r\n+                <small>Receipt #${sale.id}</small><br>\r\n+                <small>${sale.date} ${sale.time}</small>\r\n+            </div>\r\n+            ${sale.status === 'voided' ? '<div class=\"status voided\">*** VOIDED ***</div>' : ''}\r\n+            ${sale.status === 'refunded' ? '<div class=\"status refunded\">*** REFUNDED ***</div>' : ''}\r\n+            ${sale.status === 'partial_refund' ? '<div class=\"status refunded\">*** PARTIAL REFUND ***</div>' : ''}\r\n+            <div class=\"divider\"></div>\r\n+            <table>\r\n+                <tbody>${itemsHtml}</tbody>\r\n+            </table>\r\n+            <div class=\"divider\"></div>\r\n+            <table>\r\n+                <tr class=\"total ${sale.status === 'voided' ? 'voided' : ''}\">\r\n+                    <td>TOTAL</td>\r\n+                    <td class=\"text-end\">‚Ç±${displayTotal.toFixed(2)}</td>\r\n+                </tr>\r\n+            </table>\r\n+            <div class=\"divider\"></div>\r\n+            <div style=\"text-align: center;\">\r\n+                <small>Staff: ${sale.staff}</small><br>\r\n+                <small>Thank you for visiting!</small>\r\n+            </div>\r\n+        </body>\r\n+        </html>\r\n+    `);\r\n+    printWindow.document.close();\r\n+    printWindow.print();\r\n+}\r\n+\r\n function loadRecentReceipts() {\r\n     const container = document.getElementById('recentReceipts');\r\n     if (!container) return;\r\n     container.innerHTML = '<a href=\"#\" class=\"list-group-item list-group-item-action\">No recent receipts</a>';\r\n }\r\n \r\n+/**\r\n+ * Open refund/void modal for the selected transaction\r\n+ */\r\n+function openRefundVoidModal() {\r\n+    if (!currentSelectedSale) {\r\n+        showModalNotification('Please select a transaction first', 'warning', 'No Selection');\r\n+        return;\r\n+    }\r\n+    \r\n+    const sale = currentSelectedSale;\r\n+    const total = parseFloat(sale.total) || 0;\r\n+\r\n+    // Check refund time limit\r\n+    const refundTimeLimitHours = parseInt(systemSettings.refund_time_limit_hours) || 24;\r\n+    const saleDateTime = new Date(sale.sale_datetime || sale.date + ' ' + sale.time);\r\n+    const hoursSinceSale = (Date.now() - saleDateTime.getTime()) / (1000 * 60 * 60);\r\n+    \r\n+    if (hoursSinceSale > refundTimeLimitHours && sale.status === 'completed') {\r\n+        Swal.fire({\r\n+            icon: 'warning',\r\n+            title: 'Refund Time Expired',\r\n+            html: `This transaction is older than ${refundTimeLimitHours} hours.<br>Refunds are no longer allowed.<br><br><small class=\"text-muted\">Contact admin to adjust this limit.</small>`\r\n+        });\r\n+        return;\r\n+    }\r\n+\r\n+    // Hide partial refund option if disabled in settings\r\n+    const partialRefundOption = document.querySelector('#txnActionType option[value=\"partial_refund\"]');\r\n+    if (partialRefundOption) {\r\n+        partialRefundOption.style.display = systemSettings.allow_partial_refund === 'false' ? 'none' : '';\r\n+    }\r\n+    \r\n+    // Populate modal fields\r\n+    document.getElementById('editTransactionId').value = sale.id;\r\n+    document.getElementById('txnReference').value = sale.id;\r\n+    document.getElementById('txnOriginalTotal').value = `‚Ç±${total.toFixed(2)}`;\r\n+    document.getElementById('txnDateTime').value = `${sale.date} ${sale.time}`;\r\n+    document.getElementById('txnStaff').value = sale.staff;\r\n+    \r\n+    // Populate items list (without checkboxes initially)\r\n+    renderTransactionItems(sale.items, false);\r\n+    \r\n+    // Reset form fields\r\n+    document.getElementById('txnActionType').value = '';\r\n+    document.getElementById('txnAdjustedTotal').value = '';\r\n+    document.getElementById('txnAdjustmentReason').value = '';\r\n+    document.getElementById('adjustedTotalContainer').classList.add('d-none');\r\n+    document.getElementById('selectAllHeader')?.classList.add('d-none');\r\n+    document.getElementById('itemSelectionHint')?.style.setProperty('display', 'none');\r\n+    document.getElementById('refundSummaryAlert')?.classList.add('d-none');\r\n+    \r\n+    // Show current status if exists\r\n+    const statusAlert = document.getElementById('txnCurrentStatusAlert');\r\n+    const statusText = document.getElementById('txnCurrentStatusText');\r\n+    if (sale.status && sale.status !== 'completed') {\r\n+        statusAlert.classList.remove('d-none');\r\n+        let statusMsg = '';\r\n+        const adjTotal = parseFloat(sale.adjusted_total) || 0;\r\n+        if (sale.status === 'voided') {\r\n+            statusMsg = `This transaction was VOIDED. Reason: ${sale.adjustment_reason || 'N/A'}`;\r\n+        } else if (sale.status === 'refunded') {\r\n+            statusMsg = `This transaction was REFUNDED. Reason: ${sale.adjustment_reason || 'N/A'}`;\r\n+        } else if (sale.status === 'partial_refund') {\r\n+            statusMsg = `Partial refund applied. Adjusted total: ‚Ç±${adjTotal.toFixed(2)}. Reason: ${sale.adjustment_reason || 'N/A'}`;\r\n+        }\r\n+        statusText.textContent = statusMsg;\r\n+    } else {\r\n+        statusAlert.classList.add('d-none');\r\n+    }\r\n+    \r\n+    // Show modal\r\n+    const modal = new bootstrap.Modal(document.getElementById('transactionEditModal'));\r\n+    modal.show();\r\n+}\r\n+\r\n+/**\r\n+ * Render transaction items in modal table\r\n+ */\r\n+function renderTransactionItems(items, showCheckboxes = false) {\r\n+    const itemsBody = document.getElementById('txnItemsList');\r\n+    const selectAllHeader = document.getElementById('selectAllHeader');\r\n+    \r\n+    if (showCheckboxes) {\r\n+        selectAllHeader?.classList.remove('d-none');\r\n+    } else {\r\n+        selectAllHeader?.classList.add('d-none');\r\n+    }\r\n+    \r\n+    itemsBody.innerHTML = items.map((item, index) => {\r\n+        const price = parseFloat(item.price) || 0;\r\n+        const subtotal = parseFloat(item.subtotal) || (price * (item.quantity || 1));\r\n+        \r\n+        return `\r\n+            <tr>\r\n+                ${showCheckboxes ? `\r\n+                <td class=\"text-center\">\r\n+                    <input type=\"checkbox\" class=\"form-check-input refund-item-check\" \r\n+                           data-index=\"${index}\" \r\n+                           data-subtotal=\"${subtotal}\"\r\n+                           onchange=\"calculateRefundTotal()\">\r\n+                </td>\r\n+                ` : ''}\r\n+                <td>${item.name || 'Unknown'}</td>\r\n+                <td>${item.quantity || 1}</td>\r\n+                <td>‚Ç±${price.toFixed(2)}</td>\r\n+                <td>‚Ç±${subtotal.toFixed(2)}</td>\r\n+            </tr>\r\n+        `;\r\n+    }).join('');\r\n+}\r\n+\r\n+/**\r\n+ * Calculate refund total from selected items\r\n+ */\r\n+function calculateRefundTotal() {\r\n+    const checkboxes = document.querySelectorAll('.refund-item-check:checked');\r\n+    let total = 0;\r\n+    \r\n+    checkboxes.forEach(cb => {\r\n+        total += parseFloat(cb.dataset.subtotal) || 0;\r\n+    });\r\n+    \r\n+    document.getElementById('calculatedRefundAmount').textContent = `‚Ç±${total.toFixed(2)}`;\r\n+    document.getElementById('txnAdjustedTotal').value = total.toFixed(2);\r\n+    \r\n+    // Update select all checkbox state\r\n+    const allCheckboxes = document.querySelectorAll('.refund-item-check');\r\n+    const selectAll = document.getElementById('selectAllItems');\r\n+    if (selectAll) {\r\n+        selectAll.checked = checkboxes.length === allCheckboxes.length && allCheckboxes.length > 0;\r\n+        selectAll.indeterminate = checkboxes.length > 0 && checkboxes.length < allCheckboxes.length;\r\n+    }\r\n+}\r\n+\r\n+/**\r\n+ * Initialize transaction edit modal events\r\n+ */\r\n+function initializeTransactionEditModal() {\r\n+    // Action type change handler\r\n+    const actionType = document.getElementById('txnActionType');\r\n+    if (actionType) {\r\n+        actionType.addEventListener('change', function() {\r\n+            const adjustedContainer = document.getElementById('adjustedTotalContainer');\r\n+            const refundSummary = document.getElementById('refundSummaryAlert');\r\n+            const itemHint = document.getElementById('itemSelectionHint');\r\n+            \r\n+            if (this.value === 'partial_refund') {\r\n+                // Show checkboxes for item selection\r\n+                adjustedContainer?.classList.remove('d-none');\r\n+                refundSummary?.classList.remove('d-none');\r\n+                itemHint?.style.setProperty('display', 'inline');\r\n+                \r\n+                // Re-render items with checkboxes\r\n+                if (currentSelectedSale) {\r\n+                    renderTransactionItems(currentSelectedSale.items, true);\r\n+                }\r\n+            } else {\r\n+                adjustedContainer?.classList.add('d-none');\r\n+                refundSummary?.classList.add('d-none');\r\n+                itemHint?.style.setProperty('display', 'none');\r\n+                \r\n+                // Re-render items without checkboxes\r\n+                if (currentSelectedSale) {\r\n+                    renderTransactionItems(currentSelectedSale.items, false);\r\n+                }\r\n+            }\r\n+        });\r\n+    }\r\n+    \r\n+    // Select all checkbox handler\r\n+    document.getElementById('selectAllItems')?.addEventListener('change', function() {\r\n+        const checkboxes = document.querySelectorAll('.refund-item-check');\r\n+        checkboxes.forEach(cb => cb.checked = this.checked);\r\n+        calculateRefundTotal();\r\n+    });\r\n+    \r\n+    // Save adjustment button\r\n+    const saveBtn = document.getElementById('saveTransactionAdjustment');\r\n+    if (saveBtn) {\r\n+        saveBtn.addEventListener('click', saveTransactionAdjustment);\r\n+    }\r\n+}\r\n+\r\n+/**\r\n+ * Save transaction adjustment (refund/void)\r\n+ */\r\n+async function saveTransactionAdjustment() {\r\n+    const saleId = document.getElementById('editTransactionId').value;\r\n+    const actionType = document.getElementById('txnActionType').value;\r\n+    const reason = document.getElementById('txnAdjustmentReason').value.trim();\r\n+    const refundAmount = parseFloat(document.getElementById('txnAdjustedTotal').value) || 0;\r\n+    \r\n+    // Validation\r\n+    if (!actionType) {\r\n+        Swal.fire('Error', 'Please select an action type', 'warning');\r\n+        return;\r\n+    }\r\n+    \r\n+    // Check if reason is required based on settings\r\n+    const requireReason = systemSettings.require_reason_for_void !== 'false';\r\n+    if (requireReason && !reason) {\r\n+        Swal.fire('Error', 'Please provide a reason for this adjustment', 'warning');\r\n+        return;\r\n+    }\r\n+    \r\n+    // Get selected items for partial refund\r\n+    let selectedItems = [];\r\n+    if (actionType === 'partial_refund') {\r\n+        const checkedBoxes = document.querySelectorAll('.refund-item-check:checked');\r\n+        if (checkedBoxes.length === 0) {\r\n+            Swal.fire('Error', 'Please select at least one item to refund', 'warning');\r\n+            return;\r\n+        }\r\n+        \r\n+        checkedBoxes.forEach(cb => {\r\n+            const idx = parseInt(cb.dataset.index);\r\n+            if (currentSelectedSale?.items[idx]) {\r\n+                selectedItems.push(currentSelectedSale.items[idx].name);\r\n+            }\r\n+        });\r\n+    }\r\n+    \r\n+    // Confirm action\r\n+    let confirmText = '';\r\n+    if (actionType === 'void') {\r\n+        confirmText = 'VOID this entire transaction? The total will be set to ‚Ç±0.00';\r\n+    } else if (actionType === 'refund') {\r\n+        confirmText = `Issue a FULL REFUND of ‚Ç±${currentSelectedSale?.total?.toFixed(2)}?`;\r\n+    } else {\r\n+        confirmText = `Issue a PARTIAL REFUND of ‚Ç±${refundAmount.toFixed(2)} for: ${selectedItems.join(', ')}?`;\r\n+    }\r\n+    \r\n+    const result = await Swal.fire({\r\n+        title: 'Confirm Action',\r\n+        html: `<p>${confirmText}</p><p class=\"text-muted small\">This action will be logged and notified to admin.</p>`,\r\n+        icon: 'warning',\r\n+        showCancelButton: true,\r\n+        confirmButtonColor: '#800000',\r\n+        confirmButtonText: 'Yes, proceed'\r\n+    });\r\n+    \r\n+    if (!result.isConfirmed) return;\r\n+    \r\n+    try {\r\n+        const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n+        \r\n+        // Find the sale in allSales\r\n+        const saleIndex = allSales.findIndex(s => String(s.id) === String(saleId));\r\n+        if (saleIndex === -1) {\r\n+            Swal.fire('Error', 'Transaction not found', 'error');\r\n+            return;\r\n+        }\r\n+        \r\n+        const sale = allSales[saleIndex];\r\n+        const originalTotal = parseFloat(sale.total) || 0;\r\n+        \r\n+        // Calculate adjusted total (remaining amount after refund)\r\n+        const newStatus = actionType === 'partial_refund' ? 'partial_refund' : \r\n+                          actionType === 'void' ? 'voided' : 'refunded';\r\n+        let newAdjustedTotal = 0;\r\n+        if (actionType === 'partial_refund') {\r\n+            // Adjusted total = original - refund amount (what customer keeps)\r\n+            newAdjustedTotal = originalTotal - refundAmount;\r\n+        } else if (actionType === 'void' || actionType === 'refund') {\r\n+            newAdjustedTotal = 0;\r\n+        }\r\n+        \r\n+        // Build refund description with items if partial\r\n+        let refundDetails = reason;\r\n+        if (actionType === 'partial_refund' && selectedItems.length > 0) {\r\n+            refundDetails = `${reason} | Items: ${selectedItems.join(', ')}`;\r\n+        }\r\n+        \r\n+        // Update in database\r\n+        await salesDB.edit({\r\n+            id: parseInt(saleId) || saleId,\r\n+            status: newStatus,\r\n+            adjusted_total: newAdjustedTotal,\r\n+            adjusted_by: user.id,\r\n+            adjusted_at: new Date().toISOString().slice(0, 19).replace('T', ' '),\r\n+            adjustment_reason: refundDetails\r\n+        });\r\n+        \r\n+        // Update local record\r\n+        allSales[saleIndex].status = newStatus;\r\n+        allSales[saleIndex].adjusted_total = newAdjustedTotal;\r\n+        allSales[saleIndex].adjustment_reason = refundDetails;\r\n+        \r\n+        // Update localStorage too\r\n+        const localSales = JSON.parse(localStorage.getItem('sales') || '[]');\r\n+        const localIdx = localSales.findIndex(s => String(s.id) === String(saleId));\r\n+        if (localIdx !== -1) {\r\n+            localSales[localIdx].status = newStatus;\r\n+            localSales[localIdx].adjusted_total = newAdjustedTotal;\r\n+            localSales[localIdx].adjusted_by = user.full_name || user.username;\r\n+            localSales[localIdx].adjusted_at = new Date().toISOString().slice(0, 19).replace('T', ' ');\r\n+            localSales[localIdx].adjustment_reason = refundDetails;\r\n+            localStorage.setItem('sales', JSON.stringify(localSales));\r\n+        }\r\n+        \r\n+        // Create notification for admin\r\n+        const notifDesc = actionType === 'void' ? \r\n+            `Transaction #${saleId} VOIDED. Original: ‚Ç±${originalTotal.toFixed(2)}` :\r\n+            actionType === 'refund' ?\r\n+            `Transaction #${saleId} REFUNDED. Amount: ‚Ç±${originalTotal.toFixed(2)}` :\r\n+            `Transaction #${saleId} PARTIAL REFUND of ‚Ç±${refundAmount.toFixed(2)}. Remaining: ‚Ç±${newAdjustedTotal.toFixed(2)}`;\r\n+        \r\n+        await createNotification(user.id, actionType, 'sales', saleId, notifDesc, reason);\r\n+        \r\n+        // Log activity\r\n+        logStaffActivity('sales', `${actionType.toUpperCase()}: Transaction #${saleId} - ${reason}`);\r\n+        \r\n+        // Close modal\r\n+        const modal = bootstrap.Modal.getInstance(document.getElementById('transactionEditModal'));\r\n+        if (modal) modal.hide();\r\n+        \r\n+        // Refresh display\r\n+        displayReceipts(allSales);\r\n+        selectReceipt(saleId);\r\n+        \r\n+        Swal.fire({\r\n+            icon: 'success',\r\n+            title: 'Success',\r\n+            text: `Transaction ${actionType === 'void' ? 'voided' : 'adjusted'} successfully`,\r\n+            timer: 2000,\r\n+            showConfirmButton: false\r\n+        });\r\n+        \r\n+    } catch (error) {\r\n+        console.error('Failed to save adjustment:', error);\r\n+        Swal.fire('Error', 'Failed to save adjustment: ' + error.message, 'error');\r\n+    }\r\n+}\r\n+\r\n // ‚îÄ‚îÄ‚îÄ Account ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n \r\n function initializeAccountFunctionality() {\r\n     loadAccountData();\r\n@@ -1054,29 +2300,43 @@\n         showModalNotification('Full Name is required', 'warning', 'Validation');\r\n         return;\r\n     }\r\n \r\n+    showLoadingModal('Updating account...');\r\n+\r\n     try {\r\n-        const res = await fetch(API_URL, {\r\n+        // Use dedicated profile update endpoint\r\n+        const res = await fetch('php/update_profile.php', {\r\n             method: 'POST',\r\n             headers: { 'Content-Type': 'application/json' },\r\n             body: JSON.stringify({\r\n-                table: 'requests_tbl',\r\n-                type: 'account_update',\r\n-                requester_id: user.id,\r\n-                payload: JSON.stringify({ full_name: fullName, email }),\r\n-                status: 'Pending',\r\n-                created_at: new Date().toISOString().slice(0, 19).replace('T', ' ')\r\n+                user_id: user.id,\r\n+                full_name: fullName,\r\n+                email: email\r\n             })\r\n         });\r\n         const data = await res.json();\r\n+        hideLoadingModal();\r\n+        \r\n         if (data.error) throw new Error(data.error);\r\n \r\n-        showModalNotification('Update request sent to administrator for approval.', 'success', 'Request Sent');\r\n-        logStaffActivity('Requested Account Update', `New Name: ${fullName}`, 'Pending');\r\n+        // Update localStorage with new info\r\n+        user.full_name = fullName;\r\n+        user.email = email;\r\n+        localStorage.setItem('loggedInUser', JSON.stringify(user));\r\n+\r\n+        // Update UI\r\n+        const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };\r\n+        set('profFullName', fullName);\r\n+        const headerUserName = document.querySelector('.navbar .dropdown-toggle');\r\n+        if (headerUserName) headerUserName.innerHTML = `<i class=\"fas fa-user-circle me-1\"></i>${fullName}`;\r\n+\r\n+        showModalNotification('Account updated successfully!', 'success', 'Success');\r\n+        logStaffActivity('Updated Account Info', `Name: ${fullName}`, 'Success');\r\n     } catch (err) {\r\n-        console.error('Failed to send request:', err);\r\n-        showModalNotification('Failed to send update request.', 'danger', 'Error');\r\n+        hideLoadingModal();\r\n+        console.error('Failed to update account:', err);\r\n+        showModalNotification('Failed to update account.', 'danger', 'Error');\r\n     }\r\n }\r\n \r\n async function handlePasswordUpdate() {\r\n@@ -1097,30 +2357,36 @@\n         showModalNotification('Password must be at least 6 characters', 'warning', 'Validation');\r\n         return;\r\n     }\r\n \r\n+    showLoadingModal('Changing password...');\r\n+\r\n     try {\r\n-        const res = await fetch(API_URL, {\r\n+        // Use dedicated password change endpoint\r\n+        const res = await fetch('php/change_password.php', {\r\n             method: 'POST',\r\n             headers: { 'Content-Type': 'application/json' },\r\n             body: JSON.stringify({\r\n-                table: 'requests_tbl',\r\n-                type: 'password_change',\r\n-                requester_id: user.id,\r\n-                payload: JSON.stringify({ current_password: currentPass, new_password: newPass }),\r\n-                status: 'Pending',\r\n-                created_at: new Date().toISOString().slice(0, 19).replace('T', ' ')\r\n+                user_id: user.id,\r\n+                current_password: currentPass,\r\n+                new_password: newPass\r\n             })\r\n         });\r\n         const data = await res.json();\r\n-        if (data.error) throw new Error(data.error);\r\n+        hideLoadingModal();\r\n+        \r\n+        if (data.error) {\r\n+            showModalNotification(data.error, 'danger', 'Error');\r\n+            return;\r\n+        }\r\n \r\n-        showModalNotification('Password change request sent to administrator.', 'success', 'Request Sent');\r\n-        logStaffActivity('Requested Password Change', '', 'Pending');\r\n+        showModalNotification('Password changed successfully!', 'success', 'Success');\r\n+        logStaffActivity('Changed Password', '', 'Success');\r\n         document.getElementById('changePasswordForm')?.reset();\r\n     } catch (err) {\r\n-        console.error('Failed to send request:', err);\r\n-        showModalNotification('Failed to send request.', 'danger', 'Error');\r\n+        hideLoadingModal();\r\n+        console.error('Failed to change password:', err);\r\n+        showModalNotification('Failed to change password.', 'danger', 'Error');\r\n     }\r\n }\r\n \r\n // ‚îÄ‚îÄ‚îÄ Activity Log ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n"
                },
                {
                    "date": 1772372631910,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -60,14 +60,30 @@\n             }\r\n         },\r\n         delete: async (id) => {\r\n             try {\r\n+                console.log(`[${table}] DELETE request - ID:`, id);\r\n+                const requestBody = { id, table };\r\n+                console.log(`[${table}] Request body:`, JSON.stringify(requestBody));\r\n+                \r\n                 const res = await fetch(API_URL, {\r\n                     method: \"DELETE\",\r\n                     headers: { \"Content-Type\": \"application/json\" },\r\n-                    body: JSON.stringify({ id, table })\r\n+                    body: JSON.stringify(requestBody)\r\n                 });\r\n-                return await res.json();\r\n+                \r\n+                console.log(`[${table}] Response status:`, res.status, res.statusText);\r\n+                const responseText = await res.text();\r\n+                console.log(`[${table}] Raw response:`, responseText);\r\n+                \r\n+                try {\r\n+                    const jsonResponse = JSON.parse(responseText);\r\n+                    console.log(`[${table}] Parsed response:`, jsonResponse);\r\n+                    return jsonResponse;\r\n+                } catch (parseErr) {\r\n+                    console.error(`[${table}] JSON parse error:`, parseErr);\r\n+                    return { error: 'Invalid JSON response', raw: responseText };\r\n+                }\r\n             } catch (err) {\r\n                 console.error(`Delete failed [${table}]:`, err);\r\n                 return { error: err.message };\r\n             }\r\n@@ -98,8 +114,10 @@\n let currentDiscount = 0;\r\n let currentCoupon = null;\r\n let currentOrderType = 'walk-in';\r\n let systemSettings = {};\r\n+let idleTimer = null;\r\n+let lastActivityTime = Date.now();\r\n \r\n /**\r\n  * Create a notification for admin to track staff actions\r\n  */\r\n@@ -122,16 +140,82 @@\n         console.error('Failed to create notification:', error);\r\n     }\r\n }\r\n \r\n+/**\r\n+ * Send email notification for system events\r\n+ * @param {string} eventType - Type of event (low_stock, expiring_ingredients, void_transaction, refund_transaction)\r\n+ * @param {object} eventData - Data related to the event\r\n+ */\r\n+async function sendEmailNotification(eventType, eventData) {\r\n+    // Only proceed if email notifications are enabled\r\n+    if (systemSettings.enable_email_notifications !== 'true') {\r\n+        return { success: true, sent: false, message: 'Email notifications disabled' };\r\n+    }\r\n+    \r\n+    try {\r\n+        const response = await fetch('php/send_notification.php', {\r\n+            method: 'POST',\r\n+            headers: { 'Content-Type': 'application/json' },\r\n+            body: JSON.stringify({\r\n+                event_type: eventType,\r\n+                event_data: eventData\r\n+            })\r\n+        });\r\n+        return await response.json();\r\n+    } catch (error) {\r\n+        console.error('Failed to send email notification:', error);\r\n+        return { success: false, message: error.message };\r\n+    }\r\n+}\r\n+\r\n+/**\r\n+ * Check for low stock and expiring ingredients and send notifications\r\n+ */\r\n+async function checkAndNotifyInventoryAlerts() {\r\n+    if (systemSettings.enable_email_notifications !== 'true') return;\r\n+    \r\n+    const lowStockItems = [];\r\n+    const expiringItems = [];\r\n+    \r\n+    allIngredients.forEach(ing => {\r\n+        if (ing.status === 'Low') {\r\n+            lowStockItems.push({\r\n+                name: ing.name,\r\n+                quantity: ing.quantity,\r\n+                unit: ing.unit,\r\n+                threshold: ing.minLevel\r\n+            });\r\n+        }\r\n+        if (ing.expiryStatus === 'expired' || ing.expiryStatus === 'expiring') {\r\n+            expiringItems.push({\r\n+                name: ing.name,\r\n+                status: ing.expiryStatus,\r\n+                days: Math.abs(ing.daysUntilExpiry)\r\n+            });\r\n+        }\r\n+    });\r\n+    \r\n+    // Send low stock notification if any\r\n+    if (lowStockItems.length > 0) {\r\n+        await sendEmailNotification('low_stock', { items: lowStockItems });\r\n+    }\r\n+    \r\n+    // Send expiring notification if any\r\n+    if (expiringItems.length > 0) {\r\n+        await sendEmailNotification('expiring_ingredients', { items: expiringItems });\r\n+    }\r\n+}\r\n+\r\n // DOM Ready\r\n document.addEventListener('DOMContentLoaded', function () {\r\n     if (typeof bootstrap !== 'undefined') {\r\n         const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle=\"tooltip\"]'));\r\n         tooltipTriggerList.map(el => new bootstrap.Tooltip(el));\r\n     }\r\n \r\n     initializeCommonStaffFeatures();\r\n+    initializeAutoLogout();\r\n \r\n     if (document.getElementById('menuItemsGrid'))                                       initializeMenuFunctionality();\r\n     if (document.getElementById('ingredientsListTable') || document.getElementById('ingredientsTable')) initializeIngredientsFunctionality();\r\n     if (document.getElementById('recentReceipts') || document.getElementById('receiptsList')) initializeReceiptsFunctionality();\r\n@@ -183,8 +267,169 @@\n         window.location.href = 'index.html';\r\n     });\r\n }\r\n \r\n+// ‚îÄ‚îÄ‚îÄ Auto Logout Timer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n+\r\n+/**\r\n+ * Initialize auto-logout functionality based on system settings\r\n+ */\r\n+function initializeAutoLogout() {\r\n+    // Reset activity timer on user interaction\r\n+    const activityEvents = ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart', 'click'];\r\n+    activityEvents.forEach(event => {\r\n+        document.addEventListener(event, resetIdleTimer, { passive: true });\r\n+    });\r\n+    \r\n+    // Start checking idle time after settings are loaded\r\n+    startIdleCheck();\r\n+}\r\n+\r\n+/**\r\n+ * Reset the idle timer on user activity\r\n+ */\r\n+function resetIdleTimer() {\r\n+    lastActivityTime = Date.now();\r\n+}\r\n+\r\n+/**\r\n+ * Start periodic idle check\r\n+ */\r\n+function startIdleCheck() {\r\n+    // Check every 30 seconds\r\n+    setInterval(() => {\r\n+        const autoLogoutMinutes = parseInt(systemSettings.auto_logout_minutes) || 0;\r\n+        \r\n+        // If auto logout is disabled (0 or not set), don't do anything\r\n+        if (autoLogoutMinutes <= 0) return;\r\n+        \r\n+        const idleTime = (Date.now() - lastActivityTime) / 1000 / 60; // in minutes\r\n+        const warningTime = autoLogoutMinutes - 1; // Show warning 1 minute before\r\n+        \r\n+        if (idleTime >= autoLogoutMinutes) {\r\n+            // Auto logout\r\n+            performAutoLogout();\r\n+        } else if (idleTime >= warningTime && idleTime < warningTime + 0.5) {\r\n+            // Show warning (only once in the 30 second window)\r\n+            showIdleWarning(Math.ceil((autoLogoutMinutes - idleTime) * 60));\r\n+        }\r\n+    }, 30000);\r\n+}\r\n+\r\n+/**\r\n+ * Show warning before auto logout\r\n+ */\r\n+function showIdleWarning(secondsLeft) {\r\n+    Swal.fire({\r\n+        title: 'Session Expiring',\r\n+        html: `<p>You will be logged out due to inactivity in <strong>${secondsLeft} seconds</strong>.</p><p>Move your mouse or press any key to stay logged in.</p>`,\r\n+        icon: 'warning',\r\n+        timer: 30000,\r\n+        timerProgressBar: true,\r\n+        showConfirmButton: true,\r\n+        confirmButtonText: 'Stay Logged In',\r\n+        confirmButtonColor: '#800000'\r\n+    }).then(() => {\r\n+        resetIdleTimer();\r\n+    });\r\n+}\r\n+\r\n+/**\r\n+ * Perform automatic logout due to inactivity\r\n+ */\r\n+async function performAutoLogout() {\r\n+    try {\r\n+        await fetch('php/logout.php', {\r\n+            method: 'POST',\r\n+            credentials: 'include'\r\n+        });\r\n+    } catch (err) {\r\n+        console.error('Auto logout server call failed:', err);\r\n+    }\r\n+    \r\n+    localStorage.removeItem('loggedInRole');\r\n+    localStorage.removeItem('loggedInUser');\r\n+    localStorage.removeItem('loggedInUserId');\r\n+    \r\n+    // Show message and redirect\r\n+    Swal.fire({\r\n+        title: 'Session Expired',\r\n+        text: 'You have been logged out due to inactivity.',\r\n+        icon: 'info',\r\n+        confirmButtonColor: '#800000'\r\n+    }).then(() => {\r\n+        window.location.href = 'index.html';\r\n+    });\r\n+}\r\n+\r\n+// ‚îÄ‚îÄ‚îÄ Manager Approval ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n+\r\n+/**\r\n+ * Request manager approval for sensitive operations\r\n+ * Prompts for manager PIN and validates against admin/manager accounts\r\n+ */\r\n+async function requestManagerApproval(actionDescription) {\r\n+    return new Promise(async (resolve) => {\r\n+        const result = await Swal.fire({\r\n+            title: 'Manager Approval Required',\r\n+            html: `\r\n+                <p class=\"mb-3\">A manager must authorize: <strong>${actionDescription}</strong></p>\r\n+                <div class=\"form-group\">\r\n+                    <label class=\"form-label\">Manager PIN or Password:</label>\r\n+                    <input type=\"password\" id=\"managerPinInput\" class=\"form-control\" placeholder=\"Enter manager PIN\" autocomplete=\"off\">\r\n+                </div>\r\n+            `,\r\n+            icon: 'warning',\r\n+            showCancelButton: true,\r\n+            confirmButtonColor: '#800000',\r\n+            confirmButtonText: 'Authorize',\r\n+            cancelButtonText: 'Cancel',\r\n+            preConfirm: () => {\r\n+                return document.getElementById('managerPinInput').value;\r\n+            }\r\n+        });\r\n+        \r\n+        if (!result.isConfirmed || !result.value) {\r\n+            resolve(false);\r\n+            return;\r\n+        }\r\n+        \r\n+        const pin = result.value;\r\n+        \r\n+        try {\r\n+            // Validate PIN against admin/manager accounts\r\n+            const response = await fetch('php/verify_manager_pin.php', {\r\n+                method: 'POST',\r\n+                headers: { 'Content-Type': 'application/json' },\r\n+                body: JSON.stringify({ pin: pin })\r\n+            });\r\n+            \r\n+            const data = await response.json();\r\n+            \r\n+            if (data.success) {\r\n+                // Log the manager authorization\r\n+                logStaffActivity('Manager Authorization', `${actionDescription} - Approved by ${data.manager_name}`, 'Success');\r\n+                Swal.fire({\r\n+                    icon: 'success',\r\n+                    title: 'Authorized',\r\n+                    text: `Approved by ${data.manager_name}`,\r\n+                    timer: 1500,\r\n+                    showConfirmButton: false\r\n+                });\r\n+                resolve(true);\r\n+            } else {\r\n+                Swal.fire('Invalid PIN', data.message || 'The PIN entered is not valid.', 'error');\r\n+                logStaffActivity('Manager Authorization', `${actionDescription} - FAILED`, 'Failed');\r\n+                resolve(false);\r\n+            }\r\n+        } catch (err) {\r\n+            console.error('Manager verification failed:', err);\r\n+            Swal.fire('Error', 'Failed to verify manager credentials.', 'error');\r\n+            resolve(false);\r\n+        }\r\n+    });\r\n+}\r\n+\r\n // ‚îÄ‚îÄ‚îÄ Activity Logging (single authoritative version ‚Äî async/DB) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n \r\n async function logStaffActivity(action, reference = 'N/A', status = 'Success') {\r\n     const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n@@ -221,8 +466,9 @@\n \r\n     document.getElementById('clearSaleBtn')?.addEventListener('click', () =>\r\n         showConfirm('Are you sure you want to clear the cart?', clearCurrentSale)\r\n     );\r\n+    document.getElementById('printerSetupBtn')?.addEventListener('click', showPrinterSetup);\r\n     document.getElementById('checkoutBtn')?.addEventListener('click', processCheckout);\r\n     document.getElementById('selectCustomerBtn')?.addEventListener('click', selectCustomer);\r\n     document.getElementById('discountBtn')?.addEventListener('click', applyDiscount);\r\n     document.getElementById('couponBtn')?.addEventListener('click', applyCoupon);\r\n@@ -316,8 +562,15 @@\n // Load system settings from database\r\n async function loadSystemSettings() {\r\n     try {\r\n         const settings = await systemSettingsDB.show();\r\n+        \r\n+        // Ensure settings is an array before iterating\r\n+        if (!Array.isArray(settings)) {\r\n+            console.warn('System settings response is not an array:', settings);\r\n+            return;\r\n+        }\r\n+        \r\n         settings.forEach(s => {\r\n             systemSettings[s.key] = s.value;\r\n         });\r\n \r\n@@ -841,10 +1094,10 @@\n             Swal.fire('Error', saleResult.error, 'error');\r\n             return;\r\n         }\r\n \r\n-        // Get the sale ID from result\r\n-        const saleId = saleResult.id || saleResult[0]?.id;\r\n+        // Get the sale ID from result - handle different response structures\r\n+        const saleId = saleResult.data?.[0]?.id || saleResult.id || saleResult[0]?.id;\r\n \r\n         // Save sale items if we have a sale ID\r\n         if (saleId) {\r\n             for (const item of currentSaleItems) {\r\n@@ -866,8 +1119,17 @@\n         hideLoadingModal();\r\n \r\n         logStaffActivity('Recorded Sale', `${receiptNo} - Total: ${getCurrency()}${total.toFixed(2)} - Customer: ${saleData.customer_name}`, 'Success');\r\n \r\n+        // Create notification for successful payment\r\n+        await createNotification(\r\n+            staffUser.id || 1,\r\n+            'payment',\r\n+            'sales',\r\n+            saleId,\r\n+            `Payment completed: ${receiptNo} - ${getCurrency()}${total.toFixed(2)} (${saleData.customer_name})`\r\n+        );\r\n+\r\n         // Show receipt modal with print option\r\n         showReceiptModal({\r\n             receiptNo,\r\n             saleDateTime: new Date().toLocaleString(),\r\n@@ -921,8 +1183,28 @@\n                     prev_qty: ingredient.quantity,\r\n                     new_qty: newQty,\r\n                     timestamp: new Date().toISOString()\r\n                 });\r\n+\r\n+                // Check for low stock and create notification\r\n+                const threshold = parseFloat(ingredient.low_stock_threshold) || 0;\r\n+                if (newQty <= threshold && newQty > 0) {\r\n+                    await createNotification(\r\n+                        staffUser.id || 1,\r\n+                        'low_stock',\r\n+                        'ingredients',\r\n+                        recipe.ingredient_id,\r\n+                        `Low stock alert: ${ingredient.name} is at ${newQty} ${ingredient.unit || 'units'} (threshold: ${threshold})`\r\n+                    );\r\n+                } else if (newQty === 0) {\r\n+                    await createNotification(\r\n+                        staffUser.id || 1,\r\n+                        'out_of_stock',\r\n+                        'ingredients',\r\n+                        recipe.ingredient_id,\r\n+                        `Out of stock: ${ingredient.name} is now depleted!`\r\n+                    );\r\n+                }\r\n             }\r\n         }\r\n     } catch (err) {\r\n         console.error('Failed to deduct ingredients:', err);\r\n@@ -1052,105 +1334,411 @@\n         clearCurrentSale();\r\n     });\r\n }\r\n \r\n-// Print receipt function\r\n+// ‚îÄ‚îÄ‚îÄ Printer Detection & Print Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n+\r\n+/**\r\n+ * Check if printing is available\r\n+ * Note: Browser APIs cannot detect specific printers or paper status\r\n+ * For thermal printers, you would need a local print server or desktop app\r\n+ */\r\n+async function checkPrinterStatus() {\r\n+    // Check if print API is available\r\n+    if (!window.print) {\r\n+        return { available: false, message: 'Printing not supported in this browser' };\r\n+    }\r\n+    \r\n+    // Check for any connected printers using experimental API (Chrome only)\r\n+    // Note: This requires user gesture and may not be available in all browsers\r\n+    try {\r\n+        // Try to get printer info using the experimental API\r\n+        if ('queryLocalFonts' in window) {\r\n+            // Browser supports some advanced APIs, likely has print support\r\n+        }\r\n+    } catch (e) {\r\n+        console.log('Cannot detect printers:', e);\r\n+    }\r\n+    \r\n+    return { available: true, message: 'Print ready' };\r\n+}\r\n+\r\n+/**\r\n+ * Print receipt using inline printing (most reliable method)\r\n+ * Opens Chrome's native print dialog with status feedback\r\n+ */\r\n function printReceipt() {\r\n     const receiptContent = document.getElementById('receiptContent');\r\n-    if (!receiptContent) return;\r\n+    if (!receiptContent) {\r\n+        Swal.fire({\r\n+            icon: 'error',\r\n+            title: 'No Receipt',\r\n+            text: 'No receipt content found to print.',\r\n+            confirmButtonColor: '#800000'\r\n+        }).then(() => {\r\n+            window.location.href = 'staff-receipts.html';\r\n+        });\r\n+        return;\r\n+    }\r\n \r\n-    const printWindow = window.open('', '_blank', 'width=400,height=600');\r\n-    printWindow.document.write(`\r\n-        <!DOCTYPE html>\r\n-        <html>\r\n-        <head>\r\n-            <title>Receipt</title>\r\n-            <style>\r\n-                body { font-family: 'Courier New', monospace; padding: 10px; margin: 0; }\r\n-                table { width: 100%; border-collapse: collapse; }\r\n-                th, td { padding: 4px 0; }\r\n-                .text-center { text-align: center; }\r\n-                .text-end { text-align: right; }\r\n-                .text-start { text-align: left; }\r\n-                .d-flex { display: flex; }\r\n-                .justify-content-between { justify-content: space-between; }\r\n-                .fw-bold { font-weight: bold; }\r\n-                .text-muted { color: #666; }\r\n-                .text-danger { color: red; }\r\n-                hr { border: none; border-top: 1px dashed #000; margin: 8px 0; }\r\n-                .mb-0 { margin-bottom: 0; }\r\n-                .mb-1 { margin-bottom: 4px; }\r\n-                .mb-2 { margin-bottom: 8px; }\r\n-                .mb-3 { margin-bottom: 12px; }\r\n-                .mt-3 { margin-top: 12px; }\r\n-                small { font-size: 0.85em; }\r\n-                @media print {\r\n-                    body { -webkit-print-color-adjust: exact; }\r\n-                }\r\n-            </style>\r\n-        </head>\r\n-        <body>\r\n-            ${receiptContent.innerHTML}\r\n-            <script>\r\n-                window.onload = function() {\r\n-                    window.print();\r\n-                    window.onafterprint = function() { window.close(); };\r\n-                };\r\n-            </script>\r\n-        </body>\r\n-        </html>\r\n-    `);\r\n-    printWindow.document.close();\r\n+    // Try to print directly\r\n+    attemptPrint(receiptContent);\r\n }\r\n \r\n-// Print receipt from an element (for auto-print feature)\r\n+/**\r\n+ * Attempt to print and show appropriate status\r\n+ */\r\n+function attemptPrint(receiptContent) {\r\n+    // Check if print is available\r\n+    if (!window.print) {\r\n+        showNoPrinterModal('Browser does not support printing');\r\n+        return;\r\n+    }\r\n+\r\n+    // Create a hidden iframe for printing (avoids popup blockers)\r\n+    let printFrame = document.getElementById('printFrame');\r\n+    if (!printFrame) {\r\n+        printFrame = document.createElement('iframe');\r\n+        printFrame.id = 'printFrame';\r\n+        printFrame.name = 'printFrame';\r\n+        printFrame.style.cssText = 'position:absolute;left:-9999px;top:-9999px;width:0;height:0;border:0;';\r\n+        document.body.appendChild(printFrame);\r\n+    }\r\n+\r\n+    try {\r\n+        const printDocument = printFrame.contentWindow || printFrame.contentDocument;\r\n+        const doc = printDocument.document || printDocument;\r\n+\r\n+        doc.open();\r\n+        doc.write(`\r\n+            <!DOCTYPE html>\r\n+            <html>\r\n+            <head>\r\n+                <title>Receipt - Ethan's Cafe</title>\r\n+                <style>\r\n+                    * { margin: 0; padding: 0; box-sizing: border-box; }\r\n+                    body { \r\n+                        font-family: 'Courier New', Courier, monospace; \r\n+                        padding: 5mm; \r\n+                        font-size: 12px;\r\n+                        line-height: 1.4;\r\n+                    }\r\n+                    table { width: 100%; border-collapse: collapse; }\r\n+                    th, td { padding: 2px 0; vertical-align: top; }\r\n+                    .text-center { text-align: center; }\r\n+                    .text-end, .text-right { text-align: right; }\r\n+                    .text-start, .text-left { text-align: left; }\r\n+                    .d-flex { display: flex; }\r\n+                    .justify-content-between { justify-content: space-between; }\r\n+                    .fw-bold, strong { font-weight: bold; }\r\n+                    .text-muted { color: #666; }\r\n+                    .text-danger { color: #dc3545; }\r\n+                    hr { border: none; border-top: 1px dashed #000; margin: 5px 0; }\r\n+                    .mb-0 { margin-bottom: 0; }\r\n+                    .mb-1 { margin-bottom: 2px; }\r\n+                    .mb-2 { margin-bottom: 5px; }\r\n+                    .mb-3 { margin-bottom: 8px; }\r\n+                    .mt-3 { margin-top: 8px; }\r\n+                    small { font-size: 10px; }\r\n+                    h5 { font-size: 16px; margin-bottom: 3px; }\r\n+                    \r\n+                    @media print {\r\n+                        @page {\r\n+                            size: 80mm auto; /* Thermal receipt paper width */\r\n+                            margin: 0;\r\n+                        }\r\n+                        body { \r\n+                            -webkit-print-color-adjust: exact !important; \r\n+                            print-color-adjust: exact !important;\r\n+                            padding: 2mm;\r\n+                        }\r\n+                    }\r\n+                </style>\r\n+            </head>\r\n+            <body>\r\n+                ${receiptContent.innerHTML}\r\n+            </body>\r\n+            </html>\r\n+        `);\r\n+        doc.close();\r\n+\r\n+        // Wait for content to render then print\r\n+        setTimeout(() => {\r\n+            try {\r\n+                // Open print dialog directly\r\n+                printFrame.contentWindow.focus();\r\n+                printFrame.contentWindow.print();\r\n+                \r\n+                // Log and redirect after print dialog closes\r\n+                logStaffActivity('Print Receipt', 'Receipt printed', 'Success');\r\n+                \r\n+                // Show success and redirect\r\n+                Swal.fire({\r\n+                    icon: 'success',\r\n+                    title: 'Print Sent',\r\n+                    html: `\r\n+                        <p class=\"mb-2\">Print command sent to printer.</p>\r\n+                        <p class=\"text-muted small\">Redirecting to receipts...</p>\r\n+                    `,\r\n+                    timer: 2000,\r\n+                    timerProgressBar: true,\r\n+                    showConfirmButton: false,\r\n+                    confirmButtonColor: '#800000'\r\n+                }).then(() => {\r\n+                    window.location.href = 'staff-receipts.html';\r\n+                });\r\n+                \r\n+            } catch (err) {\r\n+                console.error('Print failed:', err);\r\n+                showNoPrinterModal(err.message);\r\n+            }\r\n+        }, 300);\r\n+        \r\n+    } catch (err) {\r\n+        console.error('Print setup failed:', err);\r\n+        showNoPrinterModal(err.message);\r\n+    }\r\n+}\r\n+\r\n+/**\r\n+ * Show no printer modal and redirect to receipts\r\n+ */\r\n+function showNoPrinterModal(errorMsg) {\r\n+    Swal.fire({\r\n+        icon: 'error',\r\n+        title: 'No Printer',\r\n+        html: `\r\n+            <div class=\"text-center\">\r\n+                <i class=\"fas fa-print fa-3x text-danger mb-3\"></i>\r\n+                <p class=\"fw-bold text-danger\">No printer detected or printing failed</p>\r\n+                <p class=\"text-muted small\">${errorMsg || 'Please check your printer connection'}</p>\r\n+                <hr>\r\n+                <p class=\"small\">Transaction has been saved. You can print from the Receipts page later.</p>\r\n+            </div>\r\n+        `,\r\n+        confirmButtonText: 'Go to Receipts',\r\n+        confirmButtonColor: '#800000',\r\n+        allowOutsideClick: false\r\n+    }).then(() => {\r\n+        window.location.href = 'staff-receipts.html';\r\n+    });\r\n+    logStaffActivity('Print Receipt', 'Print failed: ' + (errorMsg || 'No printer'), 'Failed');\r\n+}\r\n+\r\n+/**\r\n+ * Print receipt from an element (for auto-print feature)\r\n+ * Uses the same iframe method for reliability\r\n+ */\r\n function printReceiptFromElement(element) {\r\n-    if (!element) return;\r\n+    if (!element) {\r\n+        console.error('No element provided for printing');\r\n+        return;\r\n+    }\r\n \r\n-    const printWindow = window.open('', '_blank', 'width=400,height=600');\r\n-    printWindow.document.write(`\r\n+    // Create a hidden iframe for printing\r\n+    let printFrame = document.getElementById('printFrame');\r\n+    if (!printFrame) {\r\n+        printFrame = document.createElement('iframe');\r\n+        printFrame.id = 'printFrame';\r\n+        printFrame.name = 'printFrame';\r\n+        printFrame.style.cssText = 'position:absolute;left:-9999px;top:-9999px;width:0;height:0;border:0;';\r\n+        document.body.appendChild(printFrame);\r\n+    }\r\n+\r\n+    const printDocument = printFrame.contentWindow || printFrame.contentDocument;\r\n+    const doc = printDocument.document || printDocument;\r\n+\r\n+    doc.open();\r\n+    doc.write(`\r\n         <!DOCTYPE html>\r\n         <html>\r\n         <head>\r\n-            <title>Receipt</title>\r\n+            <title>Receipt - Ethan's Cafe</title>\r\n             <style>\r\n-                body { font-family: 'Courier New', monospace; padding: 10px; margin: 0; }\r\n+                * { margin: 0; padding: 0; box-sizing: border-box; }\r\n+                body { \r\n+                    font-family: 'Courier New', Courier, monospace; \r\n+                    padding: 5mm; \r\n+                    font-size: 12px;\r\n+                    line-height: 1.4;\r\n+                }\r\n                 table { width: 100%; border-collapse: collapse; }\r\n-                th, td { padding: 4px 0; }\r\n+                th, td { padding: 2px 0; vertical-align: top; }\r\n                 .text-center { text-align: center; }\r\n-                .text-end { text-align: right; }\r\n-                .text-start { text-align: left; }\r\n+                .text-end, .text-right { text-align: right; }\r\n+                .text-start, .text-left { text-align: left; }\r\n                 .d-flex { display: flex; }\r\n                 .justify-content-between { justify-content: space-between; }\r\n-                .fw-bold { font-weight: bold; }\r\n+                .fw-bold, strong { font-weight: bold; }\r\n                 .text-muted { color: #666; }\r\n-                .text-danger { color: red; }\r\n-                hr { border: none; border-top: 1px dashed #000; margin: 8px 0; }\r\n+                .text-danger { color: #dc3545; }\r\n+                hr { border: none; border-top: 1px dashed #000; margin: 5px 0; }\r\n                 .mb-0 { margin-bottom: 0; }\r\n-                .mb-1 { margin-bottom: 4px; }\r\n-                .mb-2 { margin-bottom: 8px; }\r\n-                .mb-3 { margin-bottom: 12px; }\r\n-                .mt-3 { margin-top: 12px; }\r\n-                small { font-size: 0.85em; }\r\n+                .mb-1 { margin-bottom: 2px; }\r\n+                .mb-2 { margin-bottom: 5px; }\r\n+                .mb-3 { margin-bottom: 8px; }\r\n+                .mt-3 { margin-top: 8px; }\r\n+                small { font-size: 10px; }\r\n+                h5 { font-size: 16px; margin-bottom: 3px; }\r\n+                \r\n                 @media print {\r\n-                    body { -webkit-print-color-adjust: exact; }\r\n+                    @page {\r\n+                        size: 80mm auto;\r\n+                        margin: 0;\r\n+                    }\r\n+                    body { \r\n+                        -webkit-print-color-adjust: exact !important; \r\n+                        print-color-adjust: exact !important;\r\n+                        padding: 2mm;\r\n+                    }\r\n                 }\r\n             </style>\r\n         </head>\r\n         <body>\r\n             ${element.innerHTML}\r\n-            <script>\r\n-                window.onload = function() {\r\n-                    window.print();\r\n-                    window.onafterprint = function() { window.close(); };\r\n-                };\r\n-            </script>\r\n         </body>\r\n         </html>\r\n     `);\r\n-    printWindow.document.close();\r\n+    doc.close();\r\n+\r\n+    // Print after content loads\r\n+    setTimeout(() => {\r\n+        try {\r\n+            printFrame.contentWindow.focus();\r\n+            printFrame.contentWindow.print();\r\n+        } catch (err) {\r\n+            console.error('Auto-print failed:', err);\r\n+        }\r\n+    }, 250);\r\n }\r\n \r\n+/**\r\n+ * Show printer setup/test dialog\r\n+ */\r\n+function showPrinterSetup() {\r\n+    Swal.fire({\r\n+        title: '<i class=\"fas fa-print me-2\"></i>Printer Setup',\r\n+        html: `\r\n+            <div class=\"text-start\">\r\n+                <div class=\"alert alert-info mb-3\">\r\n+                    <i class=\"fas fa-info-circle me-2\"></i>\r\n+                    <strong>Printer Status Check</strong>\r\n+                </div>\r\n+                \r\n+                <div id=\"printerStatusCheck\" class=\"mb-3\">\r\n+                    <p><i class=\"fas fa-spinner fa-spin me-2\"></i>Checking printer...</p>\r\n+                </div>\r\n+                \r\n+                <hr>\r\n+                \r\n+                <h6 class=\"mb-2\">Recommended Settings:</h6>\r\n+                <ul class=\"small text-muted\">\r\n+                    <li>Paper size: 80mm (for thermal printers)</li>\r\n+                    <li>Margins: None or Minimum</li>\r\n+                    <li>Scale: 100%</li>\r\n+                    <li>Background graphics: ON</li>\r\n+                </ul>\r\n+                \r\n+                <hr>\r\n+                \r\n+                <h6 class=\"mb-2\">Print a Test Receipt:</h6>\r\n+                <button type=\"button\" class=\"btn btn-outline-primary btn-sm\" onclick=\"printTestReceipt()\">\r\n+                    <i class=\"fas fa-print me-2\"></i>Print Test\r\n+                </button>\r\n+                \r\n+                <hr class=\"mt-3\">\r\n+                \r\n+                <div class=\"alert alert-warning small mb-0\">\r\n+                    <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n+                    <strong>Note:</strong> Detecting paper status requires a dedicated thermal printer driver or POS software. \r\n+                    Web browsers cannot detect paper levels.\r\n+                </div>\r\n+            </div>\r\n+        `,\r\n+        showConfirmButton: true,\r\n+        confirmButtonText: 'Close',\r\n+        confirmButtonColor: '#800000',\r\n+        width: 500,\r\n+        didOpen: async () => {\r\n+            // Check printer status\r\n+            const status = await checkPrinterStatus();\r\n+            const statusDiv = document.getElementById('printerStatusCheck');\r\n+            if (statusDiv) {\r\n+                if (status.available) {\r\n+                    statusDiv.innerHTML = `\r\n+                        <p class=\"text-success mb-1\">\r\n+                            <i class=\"fas fa-check-circle me-2\"></i>\r\n+                            <strong>Print Service Available</strong>\r\n+                        </p>\r\n+                        <p class=\"small text-muted mb-0\">\r\n+                            Click \"Print Test\" below to verify your printer is working.\r\n+                        </p>\r\n+                    `;\r\n+                } else {\r\n+                    statusDiv.innerHTML = `\r\n+                        <p class=\"text-danger mb-1\">\r\n+                            <i class=\"fas fa-times-circle me-2\"></i>\r\n+                            <strong>${status.message}</strong>\r\n+                        </p>\r\n+                    `;\r\n+                }\r\n+            }\r\n+        }\r\n+    });\r\n+}\r\n+\r\n+/**\r\n+ * Print a test receipt to verify printer setup\r\n+ */\r\n+function printTestReceipt() {\r\n+    const testHtml = `\r\n+        <div style=\"font-family: 'Courier New', monospace; max-width: 300px; margin: 0 auto; padding: 15px; border: 1px dashed #000;\">\r\n+            <div class=\"text-center mb-3\">\r\n+                <h5 class=\"mb-1\"><strong>ETHAN'S CAFE</strong></h5>\r\n+                <small>*** PRINTER TEST ***</small><br>\r\n+                <small>${new Date().toLocaleString()}</small>\r\n+            </div>\r\n+            \r\n+            <hr style=\"border-style: dashed;\">\r\n+            \r\n+            <div style=\"font-size: 0.85rem;\">\r\n+                <p><strong>Test Line 1:</strong> ABCDEFGHIJKLMNOP</p>\r\n+                <p><strong>Test Line 2:</strong> 1234567890</p>\r\n+                <p><strong>Test Line 3:</strong> !@#$%^&*()</p>\r\n+            </div>\r\n+            \r\n+            <hr style=\"border-style: dashed;\">\r\n+            \r\n+            <div class=\"d-flex justify-content-between fw-bold\">\r\n+                <span>TOTAL:</span>\r\n+                <span>${getCurrency()}123.45</span>\r\n+            </div>\r\n+            \r\n+            <hr style=\"border-style: dashed;\">\r\n+            \r\n+            <div class=\"text-center\">\r\n+                <small>If you can read this, your printer is working!</small>\r\n+            </div>\r\n+        </div>\r\n+    `;\r\n+    \r\n+    // Create temporary element\r\n+    const tempDiv = document.createElement('div');\r\n+    tempDiv.innerHTML = testHtml;\r\n+    document.body.appendChild(tempDiv);\r\n+    \r\n+    // Print it\r\n+    printReceiptFromElement(tempDiv);\r\n+    \r\n+    // Remove temp element after a delay\r\n+    setTimeout(() => {\r\n+        document.body.removeChild(tempDiv);\r\n+    }, 1000);\r\n+    \r\n+    // Close the setup dialog\r\n+    Swal.close();\r\n+}\r\n+\r\n // Sync menu when admin makes changes\r\n window.addEventListener('storage', e => {\r\n     if (e.key === 'adminMenuItems') loadMenuItems();\r\n });\r\n@@ -1195,13 +1783,40 @@\n \r\n         const unitMap = {};\r\n         units.forEach(unit => { unitMap[unit.id] = unit.abbreviation || unit.name; });\r\n \r\n+        // Get system default for low stock threshold\r\n+        const defaultLowStockThreshold = parseFloat(systemSettings.low_stock_threshold) || 10;\r\n+        const expiryWarningDays = parseInt(systemSettings.expiry_warning_days) || 7;\r\n+        const today = new Date();\r\n+        today.setHours(0, 0, 0, 0);\r\n+        const warningDate = new Date(today.getTime() + (expiryWarningDays * 24 * 60 * 60 * 1000));\r\n+\r\n         // Map ingredients with proper display info\r\n         allIngredients = ingredients.map(ing => {\r\n             const qty = parseFloat(ing.current_quantity) || 0;\r\n-            const threshold = parseFloat(ing.low_stock_threshold) || 0;\r\n-            const status = qty <= threshold ? 'Low' : 'Normal';\r\n+            // Use ingredient's own threshold, or fall back to system default\r\n+            const threshold = ing.low_stock_threshold !== null && ing.low_stock_threshold !== undefined \r\n+                ? parseFloat(ing.low_stock_threshold) \r\n+                : defaultLowStockThreshold;\r\n+            \r\n+            let status = qty <= threshold ? 'Low' : 'Normal';\r\n+            let expiryStatus = null;\r\n+            let daysUntilExpiry = null;\r\n+            \r\n+            // Check expiry date\r\n+            if (ing.expiry_date) {\r\n+                const expiryDate = new Date(ing.expiry_date);\r\n+                expiryDate.setHours(0, 0, 0, 0);\r\n+                \r\n+                if (expiryDate < today) {\r\n+                    expiryStatus = 'expired';\r\n+                    daysUntilExpiry = Math.floor((today - expiryDate) / (1000 * 60 * 60 * 24)) * -1;\r\n+                } else if (expiryDate <= warningDate) {\r\n+                    expiryStatus = 'expiring';\r\n+                    daysUntilExpiry = Math.floor((expiryDate - today) / (1000 * 60 * 60 * 24));\r\n+                }\r\n+            }\r\n \r\n             return {\r\n                 id: ing.id,\r\n                 name: ing.name,\r\n@@ -1210,14 +1825,23 @@\n                 quantity: qty,\r\n                 unit: unitMap[ing.unit_id] || '',\r\n                 unit_id: ing.unit_id,\r\n                 status: status,\r\n-                minLevel: threshold\r\n+                minLevel: threshold,\r\n+                expiry_date: ing.expiry_date,\r\n+                expiryStatus: expiryStatus,\r\n+                daysUntilExpiry: daysUntilExpiry\r\n             };\r\n         });\r\n \r\n         displayIngredients(allIngredients);\r\n         populateCategoryFilter(categories);\r\n+        \r\n+        // Check for alerts and send email notifications (once per session)\r\n+        if (!sessionStorage.getItem('inventoryAlertsChecked')) {\r\n+            sessionStorage.setItem('inventoryAlertsChecked', 'true');\r\n+            checkAndNotifyInventoryAlerts();\r\n+        }\r\n \r\n     } catch (error) {\r\n         console.error('Failed to load ingredients:', error);\r\n         tbody.innerHTML = '<tr><td colspan=\"6\" class=\"text-center py-4 text-danger\"><i class=\"fas fa-exclamation-triangle me-2\"></i>Failed to load ingredients</td></tr>';\r\n@@ -1250,11 +1874,31 @@\n \r\n     const tbody = tableElem.querySelector('tbody');\r\n     if (!tbody) return;\r\n \r\n-    tbody.innerHTML = ingredients.map(ing => `\r\n-        <tr class=\"${ing.status === 'Low' ? 'table-warning' : ''}\">\r\n-            <td><strong>${ing.name}</strong></td>\r\n+    tbody.innerHTML = ingredients.map(ing => {\r\n+        // Determine row class based on status\r\n+        let rowClass = '';\r\n+        if (ing.expiryStatus === 'expired') {\r\n+            rowClass = 'table-danger';\r\n+        } else if (ing.status === 'Low' || ing.expiryStatus === 'expiring') {\r\n+            rowClass = 'table-warning';\r\n+        }\r\n+        \r\n+        // Build expiry badge if applicable\r\n+        let expiryBadge = '';\r\n+        if (ing.expiryStatus === 'expired') {\r\n+            expiryBadge = `<span class=\"badge bg-danger ms-1\" title=\"Expired ${Math.abs(ing.daysUntilExpiry)} days ago\"><i class=\"fas fa-skull-crossbones me-1\"></i>EXPIRED</span>`;\r\n+        } else if (ing.expiryStatus === 'expiring') {\r\n+            expiryBadge = `<span class=\"badge bg-warning text-dark ms-1\" title=\"Expires in ${ing.daysUntilExpiry} days\"><i class=\"fas fa-clock me-1\"></i>${ing.daysUntilExpiry}d</span>`;\r\n+        }\r\n+        \r\n+        return `\r\n+        <tr class=\"${rowClass}\">\r\n+            <td>\r\n+                <strong>${ing.name}</strong>\r\n+                ${expiryBadge}\r\n+            </td>\r\n             <td><span class=\"badge bg-secondary\">${ing.category}</span></td>\r\n             <td>\r\n                 <span class=\"fw-bold ${ing.status === 'Low' ? 'text-danger' : 'text-success'}\">${ing.quantity}</span> \r\n                 <small class=\"text-muted\">${ing.unit}</small>\r\n@@ -1277,10 +1921,10 @@\n                         <i class=\"fas fa-history\"></i>\r\n                     </button>\r\n                 </div>\r\n             </td>\r\n-        </tr>`\r\n-    ).join('');\r\n+        </tr>`;\r\n+    }).join('');\r\n \r\n     // Update total count if element exists\r\n     const totalCount = document.getElementById('ingredientsTotalCount');\r\n     if (totalCount) {\r\n@@ -1572,19 +2216,23 @@\n         const menuItems = await menuItemsDB.show();\r\n         \r\n         // Map sale items to sales\r\n         allSales = (Array.isArray(dbSales) ? dbSales : []).map(sale => {\r\n-            const items = saleItems.filter(si => si.sale_id === sale.id).map(si => {\r\n-                const menuItem = menuItems.find(mi => mi.id === si.menu_item_id);\r\n+            const saleId = parseInt(sale.id);\r\n+            const matchedItems = saleItems.filter(si => parseInt(si.sale_id) === saleId);\r\n+            \r\n+            const items = matchedItems.map(si => {\r\n+                const menuItemId = parseInt(si.menu_item_id);\r\n+                const menuItem = menuItems.find(mi => parseInt(mi.id) === menuItemId);\r\n                 return {\r\n-                    name: menuItem?.name || si.item_name || 'Unknown Item',\r\n+                    name: si.item_name || menuItem?.name || 'Unknown Item',\r\n                     quantity: si.quantity,\r\n-                    price: parseFloat(si.price),\r\n-                    subtotal: parseFloat(si.subtotal)\r\n+                    price: parseFloat(si.unit_price) || 0,\r\n+                    subtotal: (parseFloat(si.unit_price) || 0) * (parseInt(si.quantity) || 1)\r\n                 };\r\n             });\r\n             \r\n-            const saleDate = new Date(sale.sale_date || sale.created_at);\r\n+            const saleDate = new Date(sale.sale_datetime || sale.created_at);\r\n             return {\r\n                 id: sale.id,\r\n                 date: saleDate.toLocaleDateString(),\r\n                 time: saleDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),\r\n@@ -1626,14 +2274,15 @@\n     \r\n     if (sales.length === 0) {\r\n         container.innerHTML = `\r\n             <tr>\r\n-                <td colspan=\"6\" class=\"text-center py-5\">\r\n+                <td colspan=\"7\" class=\"text-center py-5\">\r\n                     <i class=\"fas fa-receipt fa-3x text-muted mb-3\"></i>\r\n                     <p class=\"text-muted mb-0\">No transactions found</p>\r\n                 </td>\r\n             </tr>\r\n         `;\r\n+        updateDeleteButtonsState();\r\n         return;\r\n     }\r\n     \r\n     // Sort by date descending\r\n@@ -1673,8 +2322,9 @@\n         const actionBtnTitle = isProcessed ? 'Already processed' : 'Refund or Void';\r\n         \r\n         return `\r\n             <tr class=\"${rowClass} receipt-row\" style=\"cursor: pointer;\" data-sale-id=\"${sale.id}\">\r\n+                <td onclick=\"event.stopPropagation();\"><input type=\"checkbox\" class=\"form-check-input receipt-checkbox\" value=\"${sale.id}\" onchange=\"updateDeleteButtonsState()\"></td>\r\n                 <td onclick=\"selectReceipt('${sale.id}')\">#${sale.id}</td>\r\n                 <td onclick=\"selectReceipt('${sale.id}')\">${sale.time}</td>\r\n                 <td onclick=\"selectReceipt('${sale.id}')\"><small>${itemsPreview}</small></td>\r\n                 <td onclick=\"selectReceipt('${sale.id}')\" class=\"fw-bold ${totalClass}\">‚Ç±${displayTotal.toFixed(2)}</td>\r\n@@ -1686,10 +2336,227 @@\n                 </td>\r\n             </tr>\r\n         `;\r\n     }).join('');\r\n+    \r\n+    updateDeleteButtonsState();\r\n }\r\n \r\n+// Toggle select all checkboxes\r\n+function toggleSelectAllReceipts() {\r\n+    const selectAll = document.getElementById('selectAllReceipts');\r\n+    const checkboxes = document.querySelectorAll('.receipt-checkbox');\r\n+    checkboxes.forEach(cb => cb.checked = selectAll.checked);\r\n+    updateDeleteButtonsState();\r\n+}\r\n+\r\n+// Update delete buttons state based on selection\r\n+function updateDeleteButtonsState() {\r\n+    const checkboxes = document.querySelectorAll('.receipt-checkbox:checked');\r\n+    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');\r\n+    const deleteAllBtn = document.getElementById('deleteAllBtn');\r\n+    const totalReceipts = document.querySelectorAll('.receipt-checkbox').length;\r\n+    \r\n+    if (deleteSelectedBtn) {\r\n+        deleteSelectedBtn.disabled = checkboxes.length === 0;\r\n+        if (checkboxes.length > 0) {\r\n+            deleteSelectedBtn.innerHTML = `<i class=\"fas fa-trash-alt me-1\"></i>Delete Selected (${checkboxes.length})`;\r\n+        } else {\r\n+            deleteSelectedBtn.innerHTML = `<i class=\"fas fa-trash-alt me-1\"></i>Delete Selected`;\r\n+        }\r\n+    }\r\n+    \r\n+    if (deleteAllBtn) {\r\n+        deleteAllBtn.disabled = totalReceipts === 0;\r\n+    }\r\n+    \r\n+    // Update select all checkbox state\r\n+    const selectAll = document.getElementById('selectAllReceipts');\r\n+    if (selectAll && totalReceipts > 0) {\r\n+        selectAll.checked = checkboxes.length === totalReceipts;\r\n+        selectAll.indeterminate = checkboxes.length > 0 && checkboxes.length < totalReceipts;\r\n+    }\r\n+}\r\n+\r\n+// Delete selected receipts\r\n+async function deleteSelectedReceipts() {\r\n+    const checkboxes = document.querySelectorAll('.receipt-checkbox:checked');\r\n+    if (checkboxes.length === 0) return;\r\n+    \r\n+    const saleIds = Array.from(checkboxes).map(cb => cb.value);\r\n+    \r\n+    const result = await Swal.fire({\r\n+        title: 'Delete Selected Transactions?',\r\n+        html: `Are you sure you want to delete <strong>${saleIds.length}</strong> transaction(s)?<br><small class=\"text-danger\">This action cannot be undone.</small>`,\r\n+        icon: 'warning',\r\n+        showCancelButton: true,\r\n+        confirmButtonColor: '#dc3545',\r\n+        confirmButtonText: 'Yes, Delete',\r\n+        cancelButtonText: 'Cancel'\r\n+    });\r\n+    \r\n+    if (!result.isConfirmed) return;\r\n+    \r\n+    showLoadingModal('Deleting transactions...');\r\n+    \r\n+    try {\r\n+        // Remove from localStorage first\r\n+        const localSales = JSON.parse(localStorage.getItem('sales') || '[]');\r\n+        const updatedLocalSales = localSales.filter(s => !saleIds.includes(String(s.id)));\r\n+        localStorage.setItem('sales', JSON.stringify(updatedLocalSales));\r\n+        console.log('Updated localStorage, removed', saleIds.length, 'sales');\r\n+        \r\n+        // Also try to delete from database\r\n+        for (const saleId of saleIds) {\r\n+            console.log('Deleting sale ID:', saleId);\r\n+            \r\n+            // Delete sale items first\r\n+            const saleItems = await saleItemsDB.show();\r\n+            const saleItemsArr = Array.isArray(saleItems) ? saleItems : [];\r\n+            const itemsToDelete = saleItemsArr.filter(si => parseInt(si.sale_id) === parseInt(saleId));\r\n+            console.log('Items to delete for sale', saleId, ':', itemsToDelete);\r\n+            \r\n+            for (const item of itemsToDelete) {\r\n+                const itemDeleteResult = await saleItemsDB.delete(item.id);\r\n+                console.log('Delete item result:', itemDeleteResult);\r\n+            }\r\n+            \r\n+            // Delete the sale\r\n+            const saleDeleteResult = await salesDB.delete(parseInt(saleId));\r\n+            console.log('Delete sale result:', saleDeleteResult);\r\n+        }\r\n+        \r\n+        // Update allSales array\r\n+        allSales = allSales.filter(s => !saleIds.includes(String(s.id)));\r\n+        \r\n+        hideLoadingModal();\r\n+        \r\n+        Swal.fire({\r\n+            icon: 'success',\r\n+            title: 'Deleted!',\r\n+            text: `${saleIds.length} transaction(s) deleted successfully`,\r\n+            timer: 2000,\r\n+            showConfirmButton: false\r\n+        });\r\n+        \r\n+        logStaffActivity('Deleted Transactions', `Deleted ${saleIds.length} transactions`, 'Success');\r\n+        \r\n+        // Reload receipts\r\n+        loadReceiptsList();\r\n+    } catch (error) {\r\n+        hideLoadingModal();\r\n+        console.error('Delete error:', error);\r\n+        Swal.fire('Error', 'Failed to delete some transactions', 'error');\r\n+    }\r\n+}\r\n+\r\n+// Delete all receipts\r\n+async function deleteAllReceipts() {\r\n+    console.log('=== DELETE ALL RECEIPTS STARTED ===');\r\n+    const totalReceipts = document.querySelectorAll('.receipt-checkbox').length;\r\n+    console.log('Total receipts found in UI:', totalReceipts);\r\n+    if (totalReceipts === 0) {\r\n+        console.log('No receipts to delete, exiting');\r\n+        return;\r\n+    }\r\n+    \r\n+    const result = await Swal.fire({\r\n+        title: 'Delete ALL Transactions?',\r\n+        html: `Are you sure you want to delete <strong>ALL ${totalReceipts}</strong> transaction(s)?<br><small class=\"text-danger\">This action cannot be undone!</small>`,\r\n+        icon: 'warning',\r\n+        showCancelButton: true,\r\n+        confirmButtonColor: '#dc3545',\r\n+        confirmButtonText: 'Yes, Delete All',\r\n+        cancelButtonText: 'Cancel',\r\n+        input: 'text',\r\n+        inputPlaceholder: 'Type DELETE to confirm',\r\n+        inputValidator: (value) => {\r\n+            if (value !== 'DELETE') {\r\n+                return 'Please type DELETE to confirm';\r\n+            }\r\n+        }\r\n+    });\r\n+    \r\n+    console.log('Swal result:', result);\r\n+    if (!result.isConfirmed) {\r\n+        console.log('User cancelled, exiting');\r\n+        return;\r\n+    }\r\n+    \r\n+    console.log('User confirmed deletion, proceeding...');\r\n+    showLoadingModal('Deleting all transactions...');\r\n+    \r\n+    try {\r\n+        // Clear localStorage sales first (since this is the fallback source)\r\n+        console.log('Clearing localStorage sales...');\r\n+        localStorage.removeItem('sales');\r\n+        localStorage.removeItem('sale_items');\r\n+        console.log('localStorage cleared');\r\n+        \r\n+        // Get all sales and sale items from database\r\n+        console.log('Fetching all sales from database...');\r\n+        const dbSales = await salesDB.show();\r\n+        const sales = Array.isArray(dbSales) ? dbSales : [];\r\n+        console.log('Sales fetched:', sales);\r\n+        console.log('Number of sales:', sales.length);\r\n+        \r\n+        console.log('Fetching all sale items from database...');\r\n+        const dbSaleItems = await saleItemsDB.show();\r\n+        const saleItems = Array.isArray(dbSaleItems) ? dbSaleItems : [];\r\n+        console.log('Sale items fetched:', saleItems);\r\n+        console.log('Number of sale items:', saleItems.length);\r\n+        \r\n+        // Delete all sale items first\r\n+        console.log('=== DELETING SALE ITEMS ===');\r\n+        let itemDeleteCount = 0;\r\n+        for (const item of saleItems) {\r\n+            console.log(`Deleting sale item ID: ${item.id}`);\r\n+            const itemResult = await saleItemsDB.delete(item.id);\r\n+            console.log(`Delete item ${item.id} result:`, itemResult);\r\n+            itemDeleteCount++;\r\n+        }\r\n+        console.log(`Finished deleting ${itemDeleteCount} sale items`);\r\n+        \r\n+        // Delete all sales\r\n+        console.log('=== DELETING SALES ===');\r\n+        let saleDeleteCount = 0;\r\n+        for (const sale of sales) {\r\n+            console.log(`Deleting sale ID: ${sale.id}, Receipt: ${sale.receipt_no}`);\r\n+            const saleResult = await salesDB.delete(sale.id);\r\n+            console.log(`Delete sale ${sale.id} result:`, saleResult);\r\n+            saleDeleteCount++;\r\n+        }\r\n+        console.log(`Finished deleting ${saleDeleteCount} sales`);\r\n+        \r\n+        // Also clear allSales array\r\n+        allSales = [];\r\n+        \r\n+        hideLoadingModal();\r\n+        console.log('=== DELETE ALL COMPLETED SUCCESSFULLY ===');\r\n+        \r\n+        Swal.fire({\r\n+            icon: 'success',\r\n+            title: 'Deleted!',\r\n+            text: 'All transactions deleted successfully',\r\n+            timer: 2000,\r\n+            showConfirmButton: false\r\n+        });\r\n+        \r\n+        logStaffActivity('Deleted All Transactions', `Deleted ${sales.length} transactions`, 'Success');\r\n+        \r\n+        // Reload receipts\r\n+        console.log('Reloading receipts list...');\r\n+        loadReceiptsList();\r\n+    } catch (error) {\r\n+        hideLoadingModal();\r\n+        console.error('=== DELETE ALL ERROR ===');\r\n+        console.error('Error object:', error);\r\n+        console.error('Error message:', error.message);\r\n+        console.error('Error stack:', error.stack);\r\n+        Swal.fire('Error', 'Failed to delete transactions: ' + error.message, 'error');\r\n+    }\r\n+}\r\n+\r\n function filterReceipts() {\r\n     const dateFrom = document.getElementById('receiptDateFrom')?.value;\r\n     const dateTo = document.getElementById('receiptDateTo')?.value;\r\n     \r\n@@ -1969,62 +2836,74 @@\n \r\n /**\r\n  * Render transaction items in modal table\r\n  */\r\n-function renderTransactionItems(items, showCheckboxes = false) {\r\n+function renderTransactionItems(items, showRefundQty = false) {\r\n     const itemsBody = document.getElementById('txnItemsList');\r\n-    const selectAllHeader = document.getElementById('selectAllHeader');\r\n+    const refundQtyHeader = document.getElementById('refundQtyHeader');\r\n     \r\n-    if (showCheckboxes) {\r\n-        selectAllHeader?.classList.remove('d-none');\r\n+    if (showRefundQty) {\r\n+        refundQtyHeader?.classList.remove('d-none');\r\n     } else {\r\n-        selectAllHeader?.classList.add('d-none');\r\n+        refundQtyHeader?.classList.add('d-none');\r\n     }\r\n     \r\n     itemsBody.innerHTML = items.map((item, index) => {\r\n         const price = parseFloat(item.price) || 0;\r\n-        const subtotal = parseFloat(item.subtotal) || (price * (item.quantity || 1));\r\n+        const qty = parseInt(item.quantity) || 1;\r\n+        const subtotal = parseFloat(item.subtotal) || (price * qty);\r\n         \r\n         return `\r\n             <tr>\r\n-                ${showCheckboxes ? `\r\n-                <td class=\"text-center\">\r\n-                    <input type=\"checkbox\" class=\"form-check-input refund-item-check\" \r\n+                <td>${item.name || 'Unknown'}</td>\r\n+                <td class=\"text-center\">${qty}</td>\r\n+                ${showRefundQty ? `\r\n+                <td class=\"text-center bg-warning-subtle\">\r\n+                    <input type=\"number\" class=\"form-control form-control-sm refund-qty-input text-center\" \r\n                            data-index=\"${index}\" \r\n-                           data-subtotal=\"${subtotal}\"\r\n-                           onchange=\"calculateRefundTotal()\">\r\n+                           data-price=\"${price}\"\r\n+                           data-max-qty=\"${qty}\"\r\n+                           min=\"0\" max=\"${qty}\" value=\"0\"\r\n+                           style=\"width: 60px; margin: auto;\"\r\n+                           onchange=\"calculateRefundTotal()\" oninput=\"validateRefundQty(this)\">\r\n                 </td>\r\n                 ` : ''}\r\n-                <td>${item.name || 'Unknown'}</td>\r\n-                <td>${item.quantity || 1}</td>\r\n-                <td>‚Ç±${price.toFixed(2)}</td>\r\n-                <td>‚Ç±${subtotal.toFixed(2)}</td>\r\n+                <td class=\"text-end\">‚Ç±${price.toFixed(2)}</td>\r\n+                <td class=\"text-end\">‚Ç±${subtotal.toFixed(2)}</td>\r\n             </tr>\r\n         `;\r\n     }).join('');\r\n }\r\n \r\n /**\r\n- * Calculate refund total from selected items\r\n+ * Validate refund quantity input\r\n  */\r\n+function validateRefundQty(input) {\r\n+    const max = parseInt(input.dataset.maxQty) || 0;\r\n+    let val = parseInt(input.value) || 0;\r\n+    \r\n+    if (val < 0) val = 0;\r\n+    if (val > max) val = max;\r\n+    \r\n+    input.value = val;\r\n+    calculateRefundTotal();\r\n+}\r\n+\r\n+/**\r\n+ * Calculate refund total from quantity inputs\r\n+ */\r\n function calculateRefundTotal() {\r\n-    const checkboxes = document.querySelectorAll('.refund-item-check:checked');\r\n+    const qtyInputs = document.querySelectorAll('.refund-qty-input');\r\n     let total = 0;\r\n     \r\n-    checkboxes.forEach(cb => {\r\n-        total += parseFloat(cb.dataset.subtotal) || 0;\r\n+    qtyInputs.forEach(input => {\r\n+        const qty = parseInt(input.value) || 0;\r\n+        const price = parseFloat(input.dataset.price) || 0;\r\n+        total += qty * price;\r\n     });\r\n     \r\n     document.getElementById('calculatedRefundAmount').textContent = `‚Ç±${total.toFixed(2)}`;\r\n     document.getElementById('txnAdjustedTotal').value = total.toFixed(2);\r\n-    \r\n-    // Update select all checkbox state\r\n-    const allCheckboxes = document.querySelectorAll('.refund-item-check');\r\n-    const selectAll = document.getElementById('selectAllItems');\r\n-    if (selectAll) {\r\n-        selectAll.checked = checkboxes.length === allCheckboxes.length && allCheckboxes.length > 0;\r\n-        selectAll.indeterminate = checkboxes.length > 0 && checkboxes.length < allCheckboxes.length;\r\n-    }\r\n }\r\n \r\n /**\r\n  * Initialize transaction edit modal events\r\n@@ -2038,37 +2917,30 @@\n             const refundSummary = document.getElementById('refundSummaryAlert');\r\n             const itemHint = document.getElementById('itemSelectionHint');\r\n             \r\n             if (this.value === 'partial_refund') {\r\n-                // Show checkboxes for item selection\r\n+                // Show refund qty column\r\n                 adjustedContainer?.classList.remove('d-none');\r\n                 refundSummary?.classList.remove('d-none');\r\n                 itemHint?.style.setProperty('display', 'inline');\r\n                 \r\n-                // Re-render items with checkboxes\r\n+                // Re-render items with refund qty inputs\r\n                 if (currentSelectedSale) {\r\n                     renderTransactionItems(currentSelectedSale.items, true);\r\n                 }\r\n             } else {\r\n                 adjustedContainer?.classList.add('d-none');\r\n                 refundSummary?.classList.add('d-none');\r\n                 itemHint?.style.setProperty('display', 'none');\r\n                 \r\n-                // Re-render items without checkboxes\r\n+                // Re-render items without refund qty inputs\r\n                 if (currentSelectedSale) {\r\n                     renderTransactionItems(currentSelectedSale.items, false);\r\n                 }\r\n             }\r\n         });\r\n     }\r\n     \r\n-    // Select all checkbox handler\r\n-    document.getElementById('selectAllItems')?.addEventListener('change', function() {\r\n-        const checkboxes = document.querySelectorAll('.refund-item-check');\r\n-        checkboxes.forEach(cb => cb.checked = this.checked);\r\n-        calculateRefundTotal();\r\n-    });\r\n-    \r\n     // Save adjustment button\r\n     const saveBtn = document.getElementById('saveTransactionAdjustment');\r\n     if (saveBtn) {\r\n         saveBtn.addEventListener('click', saveTransactionAdjustment);\r\n@@ -2096,25 +2968,38 @@\n         Swal.fire('Error', 'Please provide a reason for this adjustment', 'warning');\r\n         return;\r\n     }\r\n     \r\n-    // Get selected items for partial refund\r\n-    let selectedItems = [];\r\n+    // Get refunded items with quantities for partial refund\r\n+    let refundedItems = [];\r\n     if (actionType === 'partial_refund') {\r\n-        const checkedBoxes = document.querySelectorAll('.refund-item-check:checked');\r\n-        if (checkedBoxes.length === 0) {\r\n-            Swal.fire('Error', 'Please select at least one item to refund', 'warning');\r\n-            return;\r\n-        }\r\n+        const qtyInputs = document.querySelectorAll('.refund-qty-input');\r\n+        let hasRefund = false;\r\n         \r\n-        checkedBoxes.forEach(cb => {\r\n-            const idx = parseInt(cb.dataset.index);\r\n-            if (currentSelectedSale?.items[idx]) {\r\n-                selectedItems.push(currentSelectedSale.items[idx].name);\r\n+        qtyInputs.forEach(input => {\r\n+            const qty = parseInt(input.value) || 0;\r\n+            if (qty > 0) {\r\n+                hasRefund = true;\r\n+                const idx = parseInt(input.dataset.index);\r\n+                if (currentSelectedSale?.items[idx]) {\r\n+                    refundedItems.push({\r\n+                        name: currentSelectedSale.items[idx].name,\r\n+                        qty: qty,\r\n+                        originalQty: currentSelectedSale.items[idx].quantity\r\n+                    });\r\n+                }\r\n             }\r\n         });\r\n+        \r\n+        if (!hasRefund) {\r\n+            Swal.fire('Error', 'Please enter quantity to refund for at least one item', 'warning');\r\n+            return;\r\n+        }\r\n     }\r\n     \r\n+    // Build selected items text for display\r\n+    const selectedItems = refundedItems.map(item => `${item.name} x${item.qty}`);\r\n+    \r\n     // Confirm action\r\n     let confirmText = '';\r\n     if (actionType === 'void') {\r\n         confirmText = 'VOID this entire transaction? The total will be set to ‚Ç±0.00';\r\n@@ -2123,8 +3008,16 @@\n     } else {\r\n         confirmText = `Issue a PARTIAL REFUND of ‚Ç±${refundAmount.toFixed(2)} for: ${selectedItems.join(', ')}?`;\r\n     }\r\n     \r\n+    // Check if manager approval is required for void\r\n+    if (actionType === 'void' && systemSettings.require_manager_void === 'true') {\r\n+        const managerApproved = await requestManagerApproval('Void Transaction');\r\n+        if (!managerApproved) {\r\n+            return;\r\n+        }\r\n+    }\r\n+    \r\n     const result = await Swal.fire({\r\n         title: 'Confirm Action',\r\n         html: `<p>${confirmText}</p><p class=\"text-muted small\">This action will be logged and notified to admin.</p>`,\r\n         icon: 'warning',\r\n@@ -2200,8 +3093,19 @@\n             `Transaction #${saleId} PARTIAL REFUND of ‚Ç±${refundAmount.toFixed(2)}. Remaining: ‚Ç±${newAdjustedTotal.toFixed(2)}`;\r\n         \r\n         await createNotification(user.id, actionType, 'sales', saleId, notifDesc, reason);\r\n         \r\n+        // Send email notification if enabled\r\n+        const emailEventType = actionType === 'void' ? 'void_transaction' : 'refund_transaction';\r\n+        await sendEmailNotification(emailEventType, {\r\n+            transaction_id: saleId,\r\n+            original_amount: `‚Ç±${originalTotal.toFixed(2)}`,\r\n+            refund_amount: actionType === 'partial_refund' ? `‚Ç±${refundAmount.toFixed(2)}` : `‚Ç±${originalTotal.toFixed(2)}`,\r\n+            refund_type: actionType,\r\n+            staff_name: user.full_name || user.username,\r\n+            reason: reason\r\n+        });\r\n+        \r\n         // Log activity\r\n         logStaffActivity('sales', `${actionType.toUpperCase()}: Transaction #${saleId} - ${reason}`);\r\n         \r\n         // Close modal\r\n@@ -2249,17 +3153,17 @@\n \r\n function toggleAccountEdit(forceState) {\r\n     const editBtn = document.getElementById('editAccountBtn');\r\n     const sendBtn = document.getElementById('sendAccountRequestBtn');\r\n-    const inputs  = document.querySelectorAll('#accountInfoForm input, #changePasswordForm input:not(#accUsername)');\r\n+    const inputs  = document.querySelectorAll('#accountInfoForm input, #changePasswordForm input');\r\n \r\n     const isLocked = forceState !== undefined ? !forceState : editBtn.classList.contains('btn-outline-maroon');\r\n \r\n     if (isLocked) {\r\n         editBtn.classList.replace('btn-outline-maroon', 'btn-maroon');\r\n         editBtn.innerHTML = '<i class=\"fas fa-times me-1\"></i> Cancel';\r\n         sendBtn.classList.remove('d-none');\r\n-        inputs.forEach(input => { if (input.id !== 'accUsername') input.disabled = false; });\r\n+        inputs.forEach(input => input.disabled = false);\r\n     } else {\r\n         editBtn.classList.replace('btn-maroon', 'btn-outline-maroon');\r\n         editBtn.innerHTML = '<i class=\"fas fa-edit me-1\"></i> Edit';\r\n         sendBtn.classList.add('d-none');\r\n@@ -2288,20 +3192,34 @@\n \r\n     setVal('accFullName', user.full_name || '');\r\n     setVal('accUsername', user.username || '');\r\n     setVal('accEmail',    user.email    || '');\r\n+    setVal('accPhone',    user.phone    || '');\r\n }\r\n \r\n async function saveAccountInfo() {\r\n     const user     = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n     const fullName = document.getElementById('accFullName')?.value.trim();\r\n+    const username = document.getElementById('accUsername')?.value.trim();\r\n     const email    = document.getElementById('accEmail')?.value.trim();\r\n+    const phone    = document.getElementById('accPhone')?.value.trim();\r\n \r\n     if (!fullName) {\r\n         showModalNotification('Full Name is required', 'warning', 'Validation');\r\n         return;\r\n     }\r\n \r\n+    if (!username) {\r\n+        showModalNotification('Username is required', 'warning', 'Validation');\r\n+        return;\r\n+    }\r\n+\r\n+    // Validate username format\r\n+    if (!/^[a-zA-Z0-9_]{3,30}$/.test(username)) {\r\n+        showModalNotification('Username must be 3-30 characters (letters, numbers, underscores only)', 'warning', 'Validation');\r\n+        return;\r\n+    }\r\n+\r\n     showLoadingModal('Updating account...');\r\n \r\n     try {\r\n         // Use dedicated profile update endpoint\r\n@@ -2310,19 +3228,26 @@\n             headers: { 'Content-Type': 'application/json' },\r\n             body: JSON.stringify({\r\n                 user_id: user.id,\r\n                 full_name: fullName,\r\n-                email: email\r\n+                username: username,\r\n+                email: email,\r\n+                phone: phone\r\n             })\r\n         });\r\n         const data = await res.json();\r\n         hideLoadingModal();\r\n         \r\n-        if (data.error) throw new Error(data.error);\r\n+        if (data.error) {\r\n+            showModalNotification(data.error, 'danger', 'Error');\r\n+            return;\r\n+        }\r\n \r\n         // Update localStorage with new info\r\n         user.full_name = fullName;\r\n+        user.username = username;\r\n         user.email = email;\r\n+        user.phone = phone;\r\n         localStorage.setItem('loggedInUser', JSON.stringify(user));\r\n \r\n         // Update UI\r\n         const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };\r\n@@ -2330,9 +3255,9 @@\n         const headerUserName = document.querySelector('.navbar .dropdown-toggle');\r\n         if (headerUserName) headerUserName.innerHTML = `<i class=\"fas fa-user-circle me-1\"></i>${fullName}`;\r\n \r\n         showModalNotification('Account updated successfully!', 'success', 'Success');\r\n-        logStaffActivity('Updated Account Info', `Name: ${fullName}`, 'Success');\r\n+        logStaffActivity('Updated Account Info', `Name: ${fullName}, Username: ${username}`, 'Success');\r\n     } catch (err) {\r\n         hideLoadingModal();\r\n         console.error('Failed to update account:', err);\r\n         showModalNotification('Failed to update account.', 'danger', 'Error');\r\n"
                }
            ],
            "date": 1771856401123,
            "name": "Commit-0",
            "content": "// Staff Dashboard JavaScript - Updated for Multi-page support\r\n\r\n// Global variables\r\nlet currentSaleItems = [];\r\nlet currentSaleId = null;\r\nlet allMenuItems = [];\r\nlet allIngredients = [];\r\nlet currentCustomer = null;\r\nlet currentDiscount = 0; // percentage\r\nlet currentCoupon = null;\r\n\r\n// DOM Ready\r\ndocument.addEventListener('DOMContentLoaded', function () {\r\n    // Initialize tooltips - only if bootstrap is available\r\n    if (typeof bootstrap !== 'undefined') {\r\n        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle=\"tooltip\"]'));\r\n        tooltipTriggerList.map(function (tooltipTriggerEl) {\r\n            return new bootstrap.Tooltip(tooltipTriggerEl);\r\n        });\r\n    }\r\n\r\n    // Initialize only the sections present on the current page\r\n    initializeCommonStaffFeatures();\r\n\r\n    // Auto-initialize based on elements present\r\n    if (document.getElementById('menuItemsGrid')) initializeMenuFunctionality();\r\n    if (document.getElementById('ingredientsListTable') || document.getElementById('ingredientsTable')) initializeIngredientsFunctionality();\r\n    if (document.getElementById('recentReceipts')) initializeReceiptsFunctionality();\r\n    if (document.getElementById('changePasswordForm')) initializeAccountFunctionality();\r\n    if (document.getElementById('activityLogTable')) initializeActivityLogFunctionality();\r\n\r\n    // Start background sync\r\n    setInterval(refreshUserData, 15000); // 15 seconds\r\n});\r\n\r\n// // Aliases for compatibility with separate pages\r\n// // const loadMenuItems = () => initializeMenuFunctionality();\r\n// const loadMenuItemsData = () => loadMenuItems();\r\n// // const loadIngredients = () => initializeIngredientsFunctionality();\r\n// const loadIngredientsData = () => loadIngredients();\r\nconst loadReceipts = () => initializeReceiptsFunctionality();\r\n// const loadRecentReceipts = () => initializeReceiptsFunctionality();\r\n// const loadAccountInfo = () => initializeAccountFunctionality();\r\n// const loadActivityLog = () => initializeActivityLogFunctionality();\r\n\r\n// Common features for all staff pages\r\nfunction initializeCommonStaffFeatures() {\r\n    // Update logged in user name in header\r\n    const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n    const headerUserName = document.querySelector('.navbar .dropdown-toggle');\r\n    if (headerUserName && user.full_name) {\r\n        headerUserName.innerHTML = `<i class=\"fas fa-user-circle me-1\"></i>${user.full_name}`;\r\n    }\r\n\r\n    // Logout button (global)\r\n    const logoutBtn = document.getElementById('logoutBtn');\r\n    if (logoutBtn) {\r\n        logoutBtn.addEventListener('click', function (e) {\r\n            e.preventDefault();\r\n            showConfirm('Are you sure you want to logout?', function () {\r\n                localStorage.removeItem('loggedInRole');\r\n                localStorage.removeItem('loggedInUser');\r\n                window.location.href = 'index.html';\r\n            });\r\n        });\r\n    }\r\n}\r\n\r\n// Menu Sales Functions\r\nfunction initializeMenuFunctionality() {\r\n    // Category Tabs functionality\r\n    const categoryTabs = document.querySelectorAll('.btn-category');\r\n    categoryTabs.forEach(tab => {\r\n        tab.addEventListener('click', function () {\r\n            categoryTabs.forEach(t => t.classList.remove('active'));\r\n            this.classList.add('active');\r\n            filterMenuItems();\r\n        });\r\n    });\r\n\r\n    // Search functionality\r\n    const menuSearch = document.getElementById('menuSearch');\r\n    if (menuSearch) {\r\n        menuSearch.addEventListener('input', filterMenuItems);\r\n    }\r\n\r\n    // Cart action buttons\r\n    const clearSaleBtn = document.getElementById('clearSaleBtn');\r\n    if (clearSaleBtn) {\r\n        clearSaleBtn.addEventListener('click', function () {\r\n            showConfirm('Are you sure you want to clear the cart?', clearCurrentSale);\r\n        });\r\n    }\r\n\r\n    const checkoutBtn = document.getElementById('checkoutBtn');\r\n    if (checkoutBtn) {\r\n        checkoutBtn.addEventListener('click', function () {\r\n            processCheckout();\r\n        });\r\n    }\r\n\r\n    // New POS Feature Buttons\r\n    const selectCustomerBtn = document.getElementById('selectCustomerBtn');\r\n    if (selectCustomerBtn) {\r\n        selectCustomerBtn.addEventListener('click', selectCustomer);\r\n    }\r\n\r\n    const discountBtn = document.getElementById('discountBtn');\r\n    if (discountBtn) {\r\n        discountBtn.addEventListener('click', applyDiscount);\r\n    }\r\n\r\n    const couponBtn = document.getElementById('couponBtn');\r\n    if (couponBtn) {\r\n        couponBtn.addEventListener('click', applyCoupon);\r\n    }\r\n\r\n    const holdOrderBtn = document.getElementById('holdOrderBtn');\r\n    if (holdOrderBtn) {\r\n        holdOrderBtn.addEventListener('click', holdOrder);\r\n    }\r\n\r\n    const returnOrderBtn = document.getElementById('returnOrderBtn');\r\n    if (returnOrderBtn) {\r\n        returnOrderBtn.addEventListener('click', handleReturn);\r\n    }\r\n\r\n    // Load initial data\r\n    loadMenuItems();\r\n    updateSaleDisplay();\r\n}\r\n\r\n// POS Feature Implementations\r\nfunction selectCustomer() {\r\n    Swal.fire({\r\n        title: 'Select Customer',\r\n        input: 'text',\r\n        inputLabel: 'Enter Customer Name',\r\n        inputPlaceholder: 'Search or add new customer...',\r\n        showCancelButton: true,\r\n        confirmButtonColor: '#800000',\r\n    }).then((result) => {\r\n        if (result.isConfirmed && result.value) {\r\n            currentCustomer = result.value;\r\n            showModalNotification(`Customer \"${currentCustomer}\" selected.`, 'success', 'Customer Selected');\r\n            updateSaleDisplay();\r\n            logStaffActivity('Selected Customer', currentCustomer, 'Success');\r\n        }\r\n    });\r\n}\r\n\r\nfunction applyDiscount() {\r\n    Swal.fire({\r\n        title: 'Apply Discount',\r\n        input: 'number',\r\n        inputLabel: 'Enter Discount Percentage (%)',\r\n        inputPlaceholder: '0',\r\n        inputAttributes: { min: 0, max: 100 },\r\n        showCancelButton: true,\r\n        confirmButtonColor: '#800000',\r\n    }).then((result) => {\r\n        if (result.isConfirmed) {\r\n            currentDiscount = parseFloat(result.value) || 0;\r\n            updateSaleDisplay();\r\n            logStaffActivity('Applied Discount', `${currentDiscount}%`, 'Success');\r\n        }\r\n    });\r\n}\r\n\r\nfunction applyCoupon() {\r\n    Swal.fire({\r\n        title: 'Apply Coupon',\r\n        input: 'text',\r\n        inputLabel: 'Enter Coupon Code',\r\n        inputPlaceholder: 'SAVE10, FREE50, etc.',\r\n        showCancelButton: true,\r\n        confirmButtonColor: '#800000',\r\n    }).then((result) => {\r\n        if (result.isConfirmed) {\r\n            const code = result.value.toUpperCase();\r\n            if (code === 'SAVE10') {\r\n                currentCoupon = { code: 'SAVE10', type: 'percentage', value: 10 };\r\n                showModalNotification('Coupon \"SAVE10\" (10% Off) applied!', 'success', 'Coupon Applied');\r\n            } else if (code === 'FREE50') {\r\n                currentCoupon = { code: 'FREE50', type: 'fixed', value: 50 };\r\n                showModalNotification('Coupon \"FREE50\" (P50 Off) applied!', 'success', 'Coupon Applied');\r\n            } else {\r\n                Swal.fire('Invalid Coupon', 'The coupon code entered is not valid.', 'error');\r\n                return;\r\n            }\r\n            updateSaleDisplay();\r\n            logStaffActivity('Applied Coupon', code, 'Success');\r\n        }\r\n    });\r\n}\r\n\r\nfunction holdOrder() {\r\n    if (currentSaleItems.length === 0) {\r\n        Swal.fire('Error', 'Cart is empty. Nothing to hold.', 'error');\r\n        return;\r\n    }\r\n\r\n    const heldOrders = JSON.parse(localStorage.getItem('heldOrders')) || [];\r\n    const newHold = {\r\n        id: 'HOLD-' + Date.now(),\r\n        timestamp: Date.now(),\r\n        items: [...currentSaleItems],\r\n        customer: currentCustomer,\r\n        discount: currentDiscount,\r\n        coupon: currentCoupon\r\n    };\r\n\r\n    heldOrders.push(newHold);\r\n    localStorage.setItem('heldOrders', JSON.stringify(heldOrders));\r\n\r\n    showModalNotification('Order has been put on hold.', 'info', 'Order Held');\r\n    logStaffActivity('Held Order', newHold.id, 'Success');\r\n    clearCurrentSale();\r\n}\r\n\r\nfunction handleReturn() {\r\n    // Show recent sales to select for return\r\n    const sales = JSON.parse(localStorage.getItem('sales')) || [];\r\n    if (sales.length === 0) {\r\n        Swal.fire('No Transactions', 'No recent transactions found to return.', 'info');\r\n        return;\r\n    }\r\n\r\n    const inputOptions = {};\r\n    sales.slice(0, 10).forEach(s => {\r\n        inputOptions[s.id] = `${s.id} - P${s.total.toFixed(2)} (${s.time})`;\r\n    });\r\n\r\n    Swal.fire({\r\n        title: 'Select Transaction to Return',\r\n        input: 'select',\r\n        inputOptions: inputOptions,\r\n        inputPlaceholder: 'Select a receipt...',\r\n        showCancelButton: true,\r\n        confirmButtonColor: '#800000',\r\n    }).then((result) => {\r\n        if (result.isConfirmed && result.value) {\r\n            const saleId = result.value;\r\n            Swal.fire({\r\n                title: 'Confirm Return',\r\n                text: `Are you sure you want to process a return for ${saleId}?`,\r\n                icon: 'warning',\r\n                showCancelButton: true,\r\n                confirmButtonColor: '#d33',\r\n                confirmButtonText: 'Yes, Return'\r\n            }).then((confirm) => {\r\n                if (confirm.isConfirmed) {\r\n                    // Logic to mark as returned or remove\r\n                    let updatedSales = sales.filter(s => s.id !== saleId);\r\n                    localStorage.setItem('sales', JSON.stringify(updatedSales));\r\n                    showModalNotification('Transaction successfully returned and voided.', 'success', 'Return Processed');\r\n                    logStaffActivity('Processed Return', saleId, 'Success');\r\n                }\r\n            });\r\n        }\r\n    });\r\n}\r\n\r\nfunction loadMenuItems() {\r\n    const menuGrid = document.getElementById('menuItemsGrid');\r\n    if (!menuGrid) return;\r\n\r\n    // Show loading\r\n    menuGrid.innerHTML = '<div class=\"col-12 text-center py-5\"><div class=\"loading-spinner\"></div><p class=\"mt-2\">Fetching menu from system...</p></div>';\r\n\r\n    // Simulate real-time fetch from Admin/DB\r\n    setTimeout(() => {\r\n        // Try to load from \"adminMenuItems\" (synced from admin) if available\r\n        const savedMenu = JSON.parse(localStorage.getItem('adminMenuItems'));\r\n\r\n        if (savedMenu && savedMenu.length > 0) {\r\n            allMenuItems = savedMenu;\r\n        } else {\r\n            // Default demo items if none in storage\r\n            allMenuItems = [\r\n                { id: 1, name: 'Beef Steak', category: 'Main Course', price: 450, image: 'https://images.unsplash.com/photo-1600891964092-4316c288032e?w=400&h=300&fit=crop', available: true },\r\n                { id: 2, name: 'Chicken Curry', category: 'Main Course', price: 320, image: 'https://images.unsplash.com/photo-1603894584373-5ac82b2ae398?w=400&h=300&fit=crop', available: true },\r\n                { id: 3, name: 'Vegetable Salad', category: 'Appetizer', price: 180, image: 'https://images.unsplash.com/photo-1540420773420-3366772f4999?w=400&h=300&fit=crop', available: true },\r\n                { id: 4, name: 'Garlic Bread', category: 'Appetizer', price: 120, image: 'https://images.unsplash.com/photo-1573140247632-f8fd74997d5c?w=400&h=300&fit=crop', available: true },\r\n                { id: 5, name: 'French Fries', category: 'Side Dish', price: 95, image: 'https://images.unsplash.com/photo-1576107232684-1279f390859f?w=400&h=300&fit=crop', available: true },\r\n                { id: 6, name: 'Pasta Carbonara', category: 'Main Course', price: 280, image: 'https://images.unsplash.com/photo-1598866594230-a7c12756260f?w=400&h=300&fit=crop', available: true },\r\n                { id: 7, name: 'Chocolate Cake', category: 'Dessert', price: 150, image: 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=400&h=300&fit=crop', available: true },\r\n                { id: 8, name: 'Fruit Shake', category: 'Beverage', price: 85, image: 'https://images.unsplash.com/photo-1544145945-f904253d0c71?w=400&h=300&fit=crop', available: true }\r\n            ];\r\n            localStorage.setItem('adminMenuItems', JSON.stringify(allMenuItems));\r\n        }\r\n\r\n        displayMenuItems(allMenuItems);\r\n    }, 600);\r\n}\r\n\r\nfunction displayMenuItems(items) {\r\n    const menuGrid = document.getElementById('menuItemsGrid');\r\n    if (!menuGrid) return;\r\n\r\n    menuGrid.innerHTML = '';\r\n\r\n    if (items.length === 0) {\r\n        menuGrid.innerHTML = '<div class=\"col-12 text-center py-5\"><i class=\"fas fa-search fa-3x text-muted mb-3\"></i><p class=\"text-muted\">No items found matching your filter</p></div>';\r\n        return;\r\n    }\r\n\r\n    items.forEach(item => {\r\n        const col = document.createElement('div');\r\n        col.className = 'col-6 col-md-4 col-lg-3 mb-3';\r\n\r\n        const imgSrc = item.image || 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400&h=300&fit=crop';\r\n\r\n        col.innerHTML = `\r\n            <div class=\"menu-item-card\" data-id=\"${item.id}\" onclick=\"addItemToSale(${item.id})\">\r\n                <div class=\"menu-item-img-container\">\r\n                    <img src=\"${imgSrc}\" alt=\"${item.name}\" class=\"menu-item-img\">\r\n                    <div class=\"price-tag\">P${parseFloat(item.price).toFixed(2)}</div>\r\n                </div>\r\n                <div class=\"p-2 text-center\">\r\n                    <div class=\"fw-bold mb-0 text-truncate\" style=\"font-size: 0.85rem\">${item.name}</div>\r\n                </div>\r\n            </div>\r\n        `;\r\n\r\n        menuGrid.appendChild(col);\r\n    });\r\n}\r\n\r\nfunction filterMenuItems() {\r\n    const searchTerm = document.getElementById('menuSearch')?.value.toLowerCase() || '';\r\n    const activeTab = document.querySelector('.btn-category.active');\r\n    const category = activeTab ? activeTab.getAttribute('data-category') : 'All';\r\n\r\n    const filtered = allMenuItems.filter(item =>\r\n        item.name.toLowerCase().includes(searchTerm) &&\r\n        (category === 'All' || item.category === category)\r\n    );\r\n    displayMenuItems(filtered);\r\n}\r\n\r\nfunction addItemToSale(itemId) {\r\n    const product = allMenuItems.find(item => item.id == itemId);\r\n    if (!product) return;\r\n\r\n    const existingItem = currentSaleItems.find(item => item.id == itemId);\r\n    if (existingItem) {\r\n        existingItem.quantity += 1;\r\n    } else {\r\n        currentSaleItems.push({\r\n            id: product.id,\r\n            name: product.name,\r\n            price: product.price,\r\n            img: product.image,\r\n            quantity: 1\r\n        });\r\n    }\r\n    updateSaleDisplay();\r\n\r\n    // Tiny toast or visual feedback\r\n    const card = document.querySelector(`.menu-item-card[data-id=\"${itemId}\"]`);\r\n    if (card) {\r\n        card.classList.add('animate-add');\r\n        setTimeout(() => card.classList.remove('animate-add'), 400);\r\n    }\r\n}\r\n\r\nfunction updateSaleDisplay() {\r\n    const container = document.getElementById('cartItemsList');\r\n    const subtotalEl = document.getElementById('cartSubtotal');\r\n    const taxEl = document.getElementById('cartTaxes');\r\n    const totalEl = document.getElementById('cartTotal');\r\n    const cartCountEl = document.getElementById('cartCount');\r\n    const checkoutBtn = document.getElementById('checkoutBtn');\r\n\r\n    if (!container) return;\r\n\r\n    // Update Customer Display in Sidebar if exists\r\n    const customerDisplay = document.querySelector('.customer-name-display');\r\n    if (customerDisplay) {\r\n        customerDisplay.textContent = currentCustomer || 'Walk-in Customer';\r\n    }\r\n\r\n    if (currentSaleItems.length === 0) {\r\n        container.innerHTML = `<div class=\"text-center py-5 empty-cart-msg\"><p class=\"text-muted\">No items in cart</p></div>`;\r\n        subtotalEl.textContent = 'P0.00';\r\n        taxEl.textContent = 'P0.00';\r\n        totalEl.textContent = 'P0.00';\r\n        cartCountEl.textContent = '0';\r\n        checkoutBtn.disabled = true;\r\n        return;\r\n    }\r\n\r\n    let subtotal = 0;\r\n    let itemsCount = 0;\r\n    let itemsHtml = '';\r\n\r\n    currentSaleItems.forEach((item, index) => {\r\n        subtotal += item.price * item.quantity;\r\n        itemsCount += item.quantity;\r\n        itemsHtml += `\r\n            <div class=\"cart-item\">\r\n                <div class=\"cart-item-details\">\r\n                    <span class=\"cart-item-name\">${item.name}</span>\r\n                    <span class=\"cart-item-price\">P${(item.price * item.quantity).toFixed(2)}</span>\r\n                </div>\r\n                <div class=\"qty-controls\">\r\n                    <button class=\"btn-qty\" onclick=\"changeQty(${index}, -1)\"><i class=\"fas fa-minus\"></i></button>\r\n                    <span class=\"fw-bold mx-1\">${item.quantity}</span>\r\n                    <button class=\"btn-qty\" onclick=\"changeQty(${index}, 1)\"><i class=\"fas fa-plus\"></i></button>\r\n                    <button class=\"cart-item-remove ms-2\" onclick=\"removeSaleItem(${index})\"><i class=\"fas fa-trash-alt\"></i></button>\r\n                </div>\r\n            </div>\r\n        `;\r\n    });\r\n\r\n    // Apply Discount\r\n    let discountAmount = (subtotal * (currentDiscount / 100));\r\n\r\n    // Apply Coupon\r\n    if (currentCoupon) {\r\n        if (currentCoupon.type === 'percentage') {\r\n            discountAmount += (subtotal * (currentCoupon.value / 100));\r\n        } else {\r\n            discountAmount += currentCoupon.value;\r\n        }\r\n    }\r\n\r\n    const discountedSubtotal = Math.max(0, subtotal - discountAmount);\r\n    const taxes = discountedSubtotal * 0.12;\r\n    const total = discountedSubtotal + taxes;\r\n\r\n    container.innerHTML = itemsHtml;\r\n    subtotalEl.textContent = 'P' + subtotal.toFixed(2);\r\n\r\n    // Display Discounts if any\r\n    if (discountAmount > 0) {\r\n        subtotalEl.innerHTML += ` <span class=\"text-danger small\">( -P${discountAmount.toFixed(2)} )</span>`;\r\n    }\r\n\r\n    taxEl.textContent = 'P' + taxes.toFixed(2);\r\n    totalEl.textContent = 'P' + total.toFixed(2);\r\n    cartCountEl.textContent = itemsCount;\r\n    checkoutBtn.disabled = false;\r\n}\r\n\r\nfunction changeQty(index, delta) {\r\n    currentSaleItems[index].quantity += delta;\r\n    if (currentSaleItems[index].quantity <= 0) {\r\n        currentSaleItems.splice(index, 1);\r\n    }\r\n    updateSaleDisplay();\r\n}\r\n\r\nfunction removeSaleItem(index) {\r\n    currentSaleItems.splice(index, 1);\r\n    updateSaleDisplay();\r\n}\r\n\r\nfunction clearCurrentSale() {\r\n    currentSaleItems = [];\r\n    currentCustomer = null;\r\n    currentDiscount = 0;\r\n    currentCoupon = null;\r\n    updateSaleDisplay();\r\n}\r\n\r\nfunction processCheckout() {\r\n    if (currentSaleItems.length === 0) return;\r\n\r\n    Swal.fire({\r\n        title: 'Confirm Checkout',\r\n        text: `Total Amount: ${document.getElementById('cartTotal').textContent}`,\r\n        icon: 'question',\r\n        showCancelButton: true,\r\n        confirmButtonColor: '#800000',\r\n        cancelButtonColor: '#6c757d',\r\n        confirmButtonText: 'Confirm'\r\n    }).then((result) => {\r\n        if (result.isConfirmed) {\r\n            recordSale();\r\n        }\r\n    });\r\n}\r\n\r\nfunction recordSale() {\r\n    const subtotal = currentSaleItems.reduce((acc, item) => acc + (item.price * item.quantity), 0);\r\n    let discountAmt = (subtotal * (currentDiscount / 100));\r\n    if (currentCoupon) {\r\n        discountAmt += (currentCoupon.type === 'percentage' ? (subtotal * (currentCoupon.value / 100)) : currentCoupon.value);\r\n    }\r\n    const finalSubtotal = Math.max(0, subtotal - discountAmt);\r\n    const taxes = finalSubtotal * 0.12;\r\n    const total = finalSubtotal + taxes;\r\n\r\n    const newSale = {\r\n        id: 'SALE-' + Date.now(),\r\n        date: new Date().toISOString().split('T')[0],\r\n        time: new Date().toLocaleTimeString(),\r\n        timestamp: Date.now(),\r\n        items: [...currentSaleItems],\r\n        subtotal: subtotal,\r\n        discount: discountAmt,\r\n        taxes: taxes,\r\n        total: total,\r\n        customer: currentCustomer || 'Walk-in',\r\n        staff: 'Staff Account'\r\n    };\r\n\r\n    // Save to sales history\r\n    let sales = JSON.parse(localStorage.getItem('sales')) || [];\r\n    sales.unshift(newSale); // Newest first\r\n    localStorage.setItem('sales', JSON.stringify(sales));\r\n\r\n    // Dedut ingredients (Simulated sync with inventory)\r\n    updateIngredientsStock(currentSaleItems);\r\n    logStaffActivity('Recorded Sale', `${newSale.id} - Total: P${newSale.total.toFixed(2)} - Customer: ${newSale.customer}`, 'Success');\r\n\r\n    Swal.fire('Success!', 'Transaction recorded.', 'success');\r\n\r\n    clearCurrentSale();\r\n}\r\n\r\n// Real-time listener for Admin changes\r\nwindow.addEventListener('storage', (e) => {\r\n    if (e.key === 'adminMenuItems') {\r\n        console.log(\"Admin updated menu, refreshing POS...\");\r\n        loadMenuItems();\r\n    }\r\n});\r\n\r\nfunction updateIngredientsStock(saleItems) {\r\n    let ingredients = JSON.parse(localStorage.getItem('ingredients')) || [];\r\n    let recipes = JSON.parse(localStorage.getItem('adminRecipes')) || [];\r\n\r\n    saleItems.forEach(saleItem => {\r\n        // Find recipe for this menu item\r\n        const recipe = recipes.find(r => r.menuItem === saleItem.name);\r\n        if (recipe) {\r\n            recipe.ingredients.forEach(recIng => {\r\n                const ing = ingredients.find(i => i.name === recIng.name);\r\n                if (ing) {\r\n                    ing.quantity -= (recIng.qty * saleItem.quantity);\r\n                    if (ing.quantity < 0) ing.quantity = 0;\r\n                }\r\n            });\r\n        }\r\n    });\r\n\r\n    localStorage.setItem('ingredients', JSON.stringify(ingredients));\r\n}\r\n\r\n// Global Activity Logging - Connects to Admin's systemActivityLogs\r\nfunction logStaffActivity(action, details, status) {\r\n    let logs = [];\r\n    try {\r\n        const stored = localStorage.getItem('systemActivityLogs');\r\n        if (stored) logs = JSON.parse(stored);\r\n    } catch (e) { logs = []; }\r\n\r\n    const now = new Date();\r\n    const pad = n => String(n).padStart(2, '0');\r\n    const ts = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;\r\n\r\n    const newLog = {\r\n        id: Date.now(),\r\n        userName: 'Staff User', // Could be dynamic based on login\r\n        action: action,\r\n        reference: details,\r\n        timestamp: ts,\r\n        category: action.includes('Sale') || action.includes('Return') ? 'Sales' : 'Staff',\r\n        ip: '192.168.1.10'\r\n    };\r\n\r\n    logs.unshift(newLog);\r\n    if (logs.length > 500) logs = logs.slice(0, 500);\r\n    localStorage.setItem('systemActivityLogs', JSON.stringify(logs));\r\n}\r\n\r\n// Ingredients Functions\r\nfunction initializeIngredientsFunctionality() {\r\n    const searchInput = document.getElementById('ingredientSearch');\r\n    if (searchInput) {\r\n        searchInput.addEventListener('input', filterIngredients);\r\n    }\r\n\r\n    const categoryFilter = document.getElementById('ingredientCategoryFilter');\r\n    if (categoryFilter) {\r\n        categoryFilter.addEventListener('change', filterIngredients);\r\n    }\r\n\r\n    loadIngredients();\r\n}\r\n\r\nfunction loadIngredients() {\r\n    console.log(\"‚úÖ loadIngredients() called\");\r\n\r\n    const tableElem =\r\n        document.getElementById('ingredientsListTable') ||\r\n        document.getElementById('ingredientsTable');\r\n\r\n    console.log(\"üîé Table element found:\", tableElem);\r\n\r\n    if (!tableElem) {\r\n        console.warn(\"‚ùå Table element not found!\");\r\n        return;\r\n    }\r\n\r\n    const tbody = tableElem.querySelector('tbody');\r\n    console.log(\"üîé tbody:\", tbody);\r\n\r\n    if (!tbody) {\r\n        console.warn(\"‚ùå tbody not found!\");\r\n        return;\r\n    }\r\n\r\n    tbody.innerHTML = '<tr><td colspan=\"6\" class=\"text-center py-4\">Loading...</td></tr>';\r\n\r\n    setTimeout(() => {\r\n        console.log(\"üì¶ Setting ingredient data\");\r\n\r\n        allIngredients = [\r\n            { id: 1, name: 'Beef', category: 'Meat', quantity: 15, unit: 'kg', status: 'Normal', minLevel: 5 },\r\n            { id: 2, name: 'Chicken', category: 'Meat', quantity: 8, unit: 'kg', status: 'Low', minLevel: 10 },\r\n            { id: 3, name: 'Onions', category: 'Vegetables', quantity: 3, unit: 'kg', status: 'Low', minLevel: 5 },\r\n            { id: 4, name: 'Cheese', category: 'Dairy', quantity: 4, unit: 'kg', status: 'Low', minLevel: 5 },\r\n            { id: 5, name: 'Garlic', category: 'Spices', quantity: 1, unit: 'kg', status: 'Low', minLevel: 2 },\r\n            { id: 6, name: 'Cooking Oil', category: 'Supplies', quantity: 2, unit: 'L', status: 'Low', minLevel: 5 },\r\n            { id: 7, name: 'Red Wine', category: 'Beverages', quantity: 1, unit: 'bottle', status: 'Low', minLevel: 3 }\r\n        ];\r\n\r\n        displayIngredients(allIngredients);\r\n\r\n    }, 500);\r\n}\r\n\r\n\r\nfunction displayIngredients(ingredients) {\r\n    const tableElem = document.getElementById('ingredientsListTable') || document.getElementById('ingredientsTable');\r\n    if (!tableElem) return;\r\n\r\n    const tbody = tableElem.getElementsByTagName('tbody')[0];\r\n    if (!tbody) return;\r\n\r\n    tbody.innerHTML = '';\r\n    ingredients.forEach(ing => {\r\n        const row = tbody.insertRow();\r\n        row.innerHTML = `\r\n            <td>${ing.name}</td>\r\n            <td>${ing.category}</td>\r\n            <td>${ing.quantity} ${ing.unit}</td>\r\n            <td>${ing.minLevel || '-'}</td>\r\n            <td><span class=\"badge ${ing.status === 'Normal' ? 'bg-success' : 'bg-warning'}\">${ing.status}</span></td>\r\n            <td><button class=\"btn btn-sm btn-outline-maroon\" onclick=\"showUpdateModal(${ing.id})\">Update</button></td>\r\n        `;\r\n    });\r\n}\r\n\r\nfunction showUpdateModal(id) {\r\n    // Logic to show update modal\r\n    const modal = new bootstrap.Modal(document.getElementById('updateQuantityModal') || document.getElementById('increaseQuantityModal'));\r\n    modal.show();\r\n}\r\n\r\nfunction filterIngredients() {\r\n    const searchTerm = document.getElementById('ingredientSearch')?.value.toLowerCase() || '';\r\n    const category = document.getElementById('ingredientCategoryFilter')?.value || '';\r\n\r\n    const filtered = allIngredients.filter(ing =>\r\n        ing.name.toLowerCase().includes(searchTerm) &&\r\n        (category === '' || ing.category === category)\r\n    );\r\n    displayIngredients(filtered);\r\n}\r\n\r\n// Receipts Functions\r\nfunction initializeReceiptsFunctionality() {\r\n    loadRecentReceipts();\r\n}\r\n\r\nfunction loadRecentReceipts() {\r\n    const container = document.getElementById('recentReceipts');\r\n    if (!container) return;\r\n\r\n    container.innerHTML = '<a href=\"#\" class=\"list-group-item list-group-item-action\">No recent receipts</a>';\r\n}\r\n\r\n// Account Functions\r\nfunction initializeAccountFunctionality() {\r\n    loadAccountData();\r\n\r\n    const editBtn = document.getElementById('editAccountBtn');\r\n    const sendBtn = document.getElementById('sendAccountRequestBtn');\r\n\r\n    if (editBtn) {\r\n        editBtn.addEventListener('click', function () {\r\n            toggleAccountEdit();\r\n        });\r\n    }\r\n\r\n    if (sendBtn) {\r\n        sendBtn.addEventListener('click', async function () {\r\n            const fullName = document.getElementById('accFullName').value.trim();\r\n            const email = document.getElementById('accEmail').value.trim();\r\n            const currentPass = document.getElementById('currentPass').value;\r\n            const newPass = document.getElementById('newPass').value;\r\n            const confirmPass = document.getElementById('confirmPass').value;\r\n\r\n            // Determine what's being requested\r\n            if (fullName || email) {\r\n                await saveAccountInfo();\r\n            }\r\n\r\n            if (currentPass || newPass || confirmPass) {\r\n                await handlePasswordUpdate();\r\n            }\r\n\r\n            // After sending, lock back\r\n            toggleAccountEdit(false);\r\n        });\r\n    }\r\n}\r\n\r\nfunction toggleAccountEdit(forceState) {\r\n    const editBtn = document.getElementById('editAccountBtn');\r\n    const sendBtn = document.getElementById('sendAccountRequestBtn');\r\n    const inputs = document.querySelectorAll('#accountInfoForm input, #changePasswordForm input:not(#accUsername)');\r\n\r\n    const isLocked = forceState !== undefined ? !forceState : editBtn.classList.contains('btn-outline-maroon');\r\n\r\n    if (isLocked) {\r\n        // Unlock\r\n        editBtn.classList.remove('btn-outline-maroon');\r\n        editBtn.classList.add('btn-maroon');\r\n        editBtn.innerHTML = '<i class=\"fas fa-times me-1\"></i> Cancel';\r\n        sendBtn.classList.remove('d-none');\r\n        inputs.forEach(input => {\r\n            if (input.id !== 'accUsername') input.disabled = false;\r\n        });\r\n    } else {\r\n        // Lock\r\n        editBtn.classList.add('btn-outline-maroon');\r\n        editBtn.classList.remove('btn-maroon');\r\n        editBtn.innerHTML = '<i class=\"fas fa-edit me-1\"></i> Edit';\r\n        sendBtn.classList.add('d-none');\r\n        inputs.forEach(input => input.disabled = true);\r\n        loadAccountData(); // Reset values\r\n        document.getElementById('changePasswordForm').reset();\r\n    }\r\n}\r\n\r\nfunction loadAccountData() {\r\n    const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n    if (!user.id) return;\r\n\r\n    // Sidebar/Header Info\r\n    const profFullName = document.getElementById('profFullName');\r\n    if (profFullName) profFullName.textContent = user.full_name;\r\n\r\n    const profRole = document.getElementById('profRole');\r\n    if (profRole) profRole.textContent = user.role_name || 'Staff Member';\r\n\r\n    const profEmployeeId = document.getElementById('profEmployeeId');\r\n    if (profEmployeeId) profEmployeeId.textContent = `STF-${user.id.toString().padStart(5, '0')}`;\r\n\r\n    const profJoinDate = document.getElementById('profJoinDate');\r\n    if (profJoinDate && user.created_at) {\r\n        const date = new Date(user.created_at);\r\n        const options = { year: 'numeric', month: 'long', day: 'numeric' };\r\n        profJoinDate.textContent = date.toLocaleDateString(undefined, options);\r\n    }\r\n\r\n    const profStatus = document.getElementById('profStatus');\r\n    if (profStatus) {\r\n        profStatus.innerHTML = `<i class=\"fas fa-check-circle me-2\"></i>${user.status || 'Active'}`;\r\n    }\r\n\r\n    const profActivityName = document.getElementById('profActivityName');\r\n    if (profActivityName) profActivityName.textContent = user.full_name;\r\n\r\n    // Form inputs\r\n    const fullNameInput = document.getElementById('accFullName');\r\n    if (fullNameInput) fullNameInput.value = user.full_name || '';\r\n\r\n    const usernameInput = document.getElementById('accUsername');\r\n    if (usernameInput) usernameInput.value = user.username || '';\r\n\r\n    const emailInput = document.getElementById('accEmail');\r\n    if (emailInput) emailInput.value = user.email || '';\r\n}\r\n\r\nasync function saveAccountInfo() {\r\n    const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n    const newFullName = document.getElementById('accFullName').value.trim();\r\n    const newEmail = document.getElementById('accEmail').value.trim();\r\n\r\n    if (!newFullName) {\r\n        showModalNotification('Full Name is required', 'warning', 'Validation');\r\n        return;\r\n    }\r\n\r\n    const payload = JSON.stringify({\r\n        full_name: newFullName,\r\n        email: newEmail\r\n    });\r\n\r\n    try {\r\n        const res = await fetch(\\\"/php/app.php\\\", {\r\n            method: \"POST\",\r\n            headers: { \"Content-Type\": \"application/json\" },\r\n            body: JSON.stringify({\r\n                table: 'requests_tbl',\r\n                type: 'account_update',\r\n                requester_id: user.id,\r\n                payload: payload,\r\n                status: 'Pending',\r\n                created_at: new Date().toISOString().slice(0, 19).replace('T', ' ')\r\n            })\r\n        });\r\n\r\n        const data = await res.json();\r\n        if (data.error) throw new Error(data.error);\r\n\r\n        showModalNotification('Update request sent to administrator for approval.', 'success', 'Request Sent');\r\n        logStaffActivity('Requested Account Update', `New Name: ${newFullName}`, 'Pending');\r\n    } catch (err) {\r\n        console.error('Failed to send request:', err);\r\n        showModalNotification('Failed to send update request.', 'danger', 'Error');\r\n    }\r\n}\r\n\r\nasync function handlePasswordUpdate() {\r\n    const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n    const currentPass = document.getElementById('currentPass').value;\r\n    const newPass = document.getElementById('newPass').value;\r\n    const confirmPass = document.getElementById('confirmPass').value;\r\n\r\n    if (!currentPass || !newPass || !confirmPass) {\r\n        showModalNotification('Please fill in all password fields', 'warning', 'Validation');\r\n        return;\r\n    }\r\n\r\n    if (newPass !== confirmPass) {\r\n        showModalNotification('New passwords do not match', 'warning', 'Validation');\r\n        return;\r\n    }\r\n\r\n    if (newPass.length < 6) {\r\n        showModalNotification('Password must be at least 6 characters', 'warning', 'Validation');\r\n        return;\r\n    }\r\n\r\n    const payload = JSON.stringify({\r\n        current_password: currentPass,\r\n        new_password: newPass\r\n    });\r\n\r\n    try {\r\n        const res = await fetch(\"/php/app.php\", {\r\n            method: \"POST\",\r\n            headers: { \"Content-Type\": \"application/json\" },\r\n            body: JSON.stringify({\r\n                table: 'requests_tbl',\r\n                type: 'password_change',\r\n                requester_id: user.id,\r\n                payload: payload,\r\n                status: 'Pending',\r\n                created_at: new Date().toISOString().slice(0, 19).replace('T', ' ')\r\n            })\r\n        });\r\n\r\n        const data = await res.json();\r\n        if (data.error) throw new Error(data.error);\r\n\r\n        showModalNotification('Password change request sent to administrator.', 'success', 'Request Sent');\r\n        logStaffActivity('Requested Password Change', '', 'Pending');\r\n        document.getElementById('changePasswordForm').reset();\r\n    } catch (err) {\r\n        console.error('Failed to send request:', err);\r\n        showModalNotification('Failed to send request.', 'danger', 'Error');\r\n    }\r\n}\r\n\r\n// Activity Log Functions\r\nfunction initializeActivityLogFunctionality() {\r\n    loadActivityLog();\r\n    // Real-time updates for Activity Log\r\n    setInterval(loadActivityLog, 10000); // Poll every 10 seconds\r\n}\r\n\r\nasync function logStaffActivity(action, reference, status = 'Success') {\r\n    const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n    if (!user.id) return;\r\n\r\n    try {\r\n        await fetch(\\\"/php/app.php\\\", {\r\n            method: \"POST\",\r\n            headers: { \"Content-Type\": \"application/json\" },\r\n            body: JSON.stringify({\r\n                table: 'activity_logs',\r\n                user_id: user.id,\r\n                role_label: user.role_name || 'Staff',\r\n                action: action,\r\n                reference: reference || 'N/A',\r\n                status: status,\r\n                ip_address: '127.0.0.1', // Placeholder or fetch if needed\r\n                created_at: new Date().toISOString().slice(0, 19).replace('T', ' ')\r\n            })\r\n        });\r\n        // If we are currently viewing the activity log, refresh it\r\n        if (document.getElementById('activityLogTable')) {\r\n            loadActivityLog();\r\n        }\r\n    } catch (e) {\r\n        console.error(\"Failed to log activity:\", e);\r\n    }\r\n}\r\n\r\nasync function loadActivityLog() {\r\n    const tableElem = document.getElementById('activityLogTable');\r\n    if (!tableElem) return;\r\n\r\n    const tbody = tableElem.getElementsByTagName('tbody')[0];\r\n    if (!tbody) return;\r\n\r\n    const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n    if (!user.id) return;\r\n\r\n    try {\r\n        const res = await fetch(`/php/app.php?table=activity_logs&user_id=${user.id}`);\r\n        let logs = await res.json();\r\n\r\n        if (!Array.isArray(logs)) {\r\n            console.error(\"Invalid logs data:\", logs);\r\n            return;\r\n        }\r\n\r\n        // Sort by date descending\r\n        logs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));\r\n\r\n        if (logs.length === 0) {\r\n            tbody.innerHTML = '<tr><td colspan=\"4\" class=\"text-center py-4\">No activity recorded yet.</td></tr>';\r\n            return;\r\n        }\r\n\r\n        tbody.innerHTML = logs.map(log => `\r\n            <tr>\r\n                <td>${log.created_at}</td>\r\n                <td>${log.action}</td>\r\n                <td>${log.reference}</td>\r\n                <td>\r\n                    <span class=\"badge ${log.status === 'Success' ? 'bg-success' : (log.status === 'Pending' ? 'bg-warning' : 'bg-danger')}\">\r\n                        ${log.status}\r\n                    </span>\r\n                </td>\r\n            </tr>\r\n        `).join('');\r\n\r\n    } catch (err) {\r\n        console.error('Failed to load activity logs:', err);\r\n    }\r\n}\r\n\r\nasync function refreshUserData() {\r\n    const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n    if (!user.id) return;\r\n\r\n    try {\r\n        const res = await fetch(`/php/app.php?table=users&id=${user.id}`);\r\n        const users = await res.json();\r\n        const dbUser = Array.isArray(users) ? users[0] : users;\r\n\r\n        if (dbUser && dbUser.id) {\r\n            // Check if anything significant changed (full_name, email)\r\n            if (dbUser.full_name !== user.full_name || dbUser.email !== user.email) {\r\n                // Merge and update\r\n                const updated = { ...user, ...dbUser };\r\n                localStorage.setItem('loggedInUser', JSON.stringify(updated));\r\n\r\n                // Refresh UI components\r\n                const headerUserName = document.querySelector('.navbar .dropdown-toggle');\r\n                if (headerUserName) {\r\n                    headerUserName.innerHTML = `<i class=\"fas fa-user-circle me-1\"></i>${dbUser.full_name}`;\r\n                }\r\n\r\n                if (document.getElementById('accountInfoForm')) {\r\n                    loadAccountData();\r\n                }\r\n            }\r\n        }\r\n    } catch (e) {\r\n        console.error(\"User data sync failed\", e);\r\n    }\r\n}\r\n\r\n// showModalNotification and showConfirm are defined in main.js ‚Äî not duplicated here\r\n"
        }
    ]
}