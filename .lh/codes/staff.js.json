{
    "sourceFile": "codes/staff.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 9,
            "patches": [
                {
                    "date": 1771856401123,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1771857565861,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -56,17 +56,37 @@\n     const logoutBtn = document.getElementById('logoutBtn');\r\n     if (logoutBtn) {\r\n         logoutBtn.addEventListener('click', function (e) {\r\n             e.preventDefault();\r\n-            showConfirm('Are you sure you want to logout?', function () {\r\n-                localStorage.removeItem('loggedInRole');\r\n-                localStorage.removeItem('loggedInUser');\r\n-                window.location.href = 'index.html';\r\n-            });\r\n+            performStaffLogout();\r\n         });\r\n     }\r\n+\r\n+    // Additional logout button on account section (dashboard)\r\n+    const logoutBtnAccount = document.getElementById('logoutBtnAccount');\r\n+    if (logoutBtnAccount) {\r\n+        logoutBtnAccount.addEventListener('click', function (e) {\r\n+            e.preventDefault();\r\n+            performStaffLogout();\r\n+        });\r\n+    }\r\n }\r\n \r\n+/**\r\n+ * Perform staff logout with activity logging\r\n+ */\r\n+function performStaffLogout() {\r\n+    showConfirm('Are you sure you want to logout?', function () {\r\n+        // Log the logout activity before clearing\r\n+        const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n+        logStaffActivity('Logged out', 'User session terminated', 'Success', user.id);\r\n+        \r\n+        localStorage.removeItem('loggedInRole');\r\n+        localStorage.removeItem('loggedInUser');\r\n+        window.location.href = 'index.html';\r\n+    });\r\n+}\r\n+\r\n // Menu Sales Functions\r\n function initializeMenuFunctionality() {\r\n     // Category Tabs functionality\r\n     const categoryTabs = document.querySelectorAll('.btn-category');\r\n"
                },
                {
                    "date": 1771858078961,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -71,19 +71,29 @@\n     }\r\n }\r\n \r\n /**\r\n- * Perform staff logout with activity logging\r\n+ * Perform staff logout with activity logging and status update\r\n  */\r\n function performStaffLogout() {\r\n     showConfirm('Are you sure you want to logout?', function () {\r\n-        // Log the logout activity before clearing\r\n+        // Get user info before clearing\r\n         const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n+        \r\n+        // Log the logout activity\r\n         logStaffActivity('Logged out', 'User session terminated', 'Success', user.id);\r\n         \r\n-        localStorage.removeItem('loggedInRole');\r\n-        localStorage.removeItem('loggedInUser');\r\n-        window.location.href = 'index.html';\r\n+        // Mark user as inactive\r\n+        updateUserStatus(user.id, 'inactive').then(() => {\r\n+            localStorage.removeItem('loggedInRole');\r\n+            localStorage.removeItem('loggedInUser');\r\n+            window.location.href = 'index.html';\r\n+        }).catch(err => {\r\n+            console.error('Failed to update status, but proceeding with logout:', err);\r\n+            localStorage.removeItem('loggedInRole');\r\n+            localStorage.removeItem('loggedInUser');\r\n+            window.location.href = 'index.html';\r\n+        });\r\n     });\r\n }\r\n \r\n // Menu Sales Functions\r\n@@ -1012,5 +1022,35 @@\n         console.error(\"User data sync failed\", e);\r\n     }\r\n }\r\n \r\n+/**\r\n+ * Update user status (active/inactive) in database\r\n+ * @param {number} userId - User ID\r\n+ * @param {string} status - 'active' or 'inactive'\r\n+ * @returns {Promise} - Resolves when status is updated\r\n+ */\r\n+async function updateUserStatus(userId, status) {\r\n+    try {\r\n+        const response = await fetch('/php/user_status.php', {\r\n+            method: 'POST',\r\n+            headers: { 'Content-Type': 'application/json' },\r\n+            body: JSON.stringify({\r\n+                user_id: userId,\r\n+                status: status\r\n+            })\r\n+        });\r\n+\r\n+        if (!response.ok) {\r\n+            throw new Error(`HTTP error! status: ${response.status}`);\r\n+        }\r\n+\r\n+        const data = await response.json();\r\n+        console.log(`‚úÖ User ${userId} marked as ${status}:`, data);\r\n+        return data;\r\n+    } catch (error) {\r\n+        console.error(`‚ùå Failed to update user status:`, error);\r\n+        throw error;\r\n+    }\r\n+}\r\n+\r\n // showModalNotification and showConfirm are defined in main.js ‚Äî not duplicated here\r\n"
                },
                {
                    "date": 1771858695284,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -51,45 +51,46 @@\n     if (headerUserName && user.full_name) {\r\n         headerUserName.innerHTML = `<i class=\"fas fa-user-circle me-1\"></i>${user.full_name}`;\r\n     }\r\n \r\n-    // Logout button (global)\r\n-    const logoutBtn = document.getElementById('logoutBtn');\r\n-    if (logoutBtn) {\r\n-        logoutBtn.addEventListener('click', function (e) {\r\n-            e.preventDefault();\r\n-            performStaffLogout();\r\n-        });\r\n-    }\r\n-\r\n-    // Additional logout button on account section (dashboard)\r\n-    const logoutBtnAccount = document.getElementById('logoutBtnAccount');\r\n-    if (logoutBtnAccount) {\r\n-        logoutBtnAccount.addEventListener('click', function (e) {\r\n-            e.preventDefault();\r\n-            performStaffLogout();\r\n-        });\r\n-    }\r\n+    // Logout button (global) - Handle both navbar and account page versions\r\n+    const logoutButtons = document.querySelectorAll('#logoutBtn, #logoutBtnAccount');\r\n+    logoutButtons.forEach(logoutBtn => {\r\n+        if (logoutBtn) {\r\n+            logoutBtn.addEventListener('click', function (e) {\r\n+                e.preventDefault();\r\n+                e.stopPropagation();\r\n+                performStaffLogout();\r\n+            });\r\n+        }\r\n+    });\r\n }\r\n \r\n /**\r\n  * Perform staff logout with activity logging and status update\r\n  */\r\n function performStaffLogout() {\r\n+    console.log('üîÑ Logout initiated - showing confirmation dialog');\r\n+    \r\n     showConfirm('Are you sure you want to logout?', function () {\r\n+        console.log('‚úÖ Logout confirmed by user');\r\n+        \r\n         // Get user info before clearing\r\n         const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n+        console.log('üìã User info retrieved:', user.id, user.full_name);\r\n         \r\n         // Log the logout activity\r\n-        logStaffActivity('Logged out', 'User session terminated', 'Success', user.id);\r\n+        logStaffActivity('Logged out', 'User session terminated', 'Success');\r\n         \r\n         // Mark user as inactive\r\n         updateUserStatus(user.id, 'inactive').then(() => {\r\n+            console.log('‚úÖ User marked as inactive');\r\n             localStorage.removeItem('loggedInRole');\r\n             localStorage.removeItem('loggedInUser');\r\n+            console.log('üîê Session cleared, redirecting to login...');\r\n             window.location.href = 'index.html';\r\n         }).catch(err => {\r\n-            console.error('Failed to update status, but proceeding with logout:', err);\r\n+            console.error('‚ùå Failed to update status, but proceeding with logout:', err);\r\n             localStorage.removeItem('loggedInRole');\r\n             localStorage.removeItem('loggedInUser');\r\n             window.location.href = 'index.html';\r\n         });\r\n"
                },
                {
                    "date": 1771859157837,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,177 +1,136 @@\n-// Staff Dashboard JavaScript - Updated for Multi-page support\r\n+// Staff Dashboard JavaScript - Fixed & Cleaned\r\n \r\n // Global variables\r\n let currentSaleItems = [];\r\n let currentSaleId = null;\r\n let allMenuItems = [];\r\n let allIngredients = [];\r\n let currentCustomer = null;\r\n-let currentDiscount = 0; // percentage\r\n+let currentDiscount = 0;\r\n let currentCoupon = null;\r\n \r\n // DOM Ready\r\n document.addEventListener('DOMContentLoaded', function () {\r\n-    // Initialize tooltips - only if bootstrap is available\r\n     if (typeof bootstrap !== 'undefined') {\r\n         const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle=\"tooltip\"]'));\r\n-        tooltipTriggerList.map(function (tooltipTriggerEl) {\r\n-            return new bootstrap.Tooltip(tooltipTriggerEl);\r\n-        });\r\n+        tooltipTriggerList.map(el => new bootstrap.Tooltip(el));\r\n     }\r\n \r\n-    // Initialize only the sections present on the current page\r\n     initializeCommonStaffFeatures();\r\n \r\n-    // Auto-initialize based on elements present\r\n-    if (document.getElementById('menuItemsGrid')) initializeMenuFunctionality();\r\n+    if (document.getElementById('menuItemsGrid'))                                       initializeMenuFunctionality();\r\n     if (document.getElementById('ingredientsListTable') || document.getElementById('ingredientsTable')) initializeIngredientsFunctionality();\r\n-    if (document.getElementById('recentReceipts')) initializeReceiptsFunctionality();\r\n-    if (document.getElementById('changePasswordForm')) initializeAccountFunctionality();\r\n-    if (document.getElementById('activityLogTable')) initializeActivityLogFunctionality();\r\n+    if (document.getElementById('recentReceipts'))                                      initializeReceiptsFunctionality();\r\n+    if (document.getElementById('changePasswordForm'))                                  initializeAccountFunctionality();\r\n+    if (document.getElementById('activityLogTable'))                                    initializeActivityLogFunctionality();\r\n \r\n-    // Start background sync\r\n-    setInterval(refreshUserData, 15000); // 15 seconds\r\n+    // Only poll user data on pages that show user info\r\n+    if (document.querySelector('.navbar .dropdown-toggle')) {\r\n+        setInterval(refreshUserData, 15000);\r\n+    }\r\n });\r\n \r\n-// // Aliases for compatibility with separate pages\r\n-// // const loadMenuItems = () => initializeMenuFunctionality();\r\n-// const loadMenuItemsData = () => loadMenuItems();\r\n-// // const loadIngredients = () => initializeIngredientsFunctionality();\r\n-// const loadIngredientsData = () => loadIngredients();\r\n-const loadReceipts = () => initializeReceiptsFunctionality();\r\n-// const loadRecentReceipts = () => initializeReceiptsFunctionality();\r\n-// const loadAccountInfo = () => initializeAccountFunctionality();\r\n-// const loadActivityLog = () => initializeActivityLogFunctionality();\r\n+// ‚îÄ‚îÄ‚îÄ Common ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n \r\n-// Common features for all staff pages\r\n function initializeCommonStaffFeatures() {\r\n-    // Update logged in user name in header\r\n     const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n     const headerUserName = document.querySelector('.navbar .dropdown-toggle');\r\n     if (headerUserName && user.full_name) {\r\n         headerUserName.innerHTML = `<i class=\"fas fa-user-circle me-1\"></i>${user.full_name}`;\r\n     }\r\n \r\n-    // Logout button (global) - Handle both navbar and account page versions\r\n-    const logoutButtons = document.querySelectorAll('#logoutBtn, #logoutBtnAccount');\r\n-    logoutButtons.forEach(logoutBtn => {\r\n-        if (logoutBtn) {\r\n-            logoutBtn.addEventListener('click', function (e) {\r\n-                e.preventDefault();\r\n-                e.stopPropagation();\r\n-                performStaffLogout();\r\n-            });\r\n-        }\r\n+    document.querySelectorAll('#logoutBtn, #logoutBtnAccount').forEach(btn => {\r\n+        btn.addEventListener('click', function (e) {\r\n+            e.preventDefault();\r\n+            e.stopPropagation();\r\n+            performStaffLogout();\r\n+        });\r\n     });\r\n }\r\n \r\n-/**\r\n- * Perform staff logout with activity logging and status update\r\n- */\r\n function performStaffLogout() {\r\n-    console.log('üîÑ Logout initiated - showing confirmation dialog');\r\n-    \r\n     showConfirm('Are you sure you want to logout?', function () {\r\n-        console.log('‚úÖ Logout confirmed by user');\r\n-        \r\n-        // Get user info before clearing\r\n         const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n-        console.log('üìã User info retrieved:', user.id, user.full_name);\r\n-        \r\n-        // Log the logout activity\r\n+\r\n         logStaffActivity('Logged out', 'User session terminated', 'Success');\r\n-        \r\n-        // Mark user as inactive\r\n-        updateUserStatus(user.id, 'inactive').then(() => {\r\n-            console.log('‚úÖ User marked as inactive');\r\n-            localStorage.removeItem('loggedInRole');\r\n-            localStorage.removeItem('loggedInUser');\r\n-            console.log('üîê Session cleared, redirecting to login...');\r\n-            window.location.href = 'index.html';\r\n-        }).catch(err => {\r\n-            console.error('‚ùå Failed to update status, but proceeding with logout:', err);\r\n-            localStorage.removeItem('loggedInRole');\r\n-            localStorage.removeItem('loggedInUser');\r\n-            window.location.href = 'index.html';\r\n-        });\r\n+\r\n+        updateUserStatus(user.id, 'inactive')\r\n+            .catch(err => console.error('Failed to update status on logout:', err))\r\n+            .finally(() => {\r\n+                localStorage.removeItem('loggedInRole');\r\n+                localStorage.removeItem('loggedInUser');\r\n+                window.location.href = 'index.html';\r\n+            });\r\n     });\r\n }\r\n \r\n-// Menu Sales Functions\r\n-function initializeMenuFunctionality() {\r\n-    // Category Tabs functionality\r\n-    const categoryTabs = document.querySelectorAll('.btn-category');\r\n-    categoryTabs.forEach(tab => {\r\n-        tab.addEventListener('click', function () {\r\n-            categoryTabs.forEach(t => t.classList.remove('active'));\r\n-            this.classList.add('active');\r\n-            filterMenuItems();\r\n-        });\r\n-    });\r\n+// ‚îÄ‚îÄ‚îÄ Activity Logging (single authoritative version ‚Äî async/DB) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n \r\n-    // Search functionality\r\n-    const menuSearch = document.getElementById('menuSearch');\r\n-    if (menuSearch) {\r\n-        menuSearch.addEventListener('input', filterMenuItems);\r\n-    }\r\n+async function logStaffActivity(action, reference = 'N/A', status = 'Success') {\r\n+    const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n+    if (!user.id) return;\r\n \r\n-    // Cart action buttons\r\n-    const clearSaleBtn = document.getElementById('clearSaleBtn');\r\n-    if (clearSaleBtn) {\r\n-        clearSaleBtn.addEventListener('click', function () {\r\n-            showConfirm('Are you sure you want to clear the cart?', clearCurrentSale);\r\n+    try {\r\n+        await fetch('/php/app.php', {\r\n+            method: 'POST',\r\n+            headers: { 'Content-Type': 'application/json' },\r\n+            body: JSON.stringify({\r\n+                table: 'activity_logs',\r\n+                user_id: user.id,\r\n+                role_label: user.role_name || 'Staff',\r\n+                action,\r\n+                reference,\r\n+                status,\r\n+                ip_address: '127.0.0.1',\r\n+                created_at: new Date().toISOString().slice(0, 19).replace('T', ' ')\r\n+            })\r\n         });\r\n-    }\r\n \r\n-    const checkoutBtn = document.getElementById('checkoutBtn');\r\n-    if (checkoutBtn) {\r\n-        checkoutBtn.addEventListener('click', function () {\r\n-            processCheckout();\r\n-        });\r\n+        if (document.getElementById('activityLogTable')) {\r\n+            loadActivityLog();\r\n+        }\r\n+    } catch (e) {\r\n+        console.error('Failed to log activity:', e);\r\n     }\r\n+}\r\n \r\n-    // New POS Feature Buttons\r\n-    const selectCustomerBtn = document.getElementById('selectCustomerBtn');\r\n-    if (selectCustomerBtn) {\r\n-        selectCustomerBtn.addEventListener('click', selectCustomer);\r\n-    }\r\n+// ‚îÄ‚îÄ‚îÄ Menu / POS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n \r\n-    const discountBtn = document.getElementById('discountBtn');\r\n-    if (discountBtn) {\r\n-        discountBtn.addEventListener('click', applyDiscount);\r\n-    }\r\n+function initializeMenuFunctionality() {\r\n+    document.querySelectorAll('.btn-category').forEach(tab => {\r\n+        tab.addEventListener('click', function () {\r\n+            document.querySelectorAll('.btn-category').forEach(t => t.classList.remove('active'));\r\n+            this.classList.add('active');\r\n+            filterMenuItems();\r\n+        });\r\n+    });\r\n \r\n-    const couponBtn = document.getElementById('couponBtn');\r\n-    if (couponBtn) {\r\n-        couponBtn.addEventListener('click', applyCoupon);\r\n-    }\r\n+    document.getElementById('menuSearch')?.addEventListener('input', filterMenuItems);\r\n \r\n-    const holdOrderBtn = document.getElementById('holdOrderBtn');\r\n-    if (holdOrderBtn) {\r\n-        holdOrderBtn.addEventListener('click', holdOrder);\r\n-    }\r\n+    document.getElementById('clearSaleBtn')?.addEventListener('click', () =>\r\n+        showConfirm('Are you sure you want to clear the cart?', clearCurrentSale)\r\n+    );\r\n+    document.getElementById('checkoutBtn')?.addEventListener('click', processCheckout);\r\n+    document.getElementById('selectCustomerBtn')?.addEventListener('click', selectCustomer);\r\n+    document.getElementById('discountBtn')?.addEventListener('click', applyDiscount);\r\n+    document.getElementById('couponBtn')?.addEventListener('click', applyCoupon);\r\n+    document.getElementById('holdOrderBtn')?.addEventListener('click', holdOrder);\r\n+    document.getElementById('returnOrderBtn')?.addEventListener('click', handleReturn);\r\n \r\n-    const returnOrderBtn = document.getElementById('returnOrderBtn');\r\n-    if (returnOrderBtn) {\r\n-        returnOrderBtn.addEventListener('click', handleReturn);\r\n-    }\r\n-\r\n-    // Load initial data\r\n     loadMenuItems();\r\n     updateSaleDisplay();\r\n }\r\n \r\n-// POS Feature Implementations\r\n function selectCustomer() {\r\n     Swal.fire({\r\n         title: 'Select Customer',\r\n         input: 'text',\r\n         inputLabel: 'Enter Customer Name',\r\n         inputPlaceholder: 'Search or add new customer...',\r\n         showCancelButton: true,\r\n         confirmButtonColor: '#800000',\r\n-    }).then((result) => {\r\n+    }).then(result => {\r\n         if (result.isConfirmed && result.value) {\r\n             currentCustomer = result.value;\r\n             showModalNotification(`Customer \"${currentCustomer}\" selected.`, 'success', 'Customer Selected');\r\n             updateSaleDisplay();\r\n@@ -188,9 +147,9 @@\n         inputPlaceholder: '0',\r\n         inputAttributes: { min: 0, max: 100 },\r\n         showCancelButton: true,\r\n         confirmButtonColor: '#800000',\r\n-    }).then((result) => {\r\n+    }).then(result => {\r\n         if (result.isConfirmed) {\r\n             currentDiscount = parseFloat(result.value) || 0;\r\n             updateSaleDisplay();\r\n             logStaffActivity('Applied Discount', `${currentDiscount}%`, 'Success');\r\n@@ -205,23 +164,24 @@\n         inputLabel: 'Enter Coupon Code',\r\n         inputPlaceholder: 'SAVE10, FREE50, etc.',\r\n         showCancelButton: true,\r\n         confirmButtonColor: '#800000',\r\n-    }).then((result) => {\r\n-        if (result.isConfirmed) {\r\n-            const code = result.value.toUpperCase();\r\n-            if (code === 'SAVE10') {\r\n-                currentCoupon = { code: 'SAVE10', type: 'percentage', value: 10 };\r\n-                showModalNotification('Coupon \"SAVE10\" (10% Off) applied!', 'success', 'Coupon Applied');\r\n-            } else if (code === 'FREE50') {\r\n-                currentCoupon = { code: 'FREE50', type: 'fixed', value: 50 };\r\n-                showModalNotification('Coupon \"FREE50\" (P50 Off) applied!', 'success', 'Coupon Applied');\r\n-            } else {\r\n-                Swal.fire('Invalid Coupon', 'The coupon code entered is not valid.', 'error');\r\n-                return;\r\n-            }\r\n+    }).then(result => {\r\n+        if (!result.isConfirmed) return;\r\n+\r\n+        const code = result.value.toUpperCase();\r\n+        const coupons = {\r\n+            SAVE10: { code: 'SAVE10', type: 'percentage', value: 10, label: '10% Off' },\r\n+            FREE50: { code: 'FREE50', type: 'fixed',      value: 50, label: 'P50 Off' },\r\n+        };\r\n+\r\n+        if (coupons[code]) {\r\n+            currentCoupon = coupons[code];\r\n+            showModalNotification(`Coupon \"${code}\" (${coupons[code].label}) applied!`, 'success', 'Coupon Applied');\r\n             updateSaleDisplay();\r\n             logStaffActivity('Applied Coupon', code, 'Success');\r\n+        } else {\r\n+            Swal.fire('Invalid Coupon', 'The coupon code entered is not valid.', 'error');\r\n         }\r\n     });\r\n }\r\n \r\n@@ -230,9 +190,9 @@\n         Swal.fire('Error', 'Cart is empty. Nothing to hold.', 'error');\r\n         return;\r\n     }\r\n \r\n-    const heldOrders = JSON.parse(localStorage.getItem('heldOrders')) || [];\r\n+    const heldOrders = JSON.parse(localStorage.getItem('heldOrders') || '[]');\r\n     const newHold = {\r\n         id: 'HOLD-' + Date.now(),\r\n         timestamp: Date.now(),\r\n         items: [...currentSaleItems],\r\n@@ -249,120 +209,104 @@\n     clearCurrentSale();\r\n }\r\n \r\n function handleReturn() {\r\n-    // Show recent sales to select for return\r\n-    const sales = JSON.parse(localStorage.getItem('sales')) || [];\r\n+    const sales = JSON.parse(localStorage.getItem('sales') || '[]');\r\n     if (sales.length === 0) {\r\n         Swal.fire('No Transactions', 'No recent transactions found to return.', 'info');\r\n         return;\r\n     }\r\n \r\n     const inputOptions = {};\r\n     sales.slice(0, 10).forEach(s => {\r\n-        inputOptions[s.id] = `${s.id} - P${s.total.toFixed(2)} (${s.time})`;\r\n+        inputOptions[s.id] = `${s.id} - P${parseFloat(s.total).toFixed(2)} (${s.time})`;\r\n     });\r\n \r\n     Swal.fire({\r\n         title: 'Select Transaction to Return',\r\n         input: 'select',\r\n-        inputOptions: inputOptions,\r\n+        inputOptions,\r\n         inputPlaceholder: 'Select a receipt...',\r\n         showCancelButton: true,\r\n         confirmButtonColor: '#800000',\r\n-    }).then((result) => {\r\n-        if (result.isConfirmed && result.value) {\r\n-            const saleId = result.value;\r\n-            Swal.fire({\r\n-                title: 'Confirm Return',\r\n-                text: `Are you sure you want to process a return for ${saleId}?`,\r\n-                icon: 'warning',\r\n-                showCancelButton: true,\r\n-                confirmButtonColor: '#d33',\r\n-                confirmButtonText: 'Yes, Return'\r\n-            }).then((confirm) => {\r\n-                if (confirm.isConfirmed) {\r\n-                    // Logic to mark as returned or remove\r\n-                    let updatedSales = sales.filter(s => s.id !== saleId);\r\n-                    localStorage.setItem('sales', JSON.stringify(updatedSales));\r\n-                    showModalNotification('Transaction successfully returned and voided.', 'success', 'Return Processed');\r\n-                    logStaffActivity('Processed Return', saleId, 'Success');\r\n-                }\r\n-            });\r\n-        }\r\n+    }).then(result => {\r\n+        if (!result.isConfirmed || !result.value) return;\r\n+\r\n+        const saleId = result.value;\r\n+        Swal.fire({\r\n+            title: 'Confirm Return',\r\n+            text: `Are you sure you want to process a return for ${saleId}?`,\r\n+            icon: 'warning',\r\n+            showCancelButton: true,\r\n+            confirmButtonColor: '#d33',\r\n+            confirmButtonText: 'Yes, Return'\r\n+        }).then(confirm => {\r\n+            if (confirm.isConfirmed) {\r\n+                const updated = sales.filter(s => s.id !== saleId);\r\n+                localStorage.setItem('sales', JSON.stringify(updated));\r\n+                showModalNotification('Transaction successfully returned and voided.', 'success', 'Return Processed');\r\n+                logStaffActivity('Processed Return', saleId, 'Success');\r\n+            }\r\n+        });\r\n     });\r\n }\r\n \r\n function loadMenuItems() {\r\n     const menuGrid = document.getElementById('menuItemsGrid');\r\n     if (!menuGrid) return;\r\n \r\n-    // Show loading\r\n     menuGrid.innerHTML = '<div class=\"col-12 text-center py-5\"><div class=\"loading-spinner\"></div><p class=\"mt-2\">Fetching menu from system...</p></div>';\r\n \r\n-    // Simulate real-time fetch from Admin/DB\r\n     setTimeout(() => {\r\n-        // Try to load from \"adminMenuItems\" (synced from admin) if available\r\n-        const savedMenu = JSON.parse(localStorage.getItem('adminMenuItems'));\r\n+        const savedMenu = JSON.parse(localStorage.getItem('adminMenuItems') || 'null');\r\n \r\n-        if (savedMenu && savedMenu.length > 0) {\r\n-            allMenuItems = savedMenu;\r\n-        } else {\r\n-            // Default demo items if none in storage\r\n-            allMenuItems = [\r\n-                { id: 1, name: 'Beef Steak', category: 'Main Course', price: 450, image: 'https://images.unsplash.com/photo-1600891964092-4316c288032e?w=400&h=300&fit=crop', available: true },\r\n-                { id: 2, name: 'Chicken Curry', category: 'Main Course', price: 320, image: 'https://images.unsplash.com/photo-1603894584373-5ac82b2ae398?w=400&h=300&fit=crop', available: true },\r\n-                { id: 3, name: 'Vegetable Salad', category: 'Appetizer', price: 180, image: 'https://images.unsplash.com/photo-1540420773420-3366772f4999?w=400&h=300&fit=crop', available: true },\r\n-                { id: 4, name: 'Garlic Bread', category: 'Appetizer', price: 120, image: 'https://images.unsplash.com/photo-1573140247632-f8fd74997d5c?w=400&h=300&fit=crop', available: true },\r\n-                { id: 5, name: 'French Fries', category: 'Side Dish', price: 95, image: 'https://images.unsplash.com/photo-1576107232684-1279f390859f?w=400&h=300&fit=crop', available: true },\r\n-                { id: 6, name: 'Pasta Carbonara', category: 'Main Course', price: 280, image: 'https://images.unsplash.com/photo-1598866594230-a7c12756260f?w=400&h=300&fit=crop', available: true },\r\n-                { id: 7, name: 'Chocolate Cake', category: 'Dessert', price: 150, image: 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=400&h=300&fit=crop', available: true },\r\n-                { id: 8, name: 'Fruit Shake', category: 'Beverage', price: 85, image: 'https://images.unsplash.com/photo-1544145945-f904253d0c71?w=400&h=300&fit=crop', available: true }\r\n-            ];\r\n-            localStorage.setItem('adminMenuItems', JSON.stringify(allMenuItems));\r\n-        }\r\n+        allMenuItems = (savedMenu && savedMenu.length > 0) ? savedMenu : [\r\n+            { id: 1, name: 'Beef Steak',       category: 'Main Course', price: 450, image: 'https://images.unsplash.com/photo-1600891964092-4316c288032e?w=400&h=300&fit=crop', available: true },\r\n+            { id: 2, name: 'Chicken Curry',     category: 'Main Course', price: 320, image: 'https://images.unsplash.com/photo-1603894584373-5ac82b2ae398?w=400&h=300&fit=crop', available: true },\r\n+            { id: 3, name: 'Vegetable Salad',   category: 'Appetizer',   price: 180, image: 'https://images.unsplash.com/photo-1540420773420-3366772f4999?w=400&h=300&fit=crop', available: true },\r\n+            { id: 4, name: 'Garlic Bread',      category: 'Appetizer',   price: 120, image: 'https://images.unsplash.com/photo-1573140247632-f8fd74997d5c?w=400&h=300&fit=crop', available: true },\r\n+            { id: 5, name: 'French Fries',      category: 'Side Dish',   price: 95,  image: 'https://images.unsplash.com/photo-1576107232684-1279f390859f?w=400&h=300&fit=crop', available: true },\r\n+            { id: 6, name: 'Pasta Carbonara',   category: 'Main Course', price: 280, image: 'https://images.unsplash.com/photo-1598866594230-a7c12756260f?w=400&h=300&fit=crop', available: true },\r\n+            { id: 7, name: 'Chocolate Cake',    category: 'Dessert',     price: 150, image: 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=400&h=300&fit=crop', available: true },\r\n+            { id: 8, name: 'Fruit Shake',       category: 'Beverage',    price: 85,  image: 'https://images.unsplash.com/photo-1544145945-f904253d0c71?w=400&h=300&fit=crop', available: true }\r\n+        ];\r\n \r\n+        if (!savedMenu) localStorage.setItem('adminMenuItems', JSON.stringify(allMenuItems));\r\n+\r\n         displayMenuItems(allMenuItems);\r\n     }, 600);\r\n }\r\n \r\n function displayMenuItems(items) {\r\n     const menuGrid = document.getElementById('menuItemsGrid');\r\n     if (!menuGrid) return;\r\n \r\n-    menuGrid.innerHTML = '';\r\n-\r\n     if (items.length === 0) {\r\n         menuGrid.innerHTML = '<div class=\"col-12 text-center py-5\"><i class=\"fas fa-search fa-3x text-muted mb-3\"></i><p class=\"text-muted\">No items found matching your filter</p></div>';\r\n         return;\r\n     }\r\n \r\n-    items.forEach(item => {\r\n-        const col = document.createElement('div');\r\n-        col.className = 'col-6 col-md-4 col-lg-3 mb-3';\r\n-\r\n+    menuGrid.innerHTML = items.map(item => {\r\n         const imgSrc = item.image || 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400&h=300&fit=crop';\r\n-\r\n-        col.innerHTML = `\r\n-            <div class=\"menu-item-card\" data-id=\"${item.id}\" onclick=\"addItemToSale(${item.id})\">\r\n-                <div class=\"menu-item-img-container\">\r\n-                    <img src=\"${imgSrc}\" alt=\"${item.name}\" class=\"menu-item-img\">\r\n-                    <div class=\"price-tag\">P${parseFloat(item.price).toFixed(2)}</div>\r\n+        return `\r\n+            <div class=\"col-6 col-md-4 col-lg-3 mb-3\">\r\n+                <div class=\"menu-item-card\" data-id=\"${item.id}\" onclick=\"addItemToSale(${item.id})\">\r\n+                    <div class=\"menu-item-img-container\">\r\n+                        <img src=\"${imgSrc}\" alt=\"${item.name}\" class=\"menu-item-img\">\r\n+                        <div class=\"price-tag\">P${parseFloat(item.price).toFixed(2)}</div>\r\n+                    </div>\r\n+                    <div class=\"p-2 text-center\">\r\n+                        <div class=\"fw-bold mb-0 text-truncate\" style=\"font-size:0.85rem\">${item.name}</div>\r\n+                    </div>\r\n                 </div>\r\n-                <div class=\"p-2 text-center\">\r\n-                    <div class=\"fw-bold mb-0 text-truncate\" style=\"font-size: 0.85rem\">${item.name}</div>\r\n-                </div>\r\n-            </div>\r\n-        `;\r\n-\r\n-        menuGrid.appendChild(col);\r\n-    });\r\n+            </div>`;\r\n+    }).join('');\r\n }\r\n \r\n function filterMenuItems() {\r\n     const searchTerm = document.getElementById('menuSearch')?.value.toLowerCase() || '';\r\n-    const activeTab = document.querySelector('.btn-category.active');\r\n-    const category = activeTab ? activeTab.getAttribute('data-category') : 'All';\r\n+    const activeTab  = document.querySelector('.btn-category.active');\r\n+    const category   = activeTab ? activeTab.getAttribute('data-category') : 'All';\r\n \r\n     const filtered = allMenuItems.filter(item =>\r\n         item.name.toLowerCase().includes(searchTerm) &&\r\n         (category === 'All' || item.category === category)\r\n@@ -373,114 +317,93 @@\n function addItemToSale(itemId) {\r\n     const product = allMenuItems.find(item => item.id == itemId);\r\n     if (!product) return;\r\n \r\n-    const existingItem = currentSaleItems.find(item => item.id == itemId);\r\n-    if (existingItem) {\r\n-        existingItem.quantity += 1;\r\n+    const existing = currentSaleItems.find(item => item.id == itemId);\r\n+    if (existing) {\r\n+        existing.quantity += 1;\r\n     } else {\r\n-        currentSaleItems.push({\r\n-            id: product.id,\r\n-            name: product.name,\r\n-            price: product.price,\r\n-            img: product.image,\r\n-            quantity: 1\r\n-        });\r\n+        currentSaleItems.push({ id: product.id, name: product.name, price: product.price, img: product.image, quantity: 1 });\r\n     }\r\n+\r\n     updateSaleDisplay();\r\n \r\n-    // Tiny toast or visual feedback\r\n     const card = document.querySelector(`.menu-item-card[data-id=\"${itemId}\"]`);\r\n     if (card) {\r\n         card.classList.add('animate-add');\r\n         setTimeout(() => card.classList.remove('animate-add'), 400);\r\n     }\r\n }\r\n \r\n+function calcTotals() {\r\n+    const subtotal = currentSaleItems.reduce((acc, item) => acc + item.price * item.quantity, 0);\r\n+\r\n+    let discountAmount = subtotal * (currentDiscount / 100);\r\n+    if (currentCoupon) {\r\n+        discountAmount += currentCoupon.type === 'percentage'\r\n+            ? subtotal * (currentCoupon.value / 100)\r\n+            : currentCoupon.value;\r\n+    }\r\n+\r\n+    const discountedSubtotal = Math.max(0, subtotal - discountAmount);\r\n+    const taxes = discountedSubtotal * 0.12;\r\n+    const total = discountedSubtotal + taxes;\r\n+\r\n+    return { subtotal, discountAmount, taxes, total };\r\n+}\r\n+\r\n function updateSaleDisplay() {\r\n-    const container = document.getElementById('cartItemsList');\r\n-    const subtotalEl = document.getElementById('cartSubtotal');\r\n-    const taxEl = document.getElementById('cartTaxes');\r\n-    const totalEl = document.getElementById('cartTotal');\r\n+    const container   = document.getElementById('cartItemsList');\r\n+    const subtotalEl  = document.getElementById('cartSubtotal');\r\n+    const taxEl       = document.getElementById('cartTaxes');\r\n+    const totalEl     = document.getElementById('cartTotal');\r\n     const cartCountEl = document.getElementById('cartCount');\r\n     const checkoutBtn = document.getElementById('checkoutBtn');\r\n \r\n     if (!container) return;\r\n \r\n-    // Update Customer Display in Sidebar if exists\r\n     const customerDisplay = document.querySelector('.customer-name-display');\r\n-    if (customerDisplay) {\r\n-        customerDisplay.textContent = currentCustomer || 'Walk-in Customer';\r\n-    }\r\n+    if (customerDisplay) customerDisplay.textContent = currentCustomer || 'Walk-in Customer';\r\n \r\n     if (currentSaleItems.length === 0) {\r\n         container.innerHTML = `<div class=\"text-center py-5 empty-cart-msg\"><p class=\"text-muted\">No items in cart</p></div>`;\r\n         subtotalEl.textContent = 'P0.00';\r\n-        taxEl.textContent = 'P0.00';\r\n-        totalEl.textContent = 'P0.00';\r\n+        taxEl.textContent      = 'P0.00';\r\n+        totalEl.textContent    = 'P0.00';\r\n         cartCountEl.textContent = '0';\r\n-        checkoutBtn.disabled = true;\r\n+        checkoutBtn.disabled   = true;\r\n         return;\r\n     }\r\n \r\n-    let subtotal = 0;\r\n-    let itemsCount = 0;\r\n-    let itemsHtml = '';\r\n+    const { subtotal, discountAmount, taxes, total } = calcTotals();\r\n+    const itemsCount = currentSaleItems.reduce((acc, item) => acc + item.quantity, 0);\r\n \r\n-    currentSaleItems.forEach((item, index) => {\r\n-        subtotal += item.price * item.quantity;\r\n-        itemsCount += item.quantity;\r\n-        itemsHtml += `\r\n-            <div class=\"cart-item\">\r\n-                <div class=\"cart-item-details\">\r\n-                    <span class=\"cart-item-name\">${item.name}</span>\r\n-                    <span class=\"cart-item-price\">P${(item.price * item.quantity).toFixed(2)}</span>\r\n-                </div>\r\n-                <div class=\"qty-controls\">\r\n-                    <button class=\"btn-qty\" onclick=\"changeQty(${index}, -1)\"><i class=\"fas fa-minus\"></i></button>\r\n-                    <span class=\"fw-bold mx-1\">${item.quantity}</span>\r\n-                    <button class=\"btn-qty\" onclick=\"changeQty(${index}, 1)\"><i class=\"fas fa-plus\"></i></button>\r\n-                    <button class=\"cart-item-remove ms-2\" onclick=\"removeSaleItem(${index})\"><i class=\"fas fa-trash-alt\"></i></button>\r\n-                </div>\r\n+    container.innerHTML = currentSaleItems.map((item, index) => `\r\n+        <div class=\"cart-item\">\r\n+            <div class=\"cart-item-details\">\r\n+                <span class=\"cart-item-name\">${item.name}</span>\r\n+                <span class=\"cart-item-price\">P${(item.price * item.quantity).toFixed(2)}</span>\r\n             </div>\r\n-        `;\r\n-    });\r\n+            <div class=\"qty-controls\">\r\n+                <button class=\"btn-qty\" onclick=\"changeQty(${index}, -1)\"><i class=\"fas fa-minus\"></i></button>\r\n+                <span class=\"fw-bold mx-1\">${item.quantity}</span>\r\n+                <button class=\"btn-qty\" onclick=\"changeQty(${index}, 1)\"><i class=\"fas fa-plus\"></i></button>\r\n+                <button class=\"cart-item-remove ms-2\" onclick=\"removeSaleItem(${index})\"><i class=\"fas fa-trash-alt\"></i></button>\r\n+            </div>\r\n+        </div>`\r\n+    ).join('');\r\n \r\n-    // Apply Discount\r\n-    let discountAmount = (subtotal * (currentDiscount / 100));\r\n-\r\n-    // Apply Coupon\r\n-    if (currentCoupon) {\r\n-        if (currentCoupon.type === 'percentage') {\r\n-            discountAmount += (subtotal * (currentCoupon.value / 100));\r\n-        } else {\r\n-            discountAmount += currentCoupon.value;\r\n-        }\r\n-    }\r\n-\r\n-    const discountedSubtotal = Math.max(0, subtotal - discountAmount);\r\n-    const taxes = discountedSubtotal * 0.12;\r\n-    const total = discountedSubtotal + taxes;\r\n-\r\n-    container.innerHTML = itemsHtml;\r\n-    subtotalEl.textContent = 'P' + subtotal.toFixed(2);\r\n-\r\n-    // Display Discounts if any\r\n-    if (discountAmount > 0) {\r\n-        subtotalEl.innerHTML += ` <span class=\"text-danger small\">( -P${discountAmount.toFixed(2)} )</span>`;\r\n-    }\r\n-\r\n-    taxEl.textContent = 'P' + taxes.toFixed(2);\r\n-    totalEl.textContent = 'P' + total.toFixed(2);\r\n+    subtotalEl.innerHTML = `P${subtotal.toFixed(2)}` +\r\n+        (discountAmount > 0 ? ` <span class=\"text-danger small\">(-P${discountAmount.toFixed(2)})</span>` : '');\r\n+    taxEl.textContent       = `P${taxes.toFixed(2)}`;\r\n+    totalEl.textContent     = `P${total.toFixed(2)}`;\r\n     cartCountEl.textContent = itemsCount;\r\n-    checkoutBtn.disabled = false;\r\n+    checkoutBtn.disabled    = false;\r\n }\r\n \r\n function changeQty(index, delta) {\r\n     currentSaleItems[index].quantity += delta;\r\n-    if (currentSaleItems[index].quantity <= 0) {\r\n-        currentSaleItems.splice(index, 1);\r\n-    }\r\n+    if (currentSaleItems[index].quantity <= 0) currentSaleItems.splice(index, 1);\r\n     updateSaleDisplay();\r\n }\r\n \r\n function removeSaleItem(index) {\r\n@@ -489,11 +412,11 @@\n }\r\n \r\n function clearCurrentSale() {\r\n     currentSaleItems = [];\r\n-    currentCustomer = null;\r\n-    currentDiscount = 0;\r\n-    currentCoupon = null;\r\n+    currentCustomer  = null;\r\n+    currentDiscount  = 0;\r\n+    currentCoupon    = null;\r\n     updateSaleDisplay();\r\n }\r\n \r\n function processCheckout() {\r\n@@ -506,552 +429,347 @@\n         showCancelButton: true,\r\n         confirmButtonColor: '#800000',\r\n         cancelButtonColor: '#6c757d',\r\n         confirmButtonText: 'Confirm'\r\n-    }).then((result) => {\r\n-        if (result.isConfirmed) {\r\n-            recordSale();\r\n-        }\r\n+    }).then(result => {\r\n+        if (result.isConfirmed) recordSale();\r\n     });\r\n }\r\n \r\n function recordSale() {\r\n-    const subtotal = currentSaleItems.reduce((acc, item) => acc + (item.price * item.quantity), 0);\r\n-    let discountAmt = (subtotal * (currentDiscount / 100));\r\n-    if (currentCoupon) {\r\n-        discountAmt += (currentCoupon.type === 'percentage' ? (subtotal * (currentCoupon.value / 100)) : currentCoupon.value);\r\n-    }\r\n-    const finalSubtotal = Math.max(0, subtotal - discountAmt);\r\n-    const taxes = finalSubtotal * 0.12;\r\n-    const total = finalSubtotal + taxes;\r\n+    const { subtotal, discountAmount, taxes, total } = calcTotals();\r\n \r\n     const newSale = {\r\n         id: 'SALE-' + Date.now(),\r\n         date: new Date().toISOString().split('T')[0],\r\n         time: new Date().toLocaleTimeString(),\r\n         timestamp: Date.now(),\r\n         items: [...currentSaleItems],\r\n-        subtotal: subtotal,\r\n-        discount: discountAmt,\r\n-        taxes: taxes,\r\n-        total: total,\r\n+        subtotal,\r\n+        discount: discountAmount,\r\n+        taxes,\r\n+        total,\r\n         customer: currentCustomer || 'Walk-in',\r\n-        staff: 'Staff Account'\r\n+        staff: JSON.parse(localStorage.getItem('loggedInUser') || '{}').full_name || 'Staff'\r\n     };\r\n \r\n-    // Save to sales history\r\n-    let sales = JSON.parse(localStorage.getItem('sales')) || [];\r\n-    sales.unshift(newSale); // Newest first\r\n+    const sales = JSON.parse(localStorage.getItem('sales') || '[]');\r\n+    sales.unshift(newSale);\r\n     localStorage.setItem('sales', JSON.stringify(sales));\r\n \r\n-    // Dedut ingredients (Simulated sync with inventory)\r\n-    updateIngredientsStock(currentSaleItems);\r\n-    logStaffActivity('Recorded Sale', `${newSale.id} - Total: P${newSale.total.toFixed(2)} - Customer: ${newSale.customer}`, 'Success');\r\n+    logStaffActivity('Recorded Sale', `${newSale.id} - Total: P${total.toFixed(2)} - Customer: ${newSale.customer}`, 'Success');\r\n \r\n     Swal.fire('Success!', 'Transaction recorded.', 'success');\r\n-\r\n     clearCurrentSale();\r\n }\r\n \r\n-// Real-time listener for Admin changes\r\n-window.addEventListener('storage', (e) => {\r\n-    if (e.key === 'adminMenuItems') {\r\n-        console.log(\"Admin updated menu, refreshing POS...\");\r\n-        loadMenuItems();\r\n-    }\r\n+// Sync menu when admin makes changes\r\n+window.addEventListener('storage', e => {\r\n+    if (e.key === 'adminMenuItems') loadMenuItems();\r\n });\r\n \r\n-function updateIngredientsStock(saleItems) {\r\n-    let ingredients = JSON.parse(localStorage.getItem('ingredients')) || [];\r\n-    let recipes = JSON.parse(localStorage.getItem('adminRecipes')) || [];\r\n+// ‚îÄ‚îÄ‚îÄ Ingredients ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n \r\n-    saleItems.forEach(saleItem => {\r\n-        // Find recipe for this menu item\r\n-        const recipe = recipes.find(r => r.menuItem === saleItem.name);\r\n-        if (recipe) {\r\n-            recipe.ingredients.forEach(recIng => {\r\n-                const ing = ingredients.find(i => i.name === recIng.name);\r\n-                if (ing) {\r\n-                    ing.quantity -= (recIng.qty * saleItem.quantity);\r\n-                    if (ing.quantity < 0) ing.quantity = 0;\r\n-                }\r\n-            });\r\n-        }\r\n-    });\r\n-\r\n-    localStorage.setItem('ingredients', JSON.stringify(ingredients));\r\n-}\r\n-\r\n-// Global Activity Logging - Connects to Admin's systemActivityLogs\r\n-function logStaffActivity(action, details, status) {\r\n-    let logs = [];\r\n-    try {\r\n-        const stored = localStorage.getItem('systemActivityLogs');\r\n-        if (stored) logs = JSON.parse(stored);\r\n-    } catch (e) { logs = []; }\r\n-\r\n-    const now = new Date();\r\n-    const pad = n => String(n).padStart(2, '0');\r\n-    const ts = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;\r\n-\r\n-    const newLog = {\r\n-        id: Date.now(),\r\n-        userName: 'Staff User', // Could be dynamic based on login\r\n-        action: action,\r\n-        reference: details,\r\n-        timestamp: ts,\r\n-        category: action.includes('Sale') || action.includes('Return') ? 'Sales' : 'Staff',\r\n-        ip: '192.168.1.10'\r\n-    };\r\n-\r\n-    logs.unshift(newLog);\r\n-    if (logs.length > 500) logs = logs.slice(0, 500);\r\n-    localStorage.setItem('systemActivityLogs', JSON.stringify(logs));\r\n-}\r\n-\r\n-// Ingredients Functions\r\n function initializeIngredientsFunctionality() {\r\n-    const searchInput = document.getElementById('ingredientSearch');\r\n-    if (searchInput) {\r\n-        searchInput.addEventListener('input', filterIngredients);\r\n-    }\r\n-\r\n-    const categoryFilter = document.getElementById('ingredientCategoryFilter');\r\n-    if (categoryFilter) {\r\n-        categoryFilter.addEventListener('change', filterIngredients);\r\n-    }\r\n-\r\n+    document.getElementById('ingredientSearch')?.addEventListener('input', filterIngredients);\r\n+    document.getElementById('ingredientCategoryFilter')?.addEventListener('change', filterIngredients);\r\n     loadIngredients();\r\n }\r\n \r\n function loadIngredients() {\r\n-    console.log(\"‚úÖ loadIngredients() called\");\r\n+    const tableElem = document.getElementById('ingredientsListTable') || document.getElementById('ingredientsTable');\r\n+    if (!tableElem) return;\r\n \r\n-    const tableElem =\r\n-        document.getElementById('ingredientsListTable') ||\r\n-        document.getElementById('ingredientsTable');\r\n-\r\n-    console.log(\"üîé Table element found:\", tableElem);\r\n-\r\n-    if (!tableElem) {\r\n-        console.warn(\"‚ùå Table element not found!\");\r\n-        return;\r\n-    }\r\n-\r\n     const tbody = tableElem.querySelector('tbody');\r\n-    console.log(\"üîé tbody:\", tbody);\r\n+    if (!tbody) return;\r\n \r\n-    if (!tbody) {\r\n-        console.warn(\"‚ùå tbody not found!\");\r\n-        return;\r\n-    }\r\n-\r\n     tbody.innerHTML = '<tr><td colspan=\"6\" class=\"text-center py-4\">Loading...</td></tr>';\r\n \r\n     setTimeout(() => {\r\n-        console.log(\"üì¶ Setting ingredient data\");\r\n-\r\n         allIngredients = [\r\n-            { id: 1, name: 'Beef', category: 'Meat', quantity: 15, unit: 'kg', status: 'Normal', minLevel: 5 },\r\n-            { id: 2, name: 'Chicken', category: 'Meat', quantity: 8, unit: 'kg', status: 'Low', minLevel: 10 },\r\n-            { id: 3, name: 'Onions', category: 'Vegetables', quantity: 3, unit: 'kg', status: 'Low', minLevel: 5 },\r\n-            { id: 4, name: 'Cheese', category: 'Dairy', quantity: 4, unit: 'kg', status: 'Low', minLevel: 5 },\r\n-            { id: 5, name: 'Garlic', category: 'Spices', quantity: 1, unit: 'kg', status: 'Low', minLevel: 2 },\r\n-            { id: 6, name: 'Cooking Oil', category: 'Supplies', quantity: 2, unit: 'L', status: 'Low', minLevel: 5 },\r\n-            { id: 7, name: 'Red Wine', category: 'Beverages', quantity: 1, unit: 'bottle', status: 'Low', minLevel: 3 }\r\n+            { id: 1, name: 'Beef',        category: 'Meat',       quantity: 15, unit: 'kg',     status: 'Normal', minLevel: 5  },\r\n+            { id: 2, name: 'Chicken',     category: 'Meat',       quantity: 8,  unit: 'kg',     status: 'Low',    minLevel: 10 },\r\n+            { id: 3, name: 'Onions',      category: 'Vegetables', quantity: 3,  unit: 'kg',     status: 'Low',    minLevel: 5  },\r\n+            { id: 4, name: 'Cheese',      category: 'Dairy',      quantity: 4,  unit: 'kg',     status: 'Low',    minLevel: 5  },\r\n+            { id: 5, name: 'Garlic',      category: 'Spices',     quantity: 1,  unit: 'kg',     status: 'Low',    minLevel: 2  },\r\n+            { id: 6, name: 'Cooking Oil', category: 'Supplies',   quantity: 2,  unit: 'L',      status: 'Low',    minLevel: 5  },\r\n+            { id: 7, name: 'Red Wine',    category: 'Beverages',  quantity: 1,  unit: 'bottle', status: 'Low',    minLevel: 3  }\r\n         ];\r\n-\r\n         displayIngredients(allIngredients);\r\n-\r\n     }, 500);\r\n }\r\n \r\n-\r\n function displayIngredients(ingredients) {\r\n     const tableElem = document.getElementById('ingredientsListTable') || document.getElementById('ingredientsTable');\r\n     if (!tableElem) return;\r\n \r\n-    const tbody = tableElem.getElementsByTagName('tbody')[0];\r\n+    const tbody = tableElem.querySelector('tbody');\r\n     if (!tbody) return;\r\n \r\n-    tbody.innerHTML = '';\r\n-    ingredients.forEach(ing => {\r\n-        const row = tbody.insertRow();\r\n-        row.innerHTML = `\r\n+    tbody.innerHTML = ingredients.map(ing => `\r\n+        <tr>\r\n             <td>${ing.name}</td>\r\n             <td>${ing.category}</td>\r\n             <td>${ing.quantity} ${ing.unit}</td>\r\n-            <td>${ing.minLevel || '-'}</td>\r\n+            <td>${ing.minLevel ?? '-'}</td>\r\n             <td><span class=\"badge ${ing.status === 'Normal' ? 'bg-success' : 'bg-warning'}\">${ing.status}</span></td>\r\n             <td><button class=\"btn btn-sm btn-outline-maroon\" onclick=\"showUpdateModal(${ing.id})\">Update</button></td>\r\n-        `;\r\n-    });\r\n+        </tr>`\r\n+    ).join('');\r\n }\r\n \r\n function showUpdateModal(id) {\r\n-    // Logic to show update modal\r\n-    const modal = new bootstrap.Modal(document.getElementById('updateQuantityModal') || document.getElementById('increaseQuantityModal'));\r\n-    modal.show();\r\n+    const modalEl = document.getElementById('updateQuantityModal') || document.getElementById('increaseQuantityModal');\r\n+    if (!modalEl) return;\r\n+    new bootstrap.Modal(modalEl).show();\r\n }\r\n \r\n function filterIngredients() {\r\n     const searchTerm = document.getElementById('ingredientSearch')?.value.toLowerCase() || '';\r\n-    const category = document.getElementById('ingredientCategoryFilter')?.value || '';\r\n+    const category   = document.getElementById('ingredientCategoryFilter')?.value || '';\r\n \r\n     const filtered = allIngredients.filter(ing =>\r\n         ing.name.toLowerCase().includes(searchTerm) &&\r\n         (category === '' || ing.category === category)\r\n     );\r\n     displayIngredients(filtered);\r\n }\r\n \r\n-// Receipts Functions\r\n+// ‚îÄ‚îÄ‚îÄ Receipts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n+\r\n function initializeReceiptsFunctionality() {\r\n     loadRecentReceipts();\r\n }\r\n \r\n function loadRecentReceipts() {\r\n     const container = document.getElementById('recentReceipts');\r\n     if (!container) return;\r\n-\r\n     container.innerHTML = '<a href=\"#\" class=\"list-group-item list-group-item-action\">No recent receipts</a>';\r\n }\r\n \r\n-// Account Functions\r\n+// ‚îÄ‚îÄ‚îÄ Account ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n+\r\n function initializeAccountFunctionality() {\r\n     loadAccountData();\r\n \r\n-    const editBtn = document.getElementById('editAccountBtn');\r\n-    const sendBtn = document.getElementById('sendAccountRequestBtn');\r\n+    document.getElementById('editAccountBtn')?.addEventListener('click', () => toggleAccountEdit());\r\n \r\n-    if (editBtn) {\r\n-        editBtn.addEventListener('click', function () {\r\n-            toggleAccountEdit();\r\n-        });\r\n-    }\r\n+    document.getElementById('sendAccountRequestBtn')?.addEventListener('click', async function () {\r\n+        const fullName    = document.getElementById('accFullName')?.value.trim();\r\n+        const email       = document.getElementById('accEmail')?.value.trim();\r\n+        const currentPass = document.getElementById('currentPass')?.value;\r\n+        const newPass     = document.getElementById('newPass')?.value;\r\n+        const confirmPass = document.getElementById('confirmPass')?.value;\r\n \r\n-    if (sendBtn) {\r\n-        sendBtn.addEventListener('click', async function () {\r\n-            const fullName = document.getElementById('accFullName').value.trim();\r\n-            const email = document.getElementById('accEmail').value.trim();\r\n-            const currentPass = document.getElementById('currentPass').value;\r\n-            const newPass = document.getElementById('newPass').value;\r\n-            const confirmPass = document.getElementById('confirmPass').value;\r\n+        if (fullName || email)                           await saveAccountInfo();\r\n+        if (currentPass || newPass || confirmPass)       await handlePasswordUpdate();\r\n \r\n-            // Determine what's being requested\r\n-            if (fullName || email) {\r\n-                await saveAccountInfo();\r\n-            }\r\n-\r\n-            if (currentPass || newPass || confirmPass) {\r\n-                await handlePasswordUpdate();\r\n-            }\r\n-\r\n-            // After sending, lock back\r\n-            toggleAccountEdit(false);\r\n-        });\r\n-    }\r\n+        toggleAccountEdit(false);\r\n+    });\r\n }\r\n \r\n function toggleAccountEdit(forceState) {\r\n     const editBtn = document.getElementById('editAccountBtn');\r\n     const sendBtn = document.getElementById('sendAccountRequestBtn');\r\n-    const inputs = document.querySelectorAll('#accountInfoForm input, #changePasswordForm input:not(#accUsername)');\r\n+    const inputs  = document.querySelectorAll('#accountInfoForm input, #changePasswordForm input:not(#accUsername)');\r\n \r\n     const isLocked = forceState !== undefined ? !forceState : editBtn.classList.contains('btn-outline-maroon');\r\n \r\n     if (isLocked) {\r\n-        // Unlock\r\n-        editBtn.classList.remove('btn-outline-maroon');\r\n-        editBtn.classList.add('btn-maroon');\r\n+        editBtn.classList.replace('btn-outline-maroon', 'btn-maroon');\r\n         editBtn.innerHTML = '<i class=\"fas fa-times me-1\"></i> Cancel';\r\n         sendBtn.classList.remove('d-none');\r\n-        inputs.forEach(input => {\r\n-            if (input.id !== 'accUsername') input.disabled = false;\r\n-        });\r\n+        inputs.forEach(input => { if (input.id !== 'accUsername') input.disabled = false; });\r\n     } else {\r\n-        // Lock\r\n-        editBtn.classList.add('btn-outline-maroon');\r\n-        editBtn.classList.remove('btn-maroon');\r\n+        editBtn.classList.replace('btn-maroon', 'btn-outline-maroon');\r\n         editBtn.innerHTML = '<i class=\"fas fa-edit me-1\"></i> Edit';\r\n         sendBtn.classList.add('d-none');\r\n         inputs.forEach(input => input.disabled = true);\r\n-        loadAccountData(); // Reset values\r\n-        document.getElementById('changePasswordForm').reset();\r\n+        loadAccountData();\r\n+        document.getElementById('changePasswordForm')?.reset();\r\n     }\r\n }\r\n \r\n function loadAccountData() {\r\n     const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n     if (!user.id) return;\r\n \r\n-    // Sidebar/Header Info\r\n-    const profFullName = document.getElementById('profFullName');\r\n-    if (profFullName) profFullName.textContent = user.full_name;\r\n+    const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };\r\n+    const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };\r\n \r\n-    const profRole = document.getElementById('profRole');\r\n-    if (profRole) profRole.textContent = user.role_name || 'Staff Member';\r\n+    set('profFullName', user.full_name);\r\n+    set('profRole', user.role_name || 'Staff Member');\r\n+    set('profEmployeeId', `STF-${String(user.id).padStart(5, '0')}`);\r\n+    set('profStatus', user.status || 'Active');\r\n+    set('profActivityName', user.full_name);\r\n \r\n-    const profEmployeeId = document.getElementById('profEmployeeId');\r\n-    if (profEmployeeId) profEmployeeId.textContent = `STF-${user.id.toString().padStart(5, '0')}`;\r\n-\r\n-    const profJoinDate = document.getElementById('profJoinDate');\r\n-    if (profJoinDate && user.created_at) {\r\n-        const date = new Date(user.created_at);\r\n-        const options = { year: 'numeric', month: 'long', day: 'numeric' };\r\n-        profJoinDate.textContent = date.toLocaleDateString(undefined, options);\r\n+    if (user.created_at) {\r\n+        set('profJoinDate', new Date(user.created_at).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' }));\r\n     }\r\n \r\n-    const profStatus = document.getElementById('profStatus');\r\n-    if (profStatus) {\r\n-        profStatus.innerHTML = `<i class=\"fas fa-check-circle me-2\"></i>${user.status || 'Active'}`;\r\n-    }\r\n-\r\n-    const profActivityName = document.getElementById('profActivityName');\r\n-    if (profActivityName) profActivityName.textContent = user.full_name;\r\n-\r\n-    // Form inputs\r\n-    const fullNameInput = document.getElementById('accFullName');\r\n-    if (fullNameInput) fullNameInput.value = user.full_name || '';\r\n-\r\n-    const usernameInput = document.getElementById('accUsername');\r\n-    if (usernameInput) usernameInput.value = user.username || '';\r\n-\r\n-    const emailInput = document.getElementById('accEmail');\r\n-    if (emailInput) emailInput.value = user.email || '';\r\n+    setVal('accFullName', user.full_name || '');\r\n+    setVal('accUsername', user.username || '');\r\n+    setVal('accEmail',    user.email    || '');\r\n }\r\n \r\n async function saveAccountInfo() {\r\n-    const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n-    const newFullName = document.getElementById('accFullName').value.trim();\r\n-    const newEmail = document.getElementById('accEmail').value.trim();\r\n+    const user     = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n+    const fullName = document.getElementById('accFullName')?.value.trim();\r\n+    const email    = document.getElementById('accEmail')?.value.trim();\r\n \r\n-    if (!newFullName) {\r\n+    if (!fullName) {\r\n         showModalNotification('Full Name is required', 'warning', 'Validation');\r\n         return;\r\n     }\r\n \r\n-    const payload = JSON.stringify({\r\n-        full_name: newFullName,\r\n-        email: newEmail\r\n-    });\r\n-\r\n     try {\r\n-        const res = await fetch(\\\"/php/app.php\\\", {\r\n-            method: \"POST\",\r\n-            headers: { \"Content-Type\": \"application/json\" },\r\n+        const res = await fetch('/php/app.php', {\r\n+            method: 'POST',\r\n+            headers: { 'Content-Type': 'application/json' },\r\n             body: JSON.stringify({\r\n                 table: 'requests_tbl',\r\n                 type: 'account_update',\r\n                 requester_id: user.id,\r\n-                payload: payload,\r\n+                payload: JSON.stringify({ full_name: fullName, email }),\r\n                 status: 'Pending',\r\n                 created_at: new Date().toISOString().slice(0, 19).replace('T', ' ')\r\n             })\r\n         });\r\n-\r\n         const data = await res.json();\r\n         if (data.error) throw new Error(data.error);\r\n \r\n         showModalNotification('Update request sent to administrator for approval.', 'success', 'Request Sent');\r\n-        logStaffActivity('Requested Account Update', `New Name: ${newFullName}`, 'Pending');\r\n+        logStaffActivity('Requested Account Update', `New Name: ${fullName}`, 'Pending');\r\n     } catch (err) {\r\n         console.error('Failed to send request:', err);\r\n         showModalNotification('Failed to send update request.', 'danger', 'Error');\r\n     }\r\n }\r\n \r\n async function handlePasswordUpdate() {\r\n-    const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n-    const currentPass = document.getElementById('currentPass').value;\r\n-    const newPass = document.getElementById('newPass').value;\r\n-    const confirmPass = document.getElementById('confirmPass').value;\r\n+    const user        = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n+    const currentPass = document.getElementById('currentPass')?.value;\r\n+    const newPass     = document.getElementById('newPass')?.value;\r\n+    const confirmPass = document.getElementById('confirmPass')?.value;\r\n \r\n     if (!currentPass || !newPass || !confirmPass) {\r\n         showModalNotification('Please fill in all password fields', 'warning', 'Validation');\r\n         return;\r\n     }\r\n-\r\n     if (newPass !== confirmPass) {\r\n         showModalNotification('New passwords do not match', 'warning', 'Validation');\r\n         return;\r\n     }\r\n-\r\n     if (newPass.length < 6) {\r\n         showModalNotification('Password must be at least 6 characters', 'warning', 'Validation');\r\n         return;\r\n     }\r\n \r\n-    const payload = JSON.stringify({\r\n-        current_password: currentPass,\r\n-        new_password: newPass\r\n-    });\r\n-\r\n     try {\r\n-        const res = await fetch(\"/php/app.php\", {\r\n-            method: \"POST\",\r\n-            headers: { \"Content-Type\": \"application/json\" },\r\n+        const res = await fetch('/php/app.php', {\r\n+            method: 'POST',\r\n+            headers: { 'Content-Type': 'application/json' },\r\n             body: JSON.stringify({\r\n                 table: 'requests_tbl',\r\n                 type: 'password_change',\r\n                 requester_id: user.id,\r\n-                payload: payload,\r\n+                payload: JSON.stringify({ current_password: currentPass, new_password: newPass }),\r\n                 status: 'Pending',\r\n                 created_at: new Date().toISOString().slice(0, 19).replace('T', ' ')\r\n             })\r\n         });\r\n-\r\n         const data = await res.json();\r\n         if (data.error) throw new Error(data.error);\r\n \r\n         showModalNotification('Password change request sent to administrator.', 'success', 'Request Sent');\r\n         logStaffActivity('Requested Password Change', '', 'Pending');\r\n-        document.getElementById('changePasswordForm').reset();\r\n+        document.getElementById('changePasswordForm')?.reset();\r\n     } catch (err) {\r\n         console.error('Failed to send request:', err);\r\n         showModalNotification('Failed to send request.', 'danger', 'Error');\r\n     }\r\n }\r\n \r\n-// Activity Log Functions\r\n+// ‚îÄ‚îÄ‚îÄ Activity Log ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n+\r\n function initializeActivityLogFunctionality() {\r\n     loadActivityLog();\r\n-    // Real-time updates for Activity Log\r\n-    setInterval(loadActivityLog, 10000); // Poll every 10 seconds\r\n+    setInterval(loadActivityLog, 10000);\r\n }\r\n \r\n-async function logStaffActivity(action, reference, status = 'Success') {\r\n-    const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n-    if (!user.id) return;\r\n-\r\n-    try {\r\n-        await fetch(\\\"/php/app.php\\\", {\r\n-            method: \"POST\",\r\n-            headers: { \"Content-Type\": \"application/json\" },\r\n-            body: JSON.stringify({\r\n-                table: 'activity_logs',\r\n-                user_id: user.id,\r\n-                role_label: user.role_name || 'Staff',\r\n-                action: action,\r\n-                reference: reference || 'N/A',\r\n-                status: status,\r\n-                ip_address: '127.0.0.1', // Placeholder or fetch if needed\r\n-                created_at: new Date().toISOString().slice(0, 19).replace('T', ' ')\r\n-            })\r\n-        });\r\n-        // If we are currently viewing the activity log, refresh it\r\n-        if (document.getElementById('activityLogTable')) {\r\n-            loadActivityLog();\r\n-        }\r\n-    } catch (e) {\r\n-        console.error(\"Failed to log activity:\", e);\r\n-    }\r\n-}\r\n-\r\n async function loadActivityLog() {\r\n     const tableElem = document.getElementById('activityLogTable');\r\n     if (!tableElem) return;\r\n \r\n-    const tbody = tableElem.getElementsByTagName('tbody')[0];\r\n+    const tbody = tableElem.querySelector('tbody');\r\n     if (!tbody) return;\r\n \r\n     const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n     if (!user.id) return;\r\n \r\n     try {\r\n-        const res = await fetch(`/php/app.php?table=activity_logs&user_id=${user.id}`);\r\n-        let logs = await res.json();\r\n+        const res  = await fetch(`/php/app.php?table=activity_logs&user_id=${user.id}`);\r\n+        const logs = await res.json();\r\n \r\n         if (!Array.isArray(logs)) {\r\n-            console.error(\"Invalid logs data:\", logs);\r\n+            console.error('Invalid logs data:', logs);\r\n             return;\r\n         }\r\n \r\n-        // Sort by date descending\r\n         logs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));\r\n \r\n-        if (logs.length === 0) {\r\n-            tbody.innerHTML = '<tr><td colspan=\"4\" class=\"text-center py-4\">No activity recorded yet.</td></tr>';\r\n-            return;\r\n-        }\r\n+        tbody.innerHTML = logs.length === 0\r\n+            ? '<tr><td colspan=\"4\" class=\"text-center py-4\">No activity recorded yet.</td></tr>'\r\n+            : logs.map(log => `\r\n+                <tr>\r\n+                    <td>${log.created_at}</td>\r\n+                    <td>${log.action}</td>\r\n+                    <td>${log.reference}</td>\r\n+                    <td>\r\n+                        <span class=\"badge ${log.status === 'Success' ? 'bg-success' : log.status === 'Pending' ? 'bg-warning' : 'bg-danger'}\">\r\n+                            ${log.status}\r\n+                        </span>\r\n+                    </td>\r\n+                </tr>`\r\n+            ).join('');\r\n \r\n-        tbody.innerHTML = logs.map(log => `\r\n-            <tr>\r\n-                <td>${log.created_at}</td>\r\n-                <td>${log.action}</td>\r\n-                <td>${log.reference}</td>\r\n-                <td>\r\n-                    <span class=\"badge ${log.status === 'Success' ? 'bg-success' : (log.status === 'Pending' ? 'bg-warning' : 'bg-danger')}\">\r\n-                        ${log.status}\r\n-                    </span>\r\n-                </td>\r\n-            </tr>\r\n-        `).join('');\r\n-\r\n     } catch (err) {\r\n         console.error('Failed to load activity logs:', err);\r\n     }\r\n }\r\n \r\n+// ‚îÄ‚îÄ‚îÄ User Sync ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n+\r\n async function refreshUserData() {\r\n     const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n     if (!user.id) return;\r\n \r\n     try {\r\n-        const res = await fetch(`/php/app.php?table=users&id=${user.id}`);\r\n+        const res   = await fetch(`/php/app.php?table=users&id=${user.id}`);\r\n         const users = await res.json();\r\n         const dbUser = Array.isArray(users) ? users[0] : users;\r\n \r\n-        if (dbUser && dbUser.id) {\r\n-            // Check if anything significant changed (full_name, email)\r\n-            if (dbUser.full_name !== user.full_name || dbUser.email !== user.email) {\r\n-                // Merge and update\r\n-                const updated = { ...user, ...dbUser };\r\n-                localStorage.setItem('loggedInUser', JSON.stringify(updated));\r\n+        if (dbUser?.id && (dbUser.full_name !== user.full_name || dbUser.email !== user.email)) {\r\n+            localStorage.setItem('loggedInUser', JSON.stringify({ ...user, ...dbUser }));\r\n \r\n-                // Refresh UI components\r\n-                const headerUserName = document.querySelector('.navbar .dropdown-toggle');\r\n-                if (headerUserName) {\r\n-                    headerUserName.innerHTML = `<i class=\"fas fa-user-circle me-1\"></i>${dbUser.full_name}`;\r\n-                }\r\n+            const headerUserName = document.querySelector('.navbar .dropdown-toggle');\r\n+            if (headerUserName) {\r\n+                headerUserName.innerHTML = `<i class=\"fas fa-user-circle me-1\"></i>${dbUser.full_name}`;\r\n+            }\r\n \r\n-                if (document.getElementById('accountInfoForm')) {\r\n-                    loadAccountData();\r\n-                }\r\n-            }\r\n+            if (document.getElementById('accountInfoForm')) loadAccountData();\r\n         }\r\n     } catch (e) {\r\n-        console.error(\"User data sync failed\", e);\r\n+        console.error('User data sync failed:', e);\r\n     }\r\n }\r\n \r\n-/**\r\n- * Update user status (active/inactive) in database\r\n- * @param {number} userId - User ID\r\n- * @param {string} status - 'active' or 'inactive'\r\n- * @returns {Promise} - Resolves when status is updated\r\n- */\r\n async function updateUserStatus(userId, status) {\r\n-    try {\r\n-        const response = await fetch('/php/user_status.php', {\r\n-            method: 'POST',\r\n-            headers: { 'Content-Type': 'application/json' },\r\n-            body: JSON.stringify({\r\n-                user_id: userId,\r\n-                status: status\r\n-            })\r\n-        });\r\n+    const response = await fetch('/php/user_status.php', {\r\n+        method: 'POST',\r\n+        headers: { 'Content-Type': 'application/json' },\r\n+        body: JSON.stringify({ user_id: userId, status })\r\n+    });\r\n \r\n-        if (!response.ok) {\r\n-            throw new Error(`HTTP error! status: ${response.status}`);\r\n-        }\r\n-\r\n-        const data = await response.json();\r\n-        console.log(`‚úÖ User ${userId} marked as ${status}:`, data);\r\n-        return data;\r\n-    } catch (error) {\r\n-        console.error(`‚ùå Failed to update user status:`, error);\r\n-        throw error;\r\n-    }\r\n-}\r\n-\r\n-// showModalNotification and showConfirm are defined in main.js ‚Äî not duplicated here\r\n+    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);\r\n+    return response.json();\r\n+}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1771860706709,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,10 +1,78 @@\n // Staff Dashboard JavaScript - Fixed & Cleaned\r\n \r\n+// API URL for database operations\r\n+const API_URL = \"/php/app.php\";\r\n+\r\n+// Database helper function\r\n+function createDB(table) {\r\n+    return {\r\n+        add: async (data) => {\r\n+            try {\r\n+                const res = await fetch(API_URL, {\r\n+                    method: \"POST\",\r\n+                    headers: { \"Content-Type\": \"application/json\" },\r\n+                    body: JSON.stringify({ ...data, table })\r\n+                });\r\n+                return await res.json();\r\n+            } catch (err) {\r\n+                console.error(`Add failed [${table}]:`, err);\r\n+                return { error: err.message };\r\n+            }\r\n+        },\r\n+        show: async (filters = {}) => {\r\n+            try {\r\n+                const params = new URLSearchParams({ ...filters, table }).toString();\r\n+                const res = await fetch(`${API_URL}?${params}`);\r\n+                return await res.json();\r\n+            } catch (err) {\r\n+                console.error(`Show failed [${table}]:`, err);\r\n+                return [];\r\n+            }\r\n+        },\r\n+        edit: async (data) => {\r\n+            try {\r\n+                const res = await fetch(API_URL, {\r\n+                    method: \"PUT\",\r\n+                    headers: { \"Content-Type\": \"application/json\" },\r\n+                    body: JSON.stringify({ ...data, table })\r\n+                });\r\n+                return await res.json();\r\n+            } catch (err) {\r\n+                console.error(`Edit failed [${table}]:`, err);\r\n+                return { error: err.message };\r\n+            }\r\n+        },\r\n+        delete: async (id) => {\r\n+            try {\r\n+                const res = await fetch(API_URL, {\r\n+                    method: \"DELETE\",\r\n+                    headers: { \"Content-Type\": \"application/json\" },\r\n+                    body: JSON.stringify({ id, table })\r\n+                });\r\n+                return await res.json();\r\n+            } catch (err) {\r\n+                console.error(`Delete failed [${table}]:`, err);\r\n+                return { error: err.message };\r\n+            }\r\n+        }\r\n+    };\r\n+}\r\n+\r\n+// Database objects for staff use\r\n+const menuCategoriesDB = createDB('menu_categories');\r\n+const menuItemsDB = createDB('menu_items');\r\n+const ingredientsDB = createDB('ingredients');\r\n+const salesDB = createDB('sales');\r\n+const saleItemsDB = createDB('sale_items');\r\n+const inventoryTransactionsDB = createDB('inventory_transactions');\r\n+const recipesDB = createDB('recipes');\r\n+\r\n // Global variables\r\n let currentSaleItems = [];\r\n let currentSaleId = null;\r\n let allMenuItems = [];\r\n+let allCategories = [];\r\n let allIngredients = [];\r\n let currentCustomer = null;\r\n let currentDiscount = 0;\r\n let currentCoupon = null;\r\n@@ -96,16 +164,8 @@\n \r\n // ‚îÄ‚îÄ‚îÄ Menu / POS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n \r\n function initializeMenuFunctionality() {\r\n-    document.querySelectorAll('.btn-category').forEach(tab => {\r\n-        tab.addEventListener('click', function () {\r\n-            document.querySelectorAll('.btn-category').forEach(t => t.classList.remove('active'));\r\n-            this.classList.add('active');\r\n-            filterMenuItems();\r\n-        });\r\n-    });\r\n-\r\n     document.getElementById('menuSearch')?.addEventListener('input', filterMenuItems);\r\n \r\n     document.getElementById('clearSaleBtn')?.addEventListener('click', () =>\r\n         showConfirm('Are you sure you want to clear the cart?', clearCurrentSale)\r\n@@ -116,12 +176,43 @@\n     document.getElementById('couponBtn')?.addEventListener('click', applyCoupon);\r\n     document.getElementById('holdOrderBtn')?.addEventListener('click', holdOrder);\r\n     document.getElementById('returnOrderBtn')?.addEventListener('click', handleReturn);\r\n \r\n+    // Load categories first, then menu items\r\n+    loadCategoryTabs();\r\n     loadMenuItems();\r\n     updateSaleDisplay();\r\n }\r\n \r\n+// Load category tabs from database\r\n+async function loadCategoryTabs() {\r\n+    const tabsContainer = document.getElementById('categoryTabs');\r\n+    if (!tabsContainer) return;\r\n+\r\n+    try {\r\n+        const categories = await menuCategoriesDB.show();\r\n+        allCategories = categories;\r\n+\r\n+        // Build HTML: \"All Products\" first, then DB categories\r\n+        let html = '<button class=\"btn btn-category active\" data-category=\"All\">All Products</button>';\r\n+        categories.forEach(cat => {\r\n+            html += `<button class=\"btn btn-category\" data-category=\"${cat.id}\">${cat.name}</button>`;\r\n+        });\r\n+        tabsContainer.innerHTML = html;\r\n+\r\n+        // Attach click listeners\r\n+        tabsContainer.querySelectorAll('.btn-category').forEach(tab => {\r\n+            tab.addEventListener('click', function () {\r\n+                tabsContainer.querySelectorAll('.btn-category').forEach(t => t.classList.remove('active'));\r\n+                this.classList.add('active');\r\n+                filterMenuItems();\r\n+            });\r\n+        });\r\n+    } catch (err) {\r\n+        console.error('Failed to load categories:', err);\r\n+    }\r\n+}\r\n+\r\n function selectCustomer() {\r\n     Swal.fire({\r\n         title: 'Select Customer',\r\n         input: 'text',\r\n@@ -249,32 +340,45 @@\n         });\r\n     });\r\n }\r\n \r\n-function loadMenuItems() {\r\n+async function loadMenuItems() {\r\n     const menuGrid = document.getElementById('menuItemsGrid');\r\n     if (!menuGrid) return;\r\n \r\n     menuGrid.innerHTML = '<div class=\"col-12 text-center py-5\"><div class=\"loading-spinner\"></div><p class=\"mt-2\">Fetching menu from system...</p></div>';\r\n \r\n-    setTimeout(() => {\r\n-        const savedMenu = JSON.parse(localStorage.getItem('adminMenuItems') || 'null');\r\n+    try {\r\n+        const [menuItems, categories] = await Promise.all([\r\n+            menuItemsDB.show(),\r\n+            menuCategoriesDB.show()\r\n+        ]);\r\n \r\n-        allMenuItems = (savedMenu && savedMenu.length > 0) ? savedMenu : [\r\n-            { id: 1, name: 'Beef Steak',       category: 'Main Course', price: 450, image: 'https://images.unsplash.com/photo-1600891964092-4316c288032e?w=400&h=300&fit=crop', available: true },\r\n-            { id: 2, name: 'Chicken Curry',     category: 'Main Course', price: 320, image: 'https://images.unsplash.com/photo-1603894584373-5ac82b2ae398?w=400&h=300&fit=crop', available: true },\r\n-            { id: 3, name: 'Vegetable Salad',   category: 'Appetizer',   price: 180, image: 'https://images.unsplash.com/photo-1540420773420-3366772f4999?w=400&h=300&fit=crop', available: true },\r\n-            { id: 4, name: 'Garlic Bread',      category: 'Appetizer',   price: 120, image: 'https://images.unsplash.com/photo-1573140247632-f8fd74997d5c?w=400&h=300&fit=crop', available: true },\r\n-            { id: 5, name: 'French Fries',      category: 'Side Dish',   price: 95,  image: 'https://images.unsplash.com/photo-1576107232684-1279f390859f?w=400&h=300&fit=crop', available: true },\r\n-            { id: 6, name: 'Pasta Carbonara',   category: 'Main Course', price: 280, image: 'https://images.unsplash.com/photo-1598866594230-a7c12756260f?w=400&h=300&fit=crop', available: true },\r\n-            { id: 7, name: 'Chocolate Cake',    category: 'Dessert',     price: 150, image: 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=400&h=300&fit=crop', available: true },\r\n-            { id: 8, name: 'Fruit Shake',       category: 'Beverage',    price: 85,  image: 'https://images.unsplash.com/photo-1544145945-f904253d0c71?w=400&h=300&fit=crop', available: true }\r\n-        ];\r\n+        // Create category lookup map\r\n+        const categoryMap = {};\r\n+        categories.forEach(cat => {\r\n+            categoryMap[cat.id] = cat.name;\r\n+        });\r\n \r\n-        if (!savedMenu) localStorage.setItem('adminMenuItems', JSON.stringify(allMenuItems));\r\n+        // Transform DB items to include category_name and filter only active items\r\n+        allMenuItems = menuItems\r\n+            .filter(item => item.status === 'Active' || item.status === 'active')\r\n+            .map(item => ({\r\n+                id: item.id,\r\n+                name: item.name,\r\n+                category_id: item.category_id,\r\n+                category: categoryMap[item.category_id] || 'Uncategorized',\r\n+                price: parseFloat(item.price_reference) || 0,\r\n+                image: item.image_path || 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400&h=300&fit=crop',\r\n+                description: item.description || '',\r\n+                available: true\r\n+            }));\r\n \r\n         displayMenuItems(allMenuItems);\r\n-    }, 600);\r\n+    } catch (err) {\r\n+        console.error('Failed to load menu items:', err);\r\n+        menuGrid.innerHTML = '<div class=\"col-12 text-center py-5\"><i class=\"fas fa-exclamation-circle fa-3x text-danger mb-3\"></i><p class=\"text-muted\">Failed to load menu items</p></div>';\r\n+    }\r\n }\r\n \r\n function displayMenuItems(items) {\r\n     const menuGrid = document.getElementById('menuItemsGrid');\r\n@@ -304,14 +408,17 @@\n \r\n function filterMenuItems() {\r\n     const searchTerm = document.getElementById('menuSearch')?.value.toLowerCase() || '';\r\n     const activeTab  = document.querySelector('.btn-category.active');\r\n-    const category   = activeTab ? activeTab.getAttribute('data-category') : 'All';\r\n+    const categoryValue = activeTab ? activeTab.getAttribute('data-category') : 'All';\r\n \r\n-    const filtered = allMenuItems.filter(item =>\r\n-        item.name.toLowerCase().includes(searchTerm) &&\r\n-        (category === 'All' || item.category === category)\r\n-    );\r\n+    const filtered = allMenuItems.filter(item => {\r\n+        const matchesSearch = item.name.toLowerCase().includes(searchTerm);\r\n+        const matchesCategory = categoryValue === 'All' || \r\n+            item.category_id == categoryValue || \r\n+            item.category === categoryValue;\r\n+        return matchesSearch && matchesCategory;\r\n+    });\r\n     displayMenuItems(filtered);\r\n }\r\n \r\n function addItemToSale(itemId) {\r\n"
                },
                {
                    "date": 1771861930318,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -61,8 +61,10 @@\n // Database objects for staff use\r\n const menuCategoriesDB = createDB('menu_categories');\r\n const menuItemsDB = createDB('menu_items');\r\n const ingredientsDB = createDB('ingredients');\r\n+const ingredientCategoriesDB = createDB('ingredient_categories');\r\n+const unitsDB = createDB('units');\r\n const salesDB = createDB('sales');\r\n const saleItemsDB = createDB('sale_items');\r\n const inventoryTransactionsDB = createDB('inventory_transactions');\r\n const recipesDB = createDB('recipes');\r\n@@ -578,34 +580,88 @@\n \r\n function initializeIngredientsFunctionality() {\r\n     document.getElementById('ingredientSearch')?.addEventListener('input', filterIngredients);\r\n     document.getElementById('ingredientCategoryFilter')?.addEventListener('change', filterIngredients);\r\n+    \r\n+    // Save update button listener\r\n+    const saveBtn = document.getElementById('confirmQuantityUpdate');\r\n+    if (saveBtn) {\r\n+        saveBtn.addEventListener('click', saveIngredientUpdate);\r\n+    }\r\n+    \r\n     loadIngredients();\r\n }\r\n \r\n-function loadIngredients() {\r\n+async function loadIngredients() {\r\n     const tableElem = document.getElementById('ingredientsListTable') || document.getElementById('ingredientsTable');\r\n     if (!tableElem) return;\r\n \r\n     const tbody = tableElem.querySelector('tbody');\r\n     if (!tbody) return;\r\n \r\n-    tbody.innerHTML = '<tr><td colspan=\"6\" class=\"text-center py-4\">Loading...</td></tr>';\r\n+    tbody.innerHTML = '<tr><td colspan=\"6\" class=\"text-center py-4\"><i class=\"fas fa-spinner fa-spin me-2\"></i>Loading ingredients...</td></tr>';\r\n \r\n-    setTimeout(() => {\r\n-        allIngredients = [\r\n-            { id: 1, name: 'Beef',        category: 'Meat',       quantity: 15, unit: 'kg',     status: 'Normal', minLevel: 5  },\r\n-            { id: 2, name: 'Chicken',     category: 'Meat',       quantity: 8,  unit: 'kg',     status: 'Low',    minLevel: 10 },\r\n-            { id: 3, name: 'Onions',      category: 'Vegetables', quantity: 3,  unit: 'kg',     status: 'Low',    minLevel: 5  },\r\n-            { id: 4, name: 'Cheese',      category: 'Dairy',      quantity: 4,  unit: 'kg',     status: 'Low',    minLevel: 5  },\r\n-            { id: 5, name: 'Garlic',      category: 'Spices',     quantity: 1,  unit: 'kg',     status: 'Low',    minLevel: 2  },\r\n-            { id: 6, name: 'Cooking Oil', category: 'Supplies',   quantity: 2,  unit: 'L',      status: 'Low',    minLevel: 5  },\r\n-            { id: 7, name: 'Red Wine',    category: 'Beverages',  quantity: 1,  unit: 'bottle', status: 'Low',    minLevel: 3  }\r\n-        ];\r\n+    try {\r\n+        // Fetch ingredients, categories, and units from database\r\n+        const [ingredients, categories, units] = await Promise.all([\r\n+            ingredientsDB.show(),\r\n+            ingredientCategoriesDB.show(),\r\n+            unitsDB.show()\r\n+        ]);\r\n+\r\n+        // Create lookup maps\r\n+        const categoryMap = {};\r\n+        categories.forEach(cat => { categoryMap[cat.id] = cat.name; });\r\n+\r\n+        const unitMap = {};\r\n+        units.forEach(unit => { unitMap[unit.id] = unit.abbreviation || unit.name; });\r\n+\r\n+        // Map ingredients with proper display info\r\n+        allIngredients = ingredients.map(ing => {\r\n+            const qty = parseFloat(ing.current_quantity) || 0;\r\n+            const threshold = parseFloat(ing.low_stock_threshold) || 0;\r\n+            const status = qty <= threshold ? 'Low' : 'Normal';\r\n+\r\n+            return {\r\n+                id: ing.id,\r\n+                name: ing.name,\r\n+                category: categoryMap[ing.category_id] || 'Uncategorized',\r\n+                category_id: ing.category_id,\r\n+                quantity: qty,\r\n+                unit: unitMap[ing.unit_id] || '',\r\n+                unit_id: ing.unit_id,\r\n+                status: status,\r\n+                minLevel: threshold\r\n+            };\r\n+        });\r\n+\r\n         displayIngredients(allIngredients);\r\n-    }, 500);\r\n+        populateCategoryFilter(categories);\r\n+\r\n+    } catch (error) {\r\n+        console.error('Failed to load ingredients:', error);\r\n+        tbody.innerHTML = '<tr><td colspan=\"6\" class=\"text-center py-4 text-danger\"><i class=\"fas fa-exclamation-triangle me-2\"></i>Failed to load ingredients</td></tr>';\r\n+    }\r\n }\r\n \r\n+/**\r\n+ * Populate the category filter dropdown with database categories\r\n+ */\r\n+function populateCategoryFilter(categories) {\r\n+    const filterSelect = document.getElementById('ingredientCategoryFilter');\r\n+    if (!filterSelect) return;\r\n+\r\n+    // Keep the \"All Categories\" option\r\n+    filterSelect.innerHTML = '<option value=\"\">All Categories</option>';\r\n+\r\n+    categories.forEach(cat => {\r\n+        const option = document.createElement('option');\r\n+        option.value = cat.name;\r\n+        option.textContent = cat.name;\r\n+        filterSelect.appendChild(option);\r\n+    });\r\n+}\r\n+\r\n function displayIngredients(ingredients) {\r\n     const tableElem = document.getElementById('ingredientsListTable') || document.getElementById('ingredientsTable');\r\n     if (!tableElem) return;\r\n \r\n@@ -623,14 +679,128 @@\n         </tr>`\r\n     ).join('');\r\n }\r\n \r\n+// Track currently editing ingredient\r\n+let currentEditingIngredient = null;\r\n+\r\n function showUpdateModal(id) {\r\n     const modalEl = document.getElementById('updateQuantityModal') || document.getElementById('increaseQuantityModal');\r\n     if (!modalEl) return;\r\n-    new bootstrap.Modal(modalEl).show();\r\n+\r\n+    // Find the ingredient from our loaded data\r\n+    const ingredient = allIngredients.find(ing => ing.id === id);\r\n+    if (!ingredient) {\r\n+        console.error('Ingredient not found:', id);\r\n+        return;\r\n+    }\r\n+\r\n+    currentEditingIngredient = ingredient;\r\n+\r\n+    // Populate modal with ingredient data\r\n+    const nameEl = document.getElementById('updateIngName');\r\n+    const currentStockEl = document.getElementById('currentStockDisplay');\r\n+    const unitEl = document.getElementById('stockUnitDisplay');\r\n+    const quantityInput = document.getElementById('updateQuantity');\r\n+\r\n+    if (nameEl) nameEl.textContent = ingredient.name;\r\n+    if (currentStockEl) currentStockEl.textContent = ingredient.quantity;\r\n+    if (unitEl) unitEl.textContent = ingredient.unit;\r\n+    if (quantityInput) quantityInput.value = '';\r\n+\r\n+    // Reset radio buttons\r\n+    const increaseRadio = document.getElementById('increase');\r\n+    if (increaseRadio) increaseRadio.checked = true;\r\n+\r\n+    const modal = new bootstrap.Modal(modalEl);\r\n+    modal.show();\r\n }\r\n \r\n+/**\r\n+ * Save updated ingredient quantity to database\r\n+ */\r\n+async function saveIngredientUpdate() {\r\n+    if (!currentEditingIngredient) {\r\n+        showModalNotification('No ingredient selected', 'warning', 'Error');\r\n+        return;\r\n+    }\r\n+\r\n+    const quantityInput = document.getElementById('updateAmount');\r\n+    const changeQty = parseFloat(quantityInput?.value) || 0;\r\n+\r\n+    if (changeQty <= 0) {\r\n+        showModalNotification('Please enter a valid quantity', 'warning', 'Validation Error');\r\n+        return;\r\n+    }\r\n+\r\n+    const isIncrease = document.getElementById('increase')?.checked;\r\n+    const reason = document.getElementById('updateReason')?.value || 'Manual adjustment';\r\n+    const prevQty = currentEditingIngredient.quantity;\r\n+    const newQty = isIncrease ? prevQty + changeQty : prevQty - changeQty;\r\n+\r\n+    if (newQty < 0) {\r\n+        showModalNotification('Cannot reduce below zero', 'warning', 'Validation Error');\r\n+        return;\r\n+    }\r\n+\r\n+    // Show loading state\r\n+    const saveBtn = document.getElementById('confirmQuantityUpdate');\r\n+    const originalText = saveBtn ? saveBtn.innerHTML : '';\r\n+    if (saveBtn) {\r\n+        saveBtn.disabled = true;\r\n+        saveBtn.innerHTML = '<i class=\"fas fa-spinner fa-spin me-1\"></i> Saving...';\r\n+    }\r\n+\r\n+    try {\r\n+        // Update ingredient in database\r\n+        await ingredientsDB.edit({\r\n+            id: currentEditingIngredient.id,\r\n+            current_quantity: newQty,\r\n+            updated_at: new Date().toISOString().slice(0, 19).replace('T', ' ')\r\n+        });\r\n+\r\n+        // Log the transaction\r\n+        const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n+        await inventoryTransactionsDB.add({\r\n+            ingredient_id: currentEditingIngredient.id,\r\n+            change_qty: isIncrease ? changeQty : -changeQty,\r\n+            transaction_type: isIncrease ? 'restock' : 'usage',\r\n+            reason: reason,\r\n+            performed_by: user.id || null,\r\n+            prev_qty: prevQty,\r\n+            new_qty: newQty,\r\n+            timestamp: new Date().toISOString().slice(0, 19).replace('T', ' ')\r\n+        });\r\n+\r\n+        // Close modal\r\n+        const modalEl = document.getElementById('updateQuantityModal');\r\n+        const modal = bootstrap.Modal.getInstance(modalEl);\r\n+        if (modal) modal.hide();\r\n+\r\n+        showModalNotification(\r\n+            `${currentEditingIngredient.name} updated: ${prevQty} ‚Üí ${newQty} ${currentEditingIngredient.unit}`,\r\n+            'success',\r\n+            'Stock Updated'\r\n+        );\r\n+\r\n+        // Log activity\r\n+        logStaffActivity('inventory', `Updated ${currentEditingIngredient.name}: ${isIncrease ? '+' : '-'}${changeQty} ${currentEditingIngredient.unit} (${reason})`);\r\n+\r\n+        // Reload ingredients\r\n+        loadIngredients();\r\n+\r\n+    } catch (error) {\r\n+        console.error('Failed to update ingredient:', error);\r\n+        showModalNotification('Failed to update stock: ' + error.message, 'error', 'Update Error');\r\n+    } finally {\r\n+        // Restore button state\r\n+        if (saveBtn) {\r\n+            saveBtn.disabled = false;\r\n+            saveBtn.innerHTML = originalText || 'Save Update';\r\n+        }\r\n+    }\r\n+}\r\n+\r\n function filterIngredients() {\r\n     const searchTerm = document.getElementById('ingredientSearch')?.value.toLowerCase() || '';\r\n     const category   = document.getElementById('ingredientCategoryFilter')?.value || '';\r\n \r\n"
                },
                {
                    "date": 1771862130131,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -668,23 +668,124 @@\n     const tbody = tableElem.querySelector('tbody');\r\n     if (!tbody) return;\r\n \r\n     tbody.innerHTML = ingredients.map(ing => `\r\n-        <tr>\r\n-            <td>${ing.name}</td>\r\n-            <td>${ing.category}</td>\r\n-            <td>${ing.quantity} ${ing.unit}</td>\r\n-            <td>${ing.minLevel ?? '-'}</td>\r\n-            <td><span class=\"badge ${ing.status === 'Normal' ? 'bg-success' : 'bg-warning'}\">${ing.status}</span></td>\r\n-            <td><button class=\"btn btn-sm btn-outline-maroon\" onclick=\"showUpdateModal(${ing.id})\">Update</button></td>\r\n+        <tr class=\"${ing.status === 'Low' ? 'table-warning' : ''}\">\r\n+            <td><strong>${ing.name}</strong></td>\r\n+            <td><span class=\"badge bg-secondary\">${ing.category}</span></td>\r\n+            <td>\r\n+                <span class=\"fw-bold ${ing.status === 'Low' ? 'text-danger' : 'text-success'}\">${ing.quantity}</span> \r\n+                <small class=\"text-muted\">${ing.unit}</small>\r\n+            </td>\r\n+            <td><small class=\"text-muted\">${ing.minLevel ?? '-'} ${ing.unit}</small></td>\r\n+            <td>\r\n+                <span class=\"badge ${ing.status === 'Normal' ? 'bg-success' : 'bg-warning text-dark'}\">\r\n+                    <i class=\"fas ${ing.status === 'Normal' ? 'fa-check-circle' : 'fa-exclamation-triangle'} me-1\"></i>${ing.status}\r\n+                </span>\r\n+            </td>\r\n+            <td>\r\n+                <div class=\"btn-group btn-group-sm\" role=\"group\">\r\n+                    <button class=\"btn btn-success\" onclick=\"showRestockModal(${ing.id})\" title=\"Restock\">\r\n+                        <i class=\"fas fa-plus\"></i>\r\n+                    </button>\r\n+                    <button class=\"btn btn-warning text-dark\" onclick=\"showUsageModal(${ing.id})\" title=\"Record Usage\">\r\n+                        <i class=\"fas fa-minus\"></i>\r\n+                    </button>\r\n+                    <button class=\"btn btn-outline-secondary\" onclick=\"showIngredientHistory(${ing.id})\" title=\"View History\">\r\n+                        <i class=\"fas fa-history\"></i>\r\n+                    </button>\r\n+                </div>\r\n+            </td>\r\n         </tr>`\r\n     ).join('');\r\n+\r\n+    // Update total count if element exists\r\n+    const totalCount = document.getElementById('ingredientsTotalCount');\r\n+    if (totalCount) {\r\n+        totalCount.textContent = `${ingredients.length} ingredients`;\r\n+    }\r\n }\r\n \r\n // Track currently editing ingredient\r\n let currentEditingIngredient = null;\r\n+let currentUpdateType = 'restock'; // 'restock' or 'usage'\r\n \r\n-function showUpdateModal(id) {\r\n+/**\r\n+ * Show modal for restocking (adding) inventory\r\n+ */\r\n+function showRestockModal(id) {\r\n+    currentUpdateType = 'restock';\r\n+    showUpdateModal(id, 'restock');\r\n+}\r\n+\r\n+/**\r\n+ * Show modal for recording usage (removing) inventory\r\n+ */\r\n+function showUsageModal(id) {\r\n+    currentUpdateType = 'usage';\r\n+    showUpdateModal(id, 'usage');\r\n+}\r\n+\r\n+/**\r\n+ * Show ingredient transaction history\r\n+ */\r\n+async function showIngredientHistory(id) {\r\n+    const ingredient = allIngredients.find(ing => ing.id === id);\r\n+    if (!ingredient) return;\r\n+\r\n+    try {\r\n+        // Fetch transactions for this ingredient\r\n+        const transactions = await inventoryTransactionsDB.show({ ingredient_id: id });\r\n+        \r\n+        let historyHtml = '';\r\n+        if (transactions && transactions.length > 0) {\r\n+            historyHtml = transactions.slice(-10).reverse().map(t => {\r\n+                const isPositive = parseFloat(t.change_qty) > 0;\r\n+                const date = new Date(t.timestamp).toLocaleDateString();\r\n+                const time = new Date(t.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});\r\n+                return `\r\n+                    <div class=\"d-flex justify-content-between align-items-center border-bottom py-2\">\r\n+                        <div>\r\n+                            <span class=\"badge ${isPositive ? 'bg-success' : 'bg-danger'} me-2\">\r\n+                                ${isPositive ? '+' : ''}${t.change_qty}\r\n+                            </span>\r\n+                            <small class=\"text-muted\">${t.reason || t.transaction_type}</small>\r\n+                        </div>\r\n+                        <small class=\"text-muted\">${date} ${time}</small>\r\n+                    </div>\r\n+                `;\r\n+            }).join('');\r\n+        } else {\r\n+            historyHtml = '<p class=\"text-muted text-center py-3\">No transaction history</p>';\r\n+        }\r\n+\r\n+        // Use SweetAlert2 to show history\r\n+        Swal.fire({\r\n+            title: `<i class=\"fas fa-history me-2\"></i>${ingredient.name}`,\r\n+            html: `\r\n+                <div class=\"text-start\">\r\n+                    <p class=\"mb-2\">\r\n+                        <strong>Current Stock:</strong> ${ingredient.quantity} ${ingredient.unit}<br>\r\n+                        <strong>Min Level:</strong> ${ingredient.minLevel} ${ingredient.unit}\r\n+                    </p>\r\n+                    <hr>\r\n+                    <h6>Recent Transactions:</h6>\r\n+                    <div style=\"max-height: 250px; overflow-y: auto;\">\r\n+                        ${historyHtml}\r\n+                    </div>\r\n+                </div>\r\n+            `,\r\n+            width: 500,\r\n+            showCloseButton: true,\r\n+            showConfirmButton: false\r\n+        });\r\n+    } catch (error) {\r\n+        console.error('Failed to load history:', error);\r\n+        showModalNotification('Failed to load transaction history', 'error', 'Error');\r\n+    }\r\n+}\r\n+\r\n+function showUpdateModal(id, type = 'restock') {\r\n     const modalEl = document.getElementById('updateQuantityModal') || document.getElementById('increaseQuantityModal');\r\n     if (!modalEl) return;\r\n \r\n     // Find the ingredient from our loaded data\r\n@@ -694,24 +795,43 @@\n         return;\r\n     }\r\n \r\n     currentEditingIngredient = ingredient;\r\n+    currentUpdateType = type;\r\n \r\n     // Populate modal with ingredient data\r\n     const nameEl = document.getElementById('updateIngName');\r\n     const currentStockEl = document.getElementById('currentStockDisplay');\r\n     const unitEl = document.getElementById('stockUnitDisplay');\r\n-    const quantityInput = document.getElementById('updateQuantity');\r\n+    const amountInput = document.getElementById('updateAmount');\r\n+    const unitTextEl = document.querySelector('.unit-text');\r\n \r\n     if (nameEl) nameEl.textContent = ingredient.name;\r\n     if (currentStockEl) currentStockEl.textContent = ingredient.quantity;\r\n     if (unitEl) unitEl.textContent = ingredient.unit;\r\n-    if (quantityInput) quantityInput.value = '';\r\n+    if (unitTextEl) unitTextEl.textContent = ingredient.unit;\r\n+    if (amountInput) amountInput.value = '1.00';\r\n \r\n-    // Reset radio buttons\r\n+    // Set the correct radio button based on type\r\n     const increaseRadio = document.getElementById('increase');\r\n-    if (increaseRadio) increaseRadio.checked = true;\r\n+    const decreaseRadio = document.getElementById('decrease');\r\n+    \r\n+    if (type === 'restock' && increaseRadio) {\r\n+        increaseRadio.checked = true;\r\n+    } else if (type === 'usage' && decreaseRadio) {\r\n+        decreaseRadio.checked = true;\r\n+    }\r\n \r\n+    // Update modal title based on type\r\n+    const modalTitle = modalEl.querySelector('.modal-title');\r\n+    if (modalTitle) {\r\n+        if (type === 'restock') {\r\n+            modalTitle.innerHTML = '<i class=\"fas fa-plus-circle me-2\"></i>Restock Inventory';\r\n+        } else {\r\n+            modalTitle.innerHTML = '<i class=\"fas fa-minus-circle me-2\"></i>Record Usage';\r\n+        }\r\n+    }\r\n+\r\n     const modal = new bootstrap.Modal(modalEl);\r\n     modal.show();\r\n }\r\n \r\n"
                },
                {
                    "date": 1771914953973,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,26 @@\n // Staff Dashboard JavaScript - Fixed & Cleaned\r\n \r\n-// API URL for database operations\r\n-const API_URL = \"/php/app.php\";\r\n+// API URL for database operations (relative path works on any server)\r\n+const API_URL = \"php/app.php\";\r\n \r\n+// Loading modal helper functions\r\n+function showLoadingModal(message = 'Loading data...') {\r\n+    if (window.Swal) {\r\n+        Swal.fire({\r\n+            title: message,\r\n+            html: '<div class=\"d-flex justify-content-center\"><div class=\"spinner-border text-primary\" role=\"status\"><span class=\"visually-hidden\">Loading...</span></div></div>',\r\n+            allowOutsideClick: false,\r\n+            showConfirmButton: false,\r\n+            didOpen: () => { Swal.showLoading(); }\r\n+        });\r\n+    }\r\n+}\r\n+\r\n+function hideLoadingModal() {\r\n+    if (window.Swal) Swal.close();\r\n+}\r\n+\r\n // Database helper function\r\n function createDB(table) {\r\n     return {\r\n         add: async (data) => {\r\n@@ -140,9 +157,9 @@\n     const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n     if (!user.id) return;\r\n \r\n     try {\r\n-        await fetch('/php/app.php', {\r\n+        await fetch(API_URL, {\r\n             method: 'POST',\r\n             headers: { 'Content-Type': 'application/json' },\r\n             body: JSON.stringify({\r\n                 table: 'activity_logs',\r\n@@ -150,9 +167,9 @@\n                 role_label: user.role_name || 'Staff',\r\n                 action,\r\n                 reference,\r\n                 status,\r\n-                ip_address: '127.0.0.1',\r\n+                ip_address: window.location.hostname,\r\n                 created_at: new Date().toISOString().slice(0, 19).replace('T', ' ')\r\n             })\r\n         });\r\n \r\n@@ -348,8 +365,10 @@\n     if (!menuGrid) return;\r\n \r\n     menuGrid.innerHTML = '<div class=\"col-12 text-center py-5\"><div class=\"loading-spinner\"></div><p class=\"mt-2\">Fetching menu from system...</p></div>';\r\n \r\n+    showLoadingModal('Loading menu items...');\r\n+\r\n     try {\r\n         const [menuItems, categories] = await Promise.all([\r\n             menuItemsDB.show(),\r\n             menuCategoriesDB.show()\r\n@@ -363,23 +382,32 @@\n \r\n         // Transform DB items to include category_name and filter only active items\r\n         allMenuItems = menuItems\r\n             .filter(item => item.status === 'Active' || item.status === 'active')\r\n-            .map(item => ({\r\n-                id: item.id,\r\n-                name: item.name,\r\n-                category_id: item.category_id,\r\n-                category: categoryMap[item.category_id] || 'Uncategorized',\r\n-                price: parseFloat(item.price_reference) || 0,\r\n-                image: item.image_path || 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400&h=300&fit=crop',\r\n-                description: item.description || '',\r\n-                available: true\r\n-            }));\r\n+            .map(item => {\r\n+                // Fix image path - handle both absolute and relative paths\r\n+                let imgPath = item.image_path || '';\r\n+                if (imgPath.startsWith('/')) {\r\n+                    imgPath = imgPath.substring(1); // Remove leading slash\r\n+                }\r\n+                return {\r\n+                    id: item.id,\r\n+                    name: item.name,\r\n+                    category_id: item.category_id,\r\n+                    category: categoryMap[item.category_id] || 'Uncategorized',\r\n+                    price: parseFloat(item.price_reference) || 0,\r\n+                    image: imgPath || 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400&h=300&fit=crop',\r\n+                    description: item.description || '',\r\n+                    available: true\r\n+                };\r\n+            });\r\n \r\n         displayMenuItems(allMenuItems);\r\n     } catch (err) {\r\n         console.error('Failed to load menu items:', err);\r\n         menuGrid.innerHTML = '<div class=\"col-12 text-center py-5\"><i class=\"fas fa-exclamation-circle fa-3x text-danger mb-3\"></i><p class=\"text-muted\">Failed to load menu items</p></div>';\r\n+    } finally {\r\n+        hideLoadingModal();\r\n     }\r\n }\r\n \r\n function displayMenuItems(items) {\r\n@@ -599,8 +627,10 @@\n     if (!tbody) return;\r\n \r\n     tbody.innerHTML = '<tr><td colspan=\"6\" class=\"text-center py-4\"><i class=\"fas fa-spinner fa-spin me-2\"></i>Loading ingredients...</td></tr>';\r\n \r\n+    showLoadingModal('Loading ingredients...');\r\n+\r\n     try {\r\n         // Fetch ingredients, categories, and units from database\r\n         const [ingredients, categories, units] = await Promise.all([\r\n             ingredientsDB.show(),\r\n@@ -639,8 +669,10 @@\n \r\n     } catch (error) {\r\n         console.error('Failed to load ingredients:', error);\r\n         tbody.innerHTML = '<tr><td colspan=\"6\" class=\"text-center py-4 text-danger\"><i class=\"fas fa-exclamation-triangle me-2\"></i>Failed to load ingredients</td></tr>';\r\n+    } finally {\r\n+        hideLoadingModal();\r\n     }\r\n }\r\n \r\n /**\r\n@@ -1018,9 +1050,9 @@\n         return;\r\n     }\r\n \r\n     try {\r\n-        const res = await fetch('/php/app.php', {\r\n+        const res = await fetch(API_URL, {\r\n             method: 'POST',\r\n             headers: { 'Content-Type': 'application/json' },\r\n             body: JSON.stringify({\r\n                 table: 'requests_tbl',\r\n@@ -1061,9 +1093,9 @@\n         return;\r\n     }\r\n \r\n     try {\r\n-        const res = await fetch('/php/app.php', {\r\n+        const res = await fetch(API_URL, {\r\n             method: 'POST',\r\n             headers: { 'Content-Type': 'application/json' },\r\n             body: JSON.stringify({\r\n                 table: 'requests_tbl',\r\n@@ -1103,9 +1135,9 @@\n     const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n     if (!user.id) return;\r\n \r\n     try {\r\n-        const res  = await fetch(`/php/app.php?table=activity_logs&user_id=${user.id}`);\r\n+        const res  = await fetch(`${API_URL}?table=activity_logs&user_id=${user.id}`);\r\n         const logs = await res.json();\r\n \r\n         if (!Array.isArray(logs)) {\r\n             console.error('Invalid logs data:', logs);\r\n@@ -1140,9 +1172,9 @@\n     const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n     if (!user.id) return;\r\n \r\n     try {\r\n-        const res   = await fetch(`/php/app.php?table=users&id=${user.id}`);\r\n+        const res   = await fetch(`${API_URL}?table=users&id=${user.id}`);\r\n         const users = await res.json();\r\n         const dbUser = Array.isArray(users) ? users[0] : users;\r\n \r\n         if (dbUser?.id && (dbUser.full_name !== user.full_name || dbUser.email !== user.email)) {\r\n@@ -1160,9 +1192,9 @@\n     }\r\n }\r\n \r\n async function updateUserStatus(userId, status) {\r\n-    const response = await fetch('/php/user_status.php', {\r\n+    const response = await fetch('php/user_status.php', {\r\n         method: 'POST',\r\n         headers: { 'Content-Type': 'application/json' },\r\n         body: JSON.stringify({ user_id: userId, status })\r\n     });\r\n"
                },
                {
                    "date": 1771916210697,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,9 +7,8 @@\n function showLoadingModal(message = 'Loading data...') {\r\n     if (window.Swal) {\r\n         Swal.fire({\r\n             title: message,\r\n-            html: '<div class=\"d-flex justify-content-center\"><div class=\"spinner-border text-primary\" role=\"status\"><span class=\"visually-hidden\">Loading...</span></div></div>',\r\n             allowOutsideClick: false,\r\n             showConfirmButton: false,\r\n             didOpen: () => { Swal.showLoading(); }\r\n         });\r\n"
                }
            ],
            "date": 1771856401123,
            "name": "Commit-0",
            "content": "// Staff Dashboard JavaScript - Updated for Multi-page support\r\n\r\n// Global variables\r\nlet currentSaleItems = [];\r\nlet currentSaleId = null;\r\nlet allMenuItems = [];\r\nlet allIngredients = [];\r\nlet currentCustomer = null;\r\nlet currentDiscount = 0; // percentage\r\nlet currentCoupon = null;\r\n\r\n// DOM Ready\r\ndocument.addEventListener('DOMContentLoaded', function () {\r\n    // Initialize tooltips - only if bootstrap is available\r\n    if (typeof bootstrap !== 'undefined') {\r\n        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle=\"tooltip\"]'));\r\n        tooltipTriggerList.map(function (tooltipTriggerEl) {\r\n            return new bootstrap.Tooltip(tooltipTriggerEl);\r\n        });\r\n    }\r\n\r\n    // Initialize only the sections present on the current page\r\n    initializeCommonStaffFeatures();\r\n\r\n    // Auto-initialize based on elements present\r\n    if (document.getElementById('menuItemsGrid')) initializeMenuFunctionality();\r\n    if (document.getElementById('ingredientsListTable') || document.getElementById('ingredientsTable')) initializeIngredientsFunctionality();\r\n    if (document.getElementById('recentReceipts')) initializeReceiptsFunctionality();\r\n    if (document.getElementById('changePasswordForm')) initializeAccountFunctionality();\r\n    if (document.getElementById('activityLogTable')) initializeActivityLogFunctionality();\r\n\r\n    // Start background sync\r\n    setInterval(refreshUserData, 15000); // 15 seconds\r\n});\r\n\r\n// // Aliases for compatibility with separate pages\r\n// // const loadMenuItems = () => initializeMenuFunctionality();\r\n// const loadMenuItemsData = () => loadMenuItems();\r\n// // const loadIngredients = () => initializeIngredientsFunctionality();\r\n// const loadIngredientsData = () => loadIngredients();\r\nconst loadReceipts = () => initializeReceiptsFunctionality();\r\n// const loadRecentReceipts = () => initializeReceiptsFunctionality();\r\n// const loadAccountInfo = () => initializeAccountFunctionality();\r\n// const loadActivityLog = () => initializeActivityLogFunctionality();\r\n\r\n// Common features for all staff pages\r\nfunction initializeCommonStaffFeatures() {\r\n    // Update logged in user name in header\r\n    const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n    const headerUserName = document.querySelector('.navbar .dropdown-toggle');\r\n    if (headerUserName && user.full_name) {\r\n        headerUserName.innerHTML = `<i class=\"fas fa-user-circle me-1\"></i>${user.full_name}`;\r\n    }\r\n\r\n    // Logout button (global)\r\n    const logoutBtn = document.getElementById('logoutBtn');\r\n    if (logoutBtn) {\r\n        logoutBtn.addEventListener('click', function (e) {\r\n            e.preventDefault();\r\n            showConfirm('Are you sure you want to logout?', function () {\r\n                localStorage.removeItem('loggedInRole');\r\n                localStorage.removeItem('loggedInUser');\r\n                window.location.href = 'index.html';\r\n            });\r\n        });\r\n    }\r\n}\r\n\r\n// Menu Sales Functions\r\nfunction initializeMenuFunctionality() {\r\n    // Category Tabs functionality\r\n    const categoryTabs = document.querySelectorAll('.btn-category');\r\n    categoryTabs.forEach(tab => {\r\n        tab.addEventListener('click', function () {\r\n            categoryTabs.forEach(t => t.classList.remove('active'));\r\n            this.classList.add('active');\r\n            filterMenuItems();\r\n        });\r\n    });\r\n\r\n    // Search functionality\r\n    const menuSearch = document.getElementById('menuSearch');\r\n    if (menuSearch) {\r\n        menuSearch.addEventListener('input', filterMenuItems);\r\n    }\r\n\r\n    // Cart action buttons\r\n    const clearSaleBtn = document.getElementById('clearSaleBtn');\r\n    if (clearSaleBtn) {\r\n        clearSaleBtn.addEventListener('click', function () {\r\n            showConfirm('Are you sure you want to clear the cart?', clearCurrentSale);\r\n        });\r\n    }\r\n\r\n    const checkoutBtn = document.getElementById('checkoutBtn');\r\n    if (checkoutBtn) {\r\n        checkoutBtn.addEventListener('click', function () {\r\n            processCheckout();\r\n        });\r\n    }\r\n\r\n    // New POS Feature Buttons\r\n    const selectCustomerBtn = document.getElementById('selectCustomerBtn');\r\n    if (selectCustomerBtn) {\r\n        selectCustomerBtn.addEventListener('click', selectCustomer);\r\n    }\r\n\r\n    const discountBtn = document.getElementById('discountBtn');\r\n    if (discountBtn) {\r\n        discountBtn.addEventListener('click', applyDiscount);\r\n    }\r\n\r\n    const couponBtn = document.getElementById('couponBtn');\r\n    if (couponBtn) {\r\n        couponBtn.addEventListener('click', applyCoupon);\r\n    }\r\n\r\n    const holdOrderBtn = document.getElementById('holdOrderBtn');\r\n    if (holdOrderBtn) {\r\n        holdOrderBtn.addEventListener('click', holdOrder);\r\n    }\r\n\r\n    const returnOrderBtn = document.getElementById('returnOrderBtn');\r\n    if (returnOrderBtn) {\r\n        returnOrderBtn.addEventListener('click', handleReturn);\r\n    }\r\n\r\n    // Load initial data\r\n    loadMenuItems();\r\n    updateSaleDisplay();\r\n}\r\n\r\n// POS Feature Implementations\r\nfunction selectCustomer() {\r\n    Swal.fire({\r\n        title: 'Select Customer',\r\n        input: 'text',\r\n        inputLabel: 'Enter Customer Name',\r\n        inputPlaceholder: 'Search or add new customer...',\r\n        showCancelButton: true,\r\n        confirmButtonColor: '#800000',\r\n    }).then((result) => {\r\n        if (result.isConfirmed && result.value) {\r\n            currentCustomer = result.value;\r\n            showModalNotification(`Customer \"${currentCustomer}\" selected.`, 'success', 'Customer Selected');\r\n            updateSaleDisplay();\r\n            logStaffActivity('Selected Customer', currentCustomer, 'Success');\r\n        }\r\n    });\r\n}\r\n\r\nfunction applyDiscount() {\r\n    Swal.fire({\r\n        title: 'Apply Discount',\r\n        input: 'number',\r\n        inputLabel: 'Enter Discount Percentage (%)',\r\n        inputPlaceholder: '0',\r\n        inputAttributes: { min: 0, max: 100 },\r\n        showCancelButton: true,\r\n        confirmButtonColor: '#800000',\r\n    }).then((result) => {\r\n        if (result.isConfirmed) {\r\n            currentDiscount = parseFloat(result.value) || 0;\r\n            updateSaleDisplay();\r\n            logStaffActivity('Applied Discount', `${currentDiscount}%`, 'Success');\r\n        }\r\n    });\r\n}\r\n\r\nfunction applyCoupon() {\r\n    Swal.fire({\r\n        title: 'Apply Coupon',\r\n        input: 'text',\r\n        inputLabel: 'Enter Coupon Code',\r\n        inputPlaceholder: 'SAVE10, FREE50, etc.',\r\n        showCancelButton: true,\r\n        confirmButtonColor: '#800000',\r\n    }).then((result) => {\r\n        if (result.isConfirmed) {\r\n            const code = result.value.toUpperCase();\r\n            if (code === 'SAVE10') {\r\n                currentCoupon = { code: 'SAVE10', type: 'percentage', value: 10 };\r\n                showModalNotification('Coupon \"SAVE10\" (10% Off) applied!', 'success', 'Coupon Applied');\r\n            } else if (code === 'FREE50') {\r\n                currentCoupon = { code: 'FREE50', type: 'fixed', value: 50 };\r\n                showModalNotification('Coupon \"FREE50\" (P50 Off) applied!', 'success', 'Coupon Applied');\r\n            } else {\r\n                Swal.fire('Invalid Coupon', 'The coupon code entered is not valid.', 'error');\r\n                return;\r\n            }\r\n            updateSaleDisplay();\r\n            logStaffActivity('Applied Coupon', code, 'Success');\r\n        }\r\n    });\r\n}\r\n\r\nfunction holdOrder() {\r\n    if (currentSaleItems.length === 0) {\r\n        Swal.fire('Error', 'Cart is empty. Nothing to hold.', 'error');\r\n        return;\r\n    }\r\n\r\n    const heldOrders = JSON.parse(localStorage.getItem('heldOrders')) || [];\r\n    const newHold = {\r\n        id: 'HOLD-' + Date.now(),\r\n        timestamp: Date.now(),\r\n        items: [...currentSaleItems],\r\n        customer: currentCustomer,\r\n        discount: currentDiscount,\r\n        coupon: currentCoupon\r\n    };\r\n\r\n    heldOrders.push(newHold);\r\n    localStorage.setItem('heldOrders', JSON.stringify(heldOrders));\r\n\r\n    showModalNotification('Order has been put on hold.', 'info', 'Order Held');\r\n    logStaffActivity('Held Order', newHold.id, 'Success');\r\n    clearCurrentSale();\r\n}\r\n\r\nfunction handleReturn() {\r\n    // Show recent sales to select for return\r\n    const sales = JSON.parse(localStorage.getItem('sales')) || [];\r\n    if (sales.length === 0) {\r\n        Swal.fire('No Transactions', 'No recent transactions found to return.', 'info');\r\n        return;\r\n    }\r\n\r\n    const inputOptions = {};\r\n    sales.slice(0, 10).forEach(s => {\r\n        inputOptions[s.id] = `${s.id} - P${s.total.toFixed(2)} (${s.time})`;\r\n    });\r\n\r\n    Swal.fire({\r\n        title: 'Select Transaction to Return',\r\n        input: 'select',\r\n        inputOptions: inputOptions,\r\n        inputPlaceholder: 'Select a receipt...',\r\n        showCancelButton: true,\r\n        confirmButtonColor: '#800000',\r\n    }).then((result) => {\r\n        if (result.isConfirmed && result.value) {\r\n            const saleId = result.value;\r\n            Swal.fire({\r\n                title: 'Confirm Return',\r\n                text: `Are you sure you want to process a return for ${saleId}?`,\r\n                icon: 'warning',\r\n                showCancelButton: true,\r\n                confirmButtonColor: '#d33',\r\n                confirmButtonText: 'Yes, Return'\r\n            }).then((confirm) => {\r\n                if (confirm.isConfirmed) {\r\n                    // Logic to mark as returned or remove\r\n                    let updatedSales = sales.filter(s => s.id !== saleId);\r\n                    localStorage.setItem('sales', JSON.stringify(updatedSales));\r\n                    showModalNotification('Transaction successfully returned and voided.', 'success', 'Return Processed');\r\n                    logStaffActivity('Processed Return', saleId, 'Success');\r\n                }\r\n            });\r\n        }\r\n    });\r\n}\r\n\r\nfunction loadMenuItems() {\r\n    const menuGrid = document.getElementById('menuItemsGrid');\r\n    if (!menuGrid) return;\r\n\r\n    // Show loading\r\n    menuGrid.innerHTML = '<div class=\"col-12 text-center py-5\"><div class=\"loading-spinner\"></div><p class=\"mt-2\">Fetching menu from system...</p></div>';\r\n\r\n    // Simulate real-time fetch from Admin/DB\r\n    setTimeout(() => {\r\n        // Try to load from \"adminMenuItems\" (synced from admin) if available\r\n        const savedMenu = JSON.parse(localStorage.getItem('adminMenuItems'));\r\n\r\n        if (savedMenu && savedMenu.length > 0) {\r\n            allMenuItems = savedMenu;\r\n        } else {\r\n            // Default demo items if none in storage\r\n            allMenuItems = [\r\n                { id: 1, name: 'Beef Steak', category: 'Main Course', price: 450, image: 'https://images.unsplash.com/photo-1600891964092-4316c288032e?w=400&h=300&fit=crop', available: true },\r\n                { id: 2, name: 'Chicken Curry', category: 'Main Course', price: 320, image: 'https://images.unsplash.com/photo-1603894584373-5ac82b2ae398?w=400&h=300&fit=crop', available: true },\r\n                { id: 3, name: 'Vegetable Salad', category: 'Appetizer', price: 180, image: 'https://images.unsplash.com/photo-1540420773420-3366772f4999?w=400&h=300&fit=crop', available: true },\r\n                { id: 4, name: 'Garlic Bread', category: 'Appetizer', price: 120, image: 'https://images.unsplash.com/photo-1573140247632-f8fd74997d5c?w=400&h=300&fit=crop', available: true },\r\n                { id: 5, name: 'French Fries', category: 'Side Dish', price: 95, image: 'https://images.unsplash.com/photo-1576107232684-1279f390859f?w=400&h=300&fit=crop', available: true },\r\n                { id: 6, name: 'Pasta Carbonara', category: 'Main Course', price: 280, image: 'https://images.unsplash.com/photo-1598866594230-a7c12756260f?w=400&h=300&fit=crop', available: true },\r\n                { id: 7, name: 'Chocolate Cake', category: 'Dessert', price: 150, image: 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=400&h=300&fit=crop', available: true },\r\n                { id: 8, name: 'Fruit Shake', category: 'Beverage', price: 85, image: 'https://images.unsplash.com/photo-1544145945-f904253d0c71?w=400&h=300&fit=crop', available: true }\r\n            ];\r\n            localStorage.setItem('adminMenuItems', JSON.stringify(allMenuItems));\r\n        }\r\n\r\n        displayMenuItems(allMenuItems);\r\n    }, 600);\r\n}\r\n\r\nfunction displayMenuItems(items) {\r\n    const menuGrid = document.getElementById('menuItemsGrid');\r\n    if (!menuGrid) return;\r\n\r\n    menuGrid.innerHTML = '';\r\n\r\n    if (items.length === 0) {\r\n        menuGrid.innerHTML = '<div class=\"col-12 text-center py-5\"><i class=\"fas fa-search fa-3x text-muted mb-3\"></i><p class=\"text-muted\">No items found matching your filter</p></div>';\r\n        return;\r\n    }\r\n\r\n    items.forEach(item => {\r\n        const col = document.createElement('div');\r\n        col.className = 'col-6 col-md-4 col-lg-3 mb-3';\r\n\r\n        const imgSrc = item.image || 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400&h=300&fit=crop';\r\n\r\n        col.innerHTML = `\r\n            <div class=\"menu-item-card\" data-id=\"${item.id}\" onclick=\"addItemToSale(${item.id})\">\r\n                <div class=\"menu-item-img-container\">\r\n                    <img src=\"${imgSrc}\" alt=\"${item.name}\" class=\"menu-item-img\">\r\n                    <div class=\"price-tag\">P${parseFloat(item.price).toFixed(2)}</div>\r\n                </div>\r\n                <div class=\"p-2 text-center\">\r\n                    <div class=\"fw-bold mb-0 text-truncate\" style=\"font-size: 0.85rem\">${item.name}</div>\r\n                </div>\r\n            </div>\r\n        `;\r\n\r\n        menuGrid.appendChild(col);\r\n    });\r\n}\r\n\r\nfunction filterMenuItems() {\r\n    const searchTerm = document.getElementById('menuSearch')?.value.toLowerCase() || '';\r\n    const activeTab = document.querySelector('.btn-category.active');\r\n    const category = activeTab ? activeTab.getAttribute('data-category') : 'All';\r\n\r\n    const filtered = allMenuItems.filter(item =>\r\n        item.name.toLowerCase().includes(searchTerm) &&\r\n        (category === 'All' || item.category === category)\r\n    );\r\n    displayMenuItems(filtered);\r\n}\r\n\r\nfunction addItemToSale(itemId) {\r\n    const product = allMenuItems.find(item => item.id == itemId);\r\n    if (!product) return;\r\n\r\n    const existingItem = currentSaleItems.find(item => item.id == itemId);\r\n    if (existingItem) {\r\n        existingItem.quantity += 1;\r\n    } else {\r\n        currentSaleItems.push({\r\n            id: product.id,\r\n            name: product.name,\r\n            price: product.price,\r\n            img: product.image,\r\n            quantity: 1\r\n        });\r\n    }\r\n    updateSaleDisplay();\r\n\r\n    // Tiny toast or visual feedback\r\n    const card = document.querySelector(`.menu-item-card[data-id=\"${itemId}\"]`);\r\n    if (card) {\r\n        card.classList.add('animate-add');\r\n        setTimeout(() => card.classList.remove('animate-add'), 400);\r\n    }\r\n}\r\n\r\nfunction updateSaleDisplay() {\r\n    const container = document.getElementById('cartItemsList');\r\n    const subtotalEl = document.getElementById('cartSubtotal');\r\n    const taxEl = document.getElementById('cartTaxes');\r\n    const totalEl = document.getElementById('cartTotal');\r\n    const cartCountEl = document.getElementById('cartCount');\r\n    const checkoutBtn = document.getElementById('checkoutBtn');\r\n\r\n    if (!container) return;\r\n\r\n    // Update Customer Display in Sidebar if exists\r\n    const customerDisplay = document.querySelector('.customer-name-display');\r\n    if (customerDisplay) {\r\n        customerDisplay.textContent = currentCustomer || 'Walk-in Customer';\r\n    }\r\n\r\n    if (currentSaleItems.length === 0) {\r\n        container.innerHTML = `<div class=\"text-center py-5 empty-cart-msg\"><p class=\"text-muted\">No items in cart</p></div>`;\r\n        subtotalEl.textContent = 'P0.00';\r\n        taxEl.textContent = 'P0.00';\r\n        totalEl.textContent = 'P0.00';\r\n        cartCountEl.textContent = '0';\r\n        checkoutBtn.disabled = true;\r\n        return;\r\n    }\r\n\r\n    let subtotal = 0;\r\n    let itemsCount = 0;\r\n    let itemsHtml = '';\r\n\r\n    currentSaleItems.forEach((item, index) => {\r\n        subtotal += item.price * item.quantity;\r\n        itemsCount += item.quantity;\r\n        itemsHtml += `\r\n            <div class=\"cart-item\">\r\n                <div class=\"cart-item-details\">\r\n                    <span class=\"cart-item-name\">${item.name}</span>\r\n                    <span class=\"cart-item-price\">P${(item.price * item.quantity).toFixed(2)}</span>\r\n                </div>\r\n                <div class=\"qty-controls\">\r\n                    <button class=\"btn-qty\" onclick=\"changeQty(${index}, -1)\"><i class=\"fas fa-minus\"></i></button>\r\n                    <span class=\"fw-bold mx-1\">${item.quantity}</span>\r\n                    <button class=\"btn-qty\" onclick=\"changeQty(${index}, 1)\"><i class=\"fas fa-plus\"></i></button>\r\n                    <button class=\"cart-item-remove ms-2\" onclick=\"removeSaleItem(${index})\"><i class=\"fas fa-trash-alt\"></i></button>\r\n                </div>\r\n            </div>\r\n        `;\r\n    });\r\n\r\n    // Apply Discount\r\n    let discountAmount = (subtotal * (currentDiscount / 100));\r\n\r\n    // Apply Coupon\r\n    if (currentCoupon) {\r\n        if (currentCoupon.type === 'percentage') {\r\n            discountAmount += (subtotal * (currentCoupon.value / 100));\r\n        } else {\r\n            discountAmount += currentCoupon.value;\r\n        }\r\n    }\r\n\r\n    const discountedSubtotal = Math.max(0, subtotal - discountAmount);\r\n    const taxes = discountedSubtotal * 0.12;\r\n    const total = discountedSubtotal + taxes;\r\n\r\n    container.innerHTML = itemsHtml;\r\n    subtotalEl.textContent = 'P' + subtotal.toFixed(2);\r\n\r\n    // Display Discounts if any\r\n    if (discountAmount > 0) {\r\n        subtotalEl.innerHTML += ` <span class=\"text-danger small\">( -P${discountAmount.toFixed(2)} )</span>`;\r\n    }\r\n\r\n    taxEl.textContent = 'P' + taxes.toFixed(2);\r\n    totalEl.textContent = 'P' + total.toFixed(2);\r\n    cartCountEl.textContent = itemsCount;\r\n    checkoutBtn.disabled = false;\r\n}\r\n\r\nfunction changeQty(index, delta) {\r\n    currentSaleItems[index].quantity += delta;\r\n    if (currentSaleItems[index].quantity <= 0) {\r\n        currentSaleItems.splice(index, 1);\r\n    }\r\n    updateSaleDisplay();\r\n}\r\n\r\nfunction removeSaleItem(index) {\r\n    currentSaleItems.splice(index, 1);\r\n    updateSaleDisplay();\r\n}\r\n\r\nfunction clearCurrentSale() {\r\n    currentSaleItems = [];\r\n    currentCustomer = null;\r\n    currentDiscount = 0;\r\n    currentCoupon = null;\r\n    updateSaleDisplay();\r\n}\r\n\r\nfunction processCheckout() {\r\n    if (currentSaleItems.length === 0) return;\r\n\r\n    Swal.fire({\r\n        title: 'Confirm Checkout',\r\n        text: `Total Amount: ${document.getElementById('cartTotal').textContent}`,\r\n        icon: 'question',\r\n        showCancelButton: true,\r\n        confirmButtonColor: '#800000',\r\n        cancelButtonColor: '#6c757d',\r\n        confirmButtonText: 'Confirm'\r\n    }).then((result) => {\r\n        if (result.isConfirmed) {\r\n            recordSale();\r\n        }\r\n    });\r\n}\r\n\r\nfunction recordSale() {\r\n    const subtotal = currentSaleItems.reduce((acc, item) => acc + (item.price * item.quantity), 0);\r\n    let discountAmt = (subtotal * (currentDiscount / 100));\r\n    if (currentCoupon) {\r\n        discountAmt += (currentCoupon.type === 'percentage' ? (subtotal * (currentCoupon.value / 100)) : currentCoupon.value);\r\n    }\r\n    const finalSubtotal = Math.max(0, subtotal - discountAmt);\r\n    const taxes = finalSubtotal * 0.12;\r\n    const total = finalSubtotal + taxes;\r\n\r\n    const newSale = {\r\n        id: 'SALE-' + Date.now(),\r\n        date: new Date().toISOString().split('T')[0],\r\n        time: new Date().toLocaleTimeString(),\r\n        timestamp: Date.now(),\r\n        items: [...currentSaleItems],\r\n        subtotal: subtotal,\r\n        discount: discountAmt,\r\n        taxes: taxes,\r\n        total: total,\r\n        customer: currentCustomer || 'Walk-in',\r\n        staff: 'Staff Account'\r\n    };\r\n\r\n    // Save to sales history\r\n    let sales = JSON.parse(localStorage.getItem('sales')) || [];\r\n    sales.unshift(newSale); // Newest first\r\n    localStorage.setItem('sales', JSON.stringify(sales));\r\n\r\n    // Dedut ingredients (Simulated sync with inventory)\r\n    updateIngredientsStock(currentSaleItems);\r\n    logStaffActivity('Recorded Sale', `${newSale.id} - Total: P${newSale.total.toFixed(2)} - Customer: ${newSale.customer}`, 'Success');\r\n\r\n    Swal.fire('Success!', 'Transaction recorded.', 'success');\r\n\r\n    clearCurrentSale();\r\n}\r\n\r\n// Real-time listener for Admin changes\r\nwindow.addEventListener('storage', (e) => {\r\n    if (e.key === 'adminMenuItems') {\r\n        console.log(\"Admin updated menu, refreshing POS...\");\r\n        loadMenuItems();\r\n    }\r\n});\r\n\r\nfunction updateIngredientsStock(saleItems) {\r\n    let ingredients = JSON.parse(localStorage.getItem('ingredients')) || [];\r\n    let recipes = JSON.parse(localStorage.getItem('adminRecipes')) || [];\r\n\r\n    saleItems.forEach(saleItem => {\r\n        // Find recipe for this menu item\r\n        const recipe = recipes.find(r => r.menuItem === saleItem.name);\r\n        if (recipe) {\r\n            recipe.ingredients.forEach(recIng => {\r\n                const ing = ingredients.find(i => i.name === recIng.name);\r\n                if (ing) {\r\n                    ing.quantity -= (recIng.qty * saleItem.quantity);\r\n                    if (ing.quantity < 0) ing.quantity = 0;\r\n                }\r\n            });\r\n        }\r\n    });\r\n\r\n    localStorage.setItem('ingredients', JSON.stringify(ingredients));\r\n}\r\n\r\n// Global Activity Logging - Connects to Admin's systemActivityLogs\r\nfunction logStaffActivity(action, details, status) {\r\n    let logs = [];\r\n    try {\r\n        const stored = localStorage.getItem('systemActivityLogs');\r\n        if (stored) logs = JSON.parse(stored);\r\n    } catch (e) { logs = []; }\r\n\r\n    const now = new Date();\r\n    const pad = n => String(n).padStart(2, '0');\r\n    const ts = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;\r\n\r\n    const newLog = {\r\n        id: Date.now(),\r\n        userName: 'Staff User', // Could be dynamic based on login\r\n        action: action,\r\n        reference: details,\r\n        timestamp: ts,\r\n        category: action.includes('Sale') || action.includes('Return') ? 'Sales' : 'Staff',\r\n        ip: '192.168.1.10'\r\n    };\r\n\r\n    logs.unshift(newLog);\r\n    if (logs.length > 500) logs = logs.slice(0, 500);\r\n    localStorage.setItem('systemActivityLogs', JSON.stringify(logs));\r\n}\r\n\r\n// Ingredients Functions\r\nfunction initializeIngredientsFunctionality() {\r\n    const searchInput = document.getElementById('ingredientSearch');\r\n    if (searchInput) {\r\n        searchInput.addEventListener('input', filterIngredients);\r\n    }\r\n\r\n    const categoryFilter = document.getElementById('ingredientCategoryFilter');\r\n    if (categoryFilter) {\r\n        categoryFilter.addEventListener('change', filterIngredients);\r\n    }\r\n\r\n    loadIngredients();\r\n}\r\n\r\nfunction loadIngredients() {\r\n    console.log(\"‚úÖ loadIngredients() called\");\r\n\r\n    const tableElem =\r\n        document.getElementById('ingredientsListTable') ||\r\n        document.getElementById('ingredientsTable');\r\n\r\n    console.log(\"üîé Table element found:\", tableElem);\r\n\r\n    if (!tableElem) {\r\n        console.warn(\"‚ùå Table element not found!\");\r\n        return;\r\n    }\r\n\r\n    const tbody = tableElem.querySelector('tbody');\r\n    console.log(\"üîé tbody:\", tbody);\r\n\r\n    if (!tbody) {\r\n        console.warn(\"‚ùå tbody not found!\");\r\n        return;\r\n    }\r\n\r\n    tbody.innerHTML = '<tr><td colspan=\"6\" class=\"text-center py-4\">Loading...</td></tr>';\r\n\r\n    setTimeout(() => {\r\n        console.log(\"üì¶ Setting ingredient data\");\r\n\r\n        allIngredients = [\r\n            { id: 1, name: 'Beef', category: 'Meat', quantity: 15, unit: 'kg', status: 'Normal', minLevel: 5 },\r\n            { id: 2, name: 'Chicken', category: 'Meat', quantity: 8, unit: 'kg', status: 'Low', minLevel: 10 },\r\n            { id: 3, name: 'Onions', category: 'Vegetables', quantity: 3, unit: 'kg', status: 'Low', minLevel: 5 },\r\n            { id: 4, name: 'Cheese', category: 'Dairy', quantity: 4, unit: 'kg', status: 'Low', minLevel: 5 },\r\n            { id: 5, name: 'Garlic', category: 'Spices', quantity: 1, unit: 'kg', status: 'Low', minLevel: 2 },\r\n            { id: 6, name: 'Cooking Oil', category: 'Supplies', quantity: 2, unit: 'L', status: 'Low', minLevel: 5 },\r\n            { id: 7, name: 'Red Wine', category: 'Beverages', quantity: 1, unit: 'bottle', status: 'Low', minLevel: 3 }\r\n        ];\r\n\r\n        displayIngredients(allIngredients);\r\n\r\n    }, 500);\r\n}\r\n\r\n\r\nfunction displayIngredients(ingredients) {\r\n    const tableElem = document.getElementById('ingredientsListTable') || document.getElementById('ingredientsTable');\r\n    if (!tableElem) return;\r\n\r\n    const tbody = tableElem.getElementsByTagName('tbody')[0];\r\n    if (!tbody) return;\r\n\r\n    tbody.innerHTML = '';\r\n    ingredients.forEach(ing => {\r\n        const row = tbody.insertRow();\r\n        row.innerHTML = `\r\n            <td>${ing.name}</td>\r\n            <td>${ing.category}</td>\r\n            <td>${ing.quantity} ${ing.unit}</td>\r\n            <td>${ing.minLevel || '-'}</td>\r\n            <td><span class=\"badge ${ing.status === 'Normal' ? 'bg-success' : 'bg-warning'}\">${ing.status}</span></td>\r\n            <td><button class=\"btn btn-sm btn-outline-maroon\" onclick=\"showUpdateModal(${ing.id})\">Update</button></td>\r\n        `;\r\n    });\r\n}\r\n\r\nfunction showUpdateModal(id) {\r\n    // Logic to show update modal\r\n    const modal = new bootstrap.Modal(document.getElementById('updateQuantityModal') || document.getElementById('increaseQuantityModal'));\r\n    modal.show();\r\n}\r\n\r\nfunction filterIngredients() {\r\n    const searchTerm = document.getElementById('ingredientSearch')?.value.toLowerCase() || '';\r\n    const category = document.getElementById('ingredientCategoryFilter')?.value || '';\r\n\r\n    const filtered = allIngredients.filter(ing =>\r\n        ing.name.toLowerCase().includes(searchTerm) &&\r\n        (category === '' || ing.category === category)\r\n    );\r\n    displayIngredients(filtered);\r\n}\r\n\r\n// Receipts Functions\r\nfunction initializeReceiptsFunctionality() {\r\n    loadRecentReceipts();\r\n}\r\n\r\nfunction loadRecentReceipts() {\r\n    const container = document.getElementById('recentReceipts');\r\n    if (!container) return;\r\n\r\n    container.innerHTML = '<a href=\"#\" class=\"list-group-item list-group-item-action\">No recent receipts</a>';\r\n}\r\n\r\n// Account Functions\r\nfunction initializeAccountFunctionality() {\r\n    loadAccountData();\r\n\r\n    const editBtn = document.getElementById('editAccountBtn');\r\n    const sendBtn = document.getElementById('sendAccountRequestBtn');\r\n\r\n    if (editBtn) {\r\n        editBtn.addEventListener('click', function () {\r\n            toggleAccountEdit();\r\n        });\r\n    }\r\n\r\n    if (sendBtn) {\r\n        sendBtn.addEventListener('click', async function () {\r\n            const fullName = document.getElementById('accFullName').value.trim();\r\n            const email = document.getElementById('accEmail').value.trim();\r\n            const currentPass = document.getElementById('currentPass').value;\r\n            const newPass = document.getElementById('newPass').value;\r\n            const confirmPass = document.getElementById('confirmPass').value;\r\n\r\n            // Determine what's being requested\r\n            if (fullName || email) {\r\n                await saveAccountInfo();\r\n            }\r\n\r\n            if (currentPass || newPass || confirmPass) {\r\n                await handlePasswordUpdate();\r\n            }\r\n\r\n            // After sending, lock back\r\n            toggleAccountEdit(false);\r\n        });\r\n    }\r\n}\r\n\r\nfunction toggleAccountEdit(forceState) {\r\n    const editBtn = document.getElementById('editAccountBtn');\r\n    const sendBtn = document.getElementById('sendAccountRequestBtn');\r\n    const inputs = document.querySelectorAll('#accountInfoForm input, #changePasswordForm input:not(#accUsername)');\r\n\r\n    const isLocked = forceState !== undefined ? !forceState : editBtn.classList.contains('btn-outline-maroon');\r\n\r\n    if (isLocked) {\r\n        // Unlock\r\n        editBtn.classList.remove('btn-outline-maroon');\r\n        editBtn.classList.add('btn-maroon');\r\n        editBtn.innerHTML = '<i class=\"fas fa-times me-1\"></i> Cancel';\r\n        sendBtn.classList.remove('d-none');\r\n        inputs.forEach(input => {\r\n            if (input.id !== 'accUsername') input.disabled = false;\r\n        });\r\n    } else {\r\n        // Lock\r\n        editBtn.classList.add('btn-outline-maroon');\r\n        editBtn.classList.remove('btn-maroon');\r\n        editBtn.innerHTML = '<i class=\"fas fa-edit me-1\"></i> Edit';\r\n        sendBtn.classList.add('d-none');\r\n        inputs.forEach(input => input.disabled = true);\r\n        loadAccountData(); // Reset values\r\n        document.getElementById('changePasswordForm').reset();\r\n    }\r\n}\r\n\r\nfunction loadAccountData() {\r\n    const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n    if (!user.id) return;\r\n\r\n    // Sidebar/Header Info\r\n    const profFullName = document.getElementById('profFullName');\r\n    if (profFullName) profFullName.textContent = user.full_name;\r\n\r\n    const profRole = document.getElementById('profRole');\r\n    if (profRole) profRole.textContent = user.role_name || 'Staff Member';\r\n\r\n    const profEmployeeId = document.getElementById('profEmployeeId');\r\n    if (profEmployeeId) profEmployeeId.textContent = `STF-${user.id.toString().padStart(5, '0')}`;\r\n\r\n    const profJoinDate = document.getElementById('profJoinDate');\r\n    if (profJoinDate && user.created_at) {\r\n        const date = new Date(user.created_at);\r\n        const options = { year: 'numeric', month: 'long', day: 'numeric' };\r\n        profJoinDate.textContent = date.toLocaleDateString(undefined, options);\r\n    }\r\n\r\n    const profStatus = document.getElementById('profStatus');\r\n    if (profStatus) {\r\n        profStatus.innerHTML = `<i class=\"fas fa-check-circle me-2\"></i>${user.status || 'Active'}`;\r\n    }\r\n\r\n    const profActivityName = document.getElementById('profActivityName');\r\n    if (profActivityName) profActivityName.textContent = user.full_name;\r\n\r\n    // Form inputs\r\n    const fullNameInput = document.getElementById('accFullName');\r\n    if (fullNameInput) fullNameInput.value = user.full_name || '';\r\n\r\n    const usernameInput = document.getElementById('accUsername');\r\n    if (usernameInput) usernameInput.value = user.username || '';\r\n\r\n    const emailInput = document.getElementById('accEmail');\r\n    if (emailInput) emailInput.value = user.email || '';\r\n}\r\n\r\nasync function saveAccountInfo() {\r\n    const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n    const newFullName = document.getElementById('accFullName').value.trim();\r\n    const newEmail = document.getElementById('accEmail').value.trim();\r\n\r\n    if (!newFullName) {\r\n        showModalNotification('Full Name is required', 'warning', 'Validation');\r\n        return;\r\n    }\r\n\r\n    const payload = JSON.stringify({\r\n        full_name: newFullName,\r\n        email: newEmail\r\n    });\r\n\r\n    try {\r\n        const res = await fetch(\\\"/php/app.php\\\", {\r\n            method: \"POST\",\r\n            headers: { \"Content-Type\": \"application/json\" },\r\n            body: JSON.stringify({\r\n                table: 'requests_tbl',\r\n                type: 'account_update',\r\n                requester_id: user.id,\r\n                payload: payload,\r\n                status: 'Pending',\r\n                created_at: new Date().toISOString().slice(0, 19).replace('T', ' ')\r\n            })\r\n        });\r\n\r\n        const data = await res.json();\r\n        if (data.error) throw new Error(data.error);\r\n\r\n        showModalNotification('Update request sent to administrator for approval.', 'success', 'Request Sent');\r\n        logStaffActivity('Requested Account Update', `New Name: ${newFullName}`, 'Pending');\r\n    } catch (err) {\r\n        console.error('Failed to send request:', err);\r\n        showModalNotification('Failed to send update request.', 'danger', 'Error');\r\n    }\r\n}\r\n\r\nasync function handlePasswordUpdate() {\r\n    const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n    const currentPass = document.getElementById('currentPass').value;\r\n    const newPass = document.getElementById('newPass').value;\r\n    const confirmPass = document.getElementById('confirmPass').value;\r\n\r\n    if (!currentPass || !newPass || !confirmPass) {\r\n        showModalNotification('Please fill in all password fields', 'warning', 'Validation');\r\n        return;\r\n    }\r\n\r\n    if (newPass !== confirmPass) {\r\n        showModalNotification('New passwords do not match', 'warning', 'Validation');\r\n        return;\r\n    }\r\n\r\n    if (newPass.length < 6) {\r\n        showModalNotification('Password must be at least 6 characters', 'warning', 'Validation');\r\n        return;\r\n    }\r\n\r\n    const payload = JSON.stringify({\r\n        current_password: currentPass,\r\n        new_password: newPass\r\n    });\r\n\r\n    try {\r\n        const res = await fetch(\"/php/app.php\", {\r\n            method: \"POST\",\r\n            headers: { \"Content-Type\": \"application/json\" },\r\n            body: JSON.stringify({\r\n                table: 'requests_tbl',\r\n                type: 'password_change',\r\n                requester_id: user.id,\r\n                payload: payload,\r\n                status: 'Pending',\r\n                created_at: new Date().toISOString().slice(0, 19).replace('T', ' ')\r\n            })\r\n        });\r\n\r\n        const data = await res.json();\r\n        if (data.error) throw new Error(data.error);\r\n\r\n        showModalNotification('Password change request sent to administrator.', 'success', 'Request Sent');\r\n        logStaffActivity('Requested Password Change', '', 'Pending');\r\n        document.getElementById('changePasswordForm').reset();\r\n    } catch (err) {\r\n        console.error('Failed to send request:', err);\r\n        showModalNotification('Failed to send request.', 'danger', 'Error');\r\n    }\r\n}\r\n\r\n// Activity Log Functions\r\nfunction initializeActivityLogFunctionality() {\r\n    loadActivityLog();\r\n    // Real-time updates for Activity Log\r\n    setInterval(loadActivityLog, 10000); // Poll every 10 seconds\r\n}\r\n\r\nasync function logStaffActivity(action, reference, status = 'Success') {\r\n    const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n    if (!user.id) return;\r\n\r\n    try {\r\n        await fetch(\\\"/php/app.php\\\", {\r\n            method: \"POST\",\r\n            headers: { \"Content-Type\": \"application/json\" },\r\n            body: JSON.stringify({\r\n                table: 'activity_logs',\r\n                user_id: user.id,\r\n                role_label: user.role_name || 'Staff',\r\n                action: action,\r\n                reference: reference || 'N/A',\r\n                status: status,\r\n                ip_address: '127.0.0.1', // Placeholder or fetch if needed\r\n                created_at: new Date().toISOString().slice(0, 19).replace('T', ' ')\r\n            })\r\n        });\r\n        // If we are currently viewing the activity log, refresh it\r\n        if (document.getElementById('activityLogTable')) {\r\n            loadActivityLog();\r\n        }\r\n    } catch (e) {\r\n        console.error(\"Failed to log activity:\", e);\r\n    }\r\n}\r\n\r\nasync function loadActivityLog() {\r\n    const tableElem = document.getElementById('activityLogTable');\r\n    if (!tableElem) return;\r\n\r\n    const tbody = tableElem.getElementsByTagName('tbody')[0];\r\n    if (!tbody) return;\r\n\r\n    const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n    if (!user.id) return;\r\n\r\n    try {\r\n        const res = await fetch(`/php/app.php?table=activity_logs&user_id=${user.id}`);\r\n        let logs = await res.json();\r\n\r\n        if (!Array.isArray(logs)) {\r\n            console.error(\"Invalid logs data:\", logs);\r\n            return;\r\n        }\r\n\r\n        // Sort by date descending\r\n        logs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));\r\n\r\n        if (logs.length === 0) {\r\n            tbody.innerHTML = '<tr><td colspan=\"4\" class=\"text-center py-4\">No activity recorded yet.</td></tr>';\r\n            return;\r\n        }\r\n\r\n        tbody.innerHTML = logs.map(log => `\r\n            <tr>\r\n                <td>${log.created_at}</td>\r\n                <td>${log.action}</td>\r\n                <td>${log.reference}</td>\r\n                <td>\r\n                    <span class=\"badge ${log.status === 'Success' ? 'bg-success' : (log.status === 'Pending' ? 'bg-warning' : 'bg-danger')}\">\r\n                        ${log.status}\r\n                    </span>\r\n                </td>\r\n            </tr>\r\n        `).join('');\r\n\r\n    } catch (err) {\r\n        console.error('Failed to load activity logs:', err);\r\n    }\r\n}\r\n\r\nasync function refreshUserData() {\r\n    const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');\r\n    if (!user.id) return;\r\n\r\n    try {\r\n        const res = await fetch(`/php/app.php?table=users&id=${user.id}`);\r\n        const users = await res.json();\r\n        const dbUser = Array.isArray(users) ? users[0] : users;\r\n\r\n        if (dbUser && dbUser.id) {\r\n            // Check if anything significant changed (full_name, email)\r\n            if (dbUser.full_name !== user.full_name || dbUser.email !== user.email) {\r\n                // Merge and update\r\n                const updated = { ...user, ...dbUser };\r\n                localStorage.setItem('loggedInUser', JSON.stringify(updated));\r\n\r\n                // Refresh UI components\r\n                const headerUserName = document.querySelector('.navbar .dropdown-toggle');\r\n                if (headerUserName) {\r\n                    headerUserName.innerHTML = `<i class=\"fas fa-user-circle me-1\"></i>${dbUser.full_name}`;\r\n                }\r\n\r\n                if (document.getElementById('accountInfoForm')) {\r\n                    loadAccountData();\r\n                }\r\n            }\r\n        }\r\n    } catch (e) {\r\n        console.error(\"User data sync failed\", e);\r\n    }\r\n}\r\n\r\n// showModalNotification and showConfirm are defined in main.js ‚Äî not duplicated here\r\n"
        }
    ]
}