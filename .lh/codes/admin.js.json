{
    "sourceFile": "codes/admin.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 17,
            "patches": [
                {
                    "date": 1771514826624,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1771514836281,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,6 +1,6 @@\n // Admin Dashboard JavaScript - Updated with User Management and Multi-page fixes\r\n-\r\n+import { unitsDB } from \"./db.js\";\r\n // Global variables\r\n let tempAccountActive = false;\r\n let currentRequestType = null;\r\n let currentRequestId = null;\r\n@@ -1364,10 +1364,10 @@\n     // Load initial data\r\n     loadUserManagement();\r\n }\r\n \r\n-import { unitsDB } from \"./db.js\";\r\n \r\n+\r\n async function loadUnits() {\r\n     const unitSelect = document.getElementById(\"ingredientUnit\");\r\n     unitSelect.innerHTML = `<option value=\"\">Select Unit</option>`; \r\n \r\n"
                },
                {
                    "date": 1771514875360,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,6 +1,6 @@\n // Admin Dashboard JavaScript - Updated with User Management and Multi-page fixes\r\n-import { unitsDB } from \"./db.js\";\r\n+\r\n // Global variables\r\n let tempAccountActive = false;\r\n let currentRequestType = null;\r\n let currentRequestId = null;\r\n@@ -1364,10 +1364,10 @@\n     // Load initial data\r\n     loadUserManagement();\r\n }\r\n \r\n+import { unitsDB } from \"./db.js\";\r\n \r\n-\r\n async function loadUnits() {\r\n     const unitSelect = document.getElementById(\"ingredientUnit\");\r\n     unitSelect.innerHTML = `<option value=\"\">Select Unit</option>`; \r\n \r\n"
                },
                {
                    "date": 1771514886295,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1364,33 +1364,10 @@\n     // Load initial data\r\n     loadUserManagement();\r\n }\r\n \r\n-import { unitsDB } from \"./db.js\";\r\n \r\n-async function loadUnits() {\r\n-    const unitSelect = document.getElementById(\"ingredientUnit\");\r\n-    unitSelect.innerHTML = `<option value=\"\">Select Unit</option>`; \r\n \r\n-    const units = await unitsDB.show();\r\n-\r\n-    if (!units || units.length === 0) {\r\n-        unitSelect.innerHTML = `<option value=\"\">No units found</option>`;\r\n-        return;\r\n-    }\r\n-\r\n-    units.forEach(unit => {\r\n-        const opt = document.createElement(\"option\");\r\n-        opt.value = unit.id;             // Value = unit ID\r\n-        opt.textContent = unit.short_name || unit.name; // Visible text\r\n-        unitSelect.appendChild(opt);\r\n-    });\r\n-}\r\n-\r\n-// Load units on modal open\r\n-document.getElementById(\"addIngredientModal\").addEventListener(\"shown.bs.modal\", loadUnits);\r\n-\r\n-\r\n function loadUserManagement() {\r\n     loadActiveUsers();\r\n     loadDeletedUsers();\r\n }\r\n"
                },
                {
                    "date": 1771514899756,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,8 +4,11 @@\n let tempAccountActive = false;\r\n let currentRequestType = null;\r\n let currentRequestId = null;\r\n \r\n+\r\n+import { unitsDB } from \"./db.js\";\r\n+\r\n // DOM Ready\r\n document.addEventListener('DOMContentLoaded', function () {\r\n     // Initialize tooltips - only if bootstrap is available\r\n     if (typeof bootstrap !== 'undefined') {\r\n"
                },
                {
                    "date": 1771514910213,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,8 +7,30 @@\n \r\n \r\n import { unitsDB } from \"./db.js\";\r\n \r\n+async function loadUnits() {\r\n+    const unitSelect = document.getElementById(\"ingredientUnit\");\r\n+    unitSelect.innerHTML = `<option value=\"\">Select Unit</option>`; \r\n+\r\n+    const units = await unitsDB.show();\r\n+\r\n+    if (!units || units.length === 0) {\r\n+        unitSelect.innerHTML = `<option value=\"\">No units found</option>`;\r\n+        return;\r\n+    }\r\n+\r\n+    units.forEach(unit => {\r\n+        const opt = document.createElement(\"option\");\r\n+        opt.value = unit.id;             // Value = unit ID\r\n+        opt.textContent = unit.short_name || unit.name; // Visible text\r\n+        unitSelect.appendChild(opt);\r\n+    });\r\n+}\r\n+\r\n+// Load units on modal open\r\n+document.getElementById(\"addIngredientModal\").addEventListener(\"shown.bs.modal\", loadUnits);\r\n+\r\n // DOM Ready\r\n document.addEventListener('DOMContentLoaded', function () {\r\n     // Initialize tooltips - only if bootstrap is available\r\n     if (typeof bootstrap !== 'undefined') {\r\n"
                },
                {
                    "date": 1771515042572,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,28 +5,28 @@\n let currentRequestType = null;\r\n let currentRequestId = null;\r\n \r\n \r\n-import { unitsDB } from \"./db.js\";\r\n+// import { unitsDB } from \"./db.js\";\r\n \r\n-async function loadUnits() {\r\n-    const unitSelect = document.getElementById(\"ingredientUnit\");\r\n-    unitSelect.innerHTML = `<option value=\"\">Select Unit</option>`; \r\n+// async function loadUnits() {\r\n+//     const unitSelect = document.getElementById(\"ingredientUnit\");\r\n+//     unitSelect.innerHTML = `<option value=\"\">Select Unit</option>`; \r\n \r\n-    const units = await unitsDB.show();\r\n+//     const units = await unitsDB.show();\r\n \r\n-    if (!units || units.length === 0) {\r\n-        unitSelect.innerHTML = `<option value=\"\">No units found</option>`;\r\n-        return;\r\n-    }\r\n+//     if (!units || units.length === 0) {\r\n+//         unitSelect.innerHTML = `<option value=\"\">No units found</option>`;\r\n+//         return;\r\n+//     }\r\n \r\n-    units.forEach(unit => {\r\n-        const opt = document.createElement(\"option\");\r\n-        opt.value = unit.id;             // Value = unit ID\r\n-        opt.textContent = unit.short_name || unit.name; // Visible text\r\n-        unitSelect.appendChild(opt);\r\n-    });\r\n-}\r\n+//     units.forEach(unit => {\r\n+//         const opt = document.createElement(\"option\");\r\n+//         opt.value = unit.id;             // Value = unit ID\r\n+//         opt.textContent = unit.short_name || unit.name; // Visible text\r\n+//         unitSelect.appendChild(opt);\r\n+//     });\r\n+// }\r\n \r\n // Load units on modal open\r\n document.getElementById(\"addIngredientModal\").addEventListener(\"shown.bs.modal\", loadUnits);\r\n \r\n"
                },
                {
                    "date": 1771515052749,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,29 +5,10 @@\n let currentRequestType = null;\r\n let currentRequestId = null;\r\n \r\n \r\n-// import { unitsDB } from \"./db.js\";\r\n \r\n-// async function loadUnits() {\r\n-//     const unitSelect = document.getElementById(\"ingredientUnit\");\r\n-//     unitSelect.innerHTML = `<option value=\"\">Select Unit</option>`; \r\n \r\n-//     const units = await unitsDB.show();\r\n-\r\n-//     if (!units || units.length === 0) {\r\n-//         unitSelect.innerHTML = `<option value=\"\">No units found</option>`;\r\n-//         return;\r\n-//     }\r\n-\r\n-//     units.forEach(unit => {\r\n-//         const opt = document.createElement(\"option\");\r\n-//         opt.value = unit.id;             // Value = unit ID\r\n-//         opt.textContent = unit.short_name || unit.name; // Visible text\r\n-//         unitSelect.appendChild(opt);\r\n-//     });\r\n-// }\r\n-\r\n // Load units on modal open\r\n document.getElementById(\"addIngredientModal\").addEventListener(\"shown.bs.modal\", loadUnits);\r\n \r\n // DOM Ready\r\n"
                },
                {
                    "date": 1771515058903,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,7 +1,28 @@\n // Admin Dashboard JavaScript - Updated with User Management and Multi-page fixes\r\n \r\n // Global variables\r\n+\r\n+import { unitsDB } from \"./db.js\";\r\n+\r\n+async function loadUnits() {\r\n+    const unitSelect = document.getElementById(\"ingredientUnit\");\r\n+    unitSelect.innerHTML = `<option value=\"\">Select Unit</option>`; \r\n+\r\n+    const units = await unitsDB.show();\r\n+\r\n+    if (!units || units.length === 0) {\r\n+        unitSelect.innerHTML = `<option value=\"\">No units found</option>`;\r\n+        return;\r\n+    }\r\n+\r\n+    units.forEach(unit => {\r\n+        const opt = document.createElement(\"option\");\r\n+        opt.value = unit.id;             // Value = unit ID\r\n+        opt.textContent = unit.short_name || unit.name; // Visible text\r\n+        unitSelect.appendChild(opt);\r\n+    });\r\n+}\r\n let tempAccountActive = false;\r\n let currentRequestType = null;\r\n let currentRequestId = null;\r\n \r\n"
                },
                {
                    "date": 1771515084969,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,28 +1,9 @@\n // Admin Dashboard JavaScript - Updated with User Management and Multi-page fixes\r\n \r\n // Global variables\r\n \r\n-import { unitsDB } from \"./db.js\";\r\n \r\n-async function loadUnits() {\r\n-    const unitSelect = document.getElementById(\"ingredientUnit\");\r\n-    unitSelect.innerHTML = `<option value=\"\">Select Unit</option>`; \r\n-\r\n-    const units = await unitsDB.show();\r\n-\r\n-    if (!units || units.length === 0) {\r\n-        unitSelect.innerHTML = `<option value=\"\">No units found</option>`;\r\n-        return;\r\n-    }\r\n-\r\n-    units.forEach(unit => {\r\n-        const opt = document.createElement(\"option\");\r\n-        opt.value = unit.id;             // Value = unit ID\r\n-        opt.textContent = unit.short_name || unit.name; // Visible text\r\n-        unitSelect.appendChild(opt);\r\n-    });\r\n-}\r\n let tempAccountActive = false;\r\n let currentRequestType = null;\r\n let currentRequestId = null;\r\n \r\n"
                },
                {
                    "date": 1771515105502,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,7 @@\n // Admin Dashboard JavaScript - Updated with User Management and Multi-page fixes\r\n \r\n // Global variables\r\n-\r\n-\r\n let tempAccountActive = false;\r\n let currentRequestType = null;\r\n let currentRequestId = null;\r\n \r\n@@ -2816,5 +2814,26 @@\n         loadFullActivityLog();\r\n     }\r\n }\r\n \r\n+\r\n+import { unitsDB } from \"./db.js\";\r\n+\r\n+async function loadUnits() {\r\n+    const unitSelect = document.getElementById(\"ingredientUnit\");\r\n+    unitSelect.innerHTML = `<option value=\"\">Select Unit</option>`; \r\n+\r\n+    const units = await unitsDB.show();\r\n+\r\n+    if (!units || units.length === 0) {\r\n+        unitSelect.innerHTML = `<option value=\"\">No units found</option>`;\r\n+        return;\r\n+    }\r\n+\r\n+    units.forEach(unit => {\r\n+        const opt = document.createElement(\"option\");\r\n+        opt.value = unit.id;             // Value = unit ID\r\n+        opt.textContent = unit.short_name || unit.name; // Visible text\r\n+        unitSelect.appendChild(opt);\r\n+    });\r\n+}\r\n // showModalNotification and showConfirm are defined in main.js — not duplicated here\n\\ No newline at end of file\n"
                },
                {
                    "date": 1771515118756,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2815,25 +2815,6 @@\n     }\r\n }\r\n \r\n \r\n-import { unitsDB } from \"./db.js\";\r\n \r\n-async function loadUnits() {\r\n-    const unitSelect = document.getElementById(\"ingredientUnit\");\r\n-    unitSelect.innerHTML = `<option value=\"\">Select Unit</option>`; \r\n-\r\n-    const units = await unitsDB.show();\r\n-\r\n-    if (!units || units.length === 0) {\r\n-        unitSelect.innerHTML = `<option value=\"\">No units found</option>`;\r\n-        return;\r\n-    }\r\n-\r\n-    units.forEach(unit => {\r\n-        const opt = document.createElement(\"option\");\r\n-        opt.value = unit.id;             // Value = unit ID\r\n-        opt.textContent = unit.short_name || unit.name; // Visible text\r\n-        unitSelect.appendChild(opt);\r\n-    });\r\n-}\r\n // showModalNotification and showConfirm are defined in main.js — not duplicated here\n\\ No newline at end of file\n"
                },
                {
                    "date": 1771515280298,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2771,8 +2771,30 @@\n \r\n     tbody.innerHTML = '<tr><td colspan=\"5\" class=\"text-center\">No active temporary accounts</td></tr>';\r\n }\r\n \r\n+async function loadUnits() {\r\n+    const unitSelect = document.getElementById(\"ingredientUnit\");\r\n+    unitSelect.innerHTML = `<option value=\"\">Select Unit</option>`; \r\n+\r\n+    const units = await unitsDB.show();\r\n+\r\n+    if (!units || units.length === 0) {\r\n+        unitSelect.innerHTML = `<option value=\"\">No units found</option>`;\r\n+        return;\r\n+    }\r\n+\r\n+    units.forEach(unit => {\r\n+        const opt = document.createElement(\"option\");\r\n+        opt.value = unit.id;             // Value = unit ID\r\n+        opt.textContent = unit.short_name || unit.name; // Visible text\r\n+        unitSelect.appendChild(opt);\r\n+    });\r\n+}\r\n+\r\n+// Load units on modal open\r\n+document.getElementById(\"addIngredientModal\").addEventListener(\"shown.bs.modal\", loadUnits);\r\n+\r\n // ===== Helper Functions =====\r\n function logAdminActivity(action, details, status) {\r\n     console.log(`Activity: ${action} | Details: ${details} | Status: ${status}`);\r\n \r\n"
                },
                {
                    "date": 1771515302594,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,6 @@\n // Admin Dashboard JavaScript - Updated with User Management and Multi-page fixes\r\n+import { unitsDB } from \"./db.js\";\r\n \r\n // Global variables\r\n let tempAccountActive = false;\r\n let currentRequestType = null;\r\n"
                },
                {
                    "date": 1771515309489,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,6 +1,6 @@\n // Admin Dashboard JavaScript - Updated with User Management and Multi-page fixes\r\n-import { unitsDB } from \"./db.js\";\r\n+import { unitsDB } from \".js\";\r\n \r\n // Global variables\r\n let tempAccountActive = false;\r\n let currentRequestType = null;\r\n"
                },
                {
                    "date": 1771515316623,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,6 +1,6 @@\n // Admin Dashboard JavaScript - Updated with User Management and Multi-page fixes\r\n-import { unitsDB } from \".js\";\r\n+import { un } from \"middle.js\";\r\n \r\n // Global variables\r\n let tempAccountActive = false;\r\n let currentRequestType = null;\r\n"
                },
                {
                    "date": 1771515368074,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,6 +1,6 @@\n // Admin Dashboard JavaScript - Updated with User Management and Multi-page fixes\r\n-import\r\n+import \r\n \r\n // Global variables\r\n let tempAccountActive = false;\r\n let currentRequestType = null;\r\n"
                },
                {
                    "date": 1771516889843,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,7 +1,7 @@\n // Admin Dashboard JavaScript - Updated with User Management and Multi-page fixes\r\n+import { unitsDB} from \"./middle.js\"; \r\n \r\n-\r\n console.log(\"Module loaded ✔\");\r\n // Global variables\r\n \r\n let tempAccountActive = false;\r\n"
                }
            ],
            "date": 1771514826624,
            "name": "Commit-0",
            "content": "// Admin Dashboard JavaScript - Updated with User Management and Multi-page fixes\r\n\r\n// Global variables\r\nlet tempAccountActive = false;\r\nlet currentRequestType = null;\r\nlet currentRequestId = null;\r\n\r\n// DOM Ready\r\ndocument.addEventListener('DOMContentLoaded', function () {\r\n    // Initialize tooltips - only if bootstrap is available\r\n    if (typeof bootstrap !== 'undefined') {\r\n        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle=\"tooltip\"]'));\r\n        tooltipTriggerList.map(function (tooltipTriggerEl) {\r\n            return new bootstrap.Tooltip(tooltipTriggerEl);\r\n        });\r\n    }\r\n\r\n    // Initialize only the sections present on the current page\r\n    initializeCommonAdminFeatures();\r\n\r\n    // Auto-initialize based on elements present\r\n    if (document.getElementById('lowStockTable')) initializeAdminDashboard();\r\n    if (document.getElementById('menuControlTable')) initializeMenuControl();\r\n    if (document.getElementById('recipeMappingTable')) initializeRecipeControl();\r\n    if (document.getElementById('ingredientsMasterTable')) initializeIngredientsMasterlist();\r\n    if (document.getElementById('activeUsersTable')) initializeUserManagement();\r\n    if (document.getElementById('reports-content')) initializeReports();\r\n    if (document.getElementById('backupsTable')) initializeBackup();\r\n    if (document.getElementById('requestsTable')) initializeRequests();\r\n    if (document.getElementById('systemSettingsForm')) initializeSystemSettings();\r\n    updateRequestSidebarBadge();\r\n    if (document.getElementById('activityLogTable')) initializeActivityLog();\r\n    if (document.getElementById('fullActivityLogTable')) initializeFullActivityLog();\r\n    if (document.getElementById('tempStaffTable')) initializeTempAccount();\r\n\r\n    // Load recent activities on the dashboard\r\n    if (document.getElementById('recentActivities')) loadRecentActivities();\r\n});\r\n\r\n// Common features for all admin pages\r\nfunction initializeCommonAdminFeatures() {\r\n    // Sidebar toggle (global)\r\n    const sidebarToggle = document.getElementById('sidebarToggle');\r\n    const sidebar = document.getElementById('sidebar');\r\n    if (sidebarToggle && sidebar) {\r\n        sidebarToggle.addEventListener('click', function () {\r\n            sidebar.classList.toggle('show');\r\n        });\r\n    }\r\n\r\n    // Logout button (global)\r\n    const logoutBtn = document.getElementById('logoutBtn');\r\n    if (logoutBtn) {\r\n        logoutBtn.addEventListener('click', function (e) {\r\n            e.preventDefault();\r\n            showConfirm('Are you sure you want to logout?', function () {\r\n                localStorage.removeItem('loggedInRole');\r\n                window.location.href = 'index.html';\r\n            });\r\n        });\r\n    }\r\n\r\n    // Load sidebar badges\r\n    updateRequestSidebarBadge();\r\n}\r\n\r\n// Admin Dashboard Functions\r\nfunction initializeAdminDashboard() {\r\n    // Export dashboard data button\r\n    const exportDashboardBtn = document.getElementById('exportDashboardData');\r\n    if (exportDashboardBtn) {\r\n        exportDashboardBtn.addEventListener('click', function () {\r\n            showConfirm('Are you sure you want to Export Dashboard Data?', function () {\r\n                exportDashboardData();\r\n            });\r\n        });\r\n    }\r\n\r\n    // Generate report button\r\n    const generateReportBtn = document.getElementById('generateReportBtn');\r\n    if (generateReportBtn) {\r\n        generateReportBtn.addEventListener('click', function () {\r\n            window.location.href = 'admin-reports.html';\r\n        });\r\n    }\r\n\r\n    // Load initial data\r\n    loadAdminDashboardData();\r\n}\r\n\r\nfunction exportDashboardData() {\r\n    // Simulate data export\r\n    showModalNotification('Exporting dashboard data...', 'info', 'Exporting Data');\r\n\r\n    setTimeout(() => {\r\n        // Create a blob of the data\r\n        const data = {\r\n            timestamp: new Date().toISOString(),\r\n            salesRecords: document.getElementById('totalSalesRecords')?.textContent || '0',\r\n            staffAccounts: document.getElementById('totalStaffAccounts')?.textContent || '0',\r\n            lowStockItems: document.getElementById('ingredientsRestock')?.textContent || '0',\r\n            systemAlerts: document.getElementById('systemAlerts')?.textContent || '0'\r\n        };\r\n\r\n        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });\r\n        const url = URL.createObjectURL(blob);\r\n\r\n        // Create download link\r\n        const a = document.createElement('a');\r\n        a.href = url;\r\n        a.download = `dashboard-export-${new Date().toISOString().slice(0, 10)}.json`;\r\n        document.body.appendChild(a);\r\n        a.click();\r\n        document.body.removeChild(a);\r\n        URL.revokeObjectURL(url);\r\n\r\n        showModalNotification('Dashboard data exported successfully', 'success', 'Export Complete');\r\n    }, 1000);\r\n}\r\n\r\nfunction loadLowStockData() {\r\n    const tableElement = document.getElementById('lowStockTable');\r\n    if (!tableElement) return;\r\n\r\n    const lowStockTable = tableElement.getElementsByTagName('tbody')[0];\r\n    if (!lowStockTable) return;\r\n\r\n    const allIngredients = getAvailableIngredients();\r\n    const lowStockData = allIngredients.filter(ing => ing.quantity <= ing.threshold);\r\n\r\n    lowStockTable.innerHTML = '';\r\n\r\n    if (lowStockData.length === 0) {\r\n        lowStockTable.innerHTML = '<tr><td colspan=\"5\" class=\"text-center text-muted py-3\">All ingredients are well-stocked.</td></tr>';\r\n        return;\r\n    }\r\n\r\n    lowStockData.forEach(item => {\r\n        const row = lowStockTable.insertRow();\r\n        row.innerHTML = `\r\n            <td><strong>${item.name}</strong></td>\r\n            <td><span class=\"badge bg-secondary\">${item.category}</span></td>\r\n            <td>${item.quantity} ${item.unit}</td>\r\n            <td>${item.threshold} ${item.unit}</td>\r\n            <td><span class=\"badge bg-warning\">Low</span></td>\r\n        `;\r\n    });\r\n}\r\n\r\n// Global variable for dashboard interval\r\nlet dashboardRefreshInterval;\r\n\r\nfunction loadAdminDashboardData() {\r\n    loadLowStockData();\r\n\r\n    const allIngredients = getAvailableIngredients();\r\n    const restockItems = allIngredients.filter(ing => ing.quantity <= ing.threshold);\r\n\r\n    const restockCount = document.getElementById('ingredientsRestock');\r\n    if (restockCount) restockCount.textContent = restockItems.length;\r\n\r\n    const activeUsers = getUsers().filter(u => !u.isDeleted);\r\n    const staffCount = document.getElementById('totalStaffAccounts');\r\n    if (staffCount) staffCount.textContent = activeUsers.length;\r\n\r\n    const salesCount = document.getElementById('totalSalesRecords');\r\n    if (salesCount) salesCount.textContent = '85';\r\n\r\n    const alertsCount = document.getElementById('systemAlerts');\r\n    if (alertsCount) alertsCount.textContent = restockItems.length > 0 ? '1' : '0';\r\n\r\n    // Set up auto-refresh if not already set (every 30 seconds)\r\n    if (!dashboardRefreshInterval) {\r\n        dashboardRefreshInterval = setInterval(() => {\r\n            loadAdminDashboardData();\r\n        }, 30000);\r\n    }\r\n}\r\n\r\n// Menu Control Functions\r\n\r\n// Get menu items from localStorage or seed with defaults\r\nfunction getMenuItems() {\r\n    let items = [];\r\n    try {\r\n        const stored = localStorage.getItem('adminMenuItems');\r\n        if (stored) items = JSON.parse(stored);\r\n    } catch (e) { items = []; }\r\n\r\n    if (!items || items.length === 0) {\r\n        items = [\r\n            { id: 1, name: 'Beef Steak', category: 'Main Course', price: 24.99, status: 'Active', recipes: 4 },\r\n            { id: 2, name: 'Chicken Curry', category: 'Main Course', price: 18.99, status: 'Active', recipes: 3 },\r\n            { id: 3, name: 'Vegetable Salad', category: 'Appetizer', price: 9.99, status: 'Active', recipes: 3 },\r\n            { id: 4, name: 'Garlic Bread', category: 'Appetizer', price: 7.99, status: 'Active', recipes: 3 },\r\n            { id: 5, name: 'French Fries', category: 'Side Dish', price: 5.99, status: 'Active', recipes: 1 },\r\n            { id: 6, name: 'Grilled Salmon', category: 'Main Course', price: 22.99, status: 'Inactive', recipes: 2 },\r\n            { id: 7, name: 'Pasta Carbonara', category: 'Main Course', price: 16.99, status: 'Active', recipes: 3 },\r\n            { id: 8, name: 'Chocolate Cake', category: 'Dessert', price: 8.99, status: 'Active', recipes: 3 }\r\n        ];\r\n        localStorage.setItem('adminMenuItems', JSON.stringify(items));\r\n    }\r\n    return items;\r\n}\r\n\r\nfunction saveMenuItemsToStorage(items) {\r\n    localStorage.setItem('adminMenuItems', JSON.stringify(items));\r\n}\r\n\r\n// Variable to track if we are editing\r\nlet editingMenuItemId = null;\r\n\r\nfunction initializeMenuControl() {\r\n    // Add menu item button\r\n    const addMenuItemBtn = document.getElementById('addMenuItemBtn');\r\n    if (addMenuItemBtn) {\r\n        addMenuItemBtn.addEventListener('click', function () {\r\n            editingMenuItemId = null;\r\n            showAddMenuItemModal();\r\n        });\r\n    }\r\n\r\n    // Show inactive items toggle\r\n    const showInactiveItems = document.getElementById('showInactiveItems');\r\n    if (showInactiveItems) {\r\n        showInactiveItems.addEventListener('change', function () {\r\n            loadMenuControl();\r\n        });\r\n    }\r\n\r\n    // Search filter\r\n    const searchInput = document.getElementById('menuControlSearch');\r\n    if (searchInput) {\r\n        searchInput.addEventListener('input', function () {\r\n            loadMenuControl();\r\n        });\r\n    }\r\n\r\n    // Category filter\r\n    const categoryFilter = document.getElementById('menuControlCategory');\r\n    if (categoryFilter) {\r\n        categoryFilter.addEventListener('change', function () {\r\n            loadMenuControl();\r\n        });\r\n    }\r\n\r\n    // Initial Load\r\n    loadMenuControl();\r\n}\r\n\r\nfunction loadMenuControl() {\r\n    const tableElement = document.getElementById('menuControlTable');\r\n    if (!tableElement) return;\r\n\r\n    const menuControlTable = tableElement.getElementsByTagName('tbody')[0];\r\n    if (!menuControlTable) return;\r\n\r\n    const showInactive = document.getElementById('showInactiveItems')?.checked || false;\r\n    const searchQuery = (document.getElementById('menuControlSearch')?.value || '').toLowerCase().trim();\r\n    const categoryFilter = document.getElementById('menuControlCategory')?.value || '';\r\n\r\n    let menuItems = getMenuItems();\r\n\r\n    // Filter by active/inactive\r\n    if (!showInactive) {\r\n        menuItems = menuItems.filter(item => item.status === 'Active');\r\n    }\r\n\r\n    // Filter by search\r\n    if (searchQuery) {\r\n        menuItems = menuItems.filter(item =>\r\n            item.name.toLowerCase().includes(searchQuery) ||\r\n            item.category.toLowerCase().includes(searchQuery)\r\n        );\r\n    }\r\n\r\n    // Filter by category\r\n    if (categoryFilter) {\r\n        menuItems = menuItems.filter(item => item.category === categoryFilter);\r\n    }\r\n\r\n    menuControlTable.innerHTML = '';\r\n\r\n    if (menuItems.length === 0) {\r\n        menuControlTable.innerHTML = '<tr><td colspan=\"7\" class=\"text-center text-muted py-4\"><i class=\"fas fa-utensils fa-2x mb-2 d-block\"></i>No menu items found.</td></tr>';\r\n    } else {\r\n        menuItems.forEach(item => {\r\n            const row = menuControlTable.insertRow();\r\n            row.classList.add('animate__animated', 'animate__fadeIn');\r\n            row.innerHTML = `\r\n                <td>${item.id}</td>\r\n                <td><strong>${item.name}</strong></td>\r\n                <td><span class=\"badge bg-secondary\">${item.category}</span></td>\r\n                <td>$${parseFloat(item.price).toFixed(2)}</td>\r\n                <td><span class=\"badge ${item.status === 'Active' ? 'bg-success' : 'bg-secondary'}\">${item.status}</span></td>\r\n                <td><span class=\"badge bg-info\">${item.recipes || 0} ingredients</span></td>\r\n                <td>\r\n                    <div class=\"table-actions\">\r\n                        <button class=\"btn btn-sm btn-outline-danger\" onclick=\"editMenuItem(${item.id})\" title=\"Edit\">\r\n                            <i class=\"fas fa-edit\"></i>\r\n                        </button>\r\n                        <button class=\"btn btn-sm btn-outline-${item.status === 'Active' ? 'warning' : 'success'}\" onclick=\"toggleMenuItemStatus(${item.id})\" title=\"${item.status === 'Active' ? 'Deactivate' : 'Activate'}\">\r\n                            <i class=\"fas fa-power-off\"></i>\r\n                        </button>\r\n                        <button class=\"btn btn-sm btn-outline-danger\" onclick=\"deleteMenuItem(${item.id})\" title=\"Delete\">\r\n                            <i class=\"fas fa-trash\"></i>\r\n                        </button>\r\n                    </div>\r\n                </td>\r\n            `;\r\n        });\r\n    }\r\n\r\n    // Update total count (show all items count, not just filtered)\r\n    const allItems = getMenuItems();\r\n    const totalElems = document.getElementById('totalMenuItems');\r\n    if (totalElems) totalElems.textContent = `${allItems.length} Items`;\r\n}\r\n\r\nfunction showAddMenuItemModal() {\r\n    // Clear form\r\n    const form = document.getElementById('addMenuItemForm');\r\n    if (form) form.reset();\r\n\r\n    // Reset recipe ingredients container\r\n    const recipeContainer = document.getElementById('recipeIngredientsContainer');\r\n    if (recipeContainer) {\r\n        recipeContainer.innerHTML = '<p class=\"text-muted text-center py-2\">No ingredients assigned yet</p>';\r\n    }\r\n\r\n    // Update modal title based on add vs edit\r\n    const modalTitle = document.querySelector('#addMenuItemModal .modal-title');\r\n    if (modalTitle) {\r\n        if (editingMenuItemId) {\r\n            modalTitle.innerHTML = '<i class=\"fas fa-edit me-2\"></i>Edit Menu Item';\r\n        } else {\r\n            modalTitle.innerHTML = '<i class=\"fas fa-plus-circle me-2\"></i>Add Menu Item';\r\n        }\r\n    }\r\n\r\n    // If editing, pre-fill the form\r\n    if (editingMenuItemId) {\r\n        const items = getMenuItems();\r\n        const item = items.find(i => i.id === editingMenuItemId);\r\n        if (item) {\r\n            const nameEl = document.getElementById('menuItemName');\r\n            const catEl = document.getElementById('menuItemCategory');\r\n            const priceEl = document.getElementById('menuItemPrice');\r\n            const statusEl = document.getElementById('menuItemStatus');\r\n            if (nameEl) nameEl.value = item.name;\r\n            if (catEl) catEl.value = item.category;\r\n            if (priceEl) priceEl.value = item.price;\r\n            if (statusEl) statusEl.value = item.status;\r\n        }\r\n    }\r\n\r\n    // Show modal\r\n    const modalElem = document.getElementById('addMenuItemModal');\r\n    if (!modalElem) return;\r\n\r\n    const modal = new bootstrap.Modal(modalElem);\r\n    modal.show();\r\n\r\n    // Add ingredient to recipe button\r\n    const addIngBtn = document.getElementById('addIngredientToRecipe');\r\n    if (addIngBtn) {\r\n        const newBtn = addIngBtn.cloneNode(true);\r\n        addIngBtn.parentNode.replaceChild(newBtn, addIngBtn);\r\n        newBtn.addEventListener('click', function () {\r\n            addIngredientToRecipeForm();\r\n        });\r\n    }\r\n\r\n    // Save menu item button\r\n    const saveBtn = document.getElementById('saveMenuItemBtn');\r\n    if (saveBtn) {\r\n        const newSaveBtn = saveBtn.cloneNode(true);\r\n        saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);\r\n        newSaveBtn.addEventListener('click', function () {\r\n            saveMenuItem();\r\n        });\r\n    }\r\n}\r\n\r\nfunction addIngredientToRecipeForm() {\r\n    const container = document.getElementById('recipeIngredientsContainer');\r\n    if (!container) return;\r\n\r\n    // Clear \"no ingredients\" text if present\r\n    if (container.querySelector('p.text-muted')) {\r\n        container.innerHTML = '';\r\n    }\r\n\r\n    // Get available ingredients from localStorage or default list\r\n    let ingredients = [];\r\n    try {\r\n        const stored = localStorage.getItem('ingredients');\r\n        if (stored) {\r\n            ingredients = JSON.parse(stored).map(i => ({ id: i.id, name: i.name }));\r\n        }\r\n    } catch (e) { }\r\n    if (ingredients.length === 0) {\r\n        ingredients = [\r\n            { id: 1, name: 'Beef' }, { id: 2, name: 'Chicken' }, { id: 3, name: 'Rice' },\r\n            { id: 4, name: 'Tomatoes' }, { id: 5, name: 'Onions' }, { id: 6, name: 'Garlic' },\r\n            { id: 7, name: 'Salt' }, { id: 8, name: 'Flour' }, { id: 9, name: 'Cheese' },\r\n            { id: 10, name: 'Butter' }, { id: 11, name: 'Potatoes' }, { id: 12, name: 'Lettuce' }\r\n        ];\r\n    }\r\n\r\n    // Create ingredient row\r\n    const row = document.createElement('div');\r\n    row.className = 'row g-3 mb-3 align-items-center';\r\n    row.innerHTML = `\r\n        <div class=\"col-md-6\">\r\n            <select class=\"form-select ingredient-select\">\r\n                <option value=\"\">Select Ingredient</option>\r\n                ${ingredients.map(ing => `<option value=\"${ing.id}\">${ing.name}</option>`).join('')}\r\n            </select>\r\n        </div>\r\n        <div class=\"col-md-4\">\r\n            <div class=\"input-group\">\r\n                <input type=\"number\" class=\"form-control ingredient-quantity\" placeholder=\"Quantity\" min=\"0.01\" step=\"0.01\">\r\n                <span class=\"input-group-text\">kg</span>\r\n            </div>\r\n        </div>\r\n        <div class=\"col-md-2\">\r\n            <button type=\"button\" class=\"btn btn-sm btn-outline-danger w-100 remove-ingredient\">\r\n                <i class=\"fas fa-times\"></i>\r\n            </button>\r\n        </div>\r\n    `;\r\n\r\n    container.appendChild(row);\r\n\r\n    // Add remove event listener\r\n    row.querySelector('.remove-ingredient').addEventListener('click', function () {\r\n        row.remove();\r\n        if (container.querySelectorAll('.row').length === 0) {\r\n            container.innerHTML = '<p class=\"text-muted text-center py-2\">No ingredients assigned yet</p>';\r\n        }\r\n    });\r\n}\r\n\r\nfunction saveMenuItem() {\r\n    const nameElem = document.getElementById('menuItemName');\r\n    const categoryElem = document.getElementById('menuItemCategory');\r\n    const priceElem = document.getElementById('menuItemPrice');\r\n    const statusElem = document.getElementById('menuItemStatus');\r\n    if (!nameElem || !categoryElem) return;\r\n\r\n    const name = nameElem.value.trim();\r\n    const category = categoryElem.value;\r\n    const price = parseFloat(priceElem?.value) || 0;\r\n    const status = statusElem?.value || 'Active';\r\n\r\n    // Validation\r\n    if (!name || !category) {\r\n        showModalNotification('Please fill in all required fields', 'warning', 'Validation Error');\r\n        return;\r\n    }\r\n\r\n    // Count recipe ingredients assigned\r\n    const ingredientRows = document.querySelectorAll('#recipeIngredientsContainer .ingredient-select');\r\n    let recipesCount = 0;\r\n    ingredientRows.forEach(sel => { if (sel.value) recipesCount++; });\r\n\r\n    let items = getMenuItems();\r\n\r\n    if (editingMenuItemId) {\r\n        // --- EDIT existing item ---\r\n        const idx = items.findIndex(i => i.id === editingMenuItemId);\r\n        if (idx !== -1) {\r\n            items[idx].name = name;\r\n            items[idx].category = category;\r\n            items[idx].price = price;\r\n            items[idx].status = status;\r\n            if (recipesCount > 0) items[idx].recipes = recipesCount;\r\n        }\r\n        saveMenuItemsToStorage(items);\r\n\r\n        // Close modal\r\n        const modalElem = document.getElementById('addMenuItemModal');\r\n        const modal = bootstrap.Modal.getInstance(modalElem);\r\n        if (modal) modal.hide();\r\n\r\n        showModalNotification(`Menu item \"${name}\" updated successfully`, 'success', 'Menu Item Updated');\r\n        logAdminActivity('Updated menu item', name, 'Success');\r\n        editingMenuItemId = null;\r\n    } else {\r\n        // --- ADD new item ---\r\n        const maxId = items.length > 0 ? Math.max(...items.map(i => i.id)) : 0;\r\n        const newItem = {\r\n            id: maxId + 1,\r\n            name: name,\r\n            category: category,\r\n            price: price,\r\n            status: status,\r\n            recipes: recipesCount\r\n        };\r\n        items.push(newItem);\r\n        saveMenuItemsToStorage(items);\r\n\r\n        // Close modal\r\n        const modalElem = document.getElementById('addMenuItemModal');\r\n        const modal = bootstrap.Modal.getInstance(modalElem);\r\n        if (modal) modal.hide();\r\n\r\n        showModalNotification(`Menu item \"${name}\" added successfully`, 'success', 'Menu Item Added');\r\n        logAdminActivity('Added menu item', name, 'Success');\r\n    }\r\n\r\n    // Refresh menu control immediately\r\n    loadMenuControl();\r\n}\r\n\r\nfunction editMenuItem(id) {\r\n    editingMenuItemId = id;\r\n    showAddMenuItemModal();\r\n}\r\n\r\nfunction toggleMenuItemStatus(id) {\r\n    const items = getMenuItems();\r\n    const item = items.find(i => i.id === id);\r\n    if (!item) return;\r\n\r\n    const newStatus = item.status === 'Active' ? 'Inactive' : 'Active';\r\n    const actionWord = newStatus === 'Inactive' ? 'deactivate' : 'activate';\r\n\r\n    showConfirm(`Are you sure you want to ${actionWord} \"${item.name}\"?`, function () {\r\n        item.status = newStatus;\r\n        saveMenuItemsToStorage(items);\r\n\r\n        showModalNotification(`\"${item.name}\" has been ${newStatus === 'Inactive' ? 'deactivated' : 'activated'}`, 'success', 'Status Changed');\r\n        logAdminActivity(`${newStatus === 'Inactive' ? 'Deactivated' : 'Activated'} menu item`, item.name, 'Success');\r\n        loadMenuControl();\r\n    });\r\n}\r\n\r\nfunction deleteMenuItem(id) {\r\n    const items = getMenuItems();\r\n    const item = items.find(i => i.id === id);\r\n    if (!item) return;\r\n\r\n    showConfirm(`Are you sure you want to delete \"${item.name}\"? This action cannot be undone.`, function () {\r\n        const updatedItems = items.filter(i => i.id !== id);\r\n        saveMenuItemsToStorage(updatedItems);\r\n\r\n        showModalNotification(`\"${item.name}\" has been deleted`, 'success', 'Item Deleted');\r\n        logAdminActivity('Deleted menu item', item.name, 'Success');\r\n        loadMenuControl();\r\n    });\r\n}\r\n\r\n// ===== Recipe Control Functions =====\r\n\r\n// Available ingredients master list (shared with the rest of the system)\r\nfunction getAvailableIngredients() {\r\n    let ingredients = [];\r\n    try {\r\n        const stored = localStorage.getItem('ingredients');\r\n        if (stored) ingredients = JSON.parse(stored);\r\n    } catch (e) { }\r\n    if (!ingredients || ingredients.length === 0) {\r\n        ingredients = [\r\n            { id: 1, name: 'Beef', category: 'Meat', unit: 'kg', quantity: 15, threshold: 5, costPerUnit: 12.00, status: 'Normal', usedIn: 2 },\r\n            { id: 2, name: 'Chicken', category: 'Meat', unit: 'kg', quantity: 8, threshold: 10, costPerUnit: 8.00, status: 'Low', usedIn: 1 },\r\n            { id: 3, name: 'Rice', category: 'Grains', unit: 'kg', quantity: 25, threshold: 10, costPerUnit: 2.50, status: 'Normal', usedIn: 1 },\r\n            { id: 4, name: 'Tomatoes', category: 'Vegetables', unit: 'kg', quantity: 5, threshold: 3, costPerUnit: 3.00, status: 'Normal', usedIn: 2 },\r\n            { id: 5, name: 'Onions', category: 'Vegetables', unit: 'kg', quantity: 3, threshold: 5, costPerUnit: 2.00, status: 'Low', usedIn: 3 },\r\n            { id: 6, name: 'Garlic', category: 'Spices', unit: 'kg', quantity: 1, threshold: 2, costPerUnit: 5.00, status: 'Low', usedIn: 2 },\r\n            { id: 7, name: 'Cooking Oil', category: 'Supplies', unit: 'L', quantity: 2, threshold: 5, costPerUnit: 3.50, status: 'Low', usedIn: 5 },\r\n            { id: 8, name: 'Flour', category: 'Grains', unit: 'kg', quantity: 12, threshold: 5, costPerUnit: 1.50, status: 'Normal', usedIn: 1 },\r\n            { id: 9, name: 'Cheese', category: 'Dairy', unit: 'kg', quantity: 4, threshold: 5, costPerUnit: 10.00, status: 'Low', usedIn: 1 },\r\n            { id: 10, name: 'Butter', category: 'Dairy', unit: 'kg', quantity: 6, threshold: 2, costPerUnit: 7.00, status: 'Normal', usedIn: 1 },\r\n            { id: 11, name: 'Red Wine', category: 'Beverages', unit: 'bottles', quantity: 1, threshold: 3, costPerUnit: 15.00, status: 'Low', usedIn: 1 }\r\n        ];\r\n        localStorage.setItem('ingredients', JSON.stringify(ingredients));\r\n    }\r\n\r\n    // Patch: ensure every ingredient has costPerUnit (for existing localStorage data without it)\r\n    const defaultCosts = { 'Beef': 12, 'Chicken': 8, 'Rice': 2.5, 'Tomatoes': 3, 'Onions': 2, 'Garlic': 5, 'Cooking Oil': 3.5, 'Flour': 1.5, 'Cheese': 10, 'Butter': 7, 'Red Wine': 15 };\r\n    let patched = false;\r\n    ingredients.forEach(ing => {\r\n        if (ing.costPerUnit === undefined || ing.costPerUnit === null) {\r\n            ing.costPerUnit = defaultCosts[ing.name] || 5.00;\r\n            patched = true;\r\n        }\r\n    });\r\n    if (patched) {\r\n        localStorage.setItem('ingredients', JSON.stringify(ingredients));\r\n    }\r\n\r\n    return ingredients;\r\n}\r\n\r\nfunction saveIngredientsToStorage(ingredients) {\r\n    localStorage.setItem('ingredients', JSON.stringify(ingredients));\r\n}\r\n\r\n// Get recipes from localStorage or seed with defaults\r\nfunction getRecipes() {\r\n    let recipes = [];\r\n    try {\r\n        const stored = localStorage.getItem('adminRecipes');\r\n        if (stored) recipes = JSON.parse(stored);\r\n    } catch (e) { recipes = []; }\r\n\r\n    if (!recipes || recipes.length === 0) {\r\n        recipes = [\r\n            {\r\n                id: 1, menuItem: 'Beef Steak',\r\n                ingredients: [\r\n                    { name: 'Beef', qty: 0.30, unit: 'kg', cost: 3.60 },\r\n                    { name: 'Potatoes', qty: 0.15, unit: 'kg', cost: 0.38 },\r\n                    { name: 'Tomatoes', qty: 0.10, unit: 'kg', cost: 0.30 },\r\n                    { name: 'Onions', qty: 0.10, unit: 'kg', cost: 0.20 }\r\n                ]\r\n            },\r\n            {\r\n                id: 2, menuItem: 'Chicken Curry',\r\n                ingredients: [\r\n                    { name: 'Chicken', qty: 0.25, unit: 'kg', cost: 2.00 },\r\n                    { name: 'Rice', qty: 0.15, unit: 'kg', cost: 0.38 },\r\n                    { name: 'Garlic', qty: 0.02, unit: 'kg', cost: 0.10 },\r\n                    { name: 'Onions', qty: 0.10, unit: 'kg', cost: 0.20 }\r\n                ]\r\n            },\r\n            {\r\n                id: 3, menuItem: 'Vegetable Salad',\r\n                ingredients: [\r\n                    { name: 'Tomatoes', qty: 0.10, unit: 'kg', cost: 0.30 },\r\n                    { name: 'Lettuce', qty: 0.13, unit: 'kg', cost: 0.46 },\r\n                    { name: 'Cucumber', qty: 0.10, unit: 'kg', cost: 0.28 }\r\n                ]\r\n            },\r\n            {\r\n                id: 4, menuItem: 'Garlic Bread',\r\n                ingredients: [\r\n                    { name: 'Flour', qty: 0.08, unit: 'kg', cost: 0.12 },\r\n                    { name: 'Butter', qty: 0.05, unit: 'kg', cost: 0.35 },\r\n                    { name: 'Garlic', qty: 0.03, unit: 'kg', cost: 0.15 }\r\n                ]\r\n            },\r\n            {\r\n                id: 5, menuItem: 'Pasta Carbonara',\r\n                ingredients: [\r\n                    { name: 'Pasta', qty: 0.15, unit: 'kg', cost: 0.45 },\r\n                    { name: 'Cheese', qty: 0.08, unit: 'kg', cost: 0.80 },\r\n                    { name: 'Bacon', qty: 0.10, unit: 'kg', cost: 1.10 }\r\n                ]\r\n            }\r\n        ];\r\n        localStorage.setItem('adminRecipes', JSON.stringify(recipes));\r\n    }\r\n    return recipes;\r\n}\r\n\r\nfunction saveRecipesToStorage(recipes) {\r\n    localStorage.setItem('adminRecipes', JSON.stringify(recipes));\r\n}\r\n\r\nlet editingRecipeId = null;\r\n\r\nfunction initializeRecipeControl() {\r\n    // Assign recipe button\r\n    const assignRecipeBtn = document.getElementById('assignRecipeBtn');\r\n    if (assignRecipeBtn) {\r\n        assignRecipeBtn.addEventListener('click', function () {\r\n            editingRecipeId = null;\r\n            showAssignRecipeModal();\r\n        });\r\n    }\r\n\r\n    // Search filter\r\n    const searchInput = document.getElementById('recipeSearch');\r\n    if (searchInput) {\r\n        searchInput.addEventListener('input', function () {\r\n            loadRecipeControl();\r\n        });\r\n    }\r\n\r\n    // Load recipe control list\r\n    loadRecipeControl();\r\n}\r\n\r\nfunction loadRecipeControl() {\r\n    const tableElement = document.getElementById('recipeMappingTable');\r\n    if (!tableElement) return;\r\n\r\n    const recipeMappingTable = tableElement.getElementsByTagName('tbody')[0];\r\n    if (!recipeMappingTable) return;\r\n\r\n    const searchQuery = (document.getElementById('recipeSearch')?.value || '').toLowerCase().trim();\r\n\r\n    let recipes = getRecipes();\r\n\r\n    // Filter by search\r\n    if (searchQuery) {\r\n        recipes = recipes.filter(r =>\r\n            r.menuItem.toLowerCase().includes(searchQuery) ||\r\n            r.ingredients.some(i => i.name.toLowerCase().includes(searchQuery))\r\n        );\r\n    }\r\n\r\n    recipeMappingTable.innerHTML = '';\r\n\r\n    if (recipes.length === 0) {\r\n        recipeMappingTable.innerHTML = '<tr><td colspan=\"5\" class=\"text-center text-muted py-4\"><i class=\"fas fa-clipboard-list fa-2x mb-2 d-block\"></i>No recipe mappings found.</td></tr>';\r\n        return;\r\n    }\r\n\r\n    recipes.forEach(recipe => {\r\n        const totalQty = recipe.ingredients.reduce((sum, i) => sum + (i.qty || 0), 0);\r\n        const totalCost = recipe.ingredients.reduce((sum, i) => sum + (i.cost || 0), 0);\r\n\r\n        // Create ingredient badge tags\r\n        const ingredientBadges = recipe.ingredients.map(i =>\r\n            `<span class=\"badge bg-light text-dark border me-1 mb-1\" style=\"font-size: 0.78em;\">\r\n                <i class=\"fas fa-leaf text-success me-1\"></i>${i.name} <small class=\"text-muted\">(${i.qty} ${i.unit})</small>\r\n            </span>`\r\n        ).join('');\r\n\r\n        const row = recipeMappingTable.insertRow();\r\n        row.classList.add('animate__animated', 'animate__fadeIn');\r\n        row.innerHTML = `\r\n            <td><strong>${recipe.menuItem}</strong></td>\r\n            <td style=\"max-width: 300px;\">${ingredientBadges}</td>\r\n            <td><span class=\"badge bg-secondary\">${totalQty.toFixed(2)} kg</span></td>\r\n            <td><span class=\"badge bg-success\">$${totalCost.toFixed(2)}</span></td>\r\n            <td>\r\n                <div class=\"table-actions\">\r\n                    <button class=\"btn btn-sm btn-outline-danger\" onclick=\"editRecipe(${recipe.id})\" title=\"Edit Recipe\">\r\n                        <i class=\"fas fa-edit\"></i>\r\n                    </button>\r\n                    <button class=\"btn btn-sm btn-outline-danger\" onclick=\"deleteRecipe(${recipe.id})\" title=\"Delete Recipe\">\r\n                        <i class=\"fas fa-trash\"></i>\r\n                    </button>\r\n                </div>\r\n            </td>\r\n        `;\r\n    });\r\n}\r\n\r\nfunction showAssignRecipeModal() {\r\n    // Reset form\r\n    const form = document.getElementById('assignRecipeForm');\r\n    if (form) form.reset();\r\n\r\n    // Update title\r\n    const title = document.getElementById('recipeModalTitle');\r\n    if (title) {\r\n        title.innerHTML = editingRecipeId\r\n            ? '<i class=\"fas fa-edit me-2\"></i>Edit Recipe'\r\n            : '<i class=\"fas fa-book me-2\"></i>Assign New Recipe';\r\n    }\r\n\r\n    // Populate menu item dropdown with items from localStorage\r\n    const menuSelect = document.getElementById('recipeMenuItem');\r\n    if (menuSelect) {\r\n        let menuItems = [];\r\n        try {\r\n            const stored = localStorage.getItem('adminMenuItems');\r\n            if (stored) menuItems = JSON.parse(stored);\r\n        } catch (e) { }\r\n        if (!menuItems || menuItems.length === 0) {\r\n            menuItems = [\r\n                { id: 1, name: 'Beef Steak' }, { id: 2, name: 'Chicken Curry' },\r\n                { id: 3, name: 'Vegetable Salad' }, { id: 4, name: 'Garlic Bread' },\r\n                { id: 5, name: 'French Fries' }, { id: 6, name: 'Grilled Salmon' },\r\n                { id: 7, name: 'Pasta Carbonara' }, { id: 8, name: 'Chocolate Cake' }\r\n            ];\r\n        }\r\n        menuSelect.innerHTML = '<option value=\"\">Select a menu item...</option>';\r\n        menuItems.forEach(item => {\r\n            const opt = document.createElement('option');\r\n            opt.value = item.name;\r\n            opt.textContent = item.name;\r\n            menuSelect.appendChild(opt);\r\n        });\r\n    }\r\n\r\n    // Clear ingredients area\r\n    const ingredientsArea = document.getElementById('recipeIngredientsArea');\r\n    if (ingredientsArea) {\r\n        ingredientsArea.innerHTML = '<p class=\"text-muted text-center py-3\" id=\"noIngredientsMsg\"><i class=\"fas fa-info-circle me-1\"></i>Click \"Add Ingredient\" to start building the recipe.</p>';\r\n    }\r\n\r\n    // Reset summary\r\n    updateRecipeSummary();\r\n\r\n    // If editing, pre-fill\r\n    if (editingRecipeId) {\r\n        const recipes = getRecipes();\r\n        const recipe = recipes.find(r => r.id === editingRecipeId);\r\n        if (recipe) {\r\n            if (menuSelect) menuSelect.value = recipe.menuItem;\r\n            // Clear the no-ingredients message\r\n            if (ingredientsArea) ingredientsArea.innerHTML = '';\r\n            // Add each ingredient row\r\n            recipe.ingredients.forEach(ing => {\r\n                addRecipeIngredientRow(ing.name, ing.qty);\r\n            });\r\n            updateRecipeSummary();\r\n        }\r\n    }\r\n\r\n    // Show modal\r\n    const modalElem = document.getElementById('assignRecipeModal');\r\n    if (!modalElem) return;\r\n    const modal = new bootstrap.Modal(modalElem);\r\n    modal.show();\r\n\r\n    // Wire up \"Add Ingredient\" button (clone to prevent duplicate listeners)\r\n    const addIngBtn = document.getElementById('addRecipeIngredientBtn');\r\n    if (addIngBtn) {\r\n        const newBtn = addIngBtn.cloneNode(true);\r\n        addIngBtn.parentNode.replaceChild(newBtn, addIngBtn);\r\n        newBtn.addEventListener('click', function () {\r\n            addRecipeIngredientRow();\r\n        });\r\n    }\r\n\r\n    // Wire up \"Save\" button\r\n    const saveBtn = document.getElementById('saveRecipeBtn');\r\n    if (saveBtn) {\r\n        const newBtn = saveBtn.cloneNode(true);\r\n        saveBtn.parentNode.replaceChild(newBtn, saveBtn);\r\n        newBtn.addEventListener('click', function () {\r\n            saveRecipe();\r\n        });\r\n    }\r\n}\r\n\r\nfunction addRecipeIngredientRow(preselectedName, preselectedQty) {\r\n    const area = document.getElementById('recipeIngredientsArea');\r\n    if (!area) return;\r\n\r\n    // Remove \"no ingredients\" placeholder\r\n    const noMsg = document.getElementById('noIngredientsMsg');\r\n    if (noMsg) noMsg.remove();\r\n\r\n    const ingredients = getAvailableIngredients();\r\n\r\n    const row = document.createElement('div');\r\n    row.className = 'row g-2 mb-2 align-items-center recipe-ing-row animate__animated animate__fadeIn';\r\n    row.innerHTML = `\r\n        <div class=\"col-md-5\">\r\n            <select class=\"form-select form-select-sm recipe-ing-select\">\r\n                <option value=\"\">Select Ingredient</option>\r\n                ${ingredients.map(i => `<option value=\"${i.name}\" ${preselectedName === i.name ? 'selected' : ''}>${i.name} (${i.unit})</option>`).join('')}\r\n            </select>\r\n        </div>\r\n        <div class=\"col-md-4\">\r\n            <div class=\"input-group input-group-sm\">\r\n                <input type=\"number\" class=\"form-control recipe-ing-qty\" placeholder=\"Qty\" min=\"0.01\" step=\"0.01\" value=\"${preselectedQty || ''}\">\r\n                <span class=\"input-group-text\">kg</span>\r\n            </div>\r\n        </div>\r\n        <div class=\"col-md-3 d-flex gap-1\">\r\n            <span class=\"badge bg-light text-dark border flex-grow-1 d-flex align-items-center justify-content-center recipe-ing-cost-badge\">$0.00</span>\r\n            <button type=\"button\" class=\"btn btn-sm btn-outline-danger recipe-ing-remove\" title=\"Remove\">\r\n                <i class=\"fas fa-times\"></i>\r\n            </button>\r\n        </div>\r\n    `;\r\n\r\n    area.appendChild(row);\r\n\r\n    // Remove button\r\n    row.querySelector('.recipe-ing-remove').addEventListener('click', function () {\r\n        row.remove();\r\n        if (area.querySelectorAll('.recipe-ing-row').length === 0) {\r\n            area.innerHTML = '<p class=\"text-muted text-center py-3\" id=\"noIngredientsMsg\"><i class=\"fas fa-info-circle me-1\"></i>Click \"Add Ingredient\" to start building the recipe.</p>';\r\n        }\r\n        updateRecipeSummary();\r\n    });\r\n\r\n    // Update cost on ingredient or qty change\r\n    const select = row.querySelector('.recipe-ing-select');\r\n    const qtyInput = row.querySelector('.recipe-ing-qty');\r\n    const costBadge = row.querySelector('.recipe-ing-cost-badge');\r\n\r\n    function updateRowCost() {\r\n        const ingName = select.value;\r\n        const qty = parseFloat(qtyInput.value) || 0;\r\n        const ing = ingredients.find(i => i.name === ingName);\r\n        const cost = ing ? qty * (ing.costPerUnit || 0) : 0;\r\n        costBadge.textContent = `$${cost.toFixed(2)}`;\r\n        costBadge.className = `badge ${cost > 0 ? 'bg-success text-white' : 'bg-light text-dark border'} flex-grow-1 d-flex align-items-center justify-content-center recipe-ing-cost-badge`;\r\n        updateRecipeSummary();\r\n    }\r\n\r\n    select.addEventListener('change', updateRowCost);\r\n    qtyInput.addEventListener('input', updateRowCost);\r\n\r\n    // If prefilled, compute cost\r\n    if (preselectedName && preselectedQty) {\r\n        updateRowCost();\r\n    }\r\n}\r\n\r\nfunction updateRecipeSummary() {\r\n    const rows = document.querySelectorAll('#recipeIngredientsArea .recipe-ing-row');\r\n    const ingredients = getAvailableIngredients();\r\n    let count = 0, totalQty = 0, totalCost = 0;\r\n\r\n    rows.forEach(row => {\r\n        const name = row.querySelector('.recipe-ing-select')?.value;\r\n        const qty = parseFloat(row.querySelector('.recipe-ing-qty')?.value) || 0;\r\n        if (name && qty > 0) {\r\n            count++;\r\n            totalQty += qty;\r\n            const ing = ingredients.find(i => i.name === name);\r\n            if (ing) totalCost += qty * (ing.costPerUnit || 0);\r\n        }\r\n    });\r\n\r\n    const countEl = document.getElementById('recipeIngredientCount');\r\n    const qtyEl = document.getElementById('recipeTotalQty');\r\n    const costEl = document.getElementById('recipeEstCost');\r\n    if (countEl) countEl.textContent = count;\r\n    if (qtyEl) qtyEl.textContent = `${totalQty.toFixed(2)} kg`;\r\n    if (costEl) costEl.textContent = `$${totalCost.toFixed(2)}`;\r\n}\r\n\r\nfunction saveRecipe() {\r\n    const menuItemName = document.getElementById('recipeMenuItem')?.value;\r\n    if (!menuItemName) {\r\n        showModalNotification('Please select a menu item.', 'warning', 'Validation Error');\r\n        return;\r\n    }\r\n\r\n    const rows = document.querySelectorAll('#recipeIngredientsArea .recipe-ing-row');\r\n    const availableIngredients = getAvailableIngredients();\r\n    const ingredientsList = [];\r\n\r\n    rows.forEach(row => {\r\n        const name = row.querySelector('.recipe-ing-select')?.value;\r\n        const qty = parseFloat(row.querySelector('.recipe-ing-qty')?.value) || 0;\r\n        if (name && qty > 0) {\r\n            const ing = availableIngredients.find(i => i.name === name);\r\n            ingredientsList.push({\r\n                name: name,\r\n                qty: qty,\r\n                unit: ing?.unit || 'kg',\r\n                cost: ing ? parseFloat((qty * (ing.costPerUnit || 0)).toFixed(2)) : 0\r\n            });\r\n        }\r\n    });\r\n\r\n    if (ingredientsList.length === 0) {\r\n        showModalNotification('Please add at least one ingredient with a quantity.', 'warning', 'Validation Error');\r\n        return;\r\n    }\r\n\r\n    // Check for duplicate ingredients\r\n    const names = ingredientsList.map(i => i.name);\r\n    if (new Set(names).size !== names.length) {\r\n        showModalNotification('Duplicate ingredients found. Please use each ingredient only once.', 'warning', 'Validation Error');\r\n        return;\r\n    }\r\n\r\n    let recipes = getRecipes();\r\n\r\n    if (editingRecipeId) {\r\n        // Update existing\r\n        const idx = recipes.findIndex(r => r.id === editingRecipeId);\r\n        if (idx !== -1) {\r\n            recipes[idx].menuItem = menuItemName;\r\n            recipes[idx].ingredients = ingredientsList;\r\n        }\r\n        saveRecipesToStorage(recipes);\r\n\r\n        const modalElem = document.getElementById('assignRecipeModal');\r\n        const modal = bootstrap.Modal.getInstance(modalElem);\r\n        if (modal) modal.hide();\r\n\r\n        showModalNotification(`Recipe for \"${menuItemName}\" updated successfully!`, 'success', 'Recipe Updated');\r\n        logAdminActivity('Updated recipe', menuItemName, 'Success');\r\n        editingRecipeId = null;\r\n    } else {\r\n        // Check if recipe already exists for this menu item\r\n        const existing = recipes.find(r => r.menuItem === menuItemName);\r\n        if (existing) {\r\n            showModalNotification(`A recipe for \"${menuItemName}\" already exists. Edit the existing recipe instead.`, 'warning', 'Duplicate Recipe');\r\n            return;\r\n        }\r\n\r\n        const maxId = recipes.length > 0 ? Math.max(...recipes.map(r => r.id)) : 0;\r\n        const newRecipe = {\r\n            id: maxId + 1,\r\n            menuItem: menuItemName,\r\n            ingredients: ingredientsList\r\n        };\r\n        recipes.push(newRecipe);\r\n        saveRecipesToStorage(recipes);\r\n\r\n        const modalElem = document.getElementById('assignRecipeModal');\r\n        const modal = bootstrap.Modal.getInstance(modalElem);\r\n        if (modal) modal.hide();\r\n\r\n        showModalNotification(`Recipe for \"${menuItemName}\" assigned successfully!`, 'success', 'Recipe Assigned');\r\n        logAdminActivity('Assigned new recipe', menuItemName, 'Success');\r\n    }\r\n\r\n    loadRecipeControl();\r\n}\r\n\r\nfunction editRecipe(id) {\r\n    editingRecipeId = id;\r\n    showAssignRecipeModal();\r\n}\r\n\r\nfunction deleteRecipe(id) {\r\n    const recipes = getRecipes();\r\n    const recipe = recipes.find(r => r.id === id);\r\n    if (!recipe) return;\r\n\r\n    showConfirm(`Are you sure you want to delete the recipe for \"${recipe.menuItem}\"? This action cannot be undone.`, function () {\r\n        const updatedRecipes = recipes.filter(r => r.id !== id);\r\n        saveRecipesToStorage(updatedRecipes);\r\n\r\n        showModalNotification(`Recipe for \"${recipe.menuItem}\" has been deleted.`, 'success', 'Recipe Deleted');\r\n        logAdminActivity('Deleted recipe', recipe.menuItem, 'Success');\r\n        loadRecipeControl();\r\n    });\r\n}\r\n\r\n// Ingredients Masterlist Functions\r\nlet editingIngredientId = null;\r\n\r\n// Ingredients Masterlist Functions\r\nfunction initializeIngredientsMasterlist() {\r\n    // Add ingredient button\r\n    const addIngredientBtn = document.getElementById('addIngredientBtn');\r\n    if (addIngredientBtn) {\r\n        addIngredientBtn.addEventListener('click', function () {\r\n            editingIngredientId = null;\r\n            showAddIngredientModal();\r\n        });\r\n    }\r\n\r\n    // Set thresholds button\r\n    const setThresholdsBtn = document.getElementById('setThresholdsBtn');\r\n    if (setThresholdsBtn) {\r\n        setThresholdsBtn.addEventListener('click', function () {\r\n            showSetThresholdsModal();\r\n        });\r\n    }\r\n\r\n    // Search and Filter Listeners\r\n    const searchInput = document.getElementById('masterIngredientSearch');\r\n    if (searchInput) {\r\n        searchInput.addEventListener('input', function () {\r\n            loadIngredientsMasterlist();\r\n        });\r\n    }\r\n\r\n    const categoryFilter = document.getElementById('masterCategoryFilter');\r\n    if (categoryFilter) {\r\n        categoryFilter.addEventListener('change', function () {\r\n            loadIngredientsMasterlist();\r\n        });\r\n    }\r\n\r\n    // Load ingredients masterlist\r\n    loadIngredientsMasterlist();\r\n}\r\n\r\nfunction loadIngredientsMasterlist() {\r\n    const tableElement = document.getElementById('ingredientsMasterTable');\r\n    if (!tableElement) return;\r\n\r\n    const ingredientsMasterTable = tableElement.getElementsByTagName('tbody')[0];\r\n    const masterLowStockCount = document.getElementById('masterLowStockCount');\r\n    const masterTotalIngredients = document.getElementById('masterTotalIngredients');\r\n\r\n    const searchQuery = (document.getElementById('masterIngredientSearch')?.value || '').toLowerCase().trim();\r\n    const categoryFilter = document.getElementById('masterCategoryFilter')?.value || '';\r\n\r\n    let ingredients = getAvailableIngredients();\r\n\r\n    // Apply filtering\r\n    if (categoryFilter) {\r\n        ingredients = ingredients.filter(ing => ing.category === categoryFilter);\r\n    }\r\n    if (searchQuery) {\r\n        ingredients = ingredients.filter(ing =>\r\n            ing.name.toLowerCase().includes(searchQuery) ||\r\n            ing.id.toString().includes(searchQuery)\r\n        );\r\n    }\r\n\r\n    // Count low stock items (on all items, not just filtered)\r\n    const allIngredients = getAvailableIngredients();\r\n    let lowStockCount = 0;\r\n    allIngredients.forEach(ing => {\r\n        if (ing.quantity <= ing.threshold) lowStockCount++;\r\n    });\r\n\r\n    if (masterLowStockCount) masterLowStockCount.textContent = lowStockCount;\r\n    if (masterTotalIngredients) masterTotalIngredients.textContent = allIngredients.length;\r\n\r\n    ingredientsMasterTable.innerHTML = '';\r\n\r\n    if (ingredients.length === 0) {\r\n        ingredientsMasterTable.innerHTML = '<tr><td colspan=\"9\" class=\"text-center text-muted py-4\">No ingredients found.</td></tr>';\r\n        return;\r\n    }\r\n\r\n    const recipes = getRecipes();\r\n\r\n    ingredients.forEach(ingredient => {\r\n        const isLow = ingredient.quantity <= ingredient.threshold;\r\n        const usedInCount = recipes.filter(r =>\r\n            r.ingredients.some(ri => ri.name === ingredient.name)\r\n        ).length;\r\n\r\n        const row = ingredientsMasterTable.insertRow();\r\n        row.classList.add('animate__animated', 'animate__fadeIn');\r\n        row.innerHTML = `\r\n            <td>${ingredient.id}</td>\r\n            <td><strong>${ingredient.name}</strong></td>\r\n            <td><span class=\"badge bg-secondary\">${ingredient.category}</span></td>\r\n            <td>${ingredient.unit}</td>\r\n            <td class=\"${isLow ? 'text-danger fw-bold' : ''}\">${ingredient.quantity} ${ingredient.unit}</td>\r\n            <td>${ingredient.threshold} ${ingredient.unit}</td>\r\n            <td><span class=\"badge ${!isLow ? 'bg-success' : 'bg-warning'}\">${!isLow ? 'Normal' : 'Low Stock'}</span></td>\r\n            <td><span class=\"badge bg-info\">${usedInCount} menu items</span></td>\r\n            <td>\r\n                <div class=\"table-actions\">\r\n                    <button class=\"btn btn-sm btn-outline-danger\" onclick=\"editIngredient(${ingredient.id})\" title=\"Edit\">\r\n                        <i class=\"fas fa-edit\"></i>\r\n                    </button>\r\n                    <button class=\"btn btn-sm btn-outline-danger\" onclick=\"deleteIngredient(${ingredient.id})\" title=\"Delete\">\r\n                        <i class=\"fas fa-trash\"></i>\r\n                    </button>\r\n                </div>\r\n            </td>\r\n        `;\r\n    });\r\n}\r\n\r\nfunction showAddIngredientModal() {\r\n    // Update threshold unit based on selected unit\r\n    const unitSelect = document.getElementById('ingredientUnit');\r\n    const thresholdUnit = document.getElementById('thresholdUnit');\r\n\r\n    if (unitSelect && thresholdUnit) {\r\n        unitSelect.addEventListener('change', function () {\r\n            thresholdUnit.textContent = this.value;\r\n        });\r\n    }\r\n\r\n    // Update title\r\n    const modalTitle = document.querySelector('#addIngredientModal .modal-title');\r\n    if (modalTitle) {\r\n        modalTitle.innerHTML = editingIngredientId\r\n            ? '<i class=\"fas fa-edit me-2\"></i>Edit Ingredient'\r\n            : '<i class=\"fas fa-plus-circle me-2\"></i>Add Ingredient';\r\n    }\r\n\r\n    // Pre-fill if editing\r\n    if (editingIngredientId) {\r\n        const ingredients = getAvailableIngredients();\r\n        const ing = ingredients.find(i => i.id === editingIngredientId);\r\n        if (ing) {\r\n            document.getElementById('ingredientName').value = ing.name;\r\n            document.getElementById('ingredientCategory').value = ing.category;\r\n            document.getElementById('ingredientUnit').value = ing.unit;\r\n            document.getElementById('lowStockThreshold').value = ing.threshold;\r\n            if (thresholdUnit) thresholdUnit.textContent = ing.unit;\r\n        }\r\n    } else {\r\n        const form = document.getElementById('addIngredientForm');\r\n        if (form) form.reset();\r\n        if (thresholdUnit) thresholdUnit.textContent = 'kg';\r\n    }\r\n\r\n    // Show modal\r\n    const modalElem = document.getElementById('addIngredientModal');\r\n    if (!modalElem) return;\r\n    const modal = new bootstrap.Modal(modalElem);\r\n    modal.show();\r\n\r\n    // Save ingredient button\r\n    const saveBtn = document.getElementById('saveIngredientBtn');\r\n    if (saveBtn) {\r\n        const newSaveBtn = saveBtn.cloneNode(true);\r\n        saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);\r\n        newSaveBtn.addEventListener('click', function () {\r\n            saveIngredient();\r\n        });\r\n    }\r\n}\r\n\r\nfunction saveIngredient() {\r\n    const name = document.getElementById('ingredientName')?.value.trim();\r\n    const category = document.getElementById('ingredientCategory')?.value;\r\n    const unit = document.getElementById('ingredientUnit')?.value;\r\n    const threshold = parseFloat(document.getElementById('lowStockThreshold')?.value) || 0;\r\n\r\n    // Validation\r\n    if (!name || !category || !unit) {\r\n        showModalNotification('Please fill in all required fields', 'warning', 'Validation Error');\r\n        return;\r\n    }\r\n\r\n    let ingredients = getAvailableIngredients();\r\n\r\n    if (editingIngredientId) {\r\n        const idx = ingredients.findIndex(i => i.id === editingIngredientId);\r\n        if (idx !== -1) {\r\n            ingredients[idx].name = name;\r\n            ingredients[idx].category = category;\r\n            ingredients[idx].unit = unit;\r\n            ingredients[idx].threshold = threshold;\r\n        }\r\n        showModalNotification(`Ingredient \"${name}\" updated successfully`, 'success', 'Ingredient Updated');\r\n        logAdminActivity('Updated ingredient', name, 'Success');\r\n        editingIngredientId = null;\r\n    } else {\r\n        const maxId = ingredients.length > 0 ? Math.max(...ingredients.map(i => i.id)) : 0;\r\n        const newIngredient = {\r\n            id: maxId + 1,\r\n            name: name,\r\n            category: category,\r\n            unit: unit,\r\n            quantity: 0, // Default for new items\r\n            threshold: threshold,\r\n            usedIn: 0\r\n        };\r\n        ingredients.push(newIngredient);\r\n        showModalNotification(`Ingredient \"${name}\" added successfully`, 'success', 'Ingredient Added');\r\n        logAdminActivity('Added ingredient', name, 'Success');\r\n    }\r\n\r\n    saveIngredientsToStorage(ingredients);\r\n\r\n    // Close modal\r\n    const modalElem = document.getElementById('addIngredientModal');\r\n    const modal = bootstrap.Modal.getInstance(modalElem);\r\n    if (modal) modal.hide();\r\n\r\n    // Refresh\r\n    loadIngredientsMasterlist();\r\n}\r\n\r\nfunction showSetThresholdsModal() {\r\n    const ingredients = getAvailableIngredients();\r\n\r\n    Swal.fire({\r\n        title: 'Global Stock Thresholds',\r\n        html: `\r\n            <div class=\"text-start\">\r\n                <p class=\"small text-muted mb-3\">Update warning thresholds for all categories.</p>\r\n                <div class=\"mb-3\">\r\n                    <label class=\"form-label\">Meat & Poultry (kg)</label>\r\n                    <input type=\"number\" id=\"swal-meat\" class=\"swal2-input mt-0\" value=\"5\">\r\n                </div>\r\n                <div class=\"mb-3\">\r\n                    <label class=\"form-label\">Vegetables (kg)</label>\r\n                    <input type=\"number\" id=\"swal-veg\" class=\"swal2-input mt-0\" value=\"3\">\r\n                </div>\r\n                <p class=\"small text-danger\">Note: This will reset all individual thresholds in these categories.</p>\r\n            </div>\r\n        `,\r\n        showCancelButton: true,\r\n        confirmButtonText: 'Update All',\r\n        confirmButtonColor: '#dc3545',\r\n        preConfirm: () => {\r\n            return {\r\n                meat: document.getElementById('swal-meat').value,\r\n                veg: document.getElementById('swal-veg').value\r\n            }\r\n        }\r\n    }).then((result) => {\r\n        if (result.isConfirmed) {\r\n            const updated = ingredients.map(ing => {\r\n                if (ing.category === 'Meat') ing.threshold = parseFloat(result.value.meat);\r\n                if (ing.category === 'Vegetables') ing.threshold = parseFloat(result.value.veg);\r\n                return ing;\r\n            });\r\n            saveIngredientsToStorage(updated);\r\n            showModalNotification('Thresholds updated successfully', 'success', 'Bulk Update');\r\n            loadIngredientsMasterlist();\r\n        }\r\n    });\r\n}\r\n\r\nfunction editIngredient(id) {\r\n    editingIngredientId = id;\r\n    showAddIngredientModal();\r\n}\r\n\r\nfunction deleteIngredient(id) {\r\n    const ingredients = getAvailableIngredients();\r\n    const ing = ingredients.find(i => i.id === id);\r\n    if (!ing) return;\r\n\r\n    showConfirm(`Are you sure you want to delete \"${ing.name}\"? This will also remove it from any assigned recipes.`, function () {\r\n        const updated = ingredients.filter(i => i.id !== id);\r\n        saveIngredientsToStorage(updated);\r\n\r\n        showModalNotification(`\"${ing.name}\" has been deleted`, 'success', 'Ingredient Deleted');\r\n        logAdminActivity('Deleted ingredient', ing.name, 'Success');\r\n        loadIngredientsMasterlist();\r\n    });\r\n}\r\n\r\n// ===== User Management Functions =====\r\n\r\nfunction getUsers() {\r\n    let users = [];\r\n    try {\r\n        const stored = localStorage.getItem('users');\r\n        if (stored) users = JSON.parse(stored);\r\n    } catch (e) { users = []; }\r\n\r\n    if (!users || users.length === 0) {\r\n        users = [\r\n            { id: 1, name: 'John Doe', role: 'Staff', username: 'johndoe', status: 'Active', lastLogin: 'Today', isDeleted: false },\r\n            { id: 2, name: 'Jane Smith', role: 'Cashier', username: 'janesmith', status: 'Active', lastLogin: 'Today', isDeleted: false },\r\n            { id: 3, name: 'Robert Johnson', role: 'Staff', username: 'robertj', status: 'Active', lastLogin: 'Yesterday', isDeleted: false },\r\n            { id: 4, name: 'Sarah Williams', role: 'Senior Staff', username: 'sarahw', status: 'Active', lastLogin: 'Today', isDeleted: false },\r\n            { id: 5, name: 'Mike Brown', role: 'Staff', username: 'mikeb', deletedDate: '2023-09-28', deletedBy: 'Admin', isDeleted: true },\r\n            { id: 6, name: 'Emily Davis', role: 'Cashier', username: 'emilyd', deletedDate: '2023-09-25', deletedBy: 'Admin', isDeleted: true }\r\n        ];\r\n        localStorage.setItem('users', JSON.stringify(users));\r\n    }\r\n    return users;\r\n}\r\n\r\nfunction saveUsersToStorage(users) {\r\n    localStorage.setItem('users', JSON.stringify(users));\r\n}\r\n\r\nfunction initializeUserManagement() {\r\n    // Add User Button\r\n    const addUserBtn = document.getElementById('addUserBtn'); // Re-using ID from HTML\r\n    if (addUserBtn) {\r\n        addUserBtn.addEventListener('click', function () {\r\n            showAddUserModal();\r\n        });\r\n    }\r\n\r\n    // Save New User Button (in modal)\r\n    const saveNewUserBtn = document.getElementById('saveNewUserBtn');\r\n    if (saveNewUserBtn) {\r\n        saveNewUserBtn.addEventListener('click', function () {\r\n            saveNewUser();\r\n        });\r\n    }\r\n\r\n    // Save Edit User Button (in modal)\r\n    const saveUserChangesBtn = document.getElementById('saveUserChangesBtn');\r\n    if (saveUserChangesBtn) {\r\n        saveUserChangesBtn.addEventListener('click', function () {\r\n            saveUserChanges();\r\n        });\r\n    }\r\n\r\n    // Load initial data\r\n    loadUserManagement();\r\n}\r\n\r\nimport { unitsDB } from \"./db.js\";\r\n\r\nasync function loadUnits() {\r\n    const unitSelect = document.getElementById(\"ingredientUnit\");\r\n    unitSelect.innerHTML = `<option value=\"\">Select Unit</option>`; \r\n\r\n    const units = await unitsDB.show();\r\n\r\n    if (!units || units.length === 0) {\r\n        unitSelect.innerHTML = `<option value=\"\">No units found</option>`;\r\n        return;\r\n    }\r\n\r\n    units.forEach(unit => {\r\n        const opt = document.createElement(\"option\");\r\n        opt.value = unit.id;             // Value = unit ID\r\n        opt.textContent = unit.short_name || unit.name; // Visible text\r\n        unitSelect.appendChild(opt);\r\n    });\r\n}\r\n\r\n// Load units on modal open\r\ndocument.getElementById(\"addIngredientModal\").addEventListener(\"shown.bs.modal\", loadUnits);\r\n\r\n\r\nfunction loadUserManagement() {\r\n    loadActiveUsers();\r\n    loadDeletedUsers();\r\n}\r\n\r\nfunction loadActiveUsers() {\r\n    const tableElem = document.getElementById('activeUsersTable');\r\n    if (!tableElem) return;\r\n\r\n    const tbody = tableElem.querySelector('tbody');\r\n    if (!tbody) return;\r\n\r\n    const users = getUsers().filter(u => !u.isDeleted);\r\n\r\n    tbody.innerHTML = '';\r\n    if (users.length === 0) {\r\n        tbody.innerHTML = '<tr><td colspan=\"6\" class=\"text-center text-muted py-4\">No active users found.</td></tr>';\r\n        return;\r\n    }\r\n\r\n    users.forEach(user => {\r\n        const row = tbody.insertRow();\r\n        row.classList.add('animate__animated', 'animate__fadeIn');\r\n        row.innerHTML = `\r\n            <td><strong>${user.name}</strong></td>\r\n            <td><span class=\"badge ${user.role === 'Staff' ? 'bg-success' : user.role === 'Cashier' ? 'bg-info' : 'bg-warning'}\">${user.role}</span></td>\r\n            <td>${user.username}</td>\r\n            <td><span class=\"badge ${user.status === 'Active' ? 'bg-success' : 'bg-secondary'}\">${user.status}</span></td>\r\n            <td>${user.lastLogin || 'Never'}</td>\r\n            <td>\r\n                <div class=\"table-actions\">\r\n                    <button class=\"btn btn-sm btn-outline-primary\" onclick=\"editUser(${user.id})\" title=\"Edit\">\r\n                        <i class=\"fas fa-edit\"></i>\r\n                    </button>\r\n                    <button class=\"btn btn-sm btn-outline-danger\" onclick=\"deleteUser(${user.id})\" title=\"Delete\">\r\n                        <i class=\"fas fa-trash\"></i>\r\n                    </button>\r\n                </div>\r\n            </td>\r\n        `;\r\n    });\r\n}\r\n\r\nfunction loadDeletedUsers() {\r\n    const tableElem = document.getElementById('deletedUsersTable');\r\n    if (!tableElem) return;\r\n\r\n    const tbody = tableElem.querySelector('tbody');\r\n    const badge = document.getElementById('deletedUsersCount');\r\n    if (!tbody) return;\r\n\r\n    const users = getUsers().filter(u => u.isDeleted);\r\n\r\n    if (badge) badge.textContent = users.length;\r\n\r\n    tbody.innerHTML = '';\r\n    if (users.length === 0) {\r\n        tbody.innerHTML = '<tr><td colspan=\"6\" class=\"text-center text-muted py-4\">No deleted accounts.</td></tr>';\r\n        return;\r\n    }\r\n\r\n    users.forEach(user => {\r\n        const row = tbody.insertRow();\r\n        row.classList.add('animate__animated', 'animate__fadeIn');\r\n        row.innerHTML = `\r\n            <td><strong>${user.name}</strong></td>\r\n            <td><span class=\"badge bg-secondary\">${user.role}</span></td>\r\n            <td>${user.username}</td>\r\n            <td>${user.deletedDate || 'Unknown'}</td>\r\n            <td>${user.deletedBy || 'System'}</td>\r\n            <td>\r\n                <div class=\"table-actions\">\r\n                    <button class=\"btn btn-sm btn-outline-success\" onclick=\"restoreUser(${user.id})\" title=\"Restore\">\r\n                        <i class=\"fas fa-undo\"></i>\r\n                    </button>\r\n                    <button class=\"btn btn-sm btn-danger\" onclick=\"permanentlyDeleteUser(${user.id})\" title=\"Permanent Delete\">\r\n                        <i class=\"fas fa-times\"></i>\r\n                    </button>\r\n                </div>\r\n            </td>\r\n        `;\r\n    });\r\n}\r\n\r\nfunction showAddUserModal() {\r\n    const form = document.getElementById('addUserForm');\r\n    if (form) form.reset();\r\n\r\n    const modalElem = document.getElementById('addUserModal');\r\n    if (!modalElem) return;\r\n    const modal = new bootstrap.Modal(modalElem);\r\n    modal.show();\r\n}\r\n\r\nfunction saveNewUser() {\r\n    const name = document.getElementById('newFullName').value.trim();\r\n    const username = document.getElementById('newUsername').value.trim();\r\n    const pass = document.getElementById('newUserPassword').value;\r\n    const confirmPass = document.getElementById('confirmUserPassword').value;\r\n    const role = document.getElementById('newUserRole').value;\r\n\r\n    if (!name || !username || !pass) {\r\n        showModalNotification('Please fill in all fields', 'warning', 'Validation Error');\r\n        return;\r\n    }\r\n\r\n    if (pass !== confirmPass) {\r\n        showModalNotification('Passwords do not match', 'warning', 'Validation Error');\r\n        return;\r\n    }\r\n\r\n    let users = getUsers();\r\n    if (users.some(u => u.username.toLowerCase() === username.toLowerCase())) {\r\n        showModalNotification('Username already exists', 'warning', 'Duplicate Entry');\r\n        return;\r\n    }\r\n\r\n    const maxId = users.length > 0 ? Math.max(...users.map(u => u.id)) : 0;\r\n    const newUser = {\r\n        id: maxId + 1,\r\n        name: name,\r\n        username: username,\r\n        password: pass,\r\n        role: role,\r\n        status: 'Active',\r\n        lastLogin: 'Never',\r\n        isDeleted: false\r\n    };\r\n\r\n    users.push(newUser);\r\n    saveUsersToStorage(users);\r\n\r\n    const modalElem = document.getElementById('addUserModal');\r\n    const modal = bootstrap.Modal.getInstance(modalElem);\r\n    if (modal) modal.hide();\r\n\r\n    showModalNotification(`User \"${name}\" created successfully`, 'success', 'User Added');\r\n    logAdminActivity('Created new user account', username, 'Success');\r\n    loadUserManagement();\r\n}\r\n\r\nfunction editUser(id) {\r\n    const users = getUsers();\r\n    const user = users.find(u => u.id === id);\r\n    if (!user) return;\r\n\r\n    document.getElementById('editUserId').value = user.id;\r\n    document.getElementById('editFullName').value = user.name;\r\n    document.getElementById('editUsername').value = user.username;\r\n    document.getElementById('editUserRole').value = user.role;\r\n    document.getElementById('editUserStatus').value = user.status;\r\n    document.getElementById('editUserPassword').value = ''; // Clear password field\r\n\r\n    const modalElem = document.getElementById('editUserModal');\r\n    if (!modalElem) return;\r\n    const modal = new bootstrap.Modal(modalElem);\r\n    modal.show();\r\n}\r\n\r\nfunction saveUserChanges() {\r\n    const id = parseInt(document.getElementById('editUserId').value);\r\n    const name = document.getElementById('editFullName').value.trim();\r\n    const role = document.getElementById('editUserRole').value;\r\n    const status = document.getElementById('editUserStatus').value;\r\n    const newPass = document.getElementById('editUserPassword').value;\r\n\r\n    if (!name) {\r\n        showModalNotification('Full name is required', 'warning', 'Validation Error');\r\n        return;\r\n    }\r\n\r\n    let users = getUsers();\r\n    const idx = users.findIndex(u => u.id === id);\r\n    if (idx === -1) return;\r\n\r\n    users[idx].name = name;\r\n    users[idx].role = role;\r\n    users[idx].status = status;\r\n    if (newPass) users[idx].password = newPass;\r\n\r\n    saveUsersToStorage(users);\r\n\r\n    const modalElem = document.getElementById('editUserModal');\r\n    const modal = bootstrap.Modal.getInstance(modalElem);\r\n    if (modal) modal.hide();\r\n\r\n    showModalNotification(`Account for \"${name}\" updated`, 'success', 'User Updated');\r\n    logAdminActivity('Updated user account', users[idx].username, 'Success');\r\n    loadUserManagement();\r\n}\r\n\r\nfunction deleteUser(id) {\r\n    const users = getUsers();\r\n    const user = users.find(u => u.id === id);\r\n    if (!user) return;\r\n\r\n    showConfirm(`Are you sure you want to delete \"${user.name}\"? This account will be moved to Deleted Accounts.`, function () {\r\n        const idx = users.findIndex(u => u.id === id);\r\n        users[idx].isDeleted = true;\r\n        users[idx].deletedDate = new Date().toLocaleDateString();\r\n        users[idx].deletedBy = 'Administrator';\r\n\r\n        saveUsersToStorage(users);\r\n        showModalNotification(`Account \"${user.username}\" deleted`, 'success', 'User Removed');\r\n        logAdminActivity('Deleted user account', user.username, 'Success');\r\n        loadUserManagement();\r\n    });\r\n}\r\n\r\nfunction restoreUser(id) {\r\n    const users = getUsers();\r\n    const user = users.find(u => u.id === id);\r\n    if (!user) return;\r\n\r\n    showConfirm(`Restore account for \"${user.name}\"?`, function () {\r\n        const idx = users.findIndex(u => u.id === id);\r\n        users[idx].isDeleted = false;\r\n\r\n        saveUsersToStorage(users);\r\n        showModalNotification(`Account \"${user.username}\" restored`, 'success', 'User Restored');\r\n        logAdminActivity('Restored user account', user.username, 'Success');\r\n        loadUserManagement();\r\n    });\r\n}\r\n\r\nfunction permanentlyDeleteUser(id) {\r\n    const users = getUsers();\r\n    const user = users.find(u => u.id === id);\r\n    if (!user) return;\r\n\r\n    showConfirm(`PERMANENTLY DELETE \"${user.name}\"? This action cannot be reversed.`, function () {\r\n        const updated = users.filter(u => u.id !== id);\r\n        saveUsersToStorage(updated);\r\n\r\n        showModalNotification(`Account \"${user.username}\" permanently removed`, 'success', 'User Purged');\r\n        logAdminActivity('Permanently deleted user account', user.username, 'Success');\r\n        loadUserManagement();\r\n    });\r\n}\r\n\r\n// Reports Functions\r\nlet reportsChart = null;\r\n\r\nfunction initializeReports() {\r\n    // Generate button\r\n    const generateReportBtn = document.getElementById('generateReportBtn');\r\n    if (generateReportBtn) {\r\n        generateReportBtn.addEventListener('click', function () {\r\n            generateReport();\r\n        });\r\n    }\r\n\r\n    // Print button\r\n    const printReportBtn = document.getElementById('printReportBtn');\r\n    if (printReportBtn) {\r\n        printReportBtn.addEventListener('click', function () {\r\n            printReport();\r\n        });\r\n    }\r\n\r\n    // Excel button\r\n    const downloadExcelBtn = document.getElementById('downloadExcelBtn');\r\n    if (downloadExcelBtn) {\r\n        downloadExcelBtn.addEventListener('click', function () {\r\n            exportToExcel();\r\n        });\r\n    }\r\n\r\n    // Set default dates (today)\r\n    const dateFrom = document.getElementById('reportDateFrom');\r\n    const dateTo = document.getElementById('reportDateTo');\r\n    if (dateFrom && dateTo) {\r\n        const today = new Date().toISOString().split('T')[0];\r\n        // Set dateFrom to 7 days ago by default\r\n        const lastWeek = new Date();\r\n        lastWeek.setDate(lastWeek.getDate() - 7);\r\n        dateFrom.value = lastWeek.toISOString().split('T')[0];\r\n        dateTo.value = today;\r\n    }\r\n\r\n    // Seed sample sales if none exist\r\n    ensureSampleSalesExist();\r\n\r\n    // Initial load\r\n    generateReport();\r\n\r\n    // Real-time update every 30 seconds\r\n    setInterval(() => {\r\n        if (document.getElementById('reports-content')) {\r\n            generateReport(true); // silent update\r\n        }\r\n    }, 30000);\r\n}\r\n\r\nfunction ensureSampleSalesExist() {\r\n    let sales = loadFromLocalStorage('sales');\r\n    if (!sales || sales.length === 0) {\r\n        const today = new Date();\r\n        const sampleSales = [];\r\n\r\n        // Generate some sales for the last 7 days\r\n        for (let i = 0; i < 7; i++) {\r\n            const date = new Date();\r\n            date.setDate(today.getDate() - i);\r\n            const dateStr = date.toISOString().split('T')[0];\r\n\r\n            // 2-4 sales per day\r\n            const salesPerDay = Math.floor(Math.random() * 3) + 2;\r\n            for (let j = 0; j < salesPerDay; j++) {\r\n                const total = Math.floor(Math.random() * 500) + 100;\r\n                sampleSales.push({\r\n                    id: 'SALE-' + (1000 + sampleSales.length),\r\n                    date: dateStr,\r\n                    time: '12:00:00',\r\n                    timestamp: date.getTime(),\r\n                    items: [\r\n                        { name: 'Beef Steak', quantity: 2, price: 24.99, subtotal: 49.98 },\r\n                        { name: 'Chicken Curry', quantity: 1, price: 18.99, subtotal: 18.99 }\r\n                    ],\r\n                    total: total,\r\n                    staff: 'Staff Member'\r\n                });\r\n            }\r\n        }\r\n        saveToLocalStorage('sales', sampleSales);\r\n    }\r\n}\r\n\r\nfunction generateReport(silent = false) {\r\n    if (!silent) {\r\n        showModalNotification('Generating report data...', 'info', 'Loading');\r\n    }\r\n\r\n    setTimeout(() => {\r\n        const reportType = document.getElementById('reportType')?.value || 'Daily';\r\n        const dateFrom = document.getElementById('reportDateFrom')?.value;\r\n        const dateTo = document.getElementById('reportDateTo')?.value;\r\n\r\n        let sales = loadFromLocalStorage('sales') || [];\r\n\r\n        // Filter sales by date\r\n        if (dateFrom && dateTo) {\r\n            sales = sales.filter(sale => {\r\n                const saleDate = sale.date; // yyyy-mm-dd\r\n                return saleDate >= dateFrom && saleDate <= dateTo;\r\n            });\r\n        }\r\n\r\n        // Update Summary Metrics\r\n        updateSummaryMetrics(sales);\r\n\r\n        // Update Graph\r\n        updateReportsChart(sales, reportType);\r\n\r\n        // Update Detailed Table\r\n        updateReportsDetailTable(sales);\r\n\r\n        if (!silent) {\r\n            showModalNotification('Report generated successfully', 'success', 'Complete');\r\n            logAdminActivity('Generated report', `${reportType} (${dateFrom} to ${dateTo})`, 'Success');\r\n        }\r\n    }, silent ? 0 : 800);\r\n}\r\n\r\nfunction updateSummaryMetrics(sales) {\r\n    const totalNetSalesElem = document.getElementById('totalNetSales');\r\n    const totalTransactionsElem = document.getElementById('totalReportTransactions');\r\n    const topSellingItemElem = document.getElementById('topSellingItem');\r\n    const avgOrderValueElem = document.getElementById('avgOrderValue');\r\n\r\n    if (!totalNetSalesElem) return;\r\n\r\n    let totalSales = 0;\r\n    let itemCounts = {};\r\n\r\n    sales.forEach(sale => {\r\n        totalSales += sale.total;\r\n        sale.items.forEach(item => {\r\n            itemCounts[item.name] = (itemCounts[item.name] || 0) + item.quantity;\r\n        });\r\n    });\r\n\r\n    // Find top selling item\r\n    let topItem = '-';\r\n    let maxCount = 0;\r\n    for (let item in itemCounts) {\r\n        if (itemCounts[item] > maxCount) {\r\n            maxCount = itemCounts[item];\r\n            topItem = item;\r\n        }\r\n    }\r\n\r\n    totalNetSalesElem.textContent = formatCurrency(totalSales);\r\n    totalTransactionsElem.textContent = sales.length;\r\n    topSellingItemElem.textContent = topItem === '-' ? '-' : `${topItem} (${maxCount})`;\r\n    avgOrderValueElem.textContent = sales.length > 0 ? formatCurrency(totalSales / sales.length) : formatCurrency(0);\r\n}\r\n\r\nfunction updateReportsChart(sales, reportType) {\r\n    const ctx = document.getElementById('reportsChart');\r\n    if (!ctx) return;\r\n\r\n    // Destroy existing chart if it exists\r\n    if (reportsChart) {\r\n        reportsChart.destroy();\r\n    }\r\n\r\n    // Group sales by date for the labels\r\n    const salesByDate = {};\r\n    sales.forEach(sale => {\r\n        const date = sale.date;\r\n        salesByDate[date] = (salesByDate[date] || 0) + sale.total;\r\n    });\r\n\r\n    // Sort dates\r\n    const sortedDates = Object.keys(salesByDate).sort();\r\n    const data = sortedDates.map(date => salesByDate[date]);\r\n\r\n    // If no data, show sample data for the graph as requested\r\n    let chartLabels = sortedDates.length > 0 ? sortedDates : ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];\r\n    let chartData = data.length > 0 ? data : [120, 190, 300, 500, 200, 300, 450];\r\n    let label = sortedDates.length > 0 ? 'Sales Amount' : 'Sample Sales Data (No Actual Sales)';\r\n\r\n    reportsChart = new Chart(ctx, {\r\n        type: 'line',\r\n        data: {\r\n            labels: chartLabels,\r\n            datasets: [{\r\n                label: label,\r\n                data: chartData,\r\n                backgroundColor: 'rgba(128, 0, 0, 0.1)',\r\n                borderColor: 'rgba(128, 0, 0, 1)',\r\n                borderWidth: 3,\r\n                tension: 0.4,\r\n                fill: true,\r\n                pointBackgroundColor: 'rgba(128, 0, 0, 1)',\r\n                pointRadius: 4\r\n            }]\r\n        },\r\n        options: {\r\n            responsive: true,\r\n            maintainAspectRatio: false,\r\n            scales: {\r\n                y: {\r\n                    beginAtZero: true,\r\n                    ticks: {\r\n                        callback: function (value) {\r\n                            return '$' + value;\r\n                        }\r\n                    }\r\n                }\r\n            },\r\n            plugins: {\r\n                legend: {\r\n                    display: true,\r\n                    position: 'top'\r\n                }\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\nfunction updateReportsDetailTable(sales) {\r\n    const tableBody = document.querySelector('#reportsDetailTable tbody');\r\n    if (!tableBody) return;\r\n\r\n    tableBody.innerHTML = '';\r\n\r\n    if (sales.length === 0) {\r\n        tableBody.innerHTML = '<tr><td colspan=\"6\" class=\"text-center\">No transactions found for the selected period</td></tr>';\r\n        return;\r\n    }\r\n\r\n    // Sort sales by date decending (newest first)\r\n    const sortedSales = [...sales].sort((a, b) => b.timestamp - a.timestamp);\r\n\r\n    sortedSales.forEach(sale => {\r\n        const row = tableBody.insertRow();\r\n        const itemsList = sale.items.map(i => `${i.name} x${i.quantity}`).join(', ');\r\n\r\n        row.innerHTML = `\r\n            <td>${sale.date} ${sale.time}</td>\r\n            <td><code>${sale.id}</code></td>\r\n            <td>${sale.staff}</td>\r\n            <td><small>${itemsList}</small></td>\r\n            <td class=\"fw-bold\">${formatCurrency(sale.total)}</td>\r\n            <td>\r\n                <button class=\"btn btn-sm btn-outline-danger\" onclick=\"viewSaleDetails('${sale.id}')\">\r\n                    <i class=\"fas fa-eye\"></i>\r\n                </button>\r\n            </td>\r\n        `;\r\n    });\r\n}\r\n\r\nfunction viewSaleDetails(saleId) {\r\n    const sales = loadFromLocalStorage('sales') || [];\r\n    const sale = sales.find(s => s.id === saleId);\r\n    if (!sale) return;\r\n\r\n    let itemsHtml = sale.items.map(item => `\r\n        <tr>\r\n            <td>${item.name}</td>\r\n            <td>${item.quantity}</td>\r\n            <td>${formatCurrency(item.price)}</td>\r\n            <td>${formatCurrency(item.subtotal)}</td>\r\n        </tr>\r\n    `).join('');\r\n\r\n    Swal.fire({\r\n        title: `Transaction Details: ${sale.id}`,\r\n        html: `\r\n            <div class=\"text-start\">\r\n                <p><strong>Date:</strong> ${sale.date} ${sale.time}</p>\r\n                <p><strong>Staff:</strong> ${sale.staff}</p>\r\n                <table class=\"table table-sm table-bordered mt-3\">\r\n                    <thead>\r\n                        <tr><th>Item</th><th>Qty</th><th>Price</th><th>Subtotal</th></tr>\r\n                    </thead>\r\n                    <tbody>\r\n                        ${itemsHtml}\r\n                    </tbody>\r\n                    <tfoot>\r\n                        <tr><th colspan=\"3\" class=\"text-end\">Total:</th><th>${formatCurrency(sale.total)}</th></tr>\r\n                    </tfoot>\r\n                </table>\r\n            </div>\r\n        `,\r\n        confirmButtonColor: '#800000'\r\n    });\r\n}\r\n\r\nfunction printReport() {\r\n    const reportContent = document.getElementById('reports-content');\r\n    if (!reportContent) return;\r\n\r\n    const originalContent = document.body.innerHTML;\r\n    const printWindow = window.open('', '_blank');\r\n\r\n    // Create print-friendly version\r\n    const summary = {\r\n        sales: document.getElementById('totalNetSales').textContent,\r\n        transactions: document.getElementById('totalReportTransactions').textContent,\r\n        topItem: document.getElementById('topSellingItem').textContent,\r\n        avg: document.getElementById('avgOrderValue').textContent\r\n    };\r\n\r\n    const tableRows = document.querySelector('#reportsDetailTable tbody').innerHTML;\r\n\r\n    printWindow.document.write(`\r\n        <html>\r\n            <head>\r\n                <title>Owner Report - ${new Date().toLocaleDateString()}</title>\r\n                <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\r\n                <style>\r\n                    body { padding: 30px; }\r\n                    .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #800000; padding-bottom: 10px; }\r\n                    .metrics { display: flex; justify-content: space-between; margin-bottom: 30px; }\r\n                    .metric-box { border: 1px solid #ddd; padding: 15px; border-radius: 8px; flex: 1; margin: 0 10px; text-align: center; }\r\n                    .metric-val { font-size: 1.2rem; font-weight: bold; color: #800000; }\r\n                </style>\r\n            </head>\r\n            <body>\r\n                <div class=\"header\">\r\n                    <h2>Ethan's Cafe - Owner Report</h2>\r\n                    <p>Generated on: ${new Date().toLocaleString()}</p>\r\n                </div>\r\n                <div class=\"metrics\">\r\n                    <div class=\"metric-box\"><div>Total Sales</div><div class=\"metric-val\">${summary.sales}</div></div>\r\n                    <div class=\"metric-box\"><div>Transactions</div><div class=\"metric-val\">${summary.transactions}</div></div>\r\n                    <div class=\"metric-box\"><div>Top Item</div><div class=\"metric-val\">${summary.topItem}</div></div>\r\n                    <div class=\"metric-box\"><div>Avg Order</div><div class=\"metric-val\">${summary.avg}</div></div>\r\n                </div>\r\n                <h4>Transaction Details</h4>\r\n                <table class=\"table table-bordered table-striped\">\r\n                    <thead>\r\n                        <tr><th>Date/Time</th><th>Reference</th><th>Staff</th><th>Items</th><th>Total</th></tr>\r\n                    </thead>\r\n                    <tbody>${tableRows}</tbody>\r\n                </table>\r\n                <div class=\"mt-5 text-center text-muted small\">\r\n                    End of Report\r\n                </div>\r\n            </body>\r\n        </html>\r\n    `);\r\n\r\n    printWindow.document.close();\r\n    setTimeout(() => {\r\n        printWindow.print();\r\n    }, 500);\r\n\r\n    logAdminActivity('Printed report', 'Print View Generated', 'Success');\r\n}\r\n\r\nfunction exportToExcel() {\r\n    const sales = loadFromLocalStorage('sales') || [];\r\n    if (sales.length === 0) {\r\n        showModalNotification('No data to export', 'warning', 'Export Empty');\r\n        return;\r\n    }\r\n\r\n    let csvContent = \"data:text/csv;charset=utf-8,\";\r\n    csvContent += \"Date,Time,Reference,Staff,Items,Total\\n\";\r\n\r\n    sales.forEach(sale => {\r\n        const itemsList = sale.items.map(i => `${i.name} (${i.quantity})`).join('|');\r\n        const row = [\r\n            sale.date,\r\n            sale.time,\r\n            sale.id,\r\n            sale.staff,\r\n            `\"${itemsList}\"`,\r\n            sale.total\r\n        ].join(\",\");\r\n        csvContent += row + \"\\n\";\r\n    });\r\n\r\n    const encodedUri = encodeURI(csvContent);\r\n    const link = document.createElement(\"a\");\r\n    link.setAttribute(\"href\", encodedUri);\r\n    link.setAttribute(\"download\", `Reports_Export_${new Date().toISOString().slice(0, 10)}.csv`);\r\n    document.body.appendChild(link);\r\n    link.click();\r\n    document.body.removeChild(link);\r\n\r\n    showModalNotification('Excel/CSV export completed', 'success', 'Export Success');\r\n    logAdminActivity('Exported reports', 'CSV Export', 'Success');\r\n}\r\n\r\n// Backup Functions\r\nfunction initializeBackup() {\r\n    // Create backup button\r\n    const createBackupBtn = document.getElementById('createBackupBtn');\r\n    if (createBackupBtn) {\r\n        createBackupBtn.addEventListener('click', function () {\r\n            showConfirm('Are you sure you want to create a full system backup?', function () {\r\n                createFullBackup();\r\n            });\r\n        });\r\n    }\r\n\r\n    // Backup type buttons\r\n    document.querySelectorAll('[data-backup-type]').forEach(btn => {\r\n        btn.addEventListener('click', function () {\r\n            const type = this.getAttribute('data-backup-type');\r\n            createBackup(type);\r\n        });\r\n    });\r\n\r\n    // Restore backup button\r\n    const restoreBackupBtn = document.getElementById('restoreBackupBtn');\r\n    if (restoreBackupBtn) {\r\n        restoreBackupBtn.addEventListener('click', function () {\r\n            showConfirm('Are you sure you want to restore from this backup? Current data will be overwritten.', function () {\r\n                restoreBackup();\r\n            });\r\n        });\r\n    }\r\n\r\n    // Backup file input\r\n    const backupFileInput = document.getElementById('backupFile');\r\n    if (backupFileInput) {\r\n        backupFileInput.addEventListener('change', function () {\r\n            const btn = document.getElementById('restoreBackupBtn');\r\n            if (btn) btn.disabled = !this.files.length;\r\n        });\r\n    }\r\n\r\n    // Load backup data\r\n    loadBackupData();\r\n}\r\n\r\nfunction loadBackupData() {\r\n    const tableElem = document.getElementById('backupsTable');\r\n    if (!tableElem) return;\r\n\r\n    const backupsTable = tableElem.getElementsByTagName('tbody')[0];\r\n    if (!backupsTable) return;\r\n\r\n    backupsTable.innerHTML = '<tr><td colspan=\"5\" class=\"text-center\"><div class=\"loading-spinner\"></div><p class=\"mt-2\">Loading backup data...</p></td></tr>';\r\n\r\n    setTimeout(() => {\r\n        const backups = [\r\n            { name: 'full-backup-2023-10-01.json', type: 'Full System', date: '2023-10-01', size: '45 KB' },\r\n            { name: 'inventory-backup-2023-09-30.json', type: 'Inventory', date: '2023-09-30', size: '18 KB' }\r\n        ];\r\n\r\n        backupsTable.innerHTML = '';\r\n\r\n        backups.forEach(backup => {\r\n            const row = backupsTable.insertRow();\r\n            row.innerHTML = `\r\n                <td>${backup.name}</td>\r\n                <td><span class=\"badge bg-secondary\">${backup.type}</span></td>\r\n                <td>${backup.date}</td>\r\n                <td>${backup.size}</td>\r\n                <td><button class=\"btn btn-sm btn-outline-success\">Download</button></td>\r\n            `;\r\n        });\r\n    }, 800);\r\n}\r\n\r\nfunction createFullBackup() {\r\n    showModalNotification('Creating full system backup...', 'info', 'Creating Backup');\r\n    setTimeout(() => {\r\n        showModalNotification('Full system backup created successfully', 'success', 'Backup Complete');\r\n        logAdminActivity('Created full system backup', 'Full backup', 'Success');\r\n        loadBackupData();\r\n    }, 1500);\r\n}\r\n\r\nfunction createBackup(type) {\r\n    showModalNotification(`Creating ${type} backup...`, 'info', 'Creating Backup');\r\n    setTimeout(() => {\r\n        showModalNotification(`${type} backup created successfully`, 'success', 'Backup Complete');\r\n        logAdminActivity(`Created ${type} backup`, type, 'Success');\r\n        loadBackupData();\r\n    }, 1000);\r\n}\r\n\r\nfunction restoreBackup() {\r\n    showModalNotification('Restoring from backup...', 'info', 'Restoring Backup');\r\n    setTimeout(() => {\r\n        showModalNotification('Data restored successfully', 'success', 'Restore Complete');\r\n        logAdminActivity('Restored system from backup', 'System Restore', 'Success');\r\n    }, 2000);\r\n}\r\n\r\n// Requests Functions\r\n// ===== Request Management Functions =====\r\n\r\nfunction getAccountRequests() {\r\n    try {\r\n        const stored = localStorage.getItem('accountRequests');\r\n        return stored ? JSON.parse(stored) : [];\r\n    } catch (e) {\r\n        return [];\r\n    }\r\n}\r\n\r\nfunction saveAccountRequests(requests) {\r\n    localStorage.setItem('accountRequests', JSON.stringify(requests));\r\n}\r\n\r\nfunction initializeRequests() {\r\n    // Search listener\r\n    const searchInput = document.getElementById('requestSearch');\r\n    if (searchInput) {\r\n        searchInput.addEventListener('input', () => loadRequests());\r\n    }\r\n\r\n    // Filter listener\r\n    const statusFilter = document.getElementById('requestStatusFilter');\r\n    if (statusFilter) {\r\n        statusFilter.addEventListener('change', () => loadRequests());\r\n    }\r\n\r\n    // Initial load\r\n    loadRequests();\r\n}\r\n\r\nfunction loadRequests() {\r\n    const tableElem = document.getElementById('requestsTable');\r\n    if (!tableElem) {\r\n        updateRequestSidebarBadge();\r\n        return;\r\n    }\r\n\r\n    const tbody = tableElem.querySelector('tbody');\r\n    if (!tbody) return;\r\n\r\n    const searchTerm = (document.getElementById('requestSearch')?.value || '').toLowerCase();\r\n    const statusFilter = document.getElementById('requestStatusFilter')?.value || 'Pending';\r\n\r\n    let requests = getAccountRequests();\r\n\r\n    // Apply filtering\r\n    if (statusFilter !== 'All') {\r\n        requests = requests.filter(r => r.status === statusFilter);\r\n    }\r\n    if (searchTerm) {\r\n        requests = requests.filter(r =>\r\n            r.fullName.toLowerCase().includes(searchTerm) ||\r\n            r.username.toLowerCase().includes(searchTerm) ||\r\n            r.requestedRole.toLowerCase().includes(searchTerm)\r\n        );\r\n    }\r\n\r\n    tbody.innerHTML = '';\r\n\r\n    if (requests.length === 0) {\r\n        tbody.innerHTML = '<tr><td colspan=\"7\" class=\"text-center text-muted py-4\">No matching requests found.</td></tr>';\r\n    } else {\r\n        requests.forEach(req => {\r\n            const row = tbody.insertRow();\r\n            row.classList.add('animate__animated', 'animate__fadeIn');\r\n\r\n            const isPending = req.status === 'Pending';\r\n\r\n            row.innerHTML = `\r\n                <td>${req.date}</td>\r\n                <td><strong>${req.fullName}</strong></td>\r\n                <td><span class=\"badge bg-secondary\">Account Request</span></td>\r\n                <td>${req.requestedRole}</td>\r\n                <td class=\"small\">${isPending ? 'New user registration' : 'Processed'}</td>\r\n                <td><span class=\"badge ${req.status === 'Pending' ? 'bg-warning' : req.status === 'Approved' ? 'bg-success' : 'bg-danger'}\">${req.status}</span></td>\r\n                <td>\r\n                    ${isPending ? `\r\n                        <div class=\"table-actions\">\r\n                            <button class=\"btn btn-sm btn-outline-success\" onclick=\"approveRequest(${req.id})\" title=\"Approve\">\r\n                                <i class=\"fas fa-check\"></i>\r\n                            </button>\r\n                            <button class=\"btn btn-sm btn-outline-danger\" onclick=\"denyRequest(${req.id})\" title=\"Deny\">\r\n                                <i class=\"fas fa-times\"></i>\r\n                            </button>\r\n                        </div>\r\n                    ` : '<span class=\"text-muted small\">No actions</span>'}\r\n                </td>\r\n            `;\r\n        });\r\n    }\r\n\r\n    updateRequestSidebarBadge();\r\n\r\n    const pageBadge = document.getElementById('pendingRequestsBadge');\r\n    if (pageBadge) {\r\n        const pendingCount = getAccountRequests().filter(r => r.status === 'Pending').length;\r\n        pageBadge.textContent = `${pendingCount} Pending Request${pendingCount !== 1 ? 's' : ''}`;\r\n    }\r\n}\r\n\r\nfunction updateRequestSidebarBadge() {\r\n    const pendingCount = getAccountRequests().filter(r => r.status === 'Pending').length;\r\n\r\n    // Find \"Requests\" sidebar link\r\n    const sidebarLinks = document.querySelectorAll('.sidebar-link');\r\n    sidebarLinks.forEach(link => {\r\n        if (link.textContent.includes('Requests')) {\r\n            // Check if badge already exists\r\n            let badge = link.querySelector('.sidebar-badge');\r\n            if (pendingCount > 0) {\r\n                if (!badge) {\r\n                    badge = document.createElement('span');\r\n                    badge.className = 'badge bg-danger rounded-pill ms-auto sidebar-badge animate__animated animate__bounceIn';\r\n                    link.appendChild(badge);\r\n                }\r\n                badge.textContent = pendingCount;\r\n            } else if (badge) {\r\n                badge.remove();\r\n            }\r\n        }\r\n    });\r\n\r\n    // Also update dashboard alert count if on dashboard\r\n    const alertsCount = document.getElementById('systemAlerts');\r\n    if (alertsCount) {\r\n        const lowStock = getAvailableIngredients().filter(ing => ing.quantity <= ing.threshold).length;\r\n        alertsCount.textContent = (pendingCount > 0 || lowStock > 0) ? (pendingCount + (lowStock > 0 ? 1 : 0)) : '0';\r\n    }\r\n}\r\n\r\nfunction approveRequest(id) {\r\n    let requests = getAccountRequests();\r\n    const reqIndex = requests.findIndex(r => r.id === id);\r\n    if (reqIndex === -1) return;\r\n\r\n    const req = requests[reqIndex];\r\n\r\n    showConfirm(`Approve account request for \"${req.fullName}\"?`, function () {\r\n        // 1. Add to users\r\n        let users = getUsers();\r\n        const maxId = users.length > 0 ? Math.max(...users.map(u => u.id)) : 0;\r\n\r\n        users.push({\r\n            id: maxId + 1,\r\n            name: req.fullName,\r\n            username: req.username,\r\n            password: req.password,\r\n            role: req.requestedRole,\r\n            status: 'Active',\r\n            lastLogin: 'Never',\r\n            isDeleted: false\r\n        });\r\n        saveUsersToStorage(users);\r\n\r\n        // 2. Mark request as approved (or remove it, but user wants realtime/functional)\r\n        requests[reqIndex].status = 'Approved';\r\n        saveAccountRequests(requests);\r\n\r\n        showModalNotification(`Account for \"${req.username}\" has been created and approved`, 'success', 'Request Approved');\r\n        logAdminActivity('Approved account request', req.username, 'Success');\r\n        loadRequests();\r\n    });\r\n}\r\n\r\nfunction denyRequest(id) {\r\n    let requests = getAccountRequests();\r\n    const reqIndex = requests.findIndex(r => r.id === id);\r\n    if (reqIndex === -1) return;\r\n\r\n    const req = requests[reqIndex];\r\n\r\n    showConfirm(`Deny account request for \"${req.fullName}\"?`, function () {\r\n        requests[reqIndex].status = 'Denied';\r\n        saveAccountRequests(requests);\r\n\r\n        showModalNotification(`Account request for \"${req.username}\" has been denied`, 'info', 'Request Denied');\r\n        logAdminActivity('Denied account request', req.username, 'Admin Action');\r\n        loadRequests();\r\n    });\r\n}\r\n\r\n\r\n// System Settings Functions\r\nfunction initializeSystemSettings() {\r\n    const saveSettingsBtn = document.getElementById('saveSettingsBtn');\r\n    if (saveSettingsBtn) {\r\n        saveSettingsBtn.addEventListener('click', function () {\r\n            showConfirm('Are you sure you want to save settings?', function () {\r\n                saveSystemSettings();\r\n            });\r\n        });\r\n    }\r\n}\r\n\r\nfunction saveSystemSettings() {\r\n    showModalNotification('Saving system settings...', 'info', 'Saving');\r\n    setTimeout(() => {\r\n        showModalNotification('Settings saved successfully', 'success', 'Saved');\r\n    }, 1000);\r\n}\r\n\r\n// ===== Activity Log Functions =====\r\n\r\n// Determine category of an activity based on its action text\r\nfunction getActivityCategory(action) {\r\n    const a = action.toLowerCase();\r\n    if (a.includes('log in') || a.includes('logged in') || a.includes('login') ||\r\n        a.includes('log out') || a.includes('logged out') || a.includes('logout')) {\r\n        return 'Login';\r\n    }\r\n    if (a.includes('sale') || a.includes('receipt') || a.includes('transaction') ||\r\n        a.includes('recorded sale') || a.includes('printed receipt') || a.includes('payment') ||\r\n        a.includes('order') || a.includes('refund') || a.includes('void')) {\r\n        return 'Sales';\r\n    }\r\n    if (a.includes('ingredient') || a.includes('inventory') || a.includes('stock') ||\r\n        a.includes('increased') || a.includes('decreased') || a.includes('restock') ||\r\n        a.includes('quantity')) {\r\n        return 'Inventory';\r\n    }\r\n    // Everything else is Administrative\r\n    return 'Admin';\r\n}\r\n\r\n// Get category badge HTML\r\nfunction getCategoryBadge(category) {\r\n    const map = {\r\n        'Login': { bg: 'bg-info', label: 'Login / Logout', icon: 'fa-sign-in-alt' },\r\n        'Sales': { bg: 'bg-success', label: 'Sales & Transactions', icon: 'fa-cash-register' },\r\n        'Inventory': { bg: 'bg-warning text-dark', label: 'Inventory Update', icon: 'fa-boxes' },\r\n        'Admin': { bg: 'bg-danger', label: 'Administrative', icon: 'fa-shield-alt' }\r\n    };\r\n    const info = map[category] || map['Admin'];\r\n    return `<span class=\"badge ${info.bg}\"><i class=\"fas ${info.icon} me-1\"></i>${info.label}</span>`;\r\n}\r\n\r\n// Get all activity logs from localStorage (merged with sample data)\r\nfunction getAllActivityLogs() {\r\n    let logs = [];\r\n    try {\r\n        const stored = localStorage.getItem('systemActivityLogs');\r\n        if (stored) logs = JSON.parse(stored);\r\n    } catch (e) { logs = []; }\r\n\r\n    // If empty, seed with sample data\r\n    if (!logs || logs.length === 0) {\r\n        logs = generateSeedActivityLogs();\r\n        localStorage.setItem('systemActivityLogs', JSON.stringify(logs));\r\n    }\r\n    // Sort by timestamp descending (most recent first)\r\n    logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));\r\n    return logs;\r\n}\r\n\r\n// Generate seed activity data so the log is not empty on first load\r\nfunction generateSeedActivityLogs() {\r\n    const today = new Date();\r\n    const fmt = (d) => {\r\n        const pad = n => String(n).padStart(2, '0');\r\n        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;\r\n    };\r\n    const ms = (h, m) => h * 3600000 + m * 60000;\r\n\r\n    // Generate activities for today and past couple of days\r\n    const seeds = [];\r\n    let id = 1;\r\n\r\n    // --- Today ---\r\n    const t0 = new Date(today); t0.setHours(8, 5, 12, 0);\r\n    seeds.push({ id: id++, userName: 'Admin', action: 'Logged in', reference: 'System', timestamp: fmt(t0), category: 'Login', ip: '192.168.1.10' });\r\n\r\n    const t1 = new Date(today); t1.setHours(8, 12, 45, 0);\r\n    seeds.push({ id: id++, userName: 'Admin', action: 'Updated system settings', reference: 'System Settings', timestamp: fmt(t1), category: 'Admin', ip: '192.168.1.10' });\r\n\r\n    const t2 = new Date(today); t2.setHours(8, 30, 0, 0);\r\n    seeds.push({ id: id++, userName: 'John Doe', action: 'Logged in', reference: 'System', timestamp: fmt(t2), category: 'Login', ip: '192.168.1.15' });\r\n\r\n    const t3 = new Date(today); t3.setHours(9, 15, 33, 0);\r\n    seeds.push({ id: id++, userName: 'John Doe', action: 'Recorded sale', reference: 'SALE-2001', timestamp: fmt(t3), category: 'Sales', ip: '192.168.1.15' });\r\n\r\n    const t4 = new Date(today); t4.setHours(9, 17, 10, 0);\r\n    seeds.push({ id: id++, userName: 'John Doe', action: 'Printed receipt', reference: 'REC-2001', timestamp: fmt(t4), category: 'Sales', ip: '192.168.1.15' });\r\n\r\n    const t5 = new Date(today); t5.setHours(10, 0, 22, 0);\r\n    seeds.push({ id: id++, userName: 'Jane Smith', action: 'Logged in', reference: 'System', timestamp: fmt(t5), category: 'Login', ip: '192.168.1.20' });\r\n\r\n    const t6 = new Date(today); t6.setHours(10, 25, 5, 0);\r\n    seeds.push({ id: id++, userName: 'Jane Smith', action: 'Increased ingredient quantity', reference: 'Chicken (+10 kg)', timestamp: fmt(t6), category: 'Inventory', ip: '192.168.1.20' });\r\n\r\n    const t7 = new Date(today); t7.setHours(11, 2, 44, 0);\r\n    seeds.push({ id: id++, userName: 'Jane Smith', action: 'Recorded sale', reference: 'SALE-2002', timestamp: fmt(t7), category: 'Sales', ip: '192.168.1.20' });\r\n\r\n    const t8 = new Date(today); t8.setHours(11, 45, 18, 0);\r\n    seeds.push({ id: id++, userName: 'Admin', action: 'Added new menu item', reference: 'Grilled Salmon', timestamp: fmt(t8), category: 'Admin', ip: '192.168.1.10' });\r\n\r\n    const t9 = new Date(today); t9.setHours(12, 10, 30, 0);\r\n    seeds.push({ id: id++, userName: 'John Doe', action: 'Recorded sale', reference: 'SALE-2003', timestamp: fmt(t9), category: 'Sales', ip: '192.168.1.15' });\r\n\r\n    const t10 = new Date(today); t10.setHours(13, 5, 0, 0);\r\n    seeds.push({ id: id++, userName: 'Admin', action: 'Decreased ingredient quantity', reference: 'Tomatoes (-2 kg, Spoilage)', timestamp: fmt(t10), category: 'Inventory', ip: '192.168.1.10' });\r\n\r\n    const t11 = new Date(today); t11.setHours(14, 0, 0, 0);\r\n    seeds.push({ id: id++, userName: 'Sarah Williams', action: 'Logged in', reference: 'System', timestamp: fmt(t11), category: 'Login', ip: '192.168.1.25' });\r\n\r\n    const t12 = new Date(today); t12.setHours(14, 20, 15, 0);\r\n    seeds.push({ id: id++, userName: 'Sarah Williams', action: 'Recorded sale', reference: 'SALE-2004', timestamp: fmt(t12), category: 'Sales', ip: '192.168.1.25' });\r\n\r\n    const t13 = new Date(today); t13.setHours(15, 30, 0, 0);\r\n    seeds.push({ id: id++, userName: 'Admin', action: 'Created full system backup', reference: 'Backup', timestamp: fmt(t13), category: 'Admin', ip: '192.168.1.10' });\r\n\r\n    const t14 = new Date(today); t14.setHours(16, 0, 0, 0);\r\n    seeds.push({ id: id++, userName: 'John Doe', action: 'Logged out', reference: 'System', timestamp: fmt(t14), category: 'Login', ip: '192.168.1.15' });\r\n\r\n    // --- Yesterday ---\r\n    const yesterday = new Date(today);\r\n    yesterday.setDate(yesterday.getDate() - 1);\r\n\r\n    const y0 = new Date(yesterday); y0.setHours(7, 55, 0, 0);\r\n    seeds.push({ id: id++, userName: 'Admin', action: 'Logged in', reference: 'System', timestamp: fmt(y0), category: 'Login', ip: '192.168.1.10' });\r\n\r\n    const y1 = new Date(yesterday); y1.setHours(8, 30, 0, 0);\r\n    seeds.push({ id: id++, userName: 'John Doe', action: 'Logged in', reference: 'System', timestamp: fmt(y1), category: 'Login', ip: '192.168.1.15' });\r\n\r\n    const y2 = new Date(yesterday); y2.setHours(9, 0, 0, 0);\r\n    seeds.push({ id: id++, userName: 'John Doe', action: 'Recorded sale', reference: 'SALE-1998', timestamp: fmt(y2), category: 'Sales', ip: '192.168.1.15' });\r\n\r\n    const y3 = new Date(yesterday); y3.setHours(10, 15, 0, 0);\r\n    seeds.push({ id: id++, userName: 'Admin', action: 'Approved staff account request', reference: 'Robert Johnson', timestamp: fmt(y3), category: 'Admin', ip: '192.168.1.10' });\r\n\r\n    const y4 = new Date(yesterday); y4.setHours(11, 30, 0, 0);\r\n    seeds.push({ id: id++, userName: 'Jane Smith', action: 'Logged in', reference: 'System', timestamp: fmt(y4), category: 'Login', ip: '192.168.1.20' });\r\n\r\n    const y5 = new Date(yesterday); y5.setHours(12, 45, 0, 0);\r\n    seeds.push({ id: id++, userName: 'Jane Smith', action: 'Recorded sale', reference: 'SALE-1999', timestamp: fmt(y5), category: 'Sales', ip: '192.168.1.20' });\r\n\r\n    const y6 = new Date(yesterday); y6.setHours(14, 0, 0, 0);\r\n    seeds.push({ id: id++, userName: 'Admin', action: 'Increased ingredient quantity', reference: 'Beef (+5 kg)', timestamp: fmt(y6), category: 'Inventory', ip: '192.168.1.10' });\r\n\r\n    const y7 = new Date(yesterday); y7.setHours(15, 30, 0, 0);\r\n    seeds.push({ id: id++, userName: 'Jane Smith', action: 'Recorded sale', reference: 'SALE-2000', timestamp: fmt(y7), category: 'Sales', ip: '192.168.1.20' });\r\n\r\n    const y8 = new Date(yesterday); y8.setHours(17, 0, 0, 0);\r\n    seeds.push({ id: id++, userName: 'Admin', action: 'Logged out', reference: 'System', timestamp: fmt(y8), category: 'Login', ip: '192.168.1.10' });\r\n\r\n    // --- Two days ago ---\r\n    const twoDaysAgo = new Date(today);\r\n    twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);\r\n\r\n    const d0 = new Date(twoDaysAgo); d0.setHours(8, 0, 0, 0);\r\n    seeds.push({ id: id++, userName: 'Admin', action: 'Logged in', reference: 'System', timestamp: fmt(d0), category: 'Login', ip: '192.168.1.10' });\r\n\r\n    const d1 = new Date(twoDaysAgo); d1.setHours(9, 15, 0, 0);\r\n    seeds.push({ id: id++, userName: 'Admin', action: 'Deleted user account', reference: 'Mike Brown', timestamp: fmt(d1), category: 'Admin', ip: '192.168.1.10' });\r\n\r\n    const d2 = new Date(twoDaysAgo); d2.setHours(10, 30, 0, 0);\r\n    seeds.push({ id: id++, userName: 'Robert Johnson', action: 'Logged in', reference: 'System', timestamp: fmt(d2), category: 'Login', ip: '192.168.1.30' });\r\n\r\n    const d3 = new Date(twoDaysAgo); d3.setHours(11, 0, 0, 0);\r\n    seeds.push({ id: id++, userName: 'Robert Johnson', action: 'Recorded sale', reference: 'SALE-1995', timestamp: fmt(d3), category: 'Sales', ip: '192.168.1.30' });\r\n\r\n    const d4 = new Date(twoDaysAgo); d4.setHours(13, 0, 0, 0);\r\n    seeds.push({ id: id++, userName: 'Admin', action: 'Decreased ingredient quantity', reference: 'Onions (-1 kg, Used)', timestamp: fmt(d4), category: 'Inventory', ip: '192.168.1.10' });\r\n\r\n    const d5 = new Date(twoDaysAgo); d5.setHours(16, 0, 0, 0);\r\n    seeds.push({ id: id++, userName: 'Admin', action: 'Generated PDF report', reference: 'Daily Sales', timestamp: fmt(d5), category: 'Admin', ip: '192.168.1.10' });\r\n\r\n    return seeds;\r\n}\r\n\r\n// ===== Dashboard Recent Activity Timeline =====\r\nfunction loadRecentActivities() {\r\n    const container = document.getElementById('recentActivities');\r\n    if (!container) return;\r\n\r\n    const logs = getAllActivityLogs();\r\n    const recent = logs.slice(0, 8); // Show last 8 activities\r\n\r\n    if (recent.length === 0) {\r\n        container.innerHTML = '<p class=\"text-center text-muted py-4\">No recent activities.</p>';\r\n        return;\r\n    }\r\n\r\n    const iconMap = {\r\n        'Login': { icon: 'fa-sign-in-alt', color: 'text-info' },\r\n        'Sales': { icon: 'fa-cash-register', color: 'text-success' },\r\n        'Inventory': { icon: 'fa-boxes', color: 'text-warning' },\r\n        'Admin': { icon: 'fa-shield-alt', color: 'text-danger' }\r\n    };\r\n\r\n    let html = '';\r\n    recent.forEach(log => {\r\n        const cat = log.category || getActivityCategory(log.action);\r\n        const info = iconMap[cat] || iconMap['Admin'];\r\n        const ts = new Date(log.timestamp);\r\n        const timeStr = ts.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n        const dateStr = ts.toLocaleDateString();\r\n\r\n        html += `\r\n            <div class=\"activity-item\">\r\n                <div class=\"d-flex align-items-start\">\r\n                    <div class=\"activity-icon me-3 ${info.color}\" style=\"min-width:40px;\">\r\n                        <i class=\"fas ${info.icon}\"></i>\r\n                    </div>\r\n                    <div class=\"flex-grow-1\">\r\n                        <div class=\"d-flex justify-content-between align-items-center\">\r\n                            <strong class=\"small\">${log.userName}</strong>\r\n                            <small class=\"text-muted\">${timeStr}</small>\r\n                        </div>\r\n                        <p class=\"mb-0 small\">${log.action}</p>\r\n                        <small class=\"text-muted\">${log.reference || ''} &middot; ${dateStr}</small>\r\n                    </div>\r\n                </div>\r\n            </div>`;\r\n    });\r\n\r\n    container.innerHTML = html;\r\n}\r\n\r\n// ===== Old initializeActivityLog (for activityLogTable if it exists on other pages) =====\r\nfunction initializeActivityLog() {\r\n    const exportBtn = document.getElementById('exportActivityLog');\r\n    if (exportBtn) {\r\n        exportBtn.addEventListener('click', function () {\r\n            showModalNotification('Exporting activity log...', 'info', 'Exporting');\r\n        });\r\n    }\r\n    loadActivityLog();\r\n}\r\n\r\nfunction loadActivityLog() {\r\n    const tableElem = document.getElementById('activityLogTable');\r\n    if (!tableElem) return;\r\n\r\n    const tbody = tableElem.getElementsByTagName('tbody')[0];\r\n    if (!tbody) return;\r\n\r\n    const logs = getAllActivityLogs().slice(0, 20);\r\n    if (logs.length === 0) {\r\n        tbody.innerHTML = '<tr><td colspan=\"4\" class=\"text-center text-muted\">No activity logs found.</td></tr>';\r\n        return;\r\n    }\r\n    tbody.innerHTML = '';\r\n    logs.forEach(log => {\r\n        const row = tbody.insertRow();\r\n        row.innerHTML = `<td>${log.timestamp}</td><td>${log.userName}</td><td>${log.action}</td><td>${log.reference || '-'}</td>`;\r\n    });\r\n}\r\n\r\n// ===== Full Activity Log Page =====\r\nlet fullLogCurrentPage = 1;\r\nconst FULL_LOG_PAGE_SIZE = 15;\r\nlet fullLogFilteredData = [];\r\n\r\nfunction initializeFullActivityLog() {\r\n    // Category filter\r\n    const categoryFilter = document.getElementById('activityCategoryFilter');\r\n    if (categoryFilter) {\r\n        categoryFilter.addEventListener('change', function () {\r\n            fullLogCurrentPage = 1;\r\n            loadFullActivityLog();\r\n        });\r\n    }\r\n\r\n    // User filter\r\n    const userFilter = document.getElementById('activityUserFilter');\r\n    if (userFilter) {\r\n        userFilter.addEventListener('change', function () {\r\n            fullLogCurrentPage = 1;\r\n            loadFullActivityLog();\r\n        });\r\n    }\r\n\r\n    // Filter button\r\n    const filterBtn = document.getElementById('filterFullActivityBtn');\r\n    if (filterBtn) {\r\n        filterBtn.addEventListener('click', function () {\r\n            fullLogCurrentPage = 1;\r\n            loadFullActivityLog();\r\n        });\r\n    }\r\n\r\n    // Populate user dropdown\r\n    populateUserFilter();\r\n\r\n    // Initial load\r\n    loadFullActivityLog();\r\n}\r\n\r\nfunction populateUserFilter() {\r\n    const userFilter = document.getElementById('activityUserFilter');\r\n    if (!userFilter) return;\r\n\r\n    const logs = getAllActivityLogs();\r\n    const users = [...new Set(logs.map(l => l.userName))];\r\n    users.sort();\r\n\r\n    // Keep the \"All Users\" option, add user options\r\n    userFilter.innerHTML = '<option value=\"\">All Users</option>';\r\n    users.forEach(u => {\r\n        const opt = document.createElement('option');\r\n        opt.value = u;\r\n        opt.textContent = u;\r\n        userFilter.appendChild(opt);\r\n    });\r\n}\r\n\r\nfunction loadFullActivityLog() {\r\n    const tableElem = document.getElementById('fullActivityLogTable');\r\n    if (!tableElem) return;\r\n\r\n    const tbody = tableElem.getElementsByTagName('tbody')[0];\r\n    if (!tbody) return;\r\n\r\n    tbody.innerHTML = '<tr><td colspan=\"6\" class=\"text-center\"><div class=\"spinner-border spinner-border-sm text-danger me-2\" role=\"status\"></div>Loading activity logs...</td></tr>';\r\n\r\n    // Get filter values\r\n    const categoryVal = document.getElementById('activityCategoryFilter')?.value || '';\r\n    const userVal = document.getElementById('activityUserFilter')?.value || '';\r\n    const fromDate = document.getElementById('activityFromDate')?.value || '';\r\n    const toDate = document.getElementById('activityToDate')?.value || '';\r\n\r\n    setTimeout(() => {\r\n        let logs = getAllActivityLogs();\r\n\r\n        // Apply category filter\r\n        if (categoryVal) {\r\n            logs = logs.filter(log => {\r\n                const cat = log.category || getActivityCategory(log.action);\r\n                return cat === categoryVal;\r\n            });\r\n        }\r\n\r\n        // Apply user filter\r\n        if (userVal) {\r\n            logs = logs.filter(log => log.userName === userVal);\r\n        }\r\n\r\n        // Apply date filters\r\n        if (fromDate) {\r\n            const from = new Date(fromDate);\r\n            from.setHours(0, 0, 0, 0);\r\n            logs = logs.filter(log => new Date(log.timestamp) >= from);\r\n        }\r\n        if (toDate) {\r\n            const to = new Date(toDate);\r\n            to.setHours(23, 59, 59, 999);\r\n            logs = logs.filter(log => new Date(log.timestamp) <= to);\r\n        }\r\n\r\n        fullLogFilteredData = logs;\r\n\r\n        // Update entry count\r\n        const countBadge = document.getElementById('logEntryCount');\r\n        if (countBadge) countBadge.textContent = `${logs.length} Entries`;\r\n\r\n        // Paginate\r\n        const totalPages = Math.max(1, Math.ceil(logs.length / FULL_LOG_PAGE_SIZE));\r\n        if (fullLogCurrentPage > totalPages) fullLogCurrentPage = totalPages;\r\n\r\n        const startIdx = (fullLogCurrentPage - 1) * FULL_LOG_PAGE_SIZE;\r\n        const pageData = logs.slice(startIdx, startIdx + FULL_LOG_PAGE_SIZE);\r\n\r\n        tbody.innerHTML = '';\r\n\r\n        if (pageData.length === 0) {\r\n            tbody.innerHTML = '<tr><td colspan=\"6\" class=\"text-center text-muted py-4\"><i class=\"fas fa-inbox fa-2x mb-2 d-block\"></i>No activity logs match your filters.</td></tr>';\r\n        } else {\r\n            pageData.forEach(log => {\r\n                const cat = log.category || getActivityCategory(log.action);\r\n                const row = tbody.insertRow();\r\n                row.classList.add('animate__animated', 'animate__fadeIn');\r\n                row.innerHTML = `\r\n                    <td><small>${log.timestamp}</small></td>\r\n                    <td><strong>${log.userName}</strong></td>\r\n                    <td>${log.action}</td>\r\n                    <td>${getCategoryBadge(cat)}</td>\r\n                    <td><code>${log.ip || 'N/A'}</code></td>\r\n                    <td><small class=\"text-muted\">${log.reference || '-'}</small></td>\r\n                `;\r\n            });\r\n        }\r\n\r\n        // Render pagination\r\n        renderActivityPagination(totalPages);\r\n    }, 400);\r\n}\r\n\r\nfunction renderActivityPagination(totalPages) {\r\n    const paginationContainer = document.getElementById('activityPagination');\r\n    if (!paginationContainer) return;\r\n\r\n    paginationContainer.innerHTML = '';\r\n\r\n    if (totalPages <= 1) return;\r\n\r\n    // Previous button\r\n    const prevLi = document.createElement('li');\r\n    prevLi.className = `page-item ${fullLogCurrentPage === 1 ? 'disabled' : ''}`;\r\n    prevLi.innerHTML = `<a class=\"page-link\" href=\"#\" tabindex=\"-1\"><i class=\"fas fa-chevron-left\"></i></a>`;\r\n    prevLi.addEventListener('click', function (e) {\r\n        e.preventDefault();\r\n        if (fullLogCurrentPage > 1) {\r\n            fullLogCurrentPage--;\r\n            loadFullActivityLog();\r\n        }\r\n    });\r\n    paginationContainer.appendChild(prevLi);\r\n\r\n    // Page numbers (show max 5 pages around current)\r\n    let startPage = Math.max(1, fullLogCurrentPage - 2);\r\n    let endPage = Math.min(totalPages, startPage + 4);\r\n    if (endPage - startPage < 4) startPage = Math.max(1, endPage - 4);\r\n\r\n    for (let i = startPage; i <= endPage; i++) {\r\n        const li = document.createElement('li');\r\n        li.className = `page-item ${i === fullLogCurrentPage ? 'active' : ''}`;\r\n        li.innerHTML = `<a class=\"page-link\" href=\"#\">${i}</a>`;\r\n        li.addEventListener('click', function (e) {\r\n            e.preventDefault();\r\n            fullLogCurrentPage = i;\r\n            loadFullActivityLog();\r\n        });\r\n        paginationContainer.appendChild(li);\r\n    }\r\n\r\n    // Next button\r\n    const nextLi = document.createElement('li');\r\n    nextLi.className = `page-item ${fullLogCurrentPage === totalPages ? 'disabled' : ''}`;\r\n    nextLi.innerHTML = `<a class=\"page-link\" href=\"#\"><i class=\"fas fa-chevron-right\"></i></a>`;\r\n    nextLi.addEventListener('click', function (e) {\r\n        e.preventDefault();\r\n        if (fullLogCurrentPage < totalPages) {\r\n            fullLogCurrentPage++;\r\n            loadFullActivityLog();\r\n        }\r\n    });\r\n    paginationContainer.appendChild(nextLi);\r\n\r\n    // Style active page\r\n    paginationContainer.querySelectorAll('.page-item.active .page-link').forEach(el => {\r\n        el.style.backgroundColor = '#dc3545';\r\n        el.style.borderColor = '#dc3545';\r\n    });\r\n}\r\n\r\n// Temp Account Functions\r\nfunction initializeTempAccount() {\r\n    const createBtn = document.getElementById('createTempAccountBtn');\r\n    if (createBtn) {\r\n        createBtn.addEventListener('click', function () {\r\n            showModalNotification('Temporary account created', 'success', 'Created');\r\n        });\r\n    }\r\n\r\n    loadTempAccounts();\r\n}\r\n\r\nfunction loadTempAccounts() {\r\n    const tableElem = document.getElementById('tempStaffTable');\r\n    if (!tableElem) return;\r\n\r\n    const tbody = tableElem.getElementsByTagName('tbody')[0];\r\n    if (!tbody) return;\r\n\r\n    tbody.innerHTML = '<tr><td colspan=\"5\" class=\"text-center\">No active temporary accounts</td></tr>';\r\n}\r\n\r\n// ===== Helper Functions =====\r\nfunction logAdminActivity(action, details, status) {\r\n    console.log(`Activity: ${action} | Details: ${details} | Status: ${status}`);\r\n\r\n    // Persist to localStorage\r\n    let logs = [];\r\n    try {\r\n        const stored = localStorage.getItem('systemActivityLogs');\r\n        if (stored) logs = JSON.parse(stored);\r\n    } catch (e) { logs = []; }\r\n\r\n    const now = new Date();\r\n    const pad = n => String(n).padStart(2, '0');\r\n    const ts = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;\r\n\r\n    const newLog = {\r\n        id: Date.now(),\r\n        userName: localStorage.getItem('loggedInUser') || 'Admin',\r\n        action: action,\r\n        reference: details,\r\n        timestamp: ts,\r\n        category: getActivityCategory(action),\r\n        ip: '192.168.1.10'\r\n    };\r\n\r\n    logs.unshift(newLog);\r\n\r\n    // Keep max 500 entries\r\n    if (logs.length > 500) logs = logs.slice(0, 500);\r\n\r\n    localStorage.setItem('systemActivityLogs', JSON.stringify(logs));\r\n\r\n    // Refresh dashboard recent activities if on dashboard\r\n    if (document.getElementById('recentActivities')) {\r\n        loadRecentActivities();\r\n    }\r\n\r\n    // Refresh full log if on activity log page\r\n    if (document.getElementById('fullActivityLogTable')) {\r\n        loadFullActivityLog();\r\n    }\r\n}\r\n\r\n// showModalNotification and showConfirm are defined in main.js — not duplicated here"
        }
    ]
}