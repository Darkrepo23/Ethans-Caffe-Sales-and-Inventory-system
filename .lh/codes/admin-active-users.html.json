{
    "sourceFile": "codes/admin-active-users.html",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1772359264555,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1772359264555,
            "name": "Commit-0",
            "content": "<!DOCTYPE html>\r\n<html lang=\"en\">\r\n\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    <title>Active Users - Admin Dashboard</title>\r\n\r\n    <!-- Bootstrap 5 CSS -->\r\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\r\n    <!-- Font Awesome -->\r\n    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css\">\r\n    <!-- Animate.css -->\r\n    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css\">\r\n\r\n    <!-- Custom CSS -->\r\n    <link rel=\"stylesheet\" href=\"style.css\">\r\n    <link rel=\"stylesheet\" href=\"admin.css\">\r\n    <script>\r\n        // Immediate Sidebar State Initialization\r\n        (function () {\r\n            const html = document.documentElement;\r\n            html.classList.add('initializing');\r\n\r\n            const sidebarState = localStorage.getItem('sidebarActive');\r\n            if (sidebarState === 'true' && window.innerWidth >= 992) {\r\n                html.classList.add('sidebar-active');\r\n            }\r\n\r\n            // Auth Guard\r\n            try {\r\n                const role = localStorage.getItem('loggedInRole');\r\n                if (role !== 'admin' && role !== 'owner') {\r\n                    window.location.href = 'index.html';\r\n                }\r\n            } catch (e) {\r\n                window.location.href = 'index.html';\r\n            }\r\n        })();\r\n    </script>\r\n</head>\r\n\r\n<body>\r\n    <!-- Navigation Bar -->\r\n    <nav class=\"navbar navbar-expand-lg navbar-dark bg-black fixed-top shadow\">\r\n        <div class=\"container-fluid\">\r\n            <button class=\"sidebar-toggle mt-1 me-2\" id=\"sidebarToggle\">\r\n                <i class=\"fas fa-bars\"></i>\r\n            </button>\r\n\r\n            <button class=\"navbar-toggler\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#headerNav\">\r\n                <span class=\"fas fa-ellipsis-v\"></span>\r\n            </button>\r\n            <div class=\"collapse navbar-collapse\" id=\"headerNav\">\r\n                <ul class=\"navbar-nav ms-auto\">\r\n                    <li class=\"nav-item dropdown\">\r\n                        <a class=\"nav-link dropdown-toggle\" href=\"#\" role=\"button\" data-bs-toggle=\"dropdown\">\r\n                            <i class=\"fas fa-user-shield me-1\"></i>Administrator\r\n                        </a>\r\n                        <ul class=\"dropdown-menu dropdown-menu-end shadow border-0 animate__animated animate__fadeIn\">\r\n                            <li><a class=\"dropdown-item\" href=\"admin-system-settings.html\"><i\r\n                                        class=\"fas fa-cog me-2 text-danger\"></i>Settings</a></li>\r\n                            <li><a class=\"dropdown-item\" href=\"admin-activity-log.html\"><i\r\n                                        class=\"fas fa-history me-2 text-danger\"></i>Activity Log</a></li>\r\n                            <li>\r\n                                <hr class=\"dropdown-divider\">\r\n                            </li>\r\n                            <li><a class=\"dropdown-item text-danger\" href=\"#\" id=\"logoutBtn\"><i\r\n                                        class=\"fas fa-sign-out-alt me-2\"></i>Logout</a></li>\r\n                        </ul>\r\n                    </li>\r\n                </ul>\r\n            </div>\r\n        </div>\r\n    </nav>\r\n\r\n    <div class=\"dashboard-layout\">\r\n        <!-- Sidebar Navigation -->\r\n        <aside class=\"sidebar\" id=\"sidebar\">\r\n            <div class=\"sidebar-branding\">\r\n                <button class=\"sidebar-toggle in-sidebar\" id=\"sidebarToggleInternal\">\r\n                    <i class=\"fas fa-bars\"></i>\r\n                </button>\r\n                <a href=\"admin-dashboard.html\" class=\"sidebar-brand-group\">\r\n                    <img src=\"resources/ethans logo.jpg\" alt=\"Logo\">\r\n                    <span class=\"pos-label\">POS</span>\r\n                </a>\r\n            </div>\r\n            <div class=\"sidebar-nav\">\r\n                <div class=\"sidebar-section-title\">Navigation</div>\r\n                <a href=\"admin-dashboard.html\" class=\"sidebar-link\">\r\n                    <i class=\"fas fa-tachometer-alt\"></i>Dashboard\r\n                </a>\r\n                <a href=\"admin-menu-control.html\" class=\"sidebar-link\">\r\n                    <i class=\"fas fa-utensils\"></i>Menu Control\r\n                </a>\r\n                <a href=\"admin-recipe-control.html\" class=\"sidebar-link\">\r\n                    <i class=\"fas fa-book\"></i>Recipe Control\r\n                </a>\r\n                <a href=\"admin-ingredients-masterlist.html\" class=\"sidebar-link\">\r\n                    <i class=\"fas fa-boxes\"></i>Ingredients\r\n                </a>\r\n                <a href=\"admin-menu_customization.html\" class=\"sidebar-link\">\r\n                    <i class=\"fas fa-palette\"></i>Menu Customization\r\n                </a>\r\n                <a href=\"admin-user-management.html\" class=\"sidebar-link\">\r\n                    <i class=\"fas fa-users\"></i>Users\r\n                </a>\r\n                <a href=\"admin-requests.html\" class=\"sidebar-link\">\r\n                    <i class=\"fas fa-inbox\"></i>Requests\r\n                </a>\r\n\r\n                <div class=\"sidebar-divider\"></div>\r\n                <div class=\"sidebar-section-title\">Reports & Data</div>\r\n                <a href=\"admin-reports.html\" class=\"sidebar-link\">\r\n                    <i class=\"fas fa-chart-bar\"></i>Owner Reports\r\n                </a>\r\n                <a href=\"admin-backup.html\" class=\"sidebar-link\">\r\n                    <i class=\"fas fa-database\"></i>Backup & Restore\r\n                </a>\r\n\r\n                <div class=\"sidebar-divider\"></div>\r\n                <div class=\"sidebar-section-title\">System</div>\r\n                <a href=\"admin-system-settings.html\" class=\"sidebar-link\">\r\n                    <i class=\"fas fa-cog\"></i>System Settings\r\n                </a>\r\n                <a href=\"admin-activity-log.html\" class=\"sidebar-link\">\r\n                    <i class=\"fas fa-history\"></i>Full Activity Log\r\n                </a>\r\n                <a href=\"admin-temp-account.html\" class=\"sidebar-link\">\r\n                    <i class=\"fas fa-user-clock\"></i>Temp Staff Account\r\n                </a>\r\n                <a href=\"admin-active-users.html\" class=\"sidebar-link active\">\r\n                    <i class=\"fas fa-user-check\"></i>Active Users\r\n                </a>\r\n            </div>\r\n        </aside>\r\n\r\n        <!-- Main Content Area -->\r\n        <main class=\"main-content\">\r\n            <!-- Active Users Content -->\r\n            <div id=\"active-users-content\" class=\"page-content\">\r\n                <div class=\"d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom\">\r\n                    <h1 class=\"h2\"><i class=\"fas fa-user-check me-2 text-danger\"></i>Active Users</h1>\r\n                    <div class=\"btn-toolbar mb-2 mb-md-0\">\r\n                        <button class=\"btn btn-sm btn-outline-danger\" id=\"refreshActiveUsers\">\r\n                            <i class=\"fas fa-sync-alt\"></i> Refresh\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- Stats Cards -->\r\n                <div class=\"row mb-4\">\r\n                    <div class=\"col-md-4\">\r\n                        <div class=\"card shadow border-left-success py-2 h-100\">\r\n                            <div class=\"card-body\">\r\n                                <div class=\"row no-gutters align-items-center\">\r\n                                    <div class=\"col mr-2\">\r\n                                        <div class=\"text-xs font-weight-bold text-success text-uppercase mb-1\">Currently Active</div>\r\n                                        <div class=\"h5 mb-0 font-weight-bold\" id=\"activeCount\">0</div>\r\n                                    </div>\r\n                                    <div class=\"col-auto\">\r\n                                        <i class=\"fas fa-users fa-2x text-success\"></i>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"col-md-4\">\r\n                        <div class=\"card shadow border-left-primary py-2 h-100\">\r\n                            <div class=\"card-body\">\r\n                                <div class=\"row no-gutters align-items-center\">\r\n                                    <div class=\"col mr-2\">\r\n                                        <div class=\"text-xs font-weight-bold text-primary text-uppercase mb-1\">Admin Sessions</div>\r\n                                        <div class=\"h5 mb-0 font-weight-bold\" id=\"adminCount\">0</div>\r\n                                    </div>\r\n                                    <div class=\"col-auto\">\r\n                                        <i class=\"fas fa-user-shield fa-2x text-primary\"></i>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"col-md-4\">\r\n                        <div class=\"card shadow border-left-info py-2 h-100\">\r\n                            <div class=\"card-body\">\r\n                                <div class=\"row no-gutters align-items-center\">\r\n                                    <div class=\"col mr-2\">\r\n                                        <div class=\"text-xs font-weight-bold text-info text-uppercase mb-1\">Staff Sessions</div>\r\n                                        <div class=\"h5 mb-0 font-weight-bold\" id=\"staffCount\">0</div>\r\n                                    </div>\r\n                                    <div class=\"col-auto\">\r\n                                        <i class=\"fas fa-user fa-2x text-info\"></i>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- Active Users Table -->\r\n                <div class=\"card shadow mb-4\">\r\n                    <div class=\"card-header bg-black text-white px-3 d-flex justify-content-between align-items-center\">\r\n                        <h6 class=\"m-0 font-weight-bold\"><i class=\"fas fa-desktop me-1\"></i>Active Sessions</h6>\r\n                        <span class=\"badge bg-success\" id=\"lastUpdated\">Last updated: --</span>\r\n                    </div>\r\n                    <div class=\"card-body\">\r\n                        <div class=\"table-responsive\">\r\n                            <table class=\"table table-hover align-middle\" id=\"activeUsersTable\">\r\n                                <thead>\r\n                                    <tr>\r\n                                        <th>User</th>\r\n                                        <th>Role</th>\r\n                                        <th>IP Address</th>\r\n                                        <th>Login Time</th>\r\n                                        <th>Last Activity</th>\r\n                                        <th>Status</th>\r\n                                        <th>Actions</th>\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody>\r\n                                    <tr>\r\n                                        <td colspan=\"7\" class=\"text-center py-4\">\r\n                                            <i class=\"fas fa-spinner fa-spin me-2\"></i>Loading active users...\r\n                                        </td>\r\n                                    </tr>\r\n                                </tbody>\r\n                            </table>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- Session Activity Log -->\r\n                <div class=\"card shadow\">\r\n                    <div class=\"card-header bg-black text-white\">\r\n                        <h6 class=\"m-0 font-weight-bold\"><i class=\"fas fa-history me-1\"></i>Recent Session Activity</h6>\r\n                    </div>\r\n                    <div class=\"card-body\">\r\n                        <div class=\"activity-timeline\" id=\"sessionActivity\">\r\n                            <p class=\"text-center text-muted py-4\">Loading session activity...</p>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </main>\r\n    </div>\r\n\r\n    <!-- Force Logout Modal -->\r\n    <div class=\"modal fade\" id=\"forceLogoutModal\" tabindex=\"-1\">\r\n        <div class=\"modal-dialog\">\r\n            <div class=\"modal-content\">\r\n                <div class=\"modal-header bg-danger text-white\">\r\n                    <h5 class=\"modal-title\"><i class=\"fas fa-sign-out-alt me-2\"></i>Force Logout User</h5>\r\n                    <button type=\"button\" class=\"btn-close btn-close-white\" data-bs-dismiss=\"modal\"></button>\r\n                </div>\r\n                <div class=\"modal-body\">\r\n                    <p>Are you sure you want to force logout <strong id=\"forceLogoutUserName\">this user</strong>?</p>\r\n                    <p class=\"text-muted small\">This will immediately terminate their session.</p>\r\n                    <div class=\"mb-3\">\r\n                        <label class=\"form-label\">Reason (optional)</label>\r\n                        <input type=\"text\" class=\"form-control\" id=\"forceLogoutReason\" placeholder=\"e.g., Security concern\">\r\n                    </div>\r\n                </div>\r\n                <div class=\"modal-footer\">\r\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancel</button>\r\n                    <button type=\"button\" class=\"btn btn-danger\" id=\"confirmForceLogout\">Force Logout</button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- Bootstrap 5 JS -->\r\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js\"></script>\r\n    <script src=\"https://code.jquery.com/jquery-3.6.4.min.js\"></script>\r\n    <script src=\"https://cdn.jsdelivr.net/npm/sweetalert2@11\"></script>\r\n\r\n    <!-- Custom JS -->\r\n    <script src=\"main.js\"></script>\r\n    <script src=\"admin.js\"></script>\r\n\r\n    <script>\r\n        // Active Users Page Scripts\r\n        const NOTIFICATIONS_API = 'php/notifications.php';\r\n        let currentSessionToLogout = null;\r\n\r\n        document.addEventListener('DOMContentLoaded', function() {\r\n            loadActiveUsers();\r\n            \r\n            // Refresh button\r\n            document.getElementById('refreshActiveUsers')?.addEventListener('click', loadActiveUsers);\r\n            \r\n            // Confirm force logout\r\n            document.getElementById('confirmForceLogout')?.addEventListener('click', performForceLogout);\r\n            \r\n            // Auto-refresh every 30 seconds\r\n            setInterval(loadActiveUsers, 30000);\r\n        });\r\n\r\n        async function loadActiveUsers() {\r\n            const tbody = document.querySelector('#activeUsersTable tbody');\r\n            if (!tbody) return;\r\n\r\n            tbody.innerHTML = '<tr><td colspan=\"7\" class=\"text-center py-4\"><i class=\"fas fa-spinner fa-spin me-2\"></i>Loading...</td></tr>';\r\n\r\n            try {\r\n                const response = await fetch(`${NOTIFICATIONS_API}?action=active_users`);\r\n                const data = await response.json();\r\n\r\n                if (!data.success || !data.users) {\r\n                    throw new Error('Failed to load active users');\r\n                }\r\n\r\n                const users = data.users;\r\n                \r\n                // Update counts\r\n                document.getElementById('activeCount').textContent = users.length;\r\n                document.getElementById('adminCount').textContent = users.filter(u => u.role?.toLowerCase() === 'admin' || u.role?.toLowerCase() === 'owner').length;\r\n                document.getElementById('staffCount').textContent = users.filter(u => u.role?.toLowerCase() === 'staff' || u.role?.toLowerCase() === 'cashier').length;\r\n                document.getElementById('lastUpdated').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;\r\n\r\n                if (users.length === 0) {\r\n                    tbody.innerHTML = '<tr><td colspan=\"7\" class=\"text-center py-4 text-muted\"><i class=\"fas fa-user-slash me-2\"></i>No active users</td></tr>';\r\n                    return;\r\n                }\r\n\r\n                tbody.innerHTML = users.map(user => {\r\n                    const loginTime = user.login_time ? new Date(user.login_time).toLocaleString() : 'Unknown';\r\n                    const lastActivity = user.last_activity ? new Date(user.last_activity).toLocaleString() : 'Unknown';\r\n                    const isRecent = user.last_activity && (Date.now() - new Date(user.last_activity).getTime()) < 300000; // 5 minutes\r\n                    \r\n                    return `\r\n                        <tr class=\"animate__animated animate__fadeIn\">\r\n                            <td>\r\n                                <div class=\"d-flex align-items-center\">\r\n                                    <div class=\"avatar-circle bg-danger text-white me-2\">\r\n                                        ${user.full_name?.charAt(0) || 'U'}\r\n                                    </div>\r\n                                    <div>\r\n                                        <strong>${user.full_name || 'Unknown'}</strong>\r\n                                        <br><small class=\"text-muted\">@${user.username || ''}</small>\r\n                                    </div>\r\n                                </div>\r\n                            </td>\r\n                            <td><span class=\"badge ${user.role?.toLowerCase() === 'admin' ? 'bg-primary' : 'bg-secondary'}\">${user.role || 'Unknown'}</span></td>\r\n                            <td><code>${user.ip_address || 'N/A'}</code></td>\r\n                            <td><small>${loginTime}</small></td>\r\n                            <td><small>${lastActivity}</small></td>\r\n                            <td>\r\n                                <span class=\"badge ${isRecent ? 'bg-success' : 'bg-warning'}\">\r\n                                    <i class=\"fas fa-circle me-1\" style=\"font-size: 8px;\"></i>\r\n                                    ${isRecent ? 'Active' : 'Idle'}\r\n                                </span>\r\n                            </td>\r\n                            <td>\r\n                                <button class=\"btn btn-sm btn-outline-danger\" onclick=\"showForceLogoutModal(${user.session_id}, '${user.full_name}')\" title=\"Force Logout\">\r\n                                    <i class=\"fas fa-sign-out-alt\"></i>\r\n                                </button>\r\n                            </td>\r\n                        </tr>\r\n                    `;\r\n                }).join('');\r\n\r\n                loadSessionActivity();\r\n\r\n            } catch (error) {\r\n                console.error('Failed to load active users:', error);\r\n                tbody.innerHTML = '<tr><td colspan=\"7\" class=\"text-center py-4 text-danger\"><i class=\"fas fa-exclamation-triangle me-2\"></i>Failed to load active users</td></tr>';\r\n            }\r\n        }\r\n\r\n        async function loadSessionActivity() {\r\n            const activityDiv = document.getElementById('sessionActivity');\r\n            if (!activityDiv) return;\r\n\r\n            try {\r\n                // Get recent login activities\r\n                const response = await fetch('php/app.php?table=activity_logs&limit=10');\r\n                const logs = await response.json();\r\n\r\n                if (!logs || logs.length === 0) {\r\n                    activityDiv.innerHTML = '<p class=\"text-center text-muted py-3\">No recent activity</p>';\r\n                    return;\r\n                }\r\n\r\n                const loginLogs = logs.filter(l => l.action?.includes('Login') || l.action?.includes('Logout')).slice(0, 8);\r\n\r\n                if (loginLogs.length === 0) {\r\n                    activityDiv.innerHTML = '<p class=\"text-center text-muted py-3\">No recent session activity</p>';\r\n                    return;\r\n                }\r\n\r\n                activityDiv.innerHTML = loginLogs.map(log => {\r\n                    const isLogin = log.action?.includes('Login');\r\n                    const time = log.created_at ? new Date(log.created_at).toLocaleString() : '';\r\n                    return `\r\n                        <div class=\"activity-item d-flex align-items-start mb-3\">\r\n                            <div class=\"activity-icon ${isLogin ? 'bg-success' : 'bg-secondary'} text-white rounded-circle p-2 me-3\">\r\n                                <i class=\"fas ${isLogin ? 'fa-sign-in-alt' : 'fa-sign-out-alt'}\"></i>\r\n                            </div>\r\n                            <div class=\"activity-content\">\r\n                                <strong>${log.action}</strong>\r\n                                <p class=\"mb-0 text-muted small\">${log.reference || ''}</p>\r\n                                <small class=\"text-muted\">${time} â€¢ ${log.ip_address || ''}</small>\r\n                            </div>\r\n                        </div>\r\n                    `;\r\n                }).join('');\r\n\r\n            } catch (error) {\r\n                console.error('Failed to load session activity:', error);\r\n            }\r\n        }\r\n\r\n        function showForceLogoutModal(sessionId, userName) {\r\n            currentSessionToLogout = sessionId;\r\n            document.getElementById('forceLogoutUserName').textContent = userName;\r\n            document.getElementById('forceLogoutReason').value = '';\r\n            new bootstrap.Modal(document.getElementById('forceLogoutModal')).show();\r\n        }\r\n\r\n        async function performForceLogout() {\r\n            if (!currentSessionToLogout) return;\r\n\r\n            const reason = document.getElementById('forceLogoutReason').value;\r\n\r\n            try {\r\n                // Update session to inactive\r\n                const response = await fetch('php/app.php', {\r\n                    method: 'PUT',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({\r\n                        table: 'user_sessions',\r\n                        id: currentSessionToLogout,\r\n                        is_active: false\r\n                    })\r\n                });\r\n\r\n                if (response.ok) {\r\n                    bootstrap.Modal.getInstance(document.getElementById('forceLogoutModal')).hide();\r\n                    Swal.fire('Success', 'User has been logged out', 'success');\r\n                    loadActiveUsers();\r\n                } else {\r\n                    throw new Error('Failed to force logout');\r\n                }\r\n\r\n            } catch (error) {\r\n                console.error('Force logout failed:', error);\r\n                Swal.fire('Error', 'Failed to force logout user', 'error');\r\n            }\r\n        }\r\n    </script>\r\n\r\n    <style>\r\n        .avatar-circle {\r\n            width: 40px;\r\n            height: 40px;\r\n            border-radius: 50%;\r\n            display: flex;\r\n            align-items: center;\r\n            justify-content: center;\r\n            font-weight: bold;\r\n        }\r\n        .activity-icon {\r\n            width: 36px;\r\n            height: 36px;\r\n            display: flex;\r\n            align-items: center;\r\n            justify-content: center;\r\n            flex-shrink: 0;\r\n        }\r\n    </style>\r\n</body>\r\n\r\n</html>\r\n"
        }
    ]
}