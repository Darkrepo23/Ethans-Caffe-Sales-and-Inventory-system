{
    "sourceFile": "codes/php/send_notification.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1772372631216,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1772372631216,
            "name": "Commit-0",
            "content": "<?php\r\n/**\r\n * Send email notifications for system events\r\n * Events: low_stock, expiring_ingredients, void_transaction, refund_transaction\r\n */\r\n\r\nheader('Content-Type: application/json');\r\n\r\nrequire_once 'config.php';\r\nrequire_once 'session.php';\r\n\r\ntry {\r\n    // Only accept POST requests\r\n    if ($_SERVER['REQUEST_METHOD'] !== 'POST') {\r\n        http_response_code(405);\r\n        echo json_encode(['success' => false, 'message' => 'Method not allowed']);\r\n        exit;\r\n    }\r\n    \r\n    // Get JSON input\r\n    $input = json_decode(file_get_contents('php://input'), true);\r\n    $eventType = $input['event_type'] ?? '';\r\n    $eventData = $input['event_data'] ?? [];\r\n    \r\n    if (empty($eventType)) {\r\n        echo json_encode(['success' => false, 'message' => 'Event type is required']);\r\n        exit;\r\n    }\r\n    \r\n    // Connect to database to get admin emails and check settings\r\n    $pdo = new PDO(\r\n        \"pgsql:host=\" . SUPABASE_HOST . \";port=\" . SUPABASE_PORT . \";dbname=\" . SUPABASE_DB,\r\n        SUPABASE_USER,\r\n        SUPABASE_PASSWORD\r\n    );\r\n    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);\r\n    \r\n    // Check if email notifications are enabled\r\n    $stmt = $pdo->prepare(\"SELECT value FROM system_settings WHERE key = 'enable_email_notifications'\");\r\n    $stmt->execute();\r\n    $setting = $stmt->fetch(PDO::FETCH_ASSOC);\r\n    \r\n    if (!$setting || $setting['value'] !== 'true') {\r\n        echo json_encode(['success' => true, 'message' => 'Email notifications are disabled', 'sent' => false]);\r\n        exit;\r\n    }\r\n    \r\n    // Get admin email addresses\r\n    $stmt = $pdo->prepare(\"\r\n        SELECT u.email, u.full_name\r\n        FROM users u\r\n        JOIN roles r ON u.role_id = r.id\r\n        WHERE r.name IN ('Admin', 'admin')\r\n        AND u.status = 'active'\r\n        AND u.email IS NOT NULL\r\n        AND u.email != ''\r\n    \");\r\n    $stmt->execute();\r\n    $admins = $stmt->fetchAll(PDO::FETCH_ASSOC);\r\n    \r\n    if (empty($admins)) {\r\n        echo json_encode(['success' => false, 'message' => 'No admin email addresses found']);\r\n        exit;\r\n    }\r\n    \r\n    // Build email content based on event type\r\n    $subject = '';\r\n    $body = '';\r\n    $restaurantName = 'Ethan\\'s Cafe';\r\n    $timestamp = date('Y-m-d H:i:s');\r\n    \r\n    switch ($eventType) {\r\n        case 'low_stock':\r\n            $subject = \"[{$restaurantName}] Low Stock Alert\";\r\n            $items = $eventData['items'] ?? [];\r\n            $body = \"LOW STOCK ALERT\\n\";\r\n            $body .= \"Generated: {$timestamp}\\n\\n\";\r\n            $body .= \"The following ingredients are running low:\\n\\n\";\r\n            foreach ($items as $item) {\r\n                $body .= \"- {$item['name']}: {$item['quantity']} {$item['unit']} (Threshold: {$item['threshold']})\\n\";\r\n            }\r\n            $body .= \"\\nPlease restock these items soon.\";\r\n            break;\r\n            \r\n        case 'expiring_ingredients':\r\n            $subject = \"[{$restaurantName}] Expiring Ingredients Alert\";\r\n            $items = $eventData['items'] ?? [];\r\n            $body = \"EXPIRING INGREDIENTS ALERT\\n\";\r\n            $body .= \"Generated: {$timestamp}\\n\\n\";\r\n            $body .= \"The following ingredients are expiring soon:\\n\\n\";\r\n            foreach ($items as $item) {\r\n                if ($item['status'] === 'expired') {\r\n                    $body .= \"- {$item['name']}: EXPIRED {$item['days']} days ago\\n\";\r\n                } else {\r\n                    $body .= \"- {$item['name']}: Expires in {$item['days']} days\\n\";\r\n                }\r\n            }\r\n            $body .= \"\\nPlease check these ingredients.\";\r\n            break;\r\n            \r\n        case 'void_transaction':\r\n            $subject = \"[{$restaurantName}] Transaction Voided\";\r\n            $body = \"TRANSACTION VOIDED\\n\";\r\n            $body .= \"Generated: {$timestamp}\\n\\n\";\r\n            $body .= \"Transaction ID: \" . ($eventData['transaction_id'] ?? 'N/A') . \"\\n\";\r\n            $body .= \"Original Amount: \" . ($eventData['original_amount'] ?? 'N/A') . \"\\n\";\r\n            $body .= \"Voided By: \" . ($eventData['staff_name'] ?? 'N/A') . \"\\n\";\r\n            $body .= \"Reason: \" . ($eventData['reason'] ?? 'N/A') . \"\\n\";\r\n            if (!empty($eventData['manager_approved'])) {\r\n                $body .= \"Manager Approved: \" . ($eventData['manager_name'] ?? 'Yes') . \"\\n\";\r\n            }\r\n            break;\r\n            \r\n        case 'refund_transaction':\r\n            $subject = \"[{$restaurantName}] Transaction Refunded\";\r\n            $body = \"TRANSACTION REFUNDED\\n\";\r\n            $body .= \"Generated: {$timestamp}\\n\\n\";\r\n            $body .= \"Transaction ID: \" . ($eventData['transaction_id'] ?? 'N/A') . \"\\n\";\r\n            $body .= \"Original Amount: \" . ($eventData['original_amount'] ?? 'N/A') . \"\\n\";\r\n            $body .= \"Refund Amount: \" . ($eventData['refund_amount'] ?? 'N/A') . \"\\n\";\r\n            $body .= \"Refund Type: \" . ($eventData['refund_type'] ?? 'N/A') . \"\\n\";\r\n            $body .= \"Processed By: \" . ($eventData['staff_name'] ?? 'N/A') . \"\\n\";\r\n            $body .= \"Reason: \" . ($eventData['reason'] ?? 'N/A') . \"\\n\";\r\n            break;\r\n            \r\n        case 'daily_summary':\r\n            $subject = \"[{$restaurantName}] Daily Summary\";\r\n            $body = \"DAILY SUMMARY\\n\";\r\n            $body .= \"Date: {$timestamp}\\n\\n\";\r\n            $body .= \"Total Sales: \" . ($eventData['total_sales'] ?? 0) . \"\\n\";\r\n            $body .= \"Total Revenue: \" . ($eventData['total_revenue'] ?? '0.00') . \"\\n\";\r\n            $body .= \"Voids: \" . ($eventData['void_count'] ?? 0) . \"\\n\";\r\n            $body .= \"Refunds: \" . ($eventData['refund_count'] ?? 0) . \"\\n\";\r\n            break;\r\n            \r\n        default:\r\n            $subject = \"[{$restaurantName}] System Notification\";\r\n            $body = \"System Event: {$eventType}\\n\";\r\n            $body .= \"Timestamp: {$timestamp}\\n\";\r\n            $body .= \"Data: \" . json_encode($eventData, JSON_PRETTY_PRINT);\r\n    }\r\n    \r\n    // Add footer\r\n    $body .= \"\\n\\n---\\nThis is an automated message from {$restaurantName} POS System.\\n\";\r\n    $body .= \"Do not reply to this email.\";\r\n    \r\n    // Get email recipients\r\n    $recipients = array_column($admins, 'email');\r\n    \r\n    // Send email\r\n    $headers = \"From: noreply@ethanscafe.com\\r\\n\";\r\n    $headers .= \"Reply-To: noreply@ethanscafe.com\\r\\n\";\r\n    $headers .= \"X-Mailer: PHP/\" . phpversion();\r\n    \r\n    $emailsSent = 0;\r\n    $emailsFailed = 0;\r\n    \r\n    foreach ($recipients as $to) {\r\n        if (filter_var($to, FILTER_VALIDATE_EMAIL)) {\r\n            if (mail($to, $subject, $body, $headers)) {\r\n                $emailsSent++;\r\n            } else {\r\n                $emailsFailed++;\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Log the notification attempt\r\n    $stmt = $pdo->prepare(\"\r\n        INSERT INTO activity_logs (user_id, role_label, action, reference, status, ip_address, created_at)\r\n        VALUES (NULL, 'System', 'Email Notification', :event_type, :status, :ip, NOW())\r\n    \");\r\n    $stmt->execute([\r\n        'event_type' => $eventType,\r\n        'status' => $emailsSent > 0 ? 'Sent' : 'Failed',\r\n        'ip' => $_SERVER['REMOTE_ADDR'] ?? 'localhost'\r\n    ]);\r\n    \r\n    echo json_encode([\r\n        'success' => true, \r\n        'sent' => $emailsSent > 0,\r\n        'emails_sent' => $emailsSent,\r\n        'emails_failed' => $emailsFailed,\r\n        'message' => $emailsSent > 0 ? 'Notifications sent successfully' : 'Failed to send notifications'\r\n    ]);\r\n    \r\n} catch (PDOException $e) {\r\n    error_log('Email notification error: ' . $e->getMessage());\r\n    http_response_code(500);\r\n    echo json_encode(['success' => false, 'message' => 'Database error']);\r\n} catch (Exception $e) {\r\n    error_log('Email notification error: ' . $e->getMessage());\r\n    http_response_code(500);\r\n    echo json_encode(['success' => false, 'message' => 'Server error']);\r\n}\r\n"
        }
    ]
}