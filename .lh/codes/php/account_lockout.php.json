{
    "sourceFile": "codes/php/account_lockout.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1771919555841,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1771919555841,
            "name": "Commit-0",
            "content": "<?php\r\nob_start();\r\n\r\nheader('Content-Type: application/json');\r\nheader('Access-Control-Allow-Origin: *');\r\nheader('Access-Control-Allow-Methods: GET, POST');\r\nheader('Access-Control-Allow-Headers: Content-Type');\r\n\r\nsession_start();\r\n\r\n// Handle preflight requests\r\nif ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {\r\n    http_response_code(200);\r\n    exit();\r\n}\r\n\r\n// Load Supabase API helper\r\nrequire_once 'supabase-api.php';\r\n\r\n// GET request - List locked accounts\r\nif ($_SERVER['REQUEST_METHOD'] === 'GET') {\r\n    $action = $_GET['action'] ?? '';\r\n    \r\n    if ($action === 'list') {\r\n        try {\r\n            // Get all locked accounts with user details\r\n            $lockedAccounts = $supabase->select('account_lockout');\r\n            \r\n            if (!is_array($lockedAccounts) || isset($lockedAccounts['error'])) {\r\n                ob_end_clean();\r\n                echo json_encode(['success' => true, 'accounts' => []]);\r\n                exit();\r\n            }\r\n            \r\n            $accountsWithDetails = [];\r\n            foreach ($lockedAccounts as $lockout) {\r\n                // Get user details\r\n                $users = $supabase->select('users', ['id' => 'eq.' . $lockout['user_id']]);\r\n                if (is_array($users) && count($users) > 0) {\r\n                    $user = $users[0];\r\n                    \r\n                    // Get role name\r\n                    $roleName = 'unknown';\r\n                    if (isset($user['role_id'])) {\r\n                        $roles = $supabase->select('roles', ['id' => 'eq.' . $user['role_id']]);\r\n                        if (is_array($roles) && count($roles) > 0) {\r\n                            $roleName = $roles[0]['name'] ?? 'unknown';\r\n                        }\r\n                    }\r\n                    \r\n                    $accountsWithDetails[] = [\r\n                        'id' => $lockout['id'],\r\n                        'user_id' => $lockout['user_id'],\r\n                        'lockout_at' => $lockout['lockout_at'],\r\n                        'username' => $user['username'] ?? 'N/A',\r\n                        'full_name' => $user['full_name'] ?? 'N/A',\r\n                        'role_name' => $roleName\r\n                    ];\r\n                }\r\n            }\r\n            \r\n            ob_end_clean();\r\n            echo json_encode(['success' => true, 'accounts' => $accountsWithDetails]);\r\n            exit();\r\n            \r\n        } catch (Exception $e) {\r\n            ob_end_clean();\r\n            http_response_code(500);\r\n            echo json_encode(['success' => false, 'message' => 'Database error: ' . $e->getMessage()]);\r\n            exit();\r\n        }\r\n    }\r\n}\r\n\r\n// POST request - Unlock account\r\nif ($_SERVER['REQUEST_METHOD'] === 'POST') {\r\n    $input = json_decode(file_get_contents('php://input'), true);\r\n    $action = $input['action'] ?? '';\r\n    $userId = $input['user_id'] ?? null;\r\n    \r\n    if ($action === 'unlock' && $userId) {\r\n        try {\r\n            // Remove from lockout table\r\n            $result = $supabase->removeLockout($userId);\r\n            \r\n            // Clear any failed attempts\r\n            $users = $supabase->select('users', ['id' => 'eq.' . $userId]);\r\n            if (is_array($users) && count($users) > 0) {\r\n                $username = $users[0]['username'];\r\n                $supabase->clearFailedAttempts($username);\r\n                \r\n                // Log the unlock action\r\n                $ip = $_SERVER['REMOTE_ADDR'] ?? '0.0.0.0';\r\n                $adminUser = isset($_SESSION['user_id']) ? $_SESSION['user_id'] : null;\r\n                \r\n                $logData = [\r\n                    'user_id' => $adminUser ?? $userId,\r\n                    'role_label' => 'admin',\r\n                    'action' => 'Account Unlocked',\r\n                    'reference' => 'User: ' . $username,\r\n                    'status' => 'Success',\r\n                    'ip_address' => $ip,\r\n                    'created_at' => date('Y-m-d H:i:s')\r\n                ];\r\n                $supabase->insert('activity_logs', $logData);\r\n            }\r\n            \r\n            ob_end_clean();\r\n            echo json_encode(['success' => true, 'message' => 'Account unlocked successfully']);\r\n            exit();\r\n            \r\n        } catch (Exception $e) {\r\n            ob_end_clean();\r\n            http_response_code(500);\r\n            echo json_encode(['success' => false, 'message' => 'Failed to unlock account: ' . $e->getMessage()]);\r\n            exit();\r\n        }\r\n    }\r\n    \r\n    ob_end_clean();\r\n    http_response_code(400);\r\n    echo json_encode(['success' => false, 'message' => 'Invalid action or missing user_id']);\r\n    exit();\r\n}\r\n\r\nob_end_clean();\r\nhttp_response_code(405);\r\necho json_encode(['success' => false, 'message' => 'Method not allowed']);\r\n?>\r\n"
        }
    ]
}