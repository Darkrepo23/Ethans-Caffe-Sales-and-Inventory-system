{
    "sourceFile": "codes/php/login.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 7,
            "patches": [
                {
                    "date": 1771495398137,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1771495772176,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,36 +3,36 @@\n header(\"Content-Type: application/json\");\r\n header(\"Access-Control-Allow-Headers: Content-Type\");\r\n header(\"Access-Control-Allow-Methods: POST\");\r\n \r\n+session_start();\r\n+\r\n // DB CONFIG\r\n $host = '127.0.0.1';\r\n $db   = 'ethans_cafe';\r\n $user = 'root';\r\n $pass = '';\r\n \r\n-session_start();\r\n-\r\n try {\r\n     $pdo = new PDO(\"mysql:host=$host;dbname=$db;charset=utf8\", $user, $pass);\r\n     $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);\r\n } \r\n catch (Exception $e) {\r\n-    echo json_encode([\"error\" => \"DB Connection Failed\"]);\r\n+    echo json_encode([\"error\" => \"Database connection failed\"]);\r\n     exit();\r\n }\r\n \r\n-// Read JSON request body\r\n+// Read JSON body\r\n $data = json_decode(file_get_contents(\"php://input\"), true);\r\n $username = trim($data['username'] ?? '');\r\n $password = trim($data['password'] ?? '');\r\n \r\n-if (!$username || !$password) {\r\n+if (empty($username) || empty($password)) {\r\n     echo json_encode([\"error\" => \"Missing username or password\"]);\r\n     exit();\r\n }\r\n \r\n-// Fetch user\r\n+// Fetch user using username only\r\n $stmt = $pdo->prepare(\"SELECT * FROM users WHERE username = ? AND deleted_at IS NULL LIMIT 1\");\r\n $stmt->execute([$username]);\r\n $user = $stmt->fetch(PDO::FETCH_ASSOC);\r\n \r\n@@ -40,20 +40,21 @@\n     echo json_encode([\"error\" => \"Invalid username or password\"]);\r\n     exit();\r\n }\r\n \r\n-// Verify password\r\n+// PASSWORD VERIFY\r\n if (!password_verify($password, $user['password_hash'])) {\r\n     echo json_encode([\"error\" => \"Invalid username or password\"]);\r\n     exit();\r\n }\r\n \r\n-// Login success → create session\r\n+// SUCCESS → Create session\r\n $_SESSION['user_id'] = $user['id'];\r\n $_SESSION['role_id'] = $user['role_id'];\r\n \r\n echo json_encode([\r\n     \"success\" => true,\r\n+    \"session_id\" => session_id(),   // IMPORTANT for API-based login\r\n     \"user_id\" => $user['id'],\r\n     \"role_id\" => $user['role_id'],\r\n     \"full_name\" => $user['full_name']\r\n ]);\r\n"
                },
                {
                    "date": 1771583693497,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,10 +30,15 @@\n     echo json_encode([\"error\" => \"Missing username or password\"]);\r\n     exit();\r\n }\r\n \r\n-// Fetch user using username only\r\n-$stmt = $pdo->prepare(\"SELECT * FROM users WHERE username = ? AND deleted_at IS NULL LIMIT 1\");\r\n+$stmt = $pdo->prepare(\"\r\n+    SELECT u.*, r.name AS role_name \r\n+    FROM users u \r\n+    JOIN roles r ON u.role_id = r.id \r\n+    WHERE u.username = ? AND u.deleted_at IS NULL \r\n+    LIMIT 1\r\n+\");\r\n $stmt->execute([$username]);\r\n $user = $stmt->fetch(PDO::FETCH_ASSOC);\r\n \r\n if (!$user) {\r\n"
                },
                {
                    "date": 1771583735153,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,15 +30,10 @@\n     echo json_encode([\"error\" => \"Missing username or password\"]);\r\n     exit();\r\n }\r\n \r\n-$stmt = $pdo->prepare(\"\r\n-    SELECT u.*, r.name AS role_name \r\n-    FROM users u \r\n-    JOIN roles r ON u.role_id = r.id \r\n-    WHERE u.username = ? AND u.deleted_at IS NULL \r\n-    LIMIT 1\r\n-\");\r\n+// Fetch user using username only\r\n+$stmt = $pdo->prepare(\"SELECT * FROM users WHERE username = ? AND deleted_at IS NULL LIMIT 1\");\r\n $stmt->execute([$username]);\r\n $user = $stmt->fetch(PDO::FETCH_ASSOC);\r\n \r\n if (!$user) {\r\n"
                },
                {
                    "date": 1771583828575,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,56 +5,126 @@\n header(\"Access-Control-Allow-Methods: POST\");\r\n \r\n session_start();\r\n \r\n-// DB CONFIG\r\n $host = '127.0.0.1';\r\n $db   = 'ethans_cafe';\r\n $user = 'root';\r\n $pass = '';\r\n \r\n try {\r\n     $pdo = new PDO(\"mysql:host=$host;dbname=$db;charset=utf8\", $user, $pass);\r\n     $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);\r\n-} \r\n-catch (Exception $e) {\r\n+    $pdo->setAttribute(PDO::ATTR_EMULATE_PREPARES, false); // force true prepared statements\r\n+} catch (Exception $e) {\r\n     echo json_encode([\"error\" => \"Database connection failed\"]);\r\n     exit();\r\n }\r\n \r\n-// Read JSON body\r\n-$data = json_decode(file_get_contents(\"php://input\"), true);\r\n+// Only accept POST\r\n+if ($_SERVER['REQUEST_METHOD'] !== 'POST') {\r\n+    http_response_code(405);\r\n+    echo json_encode([\"error\" => \"Method not allowed\"]);\r\n+    exit();\r\n+}\r\n+\r\n+// Only accept JSON content type\r\n+$contentType = $_SERVER['CONTENT_TYPE'] ?? '';\r\n+if (stripos($contentType, 'application/json') === false) {\r\n+    http_response_code(415);\r\n+    echo json_encode([\"error\" => \"Unsupported Media Type\"]);\r\n+    exit();\r\n+}\r\n+\r\n+$raw = file_get_contents(\"php://input\");\r\n+$data = json_decode($raw, true);\r\n+\r\n+// Validate JSON\r\n+if (!is_array($data)) {\r\n+    http_response_code(400);\r\n+    echo json_encode([\"error\" => \"Invalid JSON\"]);\r\n+    exit();\r\n+}\r\n+\r\n $username = trim($data['username'] ?? '');\r\n $password = trim($data['password'] ?? '');\r\n \r\n+// Basic input validation\r\n if (empty($username) || empty($password)) {\r\n+    http_response_code(400);\r\n     echo json_encode([\"error\" => \"Missing username or password\"]);\r\n     exit();\r\n }\r\n \r\n-// Fetch user using username only\r\n-$stmt = $pdo->prepare(\"SELECT * FROM users WHERE username = ? AND deleted_at IS NULL LIMIT 1\");\r\n-$stmt->execute([$username]);\r\n-$user = $stmt->fetch(PDO::FETCH_ASSOC);\r\n+// Limit input length to prevent abuse\r\n+if (strlen($username) > 100 || strlen($password) > 255) {\r\n+    http_response_code(400);\r\n+    echo json_encode([\"error\" => \"Input too long\"]);\r\n+    exit();\r\n+}\r\n \r\n-if (!$user) {\r\n-    echo json_encode([\"error\" => \"Invalid username or password\"]);\r\n+// Sanitize username (alphanumeric + underscore only)\r\n+if (!preg_match('/^[a-zA-Z0-9_]+$/', $username)) {\r\n+    http_response_code(400);\r\n+    echo json_encode([\"error\" => \"Invalid username format\"]);\r\n     exit();\r\n }\r\n \r\n-// PASSWORD VERIFY\r\n-if (!password_verify($password, $user['password_hash'])) {\r\n+// Brute force protection — track failed attempts in session\r\n+if (!isset($_SESSION['login_attempts'])) {\r\n+    $_SESSION['login_attempts'] = 0;\r\n+    $_SESSION['login_last_attempt'] = time();\r\n+}\r\n+\r\n+// Reset attempts after 15 minutes\r\n+if (time() - $_SESSION['login_last_attempt'] > 900) {\r\n+    $_SESSION['login_attempts'] = 0;\r\n+    $_SESSION['login_last_attempt'] = time();\r\n+}\r\n+\r\n+if ($_SESSION['login_attempts'] >= 5) {\r\n+    http_response_code(429);\r\n+    echo json_encode([\"error\" => \"Too many login attempts. Please wait 15 minutes.\"]);\r\n+    exit();\r\n+}\r\n+\r\n+// Fetch user with role name via JOIN\r\n+$stmt = $pdo->prepare(\"\r\n+    SELECT u.id, u.username, u.full_name, u.password_hash, u.role_id, r.name AS role_name\r\n+    FROM users u\r\n+    JOIN roles r ON u.role_id = r.id\r\n+    WHERE u.username = ? AND u.deleted_at IS NULL\r\n+    LIMIT 1\r\n+\");\r\n+$stmt->execute([$username]);\r\n+$user = $stmt->fetch(PDO::FETCH_ASSOC);\r\n+\r\n+// Always verify password even if user not found (prevent timing attacks)\r\n+$dummyHash = '$2y$10$invalidhashfortimingprotection000000000000000000000000';\r\n+$hashToVerify = $user ? $user['password_hash'] : $dummyHash;\r\n+$passwordValid = password_verify($password, $hashToVerify);\r\n+\r\n+if (!$user || !$passwordValid) {\r\n+    $_SESSION['login_attempts']++;\r\n+    $_SESSION['login_last_attempt'] = time();\r\n+    http_response_code(401);\r\n     echo json_encode([\"error\" => \"Invalid username or password\"]);\r\n     exit();\r\n }\r\n \r\n-// SUCCESS → Create session\r\n+// Reset attempts on success\r\n+$_SESSION['login_attempts'] = 0;\r\n+\r\n+// Regenerate session ID to prevent session fixation\r\n+session_regenerate_id(true);\r\n+\r\n $_SESSION['user_id'] = $user['id'];\r\n $_SESSION['role_id'] = $user['role_id'];\r\n \r\n echo json_encode([\r\n-    \"success\" => true,\r\n-    \"session_id\" => session_id(),   // IMPORTANT for API-based login\r\n-    \"user_id\" => $user['id'],\r\n-    \"role_id\" => $user['role_id'],\r\n-    \"full_name\" => $user['full_name']\r\n-]);\r\n+    \"success\"    => true,\r\n+    \"session_id\" => session_id(),\r\n+    \"user_id\"    => $user['id'],\r\n+    \"role_id\"    => $user['role_id'],\r\n+    \"role_name\"  => $user['role_name'],\r\n+    \"full_name\"  => htmlspecialchars($user['full_name'], ENT_QUOTES, 'UTF-8')\r\n+]);\n\\ No newline at end of file\n"
                },
                {
                    "date": 1771835578176,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -68,29 +68,11 @@\n     echo json_encode([\"error\" => \"Invalid username format\"]);\r\n     exit();\r\n }\r\n \r\n-// Brute force protection — track failed attempts in session\r\n-if (!isset($_SESSION['login_attempts'])) {\r\n-    $_SESSION['login_attempts'] = 0;\r\n-    $_SESSION['login_last_attempt'] = time();\r\n-}\r\n-\r\n-// Reset attempts after 15 minutes\r\n-if (time() - $_SESSION['login_last_attempt'] > 900) {\r\n-    $_SESSION['login_attempts'] = 0;\r\n-    $_SESSION['login_last_attempt'] = time();\r\n-}\r\n-\r\n-if ($_SESSION['login_attempts'] >= 5) {\r\n-    http_response_code(429);\r\n-    echo json_encode([\"error\" => \"Too many login attempts. Please wait 15 minutes.\"]);\r\n-    exit();\r\n-}\r\n-\r\n // Fetch user with role name via JOIN\r\n $stmt = $pdo->prepare(\"\r\n-    SELECT u.id, u.username, u.full_name, u.password_hash, u.role_id, r.name AS role_name\r\n+    SELECT u.id, u.username, u.full_name, u.email, u.password_hash, u.role_id, r.name AS role_name\r\n     FROM users u\r\n     JOIN roles r ON u.role_id = r.id\r\n     WHERE u.username = ? AND u.deleted_at IS NULL\r\n     LIMIT 1\r\n@@ -103,28 +85,34 @@\n $hashToVerify = $user ? $user['password_hash'] : $dummyHash;\r\n $passwordValid = password_verify($password, $hashToVerify);\r\n \r\n if (!$user || !$passwordValid) {\r\n-    $_SESSION['login_attempts']++;\r\n-    $_SESSION['login_last_attempt'] = time();\r\n     http_response_code(401);\r\n     echo json_encode([\"error\" => \"Invalid username or password\"]);\r\n     exit();\r\n }\r\n \r\n-// Reset attempts on success\r\n-$_SESSION['login_attempts'] = 0;\r\n-\r\n // Regenerate session ID to prevent session fixation\r\n session_regenerate_id(true);\r\n \r\n $_SESSION['user_id'] = $user['id'];\r\n $_SESSION['role_id'] = $user['role_id'];\r\n \r\n+// Log successful login for \"My Activity\"\r\n+try {\r\n+    $ip = $_SERVER['REMOTE_ADDR'] ?? '0.0.0.0';\r\n+    $logStmt = $pdo->prepare(\"INSERT INTO activity_logs (user_id, role_label, action, reference, status, ip_address, created_at) VALUES (?, ?, ?, ?, ?, ?, NOW())\");\r\n+    $logStmt->execute([$user['id'], $user['role_name'], 'Logged in', 'System', 'Success', $ip]);\r\n+} catch (Exception $e) {\r\n+    // Silently fail logging if it errors out\r\n+}\r\n+\r\n echo json_encode([\r\n     \"success\"    => true,\r\n     \"session_id\" => session_id(),\r\n-    \"user_id\"    => $user['id'],\r\n+    \"id\"         => $user['id'],\r\n+    \"username\"   => $user['username'],\r\n+    \"email\"      => $user['email'],\r\n     \"role_id\"    => $user['role_id'],\r\n     \"role_name\"  => $user['role_name'],\r\n     \"full_name\"  => htmlspecialchars($user['full_name'], ENT_QUOTES, 'UTF-8')\r\n ]);\n\\ No newline at end of file\n"
                },
                {
                    "date": 1771856401177,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,26 +1,19 @@\n <?php\r\n+ob_start();\r\n+\r\n header(\"Access-Control-Allow-Origin: *\");\r\n header(\"Content-Type: application/json\");\r\n header(\"Access-Control-Allow-Headers: Content-Type\");\r\n header(\"Access-Control-Allow-Methods: POST\");\r\n \r\n session_start();\r\n+ini_set('display_errors', 0);\r\n+ini_set('log_errors', 1);\r\n \r\n-$host = '127.0.0.1';\r\n-$db   = 'ethans_cafe';\r\n-$user = 'root';\r\n-$pass = '';\r\n+// Load Supabase API helper\r\n+require_once 'supabase-api.php';\r\n \r\n-try {\r\n-    $pdo = new PDO(\"mysql:host=$host;dbname=$db;charset=utf8\", $user, $pass);\r\n-    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);\r\n-    $pdo->setAttribute(PDO::ATTR_EMULATE_PREPARES, false); // force true prepared statements\r\n-} catch (Exception $e) {\r\n-    echo json_encode([\"error\" => \"Database connection failed\"]);\r\n-    exit();\r\n-}\r\n-\r\n // Only accept POST\r\n if ($_SERVER['REQUEST_METHOD'] !== 'POST') {\r\n     http_response_code(405);\r\n     echo json_encode([\"error\" => \"Method not allowed\"]);\r\n@@ -49,44 +42,40 @@\n $password = trim($data['password'] ?? '');\r\n \r\n // Basic input validation\r\n if (empty($username) || empty($password)) {\r\n+    ob_end_clean();\r\n     http_response_code(400);\r\n     echo json_encode([\"error\" => \"Missing username or password\"]);\r\n     exit();\r\n }\r\n \r\n // Limit input length to prevent abuse\r\n if (strlen($username) > 100 || strlen($password) > 255) {\r\n+    ob_end_clean();\r\n     http_response_code(400);\r\n     echo json_encode([\"error\" => \"Input too long\"]);\r\n     exit();\r\n }\r\n \r\n // Sanitize username (alphanumeric + underscore only)\r\n if (!preg_match('/^[a-zA-Z0-9_]+$/', $username)) {\r\n+    ob_end_clean();\r\n     http_response_code(400);\r\n     echo json_encode([\"error\" => \"Invalid username format\"]);\r\n     exit();\r\n }\r\n \r\n-// Fetch user with role name via JOIN\r\n-$stmt = $pdo->prepare(\"\r\n-    SELECT u.id, u.username, u.full_name, u.email, u.password_hash, u.role_id, r.name AS role_name\r\n-    FROM users u\r\n-    JOIN roles r ON u.role_id = r.id\r\n-    WHERE u.username = ? AND u.deleted_at IS NULL\r\n-    LIMIT 1\r\n-\");\r\n-$stmt->execute([$username]);\r\n-$user = $stmt->fetch(PDO::FETCH_ASSOC);\r\n+// Use Supabase API to get user\r\n+$user = $supabase->getUserWithRole($username);\r\n \r\n // Always verify password even if user not found (prevent timing attacks)\r\n $dummyHash = '$2y$10$invalidhashfortimingprotection000000000000000000000000';\r\n $hashToVerify = $user ? $user['password_hash'] : $dummyHash;\r\n $passwordValid = password_verify($password, $hashToVerify);\r\n \r\n if (!$user || !$passwordValid) {\r\n+    ob_end_clean();\r\n     http_response_code(401);\r\n     echo json_encode([\"error\" => \"Invalid username or password\"]);\r\n     exit();\r\n }\r\n@@ -99,20 +88,29 @@\n \r\n // Log successful login for \"My Activity\"\r\n try {\r\n     $ip = $_SERVER['REMOTE_ADDR'] ?? '0.0.0.0';\r\n-    $logStmt = $pdo->prepare(\"INSERT INTO activity_logs (user_id, role_label, action, reference, status, ip_address, created_at) VALUES (?, ?, ?, ?, ?, ?, NOW())\");\r\n-    $logStmt->execute([$user['id'], $user['role_name'], 'Logged in', 'System', 'Success', $ip]);\r\n+    $logData = [\r\n+        'user_id' => $user['id'],\r\n+        'role_label' => $user['role_name'] ?? 'unknown',\r\n+        'action' => 'Logged in',\r\n+        'reference' => 'System',\r\n+        'status' => 'Success',\r\n+        'ip_address' => $ip,\r\n+        'created_at' => date('Y-m-d H:i:s')\r\n+    ];\r\n+    $supabase->insert('activity_logs', $logData);\r\n } catch (Exception $e) {\r\n     // Silently fail logging if it errors out\r\n }\r\n \r\n\\ No newline at end of file\n+ob_end_clean();\r\n echo json_encode([\r\n     \"success\"    => true,\r\n     \"session_id\" => session_id(),\r\n     \"id\"         => $user['id'],\r\n     \"username\"   => $user['username'],\r\n-    \"email\"      => $user['email'],\r\n     \"role_id\"    => $user['role_id'],\r\n-    \"role_name\"  => $user['role_name'],\r\n-    \"full_name\"  => htmlspecialchars($user['full_name'], ENT_QUOTES, 'UTF-8')\r\n-]);\n+    \"role_name\"  => $user['role_name'] ?? 'unknown',\r\n+    \"full_name\"  => $user['full_name'] ?? ''\r\n+]);\r\n+?>\n\\ No newline at end of file\n"
                },
                {
                    "date": 1771919555980,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -12,8 +12,17 @@\n \r\n // Load Supabase API helper\r\n require_once 'supabase-api.php';\r\n \r\n+// Cooldown times in seconds for each attempt\r\n+$COOLDOWN_TIMES = [\r\n+    1 => 10,    // 1st failed attempt: 10 seconds\r\n+    2 => 30,    // 2nd failed attempt: 30 seconds\r\n+    3 => 60,    // 3rd failed attempt: 1 minute\r\n+    4 => 120,   // 4th failed attempt: 2 minutes\r\n+    5 => -1     // 5th attempt: permanent lockout\r\n+];\r\n+\r\n // Only accept POST\r\n if ($_SERVER['REQUEST_METHOD'] !== 'POST') {\r\n     http_response_code(405);\r\n     echo json_encode([\"error\" => \"Method not allowed\"]);\r\n@@ -67,20 +76,116 @@\n \r\n // Use Supabase API to get user\r\n $user = $supabase->getUserWithRole($username);\r\n \r\n+// Check if user is locked out (only if user exists)\r\n+if ($user) {\r\n+    $isLockedOut = $supabase->isUserLockedOut($user['id']);\r\n+    if ($isLockedOut) {\r\n+        ob_end_clean();\r\n+        http_response_code(403);\r\n+        echo json_encode([\r\n+            \"error\" => \"Account is locked\",\r\n+            \"locked\" => true,\r\n+            \"message\" => \"Your account has been locked due to too many failed login attempts. Please contact an administrator.\"\r\n+        ]);\r\n+        exit();\r\n+    }\r\n+}\r\n+\r\n+// Check for existing failed attempts and cooldown\r\n+$failedAttempts = $supabase->getFailedAttempts($username);\r\n+if ($failedAttempts) {\r\n+    $attemptCount = (int)$failedAttempts['attempt_count'];\r\n+    $lastAttemptAt = strtotime($failedAttempts['last_attempt_at']);\r\n+    $now = time();\r\n+    \r\n+    // Get cooldown time for current attempt count\r\n+    $cooldownTime = $COOLDOWN_TIMES[$attemptCount] ?? 0;\r\n+    \r\n+    if ($cooldownTime > 0) {\r\n+        $timeSinceLastAttempt = $now - $lastAttemptAt;\r\n+        $remainingCooldown = $cooldownTime - $timeSinceLastAttempt;\r\n+        \r\n+        if ($remainingCooldown > 0) {\r\n+            ob_end_clean();\r\n+            http_response_code(429);\r\n+            echo json_encode([\r\n+                \"error\" => \"Too many attempts\",\r\n+                \"cooldown\" => true,\r\n+                \"remaining_seconds\" => $remainingCooldown,\r\n+                \"message\" => \"Please wait \" . $remainingCooldown . \" seconds before trying again.\"\r\n+            ]);\r\n+            exit();\r\n+        }\r\n+    }\r\n+}\r\n+\r\n // Always verify password even if user not found (prevent timing attacks)\r\n $dummyHash = '$2y$10$invalidhashfortimingprotection000000000000000000000000';\r\n $hashToVerify = $user ? $user['password_hash'] : $dummyHash;\r\n $passwordValid = password_verify($password, $hashToVerify);\r\n \r\n if (!$user || !$passwordValid) {\r\n+    // Handle failed login attempt\r\n+    $currentAttemptCount = $failedAttempts ? (int)$failedAttempts['attempt_count'] + 1 : 1;\r\n+    $nowTimestamp = date('c');\r\n+    \r\n+    // Record the failed attempt (log any errors)\r\n+    $recordResult = $supabase->recordFailedAttempt($username, $currentAttemptCount, $nowTimestamp);\r\n+    error_log(\"Login attempt recorded for $username: count=$currentAttemptCount, result=\" . json_encode($recordResult));\r\n+    \r\n+    // Check if this triggers a lockout (5th attempt)\r\n+    if ($currentAttemptCount >= 5 && $user) {\r\n+        $lockoutResult = $supabase->lockoutUser($user['id']);\r\n+        error_log(\"Lockout triggered for user {$user['id']}: \" . json_encode($lockoutResult));\r\n+        $supabase->clearFailedAttempts($username);\r\n+        \r\n+        // Log the lockout\r\n+        try {\r\n+            $ip = $_SERVER['REMOTE_ADDR'] ?? '0.0.0.0';\r\n+            $logData = [\r\n+                'user_id' => $user['id'],\r\n+                'role_label' => $user['role_name'] ?? 'unknown',\r\n+                'action' => 'Account Locked',\r\n+                'reference' => 'Brute Force Protection',\r\n+                'status' => 'Warning',\r\n+                'ip_address' => $ip,\r\n+                'created_at' => date('Y-m-d H:i:s')\r\n+            ];\r\n+            $supabase->insert('activity_logs', $logData);\r\n+        } catch (Exception $e) {}\r\n+        \r\n+        ob_end_clean();\r\n+        http_response_code(403);\r\n+        echo json_encode([\r\n+            \"error\" => \"Account locked\",\r\n+            \"locked\" => true,\r\n+            \"message\" => \"Your account has been locked due to too many failed login attempts. Please contact an administrator.\"\r\n+        ]);\r\n+        exit();\r\n+    }\r\n+    \r\n+    // Return error with cooldown info\r\n+    $cooldownTime = $COOLDOWN_TIMES[$currentAttemptCount] ?? 0;\r\n+    $attemptsRemaining = 5 - $currentAttemptCount;\r\n+    \r\n     ob_end_clean();\r\n     http_response_code(401);\r\n-    echo json_encode([\"error\" => \"Invalid username or password\"]);\r\n+    echo json_encode([\r\n+        \"error\" => \"Invalid username or password\",\r\n+        \"attempts_remaining\" => $attemptsRemaining,\r\n+        \"cooldown_seconds\" => $cooldownTime > 0 ? $cooldownTime : null,\r\n+        \"message\" => $attemptsRemaining > 0 \r\n+            ? \"Invalid credentials. $attemptsRemaining attempt(s) remaining. Wait $cooldownTime seconds before retrying.\"\r\n+            : \"Invalid credentials.\"\r\n+    ]);\r\n     exit();\r\n }\r\n \r\n+// Successful login - clear failed attempts\r\n+$supabase->clearFailedAttempts($username);\r\n+\r\n // Regenerate session ID to prevent session fixation\r\n session_regenerate_id(true);\r\n \r\n $_SESSION['user_id'] = $user['id'];\r\n"
                }
            ],
            "date": 1771495398137,
            "name": "Commit-0",
            "content": "<?php\r\nheader(\"Access-Control-Allow-Origin: *\");\r\nheader(\"Content-Type: application/json\");\r\nheader(\"Access-Control-Allow-Headers: Content-Type\");\r\nheader(\"Access-Control-Allow-Methods: POST\");\r\n\r\n// DB CONFIG\r\n$host = '127.0.0.1';\r\n$db   = 'ethans_cafe';\r\n$user = 'root';\r\n$pass = '';\r\n\r\nsession_start();\r\n\r\ntry {\r\n    $pdo = new PDO(\"mysql:host=$host;dbname=$db;charset=utf8\", $user, $pass);\r\n    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);\r\n} \r\ncatch (Exception $e) {\r\n    echo json_encode([\"error\" => \"DB Connection Failed\"]);\r\n    exit();\r\n}\r\n\r\n// Read JSON request body\r\n$data = json_decode(file_get_contents(\"php://input\"), true);\r\n$username = trim($data['username'] ?? '');\r\n$password = trim($data['password'] ?? '');\r\n\r\nif (!$username || !$password) {\r\n    echo json_encode([\"error\" => \"Missing username or password\"]);\r\n    exit();\r\n}\r\n\r\n// Fetch user\r\n$stmt = $pdo->prepare(\"SELECT * FROM users WHERE username = ? AND deleted_at IS NULL LIMIT 1\");\r\n$stmt->execute([$username]);\r\n$user = $stmt->fetch(PDO::FETCH_ASSOC);\r\n\r\nif (!$user) {\r\n    echo json_encode([\"error\" => \"Invalid username or password\"]);\r\n    exit();\r\n}\r\n\r\n// Verify password\r\nif (!password_verify($password, $user['password_hash'])) {\r\n    echo json_encode([\"error\" => \"Invalid username or password\"]);\r\n    exit();\r\n}\r\n\r\n// Login success → create session\r\n$_SESSION['user_id'] = $user['id'];\r\n$_SESSION['role_id'] = $user['role_id'];\r\n\r\necho json_encode([\r\n    \"success\" => true,\r\n    \"user_id\" => $user['id'],\r\n    \"role_id\" => $user['role_id'],\r\n    \"full_name\" => $user['full_name']\r\n]);\r\n"
        }
    ]
}