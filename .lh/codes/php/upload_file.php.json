{
    "sourceFile": "codes/php/upload_file.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1771861930266,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1771861930266,
            "name": "Commit-0",
            "content": "<?php\r\n/**\r\n * File Upload Handler for Supabase Storage\r\n * Handles image uploads for menu items\r\n */\r\n\r\nsession_start();\r\nheader('Content-Type: application/json');\r\nheader('Access-Control-Allow-Origin: *');\r\nheader('Access-Control-Allow-Methods: POST, OPTIONS');\r\nheader('Access-Control-Allow-Headers: Content-Type');\r\n\r\n// Handle preflight requests\r\nif ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {\r\n    http_response_code(200);\r\n    exit;\r\n}\r\n\r\n// Supabase configuration\r\n$SUPABASE_URL = 'https://kpuyiaadnirvnvzjugqz.supabase.co';\r\n$SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwdXlpYWFkbmlydm52emp1Z3F6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MjU1NzAsImV4cCI6MjA4NzQwMTU3MH0.BdeFCxm3m4s_EgIJ8GVbBMzGIM8sWIy6FZwprA87aUc';\r\n$BUCKET_NAME = 'menu-images'; // Supabase Storage bucket name\r\n\r\n// Only allow POST method\r\nif ($_SERVER['REQUEST_METHOD'] !== 'POST') {\r\n    http_response_code(405);\r\n    echo json_encode(['error' => 'Method not allowed']);\r\n    exit;\r\n}\r\n\r\n// Check if file was uploaded\r\nif (!isset($_FILES['image']) || $_FILES['image']['error'] !== UPLOAD_ERR_OK) {\r\n    $errorMessages = [\r\n        UPLOAD_ERR_INI_SIZE => 'File exceeds upload_max_filesize',\r\n        UPLOAD_ERR_FORM_SIZE => 'File exceeds MAX_FILE_SIZE',\r\n        UPLOAD_ERR_PARTIAL => 'File was only partially uploaded',\r\n        UPLOAD_ERR_NO_FILE => 'No file was uploaded',\r\n        UPLOAD_ERR_NO_TMP_DIR => 'Missing temporary folder',\r\n        UPLOAD_ERR_CANT_WRITE => 'Failed to write file to disk',\r\n        UPLOAD_ERR_EXTENSION => 'File upload stopped by extension'\r\n    ];\r\n    \r\n    $errorCode = $_FILES['image']['error'] ?? UPLOAD_ERR_NO_FILE;\r\n    $errorMsg = $errorMessages[$errorCode] ?? 'Unknown upload error';\r\n    \r\n    http_response_code(400);\r\n    echo json_encode(['error' => $errorMsg]);\r\n    exit;\r\n}\r\n\r\n$file = $_FILES['image'];\r\n\r\n// Validate file type\r\n$allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];\r\n$finfo = new finfo(FILEINFO_MIME_TYPE);\r\n$mimeType = $finfo->file($file['tmp_name']);\r\n\r\nif (!in_array($mimeType, $allowedTypes)) {\r\n    http_response_code(400);\r\n    echo json_encode(['error' => 'Invalid file type. Allowed: JPEG, PNG, GIF, WebP']);\r\n    exit;\r\n}\r\n\r\n// Validate file size (max 5MB)\r\n$maxSize = 5 * 1024 * 1024;\r\nif ($file['size'] > $maxSize) {\r\n    http_response_code(400);\r\n    echo json_encode(['error' => 'File too large. Maximum size is 5MB']);\r\n    exit;\r\n}\r\n\r\n// Generate unique filename\r\n$extension = pathinfo($file['name'], PATHINFO_EXTENSION);\r\n$filename = 'menu_' . time() . '_' . bin2hex(random_bytes(8)) . '.' . $extension;\r\n\r\n// Read file contents\r\n$fileContents = file_get_contents($file['tmp_name']);\r\nif ($fileContents === false) {\r\n    http_response_code(500);\r\n    echo json_encode(['error' => 'Failed to read uploaded file']);\r\n    exit;\r\n}\r\n\r\n// Upload to Supabase Storage\r\n$uploadUrl = $SUPABASE_URL . '/storage/v1/object/' . $BUCKET_NAME . '/' . $filename;\r\n\r\n$ch = curl_init($uploadUrl);\r\ncurl_setopt_array($ch, [\r\n    CURLOPT_RETURNTRANSFER => true,\r\n    CURLOPT_POST => true,\r\n    CURLOPT_POSTFIELDS => $fileContents,\r\n    CURLOPT_SSL_VERIFYPEER => false,\r\n    CURLOPT_SSL_VERIFYHOST => false,\r\n    CURLOPT_TIMEOUT => 30,\r\n    CURLOPT_HTTPHEADER => [\r\n        'Authorization: Bearer ' . $SUPABASE_KEY,\r\n        'apikey: ' . $SUPABASE_KEY,\r\n        'Content-Type: ' . $mimeType,\r\n        'x-upsert: true'\r\n    ]\r\n]);\r\n\r\n$response = curl_exec($ch);\r\n$httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);\r\n$curlError = curl_error($ch);\r\ncurl_close($ch);\r\n\r\nif ($curlError) {\r\n    http_response_code(500);\r\n    echo json_encode(['error' => 'Upload failed: ' . $curlError]);\r\n    exit;\r\n}\r\n\r\n// Check if upload was successful\r\nif ($httpCode >= 200 && $httpCode < 300) {\r\n    // Generate public URL for the uploaded image\r\n    $publicUrl = $SUPABASE_URL . '/storage/v1/object/public/' . $BUCKET_NAME . '/' . $filename;\r\n    \r\n    echo json_encode([\r\n        'success' => true,\r\n        'filename' => $filename,\r\n        'url' => $publicUrl,\r\n        'size' => $file['size'],\r\n        'type' => $mimeType\r\n    ]);\r\n} else {\r\n    // Parse error response from Supabase\r\n    $errorData = json_decode($response, true);\r\n    $errorMessage = $errorData['message'] ?? $errorData['error'] ?? 'Upload failed';\r\n    \r\n    // If bucket doesn't exist, save locally as fallback\r\n    if (strpos($response, 'Bucket not found') !== false || $httpCode === 404) {\r\n        // Fallback: Save to local uploads directory\r\n        $uploadsDir = __DIR__ . '/../resources/uploads/';\r\n        if (!is_dir($uploadsDir)) {\r\n            mkdir($uploadsDir, 0755, true);\r\n        }\r\n        \r\n        $localPath = $uploadsDir . $filename;\r\n        if (move_uploaded_file($file['tmp_name'], $localPath)) {\r\n            echo json_encode([\r\n                'success' => true,\r\n                'filename' => $filename,\r\n                'url' => '/resources/uploads/' . $filename,\r\n                'size' => $file['size'],\r\n                'type' => $mimeType,\r\n                'storage' => 'local'\r\n            ]);\r\n            exit;\r\n        }\r\n    }\r\n    \r\n    http_response_code(500);\r\n    echo json_encode([\r\n        'error' => $errorMessage,\r\n        'details' => $response\r\n    ]);\r\n}\r\n?>\r\n"
        }
    ]
}