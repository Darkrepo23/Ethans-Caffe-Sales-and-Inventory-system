{
    "sourceFile": "codes/php/master_unlock.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1771916210647,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1771916873923,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,10 +1,14 @@\n <?php\r\n+ob_start();\r\n+\r\n header('Content-Type: application/json');\r\n header('Access-Control-Allow-Origin: *');\r\n header('Access-Control-Allow-Methods: POST');\r\n header('Access-Control-Allow-Headers: Content-Type');\r\n \r\n+session_start();\r\n+\r\n // Handle preflight requests\r\n if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {\r\n     http_response_code(200);\r\n     exit();\r\n@@ -15,28 +19,82 @@\n     echo json_encode(['success' => false, 'message' => 'Method not allowed']);\r\n     exit();\r\n }\r\n \r\n+// Load Supabase API helper\r\n+require_once 'supabase-api.php';\r\n+\r\n // Get the access code from the request\r\n $input = json_decode(file_get_contents('php://input'), true);\r\n $accessCode = isset($input['accessCode']) ? trim($input['accessCode']) : '';\r\n \r\n // The master access code (stored securely on server)\r\n $MASTER_CODE = 'ETHANS-0491-772-CAFE';\r\n \r\n-if ($accessCode === $MASTER_CODE) {\r\n+if ($accessCode !== $MASTER_CODE) {\r\n+    http_response_code(401);\r\n     echo json_encode([\r\n+        'success' => false,\r\n+        'message' => 'Invalid access code'\r\n+    ]);\r\n+    exit();\r\n+}\r\n+\r\n+// Access code verified - fetch admin/owner account from database\r\n+try {\r\n+    // Query for admin or owner role user\r\n+    $adminUser = $supabase->getAdminOrOwnerUser();\r\n+    \r\n+    if (!$adminUser) {\r\n+        ob_end_clean();\r\n+        http_response_code(404);\r\n+        echo json_encode([\r\n+            'success' => false,\r\n+            'message' => 'No admin account found in database'\r\n+        ]);\r\n+        exit();\r\n+    }\r\n+    \r\n+    // Set up session for the admin user\r\n+    session_regenerate_id(true);\r\n+    $_SESSION['user_id'] = $adminUser['id'];\r\n+    $_SESSION['role_id'] = $adminUser['role_id'];\r\n+    \r\n+    // Log the master unlock login\r\n+    try {\r\n+        $ip = $_SERVER['REMOTE_ADDR'] ?? '0.0.0.0';\r\n+        $logData = [\r\n+            'user_id' => $adminUser['id'],\r\n+            'role_label' => $adminUser['role_name'] ?? 'admin',\r\n+            'action' => 'Master Unlock Login',\r\n+            'reference' => 'Emergency Access',\r\n+            'status' => 'Success',\r\n+            'ip_address' => $ip,\r\n+            'created_at' => date('Y-m-d H:i:s')\r\n+        ];\r\n+        $supabase->insert('activity_logs', $logData);\r\n+    } catch (Exception $e) {\r\n+        // Silently fail logging\r\n+    }\r\n+    \r\n+    ob_end_clean();\r\n+    echo json_encode([\r\n         'success' => true,\r\n         'message' => 'Access granted',\r\n-        'credentials' => [\r\n-            'username' => 'admin',\r\n-            'password' => 'admin123'\r\n+        'user' => [\r\n+            'id' => $adminUser['id'],\r\n+            'username' => $adminUser['username'],\r\n+            'role_id' => $adminUser['role_id'],\r\n+            'role_name' => $adminUser['role_name'] ?? 'admin',\r\n+            'full_name' => $adminUser['full_name'] ?? ''\r\n         ]\r\n     ]);\r\n-} else {\r\n-    http_response_code(401);\r\n+    \r\n+} catch (Exception $e) {\r\n+    ob_end_clean();\r\n+    http_response_code(500);\r\n     echo json_encode([\r\n         'success' => false,\r\n-        'message' => 'Invalid access code'\r\n+        'message' => 'Database error: ' . $e->getMessage()\r\n     ]);\r\n }\r\n ?>\r\n"
                },
                {
                    "date": 1771919555905,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -53,8 +53,14 @@\n         ]);\r\n         exit();\r\n     }\r\n     \r\n+    // Remove admin from lockout if they were locked out\r\n+    $supabase->removeLockout($adminUser['id']);\r\n+    \r\n+    // Clear any failed login attempts\r\n+    $supabase->clearFailedAttempts($adminUser['username']);\r\n+    \r\n     // Set up session for the admin user\r\n     session_regenerate_id(true);\r\n     $_SESSION['user_id'] = $adminUser['id'];\r\n     $_SESSION['role_id'] = $adminUser['role_id'];\r\n@@ -65,9 +71,9 @@\n         $logData = [\r\n             'user_id' => $adminUser['id'],\r\n             'role_label' => $adminUser['role_name'] ?? 'admin',\r\n             'action' => 'Master Unlock Login',\r\n-            'reference' => 'Emergency Access',\r\n+            'reference' => 'Emergency Access - Lockout Cleared',\r\n             'status' => 'Success',\r\n             'ip_address' => $ip,\r\n             'created_at' => date('Y-m-d H:i:s')\r\n         ];\r\n"
                }
            ],
            "date": 1771916210647,
            "name": "Commit-0",
            "content": "<?php\r\nheader('Content-Type: application/json');\r\nheader('Access-Control-Allow-Origin: *');\r\nheader('Access-Control-Allow-Methods: POST');\r\nheader('Access-Control-Allow-Headers: Content-Type');\r\n\r\n// Handle preflight requests\r\nif ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {\r\n    http_response_code(200);\r\n    exit();\r\n}\r\n\r\nif ($_SERVER['REQUEST_METHOD'] !== 'POST') {\r\n    http_response_code(405);\r\n    echo json_encode(['success' => false, 'message' => 'Method not allowed']);\r\n    exit();\r\n}\r\n\r\n// Get the access code from the request\r\n$input = json_decode(file_get_contents('php://input'), true);\r\n$accessCode = isset($input['accessCode']) ? trim($input['accessCode']) : '';\r\n\r\n// The master access code (stored securely on server)\r\n$MASTER_CODE = 'ETHANS-0491-772-CAFE';\r\n\r\nif ($accessCode === $MASTER_CODE) {\r\n    echo json_encode([\r\n        'success' => true,\r\n        'message' => 'Access granted',\r\n        'credentials' => [\r\n            'username' => 'admin',\r\n            'password' => 'admin123'\r\n        ]\r\n    ]);\r\n} else {\r\n    http_response_code(401);\r\n    echo json_encode([\r\n        'success' => false,\r\n        'message' => 'Invalid access code'\r\n    ]);\r\n}\r\n?>\r\n"
        }
    ]
}