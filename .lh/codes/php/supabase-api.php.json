{
    "sourceFile": "codes/php/supabase-api.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1771856401123,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1771916876419,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -115,8 +115,65 @@\n             return $user;\r\n         }\r\n         return null;\r\n     }\r\n+\r\n+    /**\r\n+     * Get admin or owner user for master unlock\r\n+     */\r\n+    public function getAdminOrOwnerUser() {\r\n+        // First get the role IDs for admin and owner\r\n+        $roles = $this->select('roles', ['name' => 'in.(admin,owner)']);\r\n+        \r\n+        if (!is_array($roles) || count($roles) === 0) {\r\n+            // Fallback: try to get by common role names\r\n+            $roles = $this->select('roles');\r\n+            if (!is_array($roles)) return null;\r\n+        }\r\n+        \r\n+        $adminRoleIds = [];\r\n+        foreach ($roles as $role) {\r\n+            $roleName = strtolower($role['name'] ?? '');\r\n+            if ($roleName === 'admin' || $roleName === 'owner') {\r\n+                $adminRoleIds[] = $role['id'];\r\n+            }\r\n+        }\r\n+        \r\n+        if (empty($adminRoleIds)) return null;\r\n+        \r\n+        // Get a user with admin or owner role\r\n+        foreach ($adminRoleIds as $roleId) {\r\n+            $users = $this->select('users', ['role_id' => 'eq.' . $roleId, 'status' => 'eq.active']);\r\n+            if (is_array($users) && count($users) > 0) {\r\n+                $user = $users[0];\r\n+                // Add role name\r\n+                foreach ($roles as $role) {\r\n+                    if ($role['id'] == $user['role_id']) {\r\n+                        $user['role_name'] = $role['name'];\r\n+                        break;\r\n+                    }\r\n+                }\r\n+                return $user;\r\n+            }\r\n+        }\r\n+        \r\n+        // If no active admin found, try without status filter\r\n+        foreach ($adminRoleIds as $roleId) {\r\n+            $users = $this->select('users', ['role_id' => 'eq.' . $roleId]);\r\n+            if (is_array($users) && count($users) > 0) {\r\n+                $user = $users[0];\r\n+                foreach ($roles as $role) {\r\n+                    if ($role['id'] == $user['role_id']) {\r\n+                        $user['role_name'] = $role['name'];\r\n+                        break;\r\n+                    }\r\n+                }\r\n+                return $user;\r\n+            }\r\n+        }\r\n+        \r\n+        return null;\r\n+    }\r\n }\r\n \r\n $supabase = new SupabaseAPI();\r\n ?>\r\n"
                },
                {
                    "date": 1771919555970,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -172,8 +172,79 @@\n         }\r\n         \r\n         return null;\r\n     }\r\n+\r\n+    /**\r\n+     * Check if user is locked out\r\n+     */\r\n+    public function isUserLockedOut($userId) {\r\n+        $result = $this->select('account_lockout', ['user_id' => 'eq.' . $userId]);\r\n+        return is_array($result) && count($result) > 0;\r\n+    }\r\n+\r\n+    /**\r\n+     * Lock out a user\r\n+     */\r\n+    public function lockoutUser($userId) {\r\n+        // Check if already locked out\r\n+        if ($this->isUserLockedOut($userId)) {\r\n+            return true;\r\n+        }\r\n+        \r\n+        $data = [\r\n+            'user_id' => $userId,\r\n+            'lockout_at' => date('c') // ISO 8601 format\r\n+        ];\r\n+        \r\n+        $result = $this->insert('account_lockout', $data);\r\n+        return !isset($result['error']);\r\n+    }\r\n+\r\n+    /**\r\n+     * Remove user from lockout\r\n+     */\r\n+    public function removeLockout($userId) {\r\n+        return $this->delete('account_lockout', ['user_id' => 'eq.' . $userId]);\r\n+    }\r\n+\r\n+    /**\r\n+     * Get failed login attempts for a user (from session or temporary storage)\r\n+     * Returns count of failed attempts\r\n+     */\r\n+    public function getFailedAttempts($username) {\r\n+        $result = $this->select('login_attempts', ['username' => 'eq.' . $username]);\r\n+        if (is_array($result) && count($result) > 0) {\r\n+            return $result[0];\r\n+        }\r\n+        return null;\r\n+    }\r\n+\r\n+    /**\r\n+     * Record/update failed login attempt\r\n+     */\r\n+    public function recordFailedAttempt($username, $attemptCount, $lastAttemptAt) {\r\n+        $existing = $this->getFailedAttempts($username);\r\n+        \r\n+        $data = [\r\n+            'username' => $username,\r\n+            'attempt_count' => $attemptCount,\r\n+            'last_attempt_at' => $lastAttemptAt\r\n+        ];\r\n+        \r\n+        if ($existing) {\r\n+            return $this->update('login_attempts', $data, ['username' => 'eq.' . $username]);\r\n+        } else {\r\n+            return $this->insert('login_attempts', $data);\r\n+        }\r\n+    }\r\n+\r\n+    /**\r\n+     * Clear failed attempts for a user\r\n+     */\r\n+    public function clearFailedAttempts($username) {\r\n+        return $this->delete('login_attempts', ['username' => 'eq.' . $username]);\r\n+    }\r\n }\r\n \r\n $supabase = new SupabaseAPI();\r\n ?>\r\n"
                }
            ],
            "date": 1771856401123,
            "name": "Commit-0",
            "content": "<?php\r\n/**\r\n * Supabase REST API Helper\r\n * Provides functions to interact with Supabase without direct PostgreSQL\r\n */\r\n\r\nclass SupabaseAPI {\r\n    private $projectUrl = 'https://kpuyiaadnirvnvzjugqz.supabase.co';\r\n    private $anonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwdXlpYWFkbmlydm52emp1Z3F6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MjU1NzAsImV4cCI6MjA4NzQwMTU3MH0.BdeFCxm3m4s_EgIJ8GVbBMzGIM8sWIy6FZwprA87aUc';\r\n\r\n    /**\r\n     * Make a REST API request to Supabase\r\n     */\r\n    private function request($method, $table, $query = null, $data = null) {\r\n        $url = $this->projectUrl . '/rest/v1/' . $table;\r\n        \r\n        if ($query) {\r\n            $url .= '?' . http_build_query($query);\r\n        }\r\n\r\n        $ch = curl_init($url);\r\n        $headers = [\r\n            'Authorization: Bearer ' . $this->anonKey,\r\n            'Content-Type: application/json',\r\n            'apikey: ' . $this->anonKey,\r\n            'Prefer: return=representation'\r\n        ];\r\n\r\n        curl_setopt_array($ch, [\r\n            CURLOPT_RETURNTRANSFER => true,\r\n            CURLOPT_SSL_VERIFYPEER => false,\r\n            CURLOPT_SSL_VERIFYHOST => false,\r\n            CURLOPT_TIMEOUT => 10,\r\n            CURLOPT_CUSTOMREQUEST => $method,\r\n            CURLOPT_HTTPHEADER => $headers\r\n        ]);\r\n\r\n        if ($data !== null) {\r\n            curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));\r\n        }\r\n\r\n        $response = curl_exec($ch);\r\n        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);\r\n        $error = curl_error($ch);\r\n        curl_close($ch);\r\n\r\n        if ($error) {\r\n            error_log(\"Supabase API Error: \" . $error);\r\n            return ['error' => $error];\r\n        }\r\n\r\n        if ($response === false || $response === '') {\r\n            return $httpCode === 200 || $httpCode === 201 ? [] : ['error' => \"HTTP $httpCode\"];\r\n        }\r\n\r\n        $decoded = json_decode($response, true);\r\n        return $decoded ?? ['error' => 'Invalid response'];\r\n    }\r\n\r\n    /**\r\n     * SELECT query\r\n     */\r\n    public function select($table, $filters = []) {\r\n        $query = [];\r\n        foreach ($filters as $key => $value) {\r\n            $query[$key] = $value;\r\n        }\r\n        $query['limit'] = 1000;\r\n        return $this->request('GET', $table, $query);\r\n    }\r\n\r\n    /**\r\n     * INSERT query\r\n     */\r\n    public function insert($table, $data) {\r\n        return $this->request('POST', $table, null, $data);\r\n    }\r\n\r\n    /**\r\n     * UPDATE query\r\n     */\r\n    public function update($table, $data, $filters = []) {\r\n        $query = [];\r\n        foreach ($filters as $key => $value) {\r\n            $query[$key] = $value;\r\n        }\r\n        return $this->request('PATCH', $table, $query, $data);\r\n    }\r\n\r\n    /**\r\n     * DELETE query\r\n     */\r\n    public function delete($table, $filters = []) {\r\n        $query = [];\r\n        foreach ($filters as $key => $value) {\r\n            $query[$key] = $value;\r\n        }\r\n        return $this->request('DELETE', $table, $query);\r\n    }\r\n\r\n    /**\r\n     * Get user with role information\r\n     */\r\n    public function getUserWithRole($username) {\r\n        $result = $this->select('users', ['username' => 'eq.' . $username]);\r\n        if (is_array($result) && count($result) > 0) {\r\n            $user = $result[0];\r\n            // Get role info if role_id exists\r\n            if (isset($user['role_id'])) {\r\n                $roles = $this->select('roles', ['id' => 'eq.' . $user['role_id']]);\r\n                if (is_array($roles) && count($roles) > 0) {\r\n                    $user['role_name'] = $roles[0]['name'] ?? 'unknown';\r\n                }\r\n            }\r\n            return $user;\r\n        }\r\n        return null;\r\n    }\r\n}\r\n\r\n$supabase = new SupabaseAPI();\r\n?>\r\n"
        }
    ]
}