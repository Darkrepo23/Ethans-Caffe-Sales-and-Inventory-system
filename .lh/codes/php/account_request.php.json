{
    "sourceFile": "codes/php/account_request.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1771608701549,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1771608701549,
            "name": "Commit-0",
            "content": "<?php\r\nheader(\"Access-Control-Allow-Origin: *\");\r\nheader(\"Content-Type: application/json\");\r\nheader(\"Access-Control-Allow-Headers: Content-Type\");\r\nheader(\"Access-Control-Allow-Methods: POST\");\r\n\r\nif ($_SERVER['REQUEST_METHOD'] !== 'POST') {\r\n    http_response_code(405);\r\n    echo json_encode([\"error\" => \"Method not allowed\"]);\r\n    exit();\r\n}\r\n\r\n$host = '127.0.0.1';\r\n$db   = 'ethans_cafe';\r\n$user = 'root';\r\n$pass = '';\r\n\r\ntry {\r\n    $pdo = new PDO(\"mysql:host=$host;dbname=$db;charset=utf8\", $user, $pass);\r\n    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);\r\n    $pdo->setAttribute(PDO::ATTR_EMULATE_PREPARES, false);\r\n} catch (Exception $e) {\r\n    http_response_code(500);\r\n    echo json_encode([\"error\" => \"Database connection failed\"]);\r\n    exit();\r\n}\r\n\r\n$data = json_decode(file_get_contents(\"php://input\"), true);\r\n\r\nif (!is_array($data)) {\r\n    http_response_code(400);\r\n    echo json_encode([\"error\" => \"Invalid JSON\"]);\r\n    exit();\r\n}\r\n\r\n$fullName  = trim($data['full_name'] ?? '');\r\n$username  = trim($data['username'] ?? '');\r\n$password  = trim($data['password'] ?? '');\r\n$roleId    = intval($data['requested_role_id'] ?? 0);\r\n\r\n// Validate required fields\r\nif (empty($fullName) || empty($username) || empty($password) || !$roleId) {\r\n    http_response_code(400);\r\n    echo json_encode([\"error\" => \"Please fill in all required fields\"]);\r\n    exit();\r\n}\r\n\r\n// Validate lengths\r\nif (strlen($username) > 100 || strlen($fullName) > 255) {\r\n    http_response_code(400);\r\n    echo json_encode([\"error\" => \"Input too long\"]);\r\n    exit();\r\n}\r\n\r\n// Validate username format\r\nif (!preg_match('/^[a-zA-Z0-9_]+$/', $username)) {\r\n    http_response_code(400);\r\n    echo json_encode([\"error\" => \"Invalid username format. Only letters, numbers, and underscores allowed.\"]);\r\n    exit();\r\n}\r\n\r\n// Validate password length\r\nif (strlen($password) < 6) {\r\n    http_response_code(400);\r\n    echo json_encode([\"error\" => \"Password must be at least 6 characters\"]);\r\n    exit();\r\n}\r\n\r\n// Check username uniqueness in users table\r\n$stmt = $pdo->prepare(\"SELECT id FROM users WHERE username = ? LIMIT 1\");\r\n$stmt->execute([$username]);\r\nif ($stmt->fetch()) {\r\n    http_response_code(409);\r\n    echo json_encode([\"error\" => \"Username already exists. Please choose a different username.\"]);\r\n    exit();\r\n}\r\n\r\n// Check username uniqueness in account_requests table\r\n$stmt = $pdo->prepare(\"SELECT id FROM account_requests WHERE username = ? AND status = 'Pending' LIMIT 1\");\r\n$stmt->execute([$username]);\r\nif ($stmt->fetch()) {\r\n    http_response_code(409);\r\n    echo json_encode([\"error\" => \"A pending request with this username already exists.\"]);\r\n    exit();\r\n}\r\n\r\n// Validate role exists and is not admin\r\n$stmt = $pdo->prepare(\"SELECT id, name FROM roles WHERE id = ? LIMIT 1\");\r\n$stmt->execute([$roleId]);\r\n$role = $stmt->fetch(PDO::FETCH_ASSOC);\r\nif (!$role || strtolower($role['name']) === 'admin') {\r\n    http_response_code(403);\r\n    echo json_encode([\"error\" => \"Invalid or unauthorized role requested.\"]);\r\n    exit();\r\n}\r\n\r\n// Hash password\r\n$passwordHash = password_hash($password, PASSWORD_BCRYPT);\r\n\r\n// Insert account request\r\n$stmt = $pdo->prepare(\"\r\n    INSERT INTO account_requests (full_name, username, password_hash, requested_role_id, status, requested_at)\r\n    VALUES (?, ?, ?, ?, 'Pending', NOW())\r\n\");\r\n$stmt->execute([$fullName, $username, $passwordHash, $roleId]);\r\n\r\necho json_encode([\"success\" => true, \"message\" => \"Account request submitted successfully.\"]);"
        }
    ]
}