{
    "sourceFile": "codes/php/notifications.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1772359264555,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1772359264555,
            "name": "Commit-0",
            "content": "<?php\r\n/**\r\n * Notifications API\r\n * Handles CRUD operations for notifications table\r\n */\r\n\r\nheader(\"Access-Control-Allow-Origin: *\");\r\nheader(\"Content-Type: application/json\");\r\nheader(\"Access-Control-Allow-Methods: POST, GET, PUT, DELETE\");\r\nheader(\"Access-Control-Allow-Headers: Content-Type\");\r\n\r\nrequire_once 'supabase-api.php';\r\n\r\n$method = $_SERVER['REQUEST_METHOD'];\r\n$data = json_decode(file_get_contents(\"php://input\"), true) ?: [];\r\n\r\nswitch ($method) {\r\n    case 'GET':\r\n        getNotifications();\r\n        break;\r\n    case 'POST':\r\n        createNotification($data);\r\n        break;\r\n    case 'PUT':\r\n        markAsRead($data);\r\n        break;\r\n    case 'DELETE':\r\n        deleteNotification($data);\r\n        break;\r\n    default:\r\n        http_response_code(405);\r\n        echo json_encode(['error' => 'Method not allowed']);\r\n}\r\n\r\nfunction getNotifications() {\r\n    global $supabase;\r\n    \r\n    $unreadOnly = isset($_GET['unread']) && $_GET['unread'] === 'true';\r\n    $limit = isset($_GET['limit']) ? intval($_GET['limit']) : 50;\r\n    \r\n    $filters = ['order' => 'created_at.desc', 'limit' => $limit];\r\n    \r\n    if ($unreadOnly) {\r\n        $filters['is_read'] = 'eq.false';\r\n    }\r\n    \r\n    $result = $supabase->select('notifications', $filters);\r\n    \r\n    if (isset($result['error'])) {\r\n        http_response_code(400);\r\n        echo json_encode($result);\r\n        return;\r\n    }\r\n    \r\n    // Get user names for each notification\r\n    $users = $supabase->select('users', ['select' => 'id,full_name,username']);\r\n    $userMap = [];\r\n    if (is_array($users) && !isset($users['error'])) {\r\n        foreach ($users as $user) {\r\n            $userMap[$user['id']] = $user['full_name'] ?? $user['username'];\r\n        }\r\n    }\r\n    \r\n    // Attach user names to notifications\r\n    foreach ($result as &$notification) {\r\n        $notification['user_name'] = $userMap[$notification['user_id']] ?? 'Unknown User';\r\n    }\r\n    \r\n    echo json_encode(['success' => true, 'notifications' => $result]);\r\n}\r\n\r\nfunction createNotification($data) {\r\n    global $supabase;\r\n    \r\n    $required = ['user_id', 'action_type', 'target_table', 'description'];\r\n    foreach ($required as $field) {\r\n        if (empty($data[$field])) {\r\n            http_response_code(400);\r\n            echo json_encode(['error' => \"Missing required field: $field\"]);\r\n            return;\r\n        }\r\n    }\r\n    \r\n    $notification = [\r\n        'user_id' => intval($data['user_id']),\r\n        'action_type' => $data['action_type'],\r\n        'target_table' => $data['target_table'],\r\n        'target_id' => $data['target_id'] ?? null,\r\n        'description' => $data['description'],\r\n        'reason' => $data['reason'] ?? null,\r\n        'is_read' => false,\r\n        'created_at' => date('Y-m-d H:i:s')\r\n    ];\r\n    \r\n    $result = $supabase->insert('notifications', $notification);\r\n    \r\n    if (isset($result['error'])) {\r\n        http_response_code(400);\r\n        echo json_encode($result);\r\n        return;\r\n    }\r\n    \r\n    echo json_encode(['success' => true, 'data' => $result]);\r\n}\r\n\r\nfunction markAsRead($data) {\r\n    global $supabase;\r\n    \r\n    if (isset($data['mark_all'])) {\r\n        // Mark all as read\r\n        $notifications = $supabase->select('notifications', ['is_read' => 'eq.false']);\r\n        if (is_array($notifications) && !isset($notifications['error'])) {\r\n            foreach ($notifications as $n) {\r\n                $supabase->update('notifications', ['is_read' => true], ['id' => 'eq.' . $n['id']]);\r\n            }\r\n        }\r\n        echo json_encode(['success' => true, 'message' => 'All notifications marked as read']);\r\n        return;\r\n    }\r\n    \r\n    if (empty($data['id'])) {\r\n        http_response_code(400);\r\n        echo json_encode(['error' => 'Missing notification id']);\r\n        return;\r\n    }\r\n    \r\n    $result = $supabase->update('notifications', ['is_read' => true], ['id' => 'eq.' . $data['id']]);\r\n    \r\n    if (isset($result['error'])) {\r\n        http_response_code(400);\r\n        echo json_encode($result);\r\n        return;\r\n    }\r\n    \r\n    echo json_encode(['success' => true]);\r\n}\r\n\r\nfunction deleteNotification($data) {\r\n    global $supabase;\r\n    \r\n    if (empty($data['id'])) {\r\n        http_response_code(400);\r\n        echo json_encode(['error' => 'Missing notification id']);\r\n        return;\r\n    }\r\n    \r\n    $result = $supabase->delete('notifications', ['id' => 'eq.' . $data['id']]);\r\n    \r\n    if (isset($result['error'])) {\r\n        http_response_code(400);\r\n        echo json_encode($result);\r\n        return;\r\n    }\r\n    \r\n    echo json_encode(['success' => true]);\r\n}\r\n\r\n// Function to get count of unread notifications\r\nfunction getUnreadCount() {\r\n    global $supabase;\r\n    \r\n    $result = $supabase->select('notifications', ['is_read' => 'eq.false', 'select' => 'id']);\r\n    \r\n    if (isset($result['error'])) {\r\n        return 0;\r\n    }\r\n    \r\n    return count($result);\r\n}\r\n\r\n// Get active users (from user_sessions)\r\nfunction getActiveUsers() {\r\n    global $supabase;\r\n    \r\n    $sessions = $supabase->select('user_sessions', [\r\n        'is_active' => 'eq.true',\r\n        'select' => 'id,user_id,ip_address,user_agent,created_at,last_activity'\r\n    ]);\r\n    \r\n    if (isset($sessions['error']) || !is_array($sessions)) {\r\n        return [];\r\n    }\r\n    \r\n    // Filter out expired sessions\r\n    $activeSessions = array_filter($sessions, function($s) {\r\n        $expiresAt = strtotime($s['expires_at'] ?? '+1 hour');\r\n        return $expiresAt > time();\r\n    });\r\n    \r\n    // Get user details\r\n    $users = $supabase->select('users', ['select' => 'id,full_name,username,role_id']);\r\n    $userMap = [];\r\n    if (is_array($users) && !isset($users['error'])) {\r\n        foreach ($users as $user) {\r\n            $userMap[$user['id']] = $user;\r\n        }\r\n    }\r\n    \r\n    // Get roles\r\n    $roles = $supabase->select('roles', ['select' => 'id,name']);\r\n    $roleMap = [];\r\n    if (is_array($roles) && !isset($roles['error'])) {\r\n        foreach ($roles as $role) {\r\n            $roleMap[$role['id']] = $role['name'];\r\n        }\r\n    }\r\n    \r\n    // Combine data\r\n    $result = [];\r\n    foreach ($activeSessions as $session) {\r\n        $user = $userMap[$session['user_id']] ?? null;\r\n        if ($user) {\r\n            $result[] = [\r\n                'session_id' => $session['id'],\r\n                'user_id' => $session['user_id'],\r\n                'full_name' => $user['full_name'],\r\n                'username' => $user['username'],\r\n                'role' => $roleMap[$user['role_id']] ?? 'Unknown',\r\n                'ip_address' => $session['ip_address'],\r\n                'user_agent' => $session['user_agent'],\r\n                'login_time' => $session['created_at'],\r\n                'last_activity' => $session['last_activity']\r\n            ];\r\n        }\r\n    }\r\n    \r\n    return $result;\r\n}\r\n\r\n// Handle special endpoints\r\nif (isset($_GET['action'])) {\r\n    switch ($_GET['action']) {\r\n        case 'unread_count':\r\n            echo json_encode(['count' => getUnreadCount()]);\r\n            exit;\r\n        case 'active_users':\r\n            echo json_encode(['success' => true, 'users' => getActiveUsers()]);\r\n            exit;\r\n    }\r\n}\r\n"
        }
    ]
}