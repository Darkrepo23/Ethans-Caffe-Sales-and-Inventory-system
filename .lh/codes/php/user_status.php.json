{
    "sourceFile": "codes/php/user_status.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1771858078929,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1771858078929,
            "name": "Commit-0",
            "content": "<?php\r\n// User Status Management - Track active/inactive status of users\r\n\r\n// Start session if not already started\r\nif (session_status() === PHP_SESSION_NONE) {\r\n    session_start();\r\n}\r\n\r\n// Set header for JSON response\r\nheader('Content-Type: application/json');\r\n\r\n// Include Supabase API helper\r\nrequire_once 'supabase-api.php';\r\n\r\n// Initialize Supabase database\r\n$usersDB = new SupabaseDB('users');\r\n\r\n// Get request method\r\n$method = $_SERVER['REQUEST_METHOD'];\r\n$input = json_decode(file_get_contents('php://input'), true) ?? [];\r\n\r\ntry {\r\n    if ($method === 'GET') {\r\n        // Fetch all users with their status\r\n        $table = $_GET['table'] ?? 'users';\r\n        \r\n        // Only allow fetching users table\r\n        if ($table !== 'users') {\r\n            http_response_code(403);\r\n            echo json_encode(['error' => 'Forbidden']);\r\n            exit;\r\n        }\r\n\r\n        // Check if user is logged in\r\n        if (!isset($_SESSION['user_id'])) {\r\n            http_response_code(401);\r\n            echo json_encode(['error' => 'Unauthorized']);\r\n            exit;\r\n        }\r\n\r\n        // Get all users with selected fields\r\n        $users = $usersDB->select(['id', 'username', 'full_name', 'status', 'last_login', 'updated_at']);\r\n        \r\n        if ($users === null) {\r\n            http_response_code(500);\r\n            echo json_encode(['error' => 'Failed to fetch users']);\r\n            exit;\r\n        }\r\n\r\n        http_response_code(200);\r\n        echo json_encode($users);\r\n        exit;\r\n\r\n    } elseif ($method === 'POST' || $method === 'PUT') {\r\n        // Update user status (active/inactive)\r\n        \r\n        if (!isset($_SESSION['user_id'])) {\r\n            http_response_code(401);\r\n            echo json_encode(['error' => 'Unauthorized']);\r\n            exit;\r\n        }\r\n\r\n        // Get user ID and new status from request\r\n        $userId = $input['user_id'] ?? null;\r\n        $status = $input['status'] ?? null;\r\n\r\n        if (!$userId || !$status) {\r\n            http_response_code(400);\r\n            echo json_encode(['error' => 'Missing user_id or status']);\r\n            exit;\r\n        }\r\n\r\n        // Validate status value\r\n        if (!in_array($status, ['active', 'inactive'])) {\r\n            http_response_code(400);\r\n            echo json_encode(['error' => 'Invalid status. Must be \"active\" or \"inactive\"']);\r\n            exit;\r\n        }\r\n\r\n        // Get current timestamp\r\n        $now = date('Y-m-d H:i:s');\r\n\r\n        // Update user status\r\n        $updateData = [\r\n            'id' => $userId,\r\n            'status' => $status,\r\n            'updated_at' => $now\r\n        ];\r\n\r\n        // If marking as active, also update last_login\r\n        if ($status === 'active') {\r\n            $updateData['last_login'] = $now;\r\n        }\r\n\r\n        $result = $usersDB->edit($updateData);\r\n\r\n        if ($result === null || (isset($result['error']) && $result['error'])) {\r\n            http_response_code(500);\r\n            echo json_encode(['error' => 'Failed to update user status']);\r\n            exit;\r\n        }\r\n\r\n        http_response_code(200);\r\n        echo json_encode([\r\n            'success' => true,\r\n            'message' => \"User status updated to {$status}\",\r\n            'user_id' => $userId,\r\n            'status' => $status,\r\n            'timestamp' => $now\r\n        ]);\r\n        exit;\r\n\r\n    } else {\r\n        http_response_code(405);\r\n        echo json_encode(['error' => 'Method not allowed']);\r\n        exit;\r\n    }\r\n\r\n} catch (Exception $e) {\r\n    http_response_code(500);\r\n    echo json_encode([\r\n        'error' => 'Server error',\r\n        'message' => $e->getMessage()\r\n    ]);\r\n    exit;\r\n}\r\n?>\r\n"
        }
    ]
}