{
    "sourceFile": "codes/php/update_profile.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1772359265027,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1772372631926,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,9 +15,11 @@\n $data = json_decode(file_get_contents('php://input'), true);\r\n \r\n $userId = $data['user_id'] ?? null;\r\n $fullName = trim($data['full_name'] ?? '');\r\n+$username = trim($data['username'] ?? '');\r\n $email = trim($data['email'] ?? '');\r\n+$phone = trim($data['phone'] ?? '');\r\n \r\n // Validation\r\n if (!$userId) {\r\n     echo json_encode(['error' => 'User ID is required']);\r\n@@ -28,25 +30,66 @@\n     echo json_encode(['error' => 'Full name is required']);\r\n     exit;\r\n }\r\n \r\n+if (empty($username)) {\r\n+    echo json_encode(['error' => 'Username is required']);\r\n+    exit;\r\n+}\r\n+\r\n+// Validate username format (alphanumeric, underscores, 3-30 chars)\r\n+if (!preg_match('/^[a-zA-Z0-9_]{3,30}$/', $username)) {\r\n+    echo json_encode(['error' => 'Username must be 3-30 characters (letters, numbers, underscores only)']);\r\n+    exit;\r\n+}\r\n+\r\n // Validate email format if provided\r\n if (!empty($email) && !filter_var($email, FILTER_VALIDATE_EMAIL)) {\r\n     echo json_encode(['error' => 'Invalid email format']);\r\n     exit;\r\n }\r\n \r\n try {\r\n+    // Check if username is already taken by another user\r\n+    $existingUser = $supabase->select('users', [\r\n+        'username' => 'eq.' . $username,\r\n+        'id' => 'neq.' . $userId\r\n+    ]);\r\n+    \r\n+    if (!empty($existingUser) && !isset($existingUser['error'])) {\r\n+        echo json_encode(['error' => 'Username is already taken']);\r\n+        exit;\r\n+    }\r\n+    \r\n+    // Check if email is already taken by another user (if email provided)\r\n+    if (!empty($email)) {\r\n+        $existingEmail = $supabase->select('users', [\r\n+            'email' => 'eq.' . $email,\r\n+            'id' => 'neq.' . $userId\r\n+        ]);\r\n+        \r\n+        if (!empty($existingEmail) && !isset($existingEmail['error'])) {\r\n+            echo json_encode(['error' => 'Email is already registered to another account']);\r\n+            exit;\r\n+        }\r\n+    }\r\n+    \r\n     // Build update data\r\n     $updateData = [\r\n         'full_name' => $fullName,\r\n+        'username' => $username,\r\n         'updated_at' => date('Y-m-d H:i:s')\r\n     ];\r\n     \r\n     if (!empty($email)) {\r\n         $updateData['email'] = $email;\r\n     }\r\n     \r\n+    // Phone column may not exist in older databases, so we try to add it\r\n+    if (!empty($phone)) {\r\n+        $updateData['phone'] = $phone;\r\n+    }\r\n+    \r\n     // Update user profile\r\n     $result = $supabase->update('users', $updateData, ['id' => 'eq.' . $userId]);\r\n     \r\n     if (isset($result['error'])) {\r\n"
                }
            ],
            "date": 1772359265027,
            "name": "Commit-0",
            "content": "<?php\r\nheader(\"Access-Control-Allow-Origin: *\");\r\nheader(\"Content-Type: application/json\");\r\nheader(\"Access-Control-Allow-Methods: POST\");\r\nheader(\"Access-Control-Allow-Headers: Content-Type\");\r\n\r\nrequire_once 'supabase-api.php';\r\n\r\n// Only accept POST\r\nif ($_SERVER['REQUEST_METHOD'] !== 'POST') {\r\n    echo json_encode(['error' => 'Method not allowed']);\r\n    exit;\r\n}\r\n\r\n$data = json_decode(file_get_contents('php://input'), true);\r\n\r\n$userId = $data['user_id'] ?? null;\r\n$fullName = trim($data['full_name'] ?? '');\r\n$email = trim($data['email'] ?? '');\r\n\r\n// Validation\r\nif (!$userId) {\r\n    echo json_encode(['error' => 'User ID is required']);\r\n    exit;\r\n}\r\n\r\nif (empty($fullName)) {\r\n    echo json_encode(['error' => 'Full name is required']);\r\n    exit;\r\n}\r\n\r\n// Validate email format if provided\r\nif (!empty($email) && !filter_var($email, FILTER_VALIDATE_EMAIL)) {\r\n    echo json_encode(['error' => 'Invalid email format']);\r\n    exit;\r\n}\r\n\r\ntry {\r\n    // Build update data\r\n    $updateData = [\r\n        'full_name' => $fullName,\r\n        'updated_at' => date('Y-m-d H:i:s')\r\n    ];\r\n    \r\n    if (!empty($email)) {\r\n        $updateData['email'] = $email;\r\n    }\r\n    \r\n    // Update user profile\r\n    $result = $supabase->update('users', $updateData, ['id' => 'eq.' . $userId]);\r\n    \r\n    if (isset($result['error'])) {\r\n        echo json_encode(['error' => 'Failed to update profile: ' . $result['error']]);\r\n        exit;\r\n    }\r\n    \r\n    // Fetch updated user data to return\r\n    $updatedUser = $supabase->select('users', ['id' => 'eq.' . $userId]);\r\n    \r\n    if (!empty($updatedUser) && !isset($updatedUser['error'])) {\r\n        echo json_encode([\r\n            'success' => true, \r\n            'message' => 'Profile updated successfully',\r\n            'user' => $updatedUser[0]\r\n        ]);\r\n    } else {\r\n        echo json_encode(['success' => true, 'message' => 'Profile updated successfully']);\r\n    }\r\n    \r\n} catch (Exception $e) {\r\n    echo json_encode(['error' => 'Server error: ' . $e->getMessage()]);\r\n}\r\n?>\r\n"
        }
    ]
}