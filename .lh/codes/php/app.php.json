{
    "sourceFile": "codes/php/app.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 28,
            "patches": [
                {
                    "date": 1771488043962,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1771488247595,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,4 +1,5 @@\n+\r\n <?php\r\n // CORS Headers\r\n header(\"Access-Control-Allow-Origin: *\");\r\n header(\"Content-Type: application/json\");\r\n@@ -18,64 +19,89 @@\n \r\n $method = $_SERVER['REQUEST_METHOD'];\r\n $data = json_decode(file_get_contents(\"php://input\"), true) ?: [];\r\n \r\n-// Table and allowed columns (example: roles)\r\n-$TABLE = 'roles';\r\n-$COLUMNS = ['id', 'name', 'permissions'];\r\n+// Table whitelist and columns\r\n+$TABLES = [\r\n+\t'roles' => ['id', 'name', 'permissions'],\r\n+\t'users' => ['id', 'full_name', 'username', 'password_hash', 'role_id', 'status', 'last_login', 'created_at', 'updated_at', 'deleted_at'],\r\n+\t'account_requests' => ['id', 'full_name', 'username', 'password_hash', 'requested_role_id', 'status', 'requested_at', 'reviewed_by', 'reviewed_at', 'notes'],\r\n+\t'menu_categories' => ['id', 'name', 'description'],\r\n+\t'menu_items' => ['id', 'name', 'category_id', 'description', 'price_reference', 'status', 'image_path', 'created_at', 'updated_at'],\r\n+\t'ingredient_categories' => ['id', 'name'],\r\n+\t'units' => ['id', 'name'],\r\n+\t'ingredients' => ['id', 'name', 'category_id', 'unit_id', 'current_quantity', 'low_stock_threshold', 'status', 'created_at', 'updated_at'],\r\n+\t'recipes' => ['id', 'menu_item_id', 'ingredient_id', 'qty_per_sale', 'unit_id'],\r\n+\t'sales' => ['id', 'receipt_no', 'sale_datetime', 'staff_id', 'total_items', 'notes', 'created_at'],\r\n+\t'sale_items' => ['id', 'sale_id', 'menu_item_id', 'quantity'],\r\n+\t'inventory_transactions' => ['id', 'ingredient_id', 'change_qty', 'transaction_type', 'reason', 'performed_by', 'prev_qty', 'new_qty', 'timestamp'],\r\n+\t'activity_logs' => ['id', 'user_id', 'role_label', 'action', 'reference', 'status', 'ip_address', 'created_at'],\r\n+\t'requests_tbl' => ['id', 'type', 'requester_id', 'target_id', 'payload', 'status', 'created_at', 'handled_by', 'handled_at'],\r\n+\t'backups' => ['id', 'name', 'type', 'file_path', 'created_at', 'size'],\r\n+\t'system_settings' => ['key', 'value', 'updated_at'],\r\n+\t'temporary_account_log' => ['id', 'activated_by', 'activated_at', 'deactivated_at', 'note']\r\n+];\r\n \r\n+// Get table name from query string or body\r\n+$table = $_GET['table'] ?? $data['table'] ?? null;\r\n+if (!$table || !isset($TABLES[$table])) {\r\n+\techo json_encode([\"error\" => \"Invalid or missing table name\"]); exit;\r\n+}\r\n+$COLUMNS = $TABLES[$table];\r\n+\r\n switch($method) {\r\n \tcase 'POST':\r\n \t\t$filtered = array_intersect_key($data, array_flip($COLUMNS));\r\n \t\t$keys = implode(', ', array_keys($filtered));\r\n \t\t$placeholders = implode(', ', array_fill(0, count($filtered), '?'));\r\n-\t\t$stmt = $pdo->prepare(\"INSERT INTO $TABLE ($keys) VALUES ($placeholders)\");\r\n+\t\t$stmt = $pdo->prepare(\"INSERT INTO `$table` ($keys) VALUES ($placeholders)\");\r\n \t\t$stmt->execute(array_values($filtered));\r\n \t\techo json_encode([\"message\" => \"Added successfully\", \"id\" => $pdo->lastInsertId()]);\r\n \t\tbreak;\r\n \tcase 'GET':\r\n-\t\t$sql = \"SELECT * FROM $TABLE\";\r\n+\t\t$sql = \"SELECT * FROM `$table`\";\r\n \t\t// Optional: filter by query string\r\n-\t\tif (!empty($_GET)) {\r\n-\t\t\t$filters = array_intersect_key($_GET, array_flip($COLUMNS));\r\n-\t\t\tif ($filters) {\r\n-\t\t\t\t$where = [];\r\n-\t\t\t\tforeach ($filters as $k => $v) {\r\n-\t\t\t\t\t$where[] = \"$k = :$k\";\r\n-\t\t\t\t}\r\n-\t\t\t\t$sql .= \" WHERE \" . implode(' AND ', $where);\r\n+\t\t$filters = array_intersect_key($_GET, array_flip($COLUMNS));\r\n+\t\tunset($filters['table']);\r\n+\t\tif ($filters) {\r\n+\t\t\t$where = [];\r\n+\t\t\tforeach ($filters as $k => $v) {\r\n+\t\t\t\t$where[] = \"$k = :$k\";\r\n \t\t\t}\r\n+\t\t\t$sql .= \" WHERE \" . implode(' AND ', $where);\r\n \t\t}\r\n \t\t$stmt = $pdo->prepare($sql);\r\n-\t\tif (!empty($filters)) {\r\n+\t\tif ($filters) {\r\n \t\t\tforeach ($filters as $k => $v) {\r\n \t\t\t\t$stmt->bindValue(\":$k\", $v);\r\n \t\t\t}\r\n \t\t}\r\n \t\t$stmt->execute();\r\n \t\techo json_encode($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n \t\tbreak;\r\n \tcase 'PUT':\r\n-\t\tif (!isset($data['id'])) {\r\n-\t\t\techo json_encode([\"error\" => \"Missing id for update\"]); exit;\r\n+\t\tif (!isset($data['id']) && !isset($data['key'])) {\r\n+\t\t\techo json_encode([\"error\" => \"Missing id/key for update\"]); exit;\r\n \t\t}\r\n-\t\t$id = $data['id'];\r\n-\t\tunset($data['id']);\r\n+\t\t$idField = in_array('id', $COLUMNS) ? 'id' : 'key';\r\n+\t\t$id = $data[$idField];\r\n+\t\tunset($data[$idField]);\r\n \t\t$filtered = array_intersect_key($data, array_flip($COLUMNS));\r\n \t\t$set = [];\r\n \t\tforeach ($filtered as $k => $v) {\r\n \t\t\t$set[] = \"$k = ?\";\r\n \t\t}\r\n-\t\t$stmt = $pdo->prepare(\"UPDATE $TABLE SET \".implode(', ', $set).\" WHERE id = ?\");\r\n+\t\t$stmt = $pdo->prepare(\"UPDATE `$table` SET \".implode(', ', $set).\" WHERE $idField = ?\");\r\n \t\t$stmt->execute(array_merge(array_values($filtered), [$id]));\r\n \t\techo json_encode([\"message\" => \"Updated successfully\"]);\r\n \t\tbreak;\r\n \tcase 'DELETE':\r\n-\t\tif (!isset($data['id'])) {\r\n-\t\t\techo json_encode([\"error\" => \"Missing id for delete\"]); exit;\r\n+\t\t$idField = in_array('id', $COLUMNS) ? 'id' : 'key';\r\n+\t\tif (!isset($data[$idField])) {\r\n+\t\t\techo json_encode([\"error\" => \"Missing id/key for delete\"]); exit;\r\n \t\t}\r\n-\t\t$stmt = $pdo->prepare(\"DELETE FROM $TABLE WHERE id = ?\");\r\n-\t\t$stmt->execute([$data['id']]);\r\n+\t\t$stmt = $pdo->prepare(\"DELETE FROM `$table` WHERE $idField = ?\");\r\n+\t\t$stmt->execute([$data[$idField]]);\r\n \t\techo json_encode([\"message\" => \"Deleted successfully\"]);\r\n \t\tbreak;\r\n \tdefault:\r\n \t\techo json_encode([\"error\" => \"Unsupported method\"]);\r\n"
                },
                {
                    "date": 1771488853553,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -50,8 +50,12 @@\n \r\n switch($method) {\r\n \tcase 'POST':\r\n \t\t$filtered = array_intersect_key($data, array_flip($COLUMNS));\r\n+\t\t// Hash password for users and account_requests\r\n+\t\tif (($table === 'users' || $table === 'account_requests') && isset($filtered['password_hash'])) {\r\n+\t\t\t$filtered['password_hash'] = password_hash($filtered['password_hash'], PASSWORD_DEFAULT);\r\n+\t\t}\r\n \t\t$keys = implode(', ', array_keys($filtered));\r\n \t\t$placeholders = implode(', ', array_fill(0, count($filtered), '?'));\r\n \t\t$stmt = $pdo->prepare(\"INSERT INTO `$table` ($keys) VALUES ($placeholders)\");\r\n \t\t$stmt->execute(array_values($filtered));\r\n@@ -85,8 +89,12 @@\n \t\t$idField = in_array('id', $COLUMNS) ? 'id' : 'key';\r\n \t\t$id = $data[$idField];\r\n \t\tunset($data[$idField]);\r\n \t\t$filtered = array_intersect_key($data, array_flip($COLUMNS));\r\n+\t\t// Hash password for users and account_requests\r\n+\t\tif (($table === 'users' || $table === 'account_requests') && isset($filtered['password_hash'])) {\r\n+\t\t\t$filtered['password_hash'] = password_hash($filtered['password_hash'], PASSWORD_DEFAULT);\r\n+\t\t}\r\n \t\t$set = [];\r\n \t\tforeach ($filtered as $k => $v) {\r\n \t\t\t$set[] = \"$k = ?\";\r\n \t\t}\r\n"
                },
                {
                    "date": 1771489135876,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,9 +6,9 @@\n header(\"Access-Control-Allow-Methods: POST, GET, PUT, DELETE\");\r\n header(\"Access-Control-Allow-Headers: Content-Type\");\r\n \r\n $host = '127.0.0.1';\r\n-$db   = 'brew-cave_db';\r\n+$db   = '';\r\n $user = 'root';\r\n $pass = '';\r\n \r\n try {\r\n"
                },
                {
                    "date": 1771489141437,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,9 +6,9 @@\n header(\"Access-Control-Allow-Methods: POST, GET, PUT, DELETE\");\r\n header(\"Access-Control-Allow-Headers: Content-Type\");\r\n \r\n $host = '127.0.0.1';\r\n-$db   = '';\r\n+$db   = 'cafe_db';\r\n $user = 'root';\r\n $pass = '';\r\n \r\n try {\r\n"
                },
                {
                    "date": 1771489146954,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,9 +6,9 @@\n header(\"Access-Control-Allow-Methods: POST, GET, PUT, DELETE\");\r\n header(\"Access-Control-Allow-Headers: Content-Type\");\r\n \r\n $host = '127.0.0.1';\r\n-$db   = 'cafe_db';\r\n+$db   = 'ethans';\r\n $user = 'root';\r\n $pass = '';\r\n \r\n try {\r\n"
                },
                {
                    "date": 1771489155656,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,9 +6,9 @@\n header(\"Access-Control-Allow-Methods: POST, GET, PUT, DELETE\");\r\n header(\"Access-Control-Allow-Headers: Content-Type\");\r\n \r\n $host = '127.0.0.1';\r\n-$db   = 'ethans';\r\n+$db   = 'ethans_cafe';\r\n $user = 'root';\r\n $pass = '';\r\n \r\n try {\r\n"
                },
                {
                    "date": 1771489579077,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,9 +8,16 @@\n \r\n $host = '127.0.0.1';\r\n $db   = 'ethans_cafe';\r\n $user = 'root';\r\n-$pass = '';\r\n+$pass = '';<?php\r\n+$origin = $_SERVER['HTTP_ORIGIN'] ?? '';\r\n+if ($origin === 'http://127.0.0.1:5500' || $origin === 'http://localhost:5500') {\r\n+    header(\"Access-Control-Allow-Origin: $origin\");\r\n+}\r\n+header(\"Access-Control-Allow-Credentials: true\");\r\n+header(\"Access-Control-Allow-Methods: POST, GET, PUT, DELETE, OPTIONS\");\r\n+header(\"Access-Control-Allow-Headers: Content-Type\");\r\n \r\n try {\r\n \t$pdo = new PDO(\"mysql:host=$host;dbname=$db;charset=utf8mb4\", $user, $pass);\r\n } catch (Exception $e) {\r\n"
                },
                {
                    "date": 1771489588477,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,18 +6,11 @@\n header(\"Access-Control-Allow-Methods: POST, GET, PUT, DELETE\");\r\n header(\"Access-Control-Allow-Headers: Content-Type\");\r\n \r\n $host = '127.0.0.1';\r\n-$db   = 'ethans_cafe';\r\n+$db   = 'cafe_db';\r\n $user = 'root';\r\n-$pass = '';<?php\r\n-$origin = $_SERVER['HTTP_ORIGIN'] ?? '';\r\n-if ($origin === 'http://127.0.0.1:5500' || $origin === 'http://localhost:5500') {\r\n-    header(\"Access-Control-Allow-Origin: $origin\");\r\n-}\r\n-header(\"Access-Control-Allow-Credentials: true\");\r\n-header(\"Access-Control-Allow-Methods: POST, GET, PUT, DELETE, OPTIONS\");\r\n-header(\"Access-Control-Allow-Headers: Content-Type\");\r\n+$pass = '';\r\n \r\n try {\r\n \t$pdo = new PDO(\"mysql:host=$host;dbname=$db;charset=utf8mb4\", $user, $pass);\r\n } catch (Exception $e) {\r\n"
                },
                {
                    "date": 1771489596200,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,9 +6,9 @@\n header(\"Access-Control-Allow-Methods: POST, GET, PUT, DELETE\");\r\n header(\"Access-Control-Allow-Headers: Content-Type\");\r\n \r\n $host = '127.0.0.1';\r\n-$db   = 'cafe_db';\r\n+$db   = '';\r\n $user = 'root';\r\n $pass = '';\r\n \r\n try {\r\n"
                },
                {
                    "date": 1771489683890,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,14 +1,27 @@\n \r\n <?php\r\n-// CORS Headers\r\n-header(\"Access-Control-Allow-Origin: *\");\r\n+// Dynamic CORS Headers\r\n+$origin = $_SERVER['HTTP_ORIGIN'] ?? '';\r\n+if (\r\n+\t$origin === 'http://127.0.0.1:5500' ||\r\n+\t$origin === 'http://localhost:5500'\r\n+) {\r\n+\theader(\"Access-Control-Allow-Origin: $origin\");\r\n+}\r\n+header(\"Access-Control-Allow-Credentials: true\");\r\n+header(\"Access-Control-Allow-Methods: POST, GET, PUT, DELETE, OPTIONS\");\r\n+header(\"Access-Control-Allow-Headers: Content-Type\");\r\n header(\"Content-Type: application/json\");\r\n-header(\"Access-Control-Allow-Methods: POST, GET, PUT, DELETE\");\r\n-header(\"Access-Control-Allow-Headers: Content-Type\");\r\n \r\n+// Handle preflight OPTIONS request\r\n+if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {\r\n+\thttp_response_code(200);\r\n+\texit();\r\n+}\r\n+\r\n $host = '127.0.0.1';\r\n-$db   = '';\r\n+$db   = 'ethans_cafe';\r\n $user = 'root';\r\n $pass = '';\r\n \r\n try {\r\n"
                },
                {
                    "date": 1771489689696,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,4 @@\n-\r\n <?php\r\n // Dynamic CORS Headers\r\n $origin = $_SERVER['HTTP_ORIGIN'] ?? '';\r\n if (\r\n"
                },
                {
                    "date": 1771489742488,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,26 +1,14 @@\n+\r\n <?php\r\n-// Dynamic CORS Headers\r\n-$origin = $_SERVER['HTTP_ORIGIN'] ?? '';\r\n-if (\r\n-\t$origin === 'http://127.0.0.1:5500' ||\r\n-\t$origin === 'http://localhost:5500'\r\n-) {\r\n-\theader(\"Access-Control-Allow-Origin: $origin\");\r\n-}\r\n-header(\"Access-Control-Allow-Credentials: true\");\r\n-header(\"Access-Control-Allow-Methods: POST, GET, PUT, DELETE, OPTIONS\");\r\n+// CORS Headers\r\n+header(\"Access-Control-Allow-Origin: *\");\r\n+header(\"Content-Type: application/json\");\r\n+header(\"Access-Control-Allow-Methods: POST, GET, PUT, DELETE\");\r\n header(\"Access-Control-Allow-Headers: Content-Type\");\r\n-header(\"Content-Type: application/json\");\r\n \r\n-// Handle preflight OPTIONS request\r\n-if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {\r\n-\thttp_response_code(200);\r\n-\texit();\r\n-}\r\n-\r\n $host = '127.0.0.1';\r\n-$db   = 'ethans_cafe';\r\n+$db   = '';\r\n $user = 'root';\r\n $pass = '';\r\n \r\n try {\r\n"
                },
                {
                    "date": 1771489750282,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,9 +6,9 @@\n header(\"Access-Control-Allow-Methods: POST, GET, PUT, DELETE\");\r\n header(\"Access-Control-Allow-Headers: Content-Type\");\r\n \r\n $host = '127.0.0.1';\r\n-$db   = '';\r\n+$db   = 'ethans';\r\n $user = 'root';\r\n $pass = '';\r\n \r\n try {\r\n"
                },
                {
                    "date": 1771489939035,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,9 +6,9 @@\n header(\"Access-Control-Allow-Methods: POST, GET, PUT, DELETE\");\r\n header(\"Access-Control-Allow-Headers: Content-Type\");\r\n \r\n $host = '127.0.0.1';\r\n-$db   = 'ethans';\r\n+$db   = 'ethans_cafe';\r\n $user = 'root';\r\n $pass = '';\r\n \r\n try {\r\n"
                },
                {
                    "date": 1771489966158,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,4 @@\n-\r\n <?php\r\n // CORS Headers\r\n header(\"Access-Control-Allow-Origin: *\");\r\n header(\"Content-Type: application/json\");\r\n"
                },
                {
                    "date": 1771490047208,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,10 @@\n <?php\r\n+// Redirect to index.html if accessed directly (not via AJAX/API)\r\n+if (basename($_SERVER['PHP_SELF']) === 'app.php' && empty($_SERVER['HTTP_X_REQUESTED_WITH']) && (!isset($_SERVER['HTTP_ACCEPT']) || strpos($_SERVER['HTTP_ACCEPT'], 'application/json') === false)) {\r\n+\theader('Location: ../index.html');\r\n+\texit();\r\n+}\r\n // CORS Headers\r\n header(\"Access-Control-Allow-Origin: *\");\r\n header(\"Content-Type: application/json\");\r\n header(\"Access-Control-Allow-Methods: POST, GET, PUT, DELETE\");\r\n"
                },
                {
                    "date": 1771490545770,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,10 +1,18 @@\n <?php\r\n // Redirect to index.html if accessed directly (not via AJAX/API)\r\n+function log_php_error($msg) {\r\n+\t$logfile = __DIR__ . '/app_error.log';\r\n+\t$entry = date('Y-m-d H:i:s') . ' ' . $msg . \"\\n\";\r\n+\tfile_put_contents($logfile, $entry, FILE_APPEND);\r\n+}\r\n if (basename($_SERVER['PHP_SELF']) === 'app.php' && empty($_SERVER['HTTP_X_REQUESTED_WITH']) && (!isset($_SERVER['HTTP_ACCEPT']) || strpos($_SERVER['HTTP_ACCEPT'], 'application/json') === false)) {\r\n+\tlog_php_error('Redirected direct access to index.html: ' . json_encode($_SERVER));\r\n \theader('Location: ../index.html');\r\n \texit();\r\n }\r\n+// Log all incoming requests\r\n+log_php_error('Request: ' . $_SERVER['REQUEST_METHOD'] . ' ' . ($_GET['table'] ?? ($data['table'] ?? '')) . ' | Data: ' . json_encode($data));\r\n // CORS Headers\r\n header(\"Access-Control-Allow-Origin: *\");\r\n header(\"Content-Type: application/json\");\r\n header(\"Access-Control-Allow-Methods: POST, GET, PUT, DELETE\");\r\n@@ -17,8 +25,9 @@\n \r\n try {\r\n \t$pdo = new PDO(\"mysql:host=$host;dbname=$db;charset=utf8mb4\", $user, $pass);\r\n } catch (Exception $e) {\r\n+    log_php_error('DB Connection Error: ' . $e->getMessage());\r\n \tdie(json_encode([\"error\" => $e->getMessage()]));\r\n }\r\n \r\n $method = $_SERVER['REQUEST_METHOD'];\r\n@@ -60,11 +69,16 @@\n \t\t\t$filtered['password_hash'] = password_hash($filtered['password_hash'], PASSWORD_DEFAULT);\r\n \t\t}\r\n \t\t$keys = implode(', ', array_keys($filtered));\r\n \t\t$placeholders = implode(', ', array_fill(0, count($filtered), '?'));\r\n-\t\t$stmt = $pdo->prepare(\"INSERT INTO `$table` ($keys) VALUES ($placeholders)\");\r\n-\t\t$stmt->execute(array_values($filtered));\r\n-\t\techo json_encode([\"message\" => \"Added successfully\", \"id\" => $pdo->lastInsertId()]);\r\n+\t\ttry {\r\n+\t\t\t$stmt = $pdo->prepare(\"INSERT INTO `$table` ($keys) VALUES ($placeholders)\");\r\n+\t\t\t$stmt->execute(array_values($filtered));\r\n+\t\t\techo json_encode([\"message\" => \"Added successfully\", \"id\" => $pdo->lastInsertId()]);\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\tlog_php_error('POST error: ' . $e->getMessage() . ' | Data: ' . json_encode($filtered));\r\n+\t\t\techo json_encode([\"error\" => $e->getMessage()]);\r\n+\t\t}\r\n \t\tbreak;\r\n \tcase 'GET':\r\n \t\t$sql = \"SELECT * FROM `$table`\";\r\n \t\t// Optional: filter by query string\r\n@@ -76,16 +90,21 @@\n \t\t\t\t$where[] = \"$k = :$k\";\r\n \t\t\t}\r\n \t\t\t$sql .= \" WHERE \" . implode(' AND ', $where);\r\n \t\t}\r\n-\t\t$stmt = $pdo->prepare($sql);\r\n-\t\tif ($filters) {\r\n-\t\t\tforeach ($filters as $k => $v) {\r\n-\t\t\t\t$stmt->bindValue(\":$k\", $v);\r\n+\t\ttry {\r\n+\t\t\t$stmt = $pdo->prepare($sql);\r\n+\t\t\tif ($filters) {\r\n+\t\t\t\tforeach ($filters as $k => $v) {\r\n+\t\t\t\t\t$stmt->bindValue(\":$k\", $v);\r\n+\t\t\t\t}\r\n \t\t\t}\r\n+\t\t\t$stmt->execute();\r\n+\t\t\techo json_encode($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\tlog_php_error('GET error: ' . $e->getMessage() . ' | SQL: ' . $sql);\r\n+\t\t\techo json_encode([\"error\" => $e->getMessage()]);\r\n \t\t}\r\n-\t\t$stmt->execute();\r\n-\t\techo json_encode($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n \t\tbreak;\r\n \tcase 'PUT':\r\n \t\tif (!isset($data['id']) && !isset($data['key'])) {\r\n \t\t\techo json_encode([\"error\" => \"Missing id/key for update\"]); exit;\r\n@@ -101,21 +120,32 @@\n \t\t$set = [];\r\n \t\tforeach ($filtered as $k => $v) {\r\n \t\t\t$set[] = \"$k = ?\";\r\n \t\t}\r\n-\t\t$stmt = $pdo->prepare(\"UPDATE `$table` SET \".implode(', ', $set).\" WHERE $idField = ?\");\r\n-\t\t$stmt->execute(array_merge(array_values($filtered), [$id]));\r\n-\t\techo json_encode([\"message\" => \"Updated successfully\"]);\r\n+\t\ttry {\r\n+\t\t\t$stmt = $pdo->prepare(\"UPDATE `$table` SET \".implode(', ', $set).\" WHERE $idField = ?\");\r\n+\t\t\t$stmt->execute(array_merge(array_values($filtered), [$id]));\r\n+\t\t\techo json_encode([\"message\" => \"Updated successfully\"]);\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\tlog_php_error('PUT error: ' . $e->getMessage() . ' | Data: ' . json_encode($filtered));\r\n+\t\t\techo json_encode([\"error\" => $e->getMessage()]);\r\n+\t\t}\r\n \t\tbreak;\r\n \tcase 'DELETE':\r\n \t\t$idField = in_array('id', $COLUMNS) ? 'id' : 'key';\r\n \t\tif (!isset($data[$idField])) {\r\n \t\t\techo json_encode([\"error\" => \"Missing id/key for delete\"]); exit;\r\n \t\t}\r\n-\t\t$stmt = $pdo->prepare(\"DELETE FROM `$table` WHERE $idField = ?\");\r\n-\t\t$stmt->execute([$data[$idField]]);\r\n-\t\techo json_encode([\"message\" => \"Deleted successfully\"]);\r\n+\t\ttry {\r\n+\t\t\t$stmt = $pdo->prepare(\"DELETE FROM `$table` WHERE $idField = ?\");\r\n+\t\t\t$stmt->execute([$data[$idField]]);\r\n+\t\t\techo json_encode([\"message\" => \"Deleted successfully\"]);\r\n+\t\t} catch (Exception $e) {\r\n+\t\t\tlog_php_error('DELETE error: ' . $e->getMessage() . ' | ID: ' . $data[$idField]);\r\n+\t\t\techo json_encode([\"error\" => $e->getMessage()]);\r\n+\t\t}\r\n \t\tbreak;\r\n \tdefault:\r\n+\t\tlog_php_error('Unsupported method: ' . $method);\r\n \t\techo json_encode([\"error\" => \"Unsupported method\"]);\r\n }\r\n ?>\r\n"
                },
                {
                    "date": 1771491030740,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,9 +9,29 @@\n \tlog_php_error('Redirected direct access to index.html: ' . json_encode($_SERVER));\r\n \theader('Location: ../index.html');\r\n \texit();\r\n }\r\n-// Log all incoming requests\r\n+// CORS Headers\r\n+header(\"Access-Control-Allow-Origin: *\");\r\n+header(\"Content-Type: application/json\");\r\n+header(\"Access-Control-Allow-Methods: POST, GET, PUT, DELETE\");\r\n+header(\"Access-Control-Allow-Headers: Content-Type\");\r\n+\r\n+$host = '127.0.0.1';\r\n+$db   = 'ethans_cafe';\r\n+$user = 'root';\r\n+$pass = '';\r\n+\r\n+try {\r\n+\t$pdo = new PDO(\"mysql:host=$host;dbname=$db;charset=utf8mb4\", $user, $pass);\r\n+} catch (Exception $e) {\r\n+    log_php_error('DB Connection Error: ' . $e->getMessage());\r\n+\tdie(json_encode([\"error\" => $e->getMessage()]));\r\n+}\r\n+\r\n+$method = $_SERVER['REQUEST_METHOD'];\r\n+$data = json_decode(file_get_contents(\"php://input\"), true) ?: [];\r\n+// Log all incoming requests (after $data is defined)\r\n log_php_error('Request: ' . $_SERVER['REQUEST_METHOD'] . ' ' . ($_GET['table'] ?? ($data['table'] ?? '')) . ' | Data: ' . json_encode($data));\r\n // CORS Headers\r\n header(\"Access-Control-Allow-Origin: *\");\r\n header(\"Content-Type: application/json\");\r\n"
                },
                {
                    "date": 1771492601678,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,6 +1,32 @@\n <?php\r\n // Redirect to index.html if accessed directly (not via AJAX/API)\r\n+\r\n+\r\n+session_start();\r\n+\r\n+// ---------------------------\r\n+// Security check snippet\r\n+// ---------------------------\r\n+$user_id = $_SESSION['user_id'] ?? null;\r\n+$role_id = $_SESSION['role_id'] ?? null;\r\n+\r\n+if (!$user_id) {\r\n+    echo json_encode(['error' => 'Unauthorized: You must log in']);\r\n+    exit();\r\n+}\r\n+\r\n+// Restrict sensitive tables to Admins only\r\n+$adminOnlyTables = ['users', 'roles', 'system_settings'];\r\n+$table = $_GET['table'] ?? $_POST['table'] ?? null;\r\n+\r\n+if (in_array($table, $adminOnlyTables) && $role_id != 1) {\r\n+    echo json_encode(['error' => 'Permission denied: Admin only']);\r\n+    exit();\r\n+}\r\n+\r\n+// Optional logging\r\n+file_put_contents('api_access.log', date('Y-m-d H:i:s') . \" | User $user_id | Table $table | Method {$_SERVER['REQUEST_METHOD']}\\n\", FILE_APPEND);\r\n function log_php_error($msg) {\r\n \t$logfile = __DIR__ . '/app_error.log';\r\n \t$entry = date('Y-m-d H:i:s') . ' ' . $msg . \"\\n\";\r\n \tfile_put_contents($logfile, $entry, FILE_APPEND);\r\n"
                },
                {
                    "date": 1771492616209,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,8 +1,6 @@\n <?php\r\n // Redirect to index.html if accessed directly (not via AJAX/API)\r\n-\r\n-\r\n session_start();\r\n \r\n // ---------------------------\r\n // Security check snippet\r\n"
                },
                {
                    "date": 1771493365572,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,14 +1,18 @@\n <?php\r\n-// Redirect to index.html if accessed directly (not via AJAX/API)\r\n session_start();\r\n \r\n // ---------------------------\r\n // Security check snippet\r\n // ---------------------------\r\n $user_id = $_SESSION['user_id'] ?? null;\r\n $role_id = $_SESSION['role_id'] ?? null;\r\n \r\n+// DEV ONLY: temporary session\r\n+$_SESSION['user_id'] = 1;\r\n+$_SESSION['role_id'] = 1; // Admin\r\n+\r\n+\r\n if (!$user_id) {\r\n     echo json_encode(['error' => 'Unauthorized: You must log in']);\r\n     exit();\r\n }\r\n"
                },
                {
                    "date": 1771493443087,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,14 +3,14 @@\n \r\n // ---------------------------\r\n // Security check snippet\r\n // ---------------------------\r\n+\r\n+\r\n+\r\n $user_id = $_SESSION['user_id'] ?? null;\r\n $role_id = $_SESSION['role_id'] ?? null;\r\n \r\n-// DEV ONLY: temporary session\r\n-$_SESSION['user_id'] = 1;\r\n-$_SESSION['role_id'] = 1; // Admin\r\n \r\n \r\n if (!$user_id) {\r\n     echo json_encode(['error' => 'Unauthorized: You must log in']);\r\n"
                },
                {
                    "date": 1771499716714,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,11 +3,12 @@\n \r\n // ---------------------------\r\n // Security check snippet\r\n // ---------------------------\r\n+$_SESSION['user_id'] = 1;\r\n+$_SESSION['role_id'] = 1; // Admin\r\n \r\n \r\n-\r\n $user_id = $_SESSION['user_id'] ?? null;\r\n $role_id = $_SESSION['role_id'] ?? null;\r\n \r\n \r\n@@ -86,9 +87,9 @@\n \t'roles' => ['id', 'name', 'permissions'],\r\n \t'users' => ['id', 'full_name', 'username', 'password_hash', 'role_id', 'status', 'last_login', 'created_at', 'updated_at', 'deleted_at'],\r\n \t'account_requests' => ['id', 'full_name', 'username', 'password_hash', 'requested_role_id', 'status', 'requested_at', 'reviewed_by', 'reviewed_at', 'notes'],\r\n \t'menu_categories' => ['id', 'name', 'description'],\r\n-\t'menu_items' => ['id', 'name', 'category_id', 'description', 'price_reference', 'status', 'image_path', 'created_at', 'updated_at'],\r\n+\t'menu_items' => ['id', 'name', 'category_id', 'description',  'price_reference', 'status', 'image_path', 'created_at', 'updated_at'],\r\n \t'ingredient_categories' => ['id', 'name'],\r\n \t'units' => ['id', 'name'],\r\n \t'ingredients' => ['id', 'name', 'category_id', 'unit_id', 'current_quantity', 'low_stock_threshold', 'status', 'created_at', 'updated_at'],\r\n \t'recipes' => ['id', 'menu_item_id', 'ingredient_id', 'qty_per_sale', 'unit_id'],\r\n"
                },
                {
                    "date": 1771499722682,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -87,9 +87,9 @@\n \t'roles' => ['id', 'name', 'permissions'],\r\n \t'users' => ['id', 'full_name', 'username', 'password_hash', 'role_id', 'status', 'last_login', 'created_at', 'updated_at', 'deleted_at'],\r\n \t'account_requests' => ['id', 'full_name', 'username', 'password_hash', 'requested_role_id', 'status', 'requested_at', 'reviewed_by', 'reviewed_at', 'notes'],\r\n \t'menu_categories' => ['id', 'name', 'description'],\r\n-\t'menu_items' => ['id', 'name', 'category_id', 'description',  'price_reference', 'status', 'image_path', 'created_at', 'updated_at'],\r\n+\t'menu_items' => ['id', 'name', 'category_id', 'description', 'recipe', 'price_reference', 'status', 'image_path', 'created_at', 'updated_at'],\r\n \t'ingredient_categories' => ['id', 'name'],\r\n \t'units' => ['id', 'name'],\r\n \t'ingredients' => ['id', 'name', 'category_id', 'unit_id', 'current_quantity', 'low_stock_threshold', 'status', 'created_at', 'updated_at'],\r\n \t'recipes' => ['id', 'menu_item_id', 'ingredient_id', 'qty_per_sale', 'unit_id'],\r\n"
                },
                {
                    "date": 1771856401246,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,20 +1,37 @@\n <?php\r\n+ob_start();\r\n+\r\n+header(\"Access-Control-Allow-Origin: *\");\r\n+header(\"Content-Type: application/json\");\r\n+header(\"Access-Control-Allow-Methods: POST, GET, PUT, DELETE\");\r\n+header(\"Access-Control-Allow-Headers: Content-Type\");\r\n+header(\"Cache-Control: no-store, no-cache, must-revalidate\");\r\n+\r\n session_start();\r\n+ini_set('display_errors', 0);\r\n+ini_set('log_errors', 1);\r\n \r\n+// Load Supabase API helper\r\n+require_once 'supabase-api.php';\r\n+\r\n+function log_php_error($msg) {\r\n+\t$logfile = __DIR__ . '/app_error.log';\r\n+\t$entry = date('Y-m-d H:i:s') . ' ' . $msg . \"\\n\";\r\n+\tfile_put_contents($logfile, $entry, FILE_APPEND);\r\n+}\r\n+\r\n // ---------------------------\r\n-// Security check snippet\r\n+// Security check\r\n // ---------------------------\r\n $_SESSION['user_id'] = 1;\r\n $_SESSION['role_id'] = 1; // Admin\r\n \r\n-\r\n $user_id = $_SESSION['user_id'] ?? null;\r\n $role_id = $_SESSION['role_id'] ?? null;\r\n \r\n-\r\n-\r\n if (!$user_id) {\r\n+    ob_end_clean();\r\n     echo json_encode(['error' => 'Unauthorized: You must log in']);\r\n     exit();\r\n }\r\n \r\n@@ -22,67 +39,18 @@\n $adminOnlyTables = ['users', 'roles', 'system_settings'];\r\n $table = $_GET['table'] ?? $_POST['table'] ?? null;\r\n \r\n if (in_array($table, $adminOnlyTables) && $role_id != 1) {\r\n+    ob_end_clean();\r\n     echo json_encode(['error' => 'Permission denied: Admin only']);\r\n     exit();\r\n }\r\n \r\n-// Optional logging\r\n-file_put_contents('api_access.log', date('Y-m-d H:i:s') . \" | User $user_id | Table $table | Method {$_SERVER['REQUEST_METHOD']}\\n\", FILE_APPEND);\r\n-function log_php_error($msg) {\r\n-\t$logfile = __DIR__ . '/app_error.log';\r\n-\t$entry = date('Y-m-d H:i:s') . ' ' . $msg . \"\\n\";\r\n-\tfile_put_contents($logfile, $entry, FILE_APPEND);\r\n-}\r\n-if (basename($_SERVER['PHP_SELF']) === 'app.php' && empty($_SERVER['HTTP_X_REQUESTED_WITH']) && (!isset($_SERVER['HTTP_ACCEPT']) || strpos($_SERVER['HTTP_ACCEPT'], 'application/json') === false)) {\r\n-\tlog_php_error('Redirected direct access to index.html: ' . json_encode($_SERVER));\r\n-\theader('Location: ../index.html');\r\n-\texit();\r\n-}\r\n-// CORS Headers\r\n-header(\"Access-Control-Allow-Origin: *\");\r\n-header(\"Content-Type: application/json\");\r\n-header(\"Access-Control-Allow-Methods: POST, GET, PUT, DELETE\");\r\n-header(\"Access-Control-Allow-Headers: Content-Type\");\r\n-\r\n-$host = '127.0.0.1';\r\n-$db   = 'ethans_cafe';\r\n-$user = 'root';\r\n-$pass = '';\r\n-\r\n-try {\r\n-\t$pdo = new PDO(\"mysql:host=$host;dbname=$db;charset=utf8mb4\", $user, $pass);\r\n-} catch (Exception $e) {\r\n-    log_php_error('DB Connection Error: ' . $e->getMessage());\r\n-\tdie(json_encode([\"error\" => $e->getMessage()]));\r\n-}\r\n-\r\n $method = $_SERVER['REQUEST_METHOD'];\r\n $data = json_decode(file_get_contents(\"php://input\"), true) ?: [];\r\n-// Log all incoming requests (after $data is defined)\r\n-log_php_error('Request: ' . $_SERVER['REQUEST_METHOD'] . ' ' . ($_GET['table'] ?? ($data['table'] ?? '')) . ' | Data: ' . json_encode($data));\r\n-// CORS Headers\r\n-header(\"Access-Control-Allow-Origin: *\");\r\n-header(\"Content-Type: application/json\");\r\n-header(\"Access-Control-Allow-Methods: POST, GET, PUT, DELETE\");\r\n-header(\"Access-Control-Allow-Headers: Content-Type\");\r\n \r\n-$host = '127.0.0.1';\r\n-$db   = 'ethans_cafe';\r\n-$user = 'root';\r\n-$pass = '';\r\n+log_php_error('Request: ' . $method . ' ' . ($table ?? 'NO_TABLE') . ' | Data: ' . json_encode($data));\r\n \r\n-try {\r\n-\t$pdo = new PDO(\"mysql:host=$host;dbname=$db;charset=utf8mb4\", $user, $pass);\r\n-} catch (Exception $e) {\r\n-    log_php_error('DB Connection Error: ' . $e->getMessage());\r\n-\tdie(json_encode([\"error\" => $e->getMessage()]));\r\n-}\r\n-\r\n-$method = $_SERVER['REQUEST_METHOD'];\r\n-$data = json_decode(file_get_contents(\"php://input\"), true) ?: [];\r\n-\r\n // Table whitelist and columns\r\n $TABLES = [\r\n \t'roles' => ['id', 'name', 'permissions'],\r\n \t'users' => ['id', 'full_name', 'username', 'password_hash', 'role_id', 'status', 'last_login', 'created_at', 'updated_at', 'deleted_at'],\r\n@@ -105,9 +73,11 @@\n \r\n // Get table name from query string or body\r\n $table = $_GET['table'] ?? $data['table'] ?? null;\r\n if (!$table || !isset($TABLES[$table])) {\r\n-\techo json_encode([\"error\" => \"Invalid or missing table name\"]); exit;\r\n+\tob_end_clean();\r\n+\techo json_encode([\"error\" => \"Invalid or missing table name\"]); \r\n+\texit;\r\n }\r\n $COLUMNS = $TABLES[$table];\r\n \r\n switch($method) {\r\n@@ -116,85 +86,115 @@\n \t\t// Hash password for users and account_requests\r\n \t\tif (($table === 'users' || $table === 'account_requests') && isset($filtered['password_hash'])) {\r\n \t\t\t$filtered['password_hash'] = password_hash($filtered['password_hash'], PASSWORD_DEFAULT);\r\n \t\t}\r\n-\t\t$keys = implode(', ', array_keys($filtered));\r\n-\t\t$placeholders = implode(', ', array_fill(0, count($filtered), '?'));\r\n+\t\t// Provide default value for required fields\r\n+\t\tif ($table === 'menu_items' && !isset($filtered['recipe'])) {\r\n+\t\t\t$filtered['recipe'] = 0;\r\n+\t\t}\r\n \t\ttry {\r\n-\t\t\t$stmt = $pdo->prepare(\"INSERT INTO `$table` ($keys) VALUES ($placeholders)\");\r\n-\t\t\t$stmt->execute(array_values($filtered));\r\n-\t\t\techo json_encode([\"message\" => \"Added successfully\", \"id\" => $pdo->lastInsertId()]);\r\n+\t\t\t$result = $supabase->insert($table, $filtered);\r\n+\t\t\tob_end_clean();\r\n+\t\t\tif (isset($result['error'])) {\r\n+\t\t\t\thttp_response_code(400);\r\n+\t\t\t\techo json_encode($result);\r\n+\t\t\t} else {\r\n+\t\t\t\techo json_encode([\"message\" => \"Added successfully\", \"data\" => $result]);\r\n+\t\t\t}\r\n \t\t} catch (Exception $e) {\r\n-\t\t\tlog_php_error('POST error: ' . $e->getMessage() . ' | Data: ' . json_encode($filtered));\r\n+\t\t\tlog_php_error('POST error: ' . $e->getMessage());\r\n+\t\t\tob_end_clean();\r\n+\t\t\thttp_response_code(500);\r\n \t\t\techo json_encode([\"error\" => $e->getMessage()]);\r\n \t\t}\r\n \t\tbreak;\r\n+\r\n \tcase 'GET':\r\n-\t\t$sql = \"SELECT * FROM `$table`\";\r\n-\t\t// Optional: filter by query string\r\n-\t\t$filters = array_intersect_key($_GET, array_flip($COLUMNS));\r\n-\t\tunset($filters['table']);\r\n-\t\tif ($filters) {\r\n-\t\t\t$where = [];\r\n-\t\t\tforeach ($filters as $k => $v) {\r\n-\t\t\t\t$where[] = \"$k = :$k\";\r\n-\t\t\t}\r\n-\t\t\t$sql .= \" WHERE \" . implode(' AND ', $where);\r\n-\t\t}\r\n \t\ttry {\r\n-\t\t\t$stmt = $pdo->prepare($sql);\r\n-\t\t\tif ($filters) {\r\n-\t\t\t\tforeach ($filters as $k => $v) {\r\n-\t\t\t\t\t$stmt->bindValue(\":$k\", $v);\r\n+\t\t\t$filters = [];\r\n+\t\t\tforeach ($_GET as $key => $value) {\r\n+\t\t\t\tif ($key !== 'table' && in_array($key, $COLUMNS)) {\r\n+\t\t\t\t\t$filters[$key] = 'eq.' . $value;\r\n \t\t\t\t}\r\n \t\t\t}\r\n-\t\t\t$stmt->execute();\r\n-\t\t\techo json_encode($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n+\t\t\t$result = $supabase->select($table, $filters);\r\n+\t\t\tob_end_clean();\r\n+\t\t\tif (isset($result['error'])) {\r\n+\t\t\t\thttp_response_code(400);\r\n+\t\t\t\techo json_encode($result);\r\n+\t\t\t} else {\r\n+\t\t\t\techo json_encode($result);\r\n+\t\t\t}\r\n \t\t} catch (Exception $e) {\r\n-\t\t\tlog_php_error('GET error: ' . $e->getMessage() . ' | SQL: ' . $sql);\r\n+\t\t\tlog_php_error('GET error: ' . $e->getMessage());\r\n+\t\t\tob_end_clean();\r\n+\t\t\thttp_response_code(500);\r\n \t\t\techo json_encode([\"error\" => $e->getMessage()]);\r\n \t\t}\r\n \t\tbreak;\r\n+\r\n \tcase 'PUT':\r\n \t\tif (!isset($data['id']) && !isset($data['key'])) {\r\n-\t\t\techo json_encode([\"error\" => \"Missing id/key for update\"]); exit;\r\n+\t\t\tob_end_clean();\r\n+\t\t\techo json_encode([\"error\" => \"Missing id/key for update\"]); \r\n+\t\t\texit;\r\n \t\t}\r\n \t\t$idField = in_array('id', $COLUMNS) ? 'id' : 'key';\r\n \t\t$id = $data[$idField];\r\n \t\tunset($data[$idField]);\r\n \t\t$filtered = array_intersect_key($data, array_flip($COLUMNS));\r\n-\t\t// Hash password for users and account_requests\r\n \t\tif (($table === 'users' || $table === 'account_requests') && isset($filtered['password_hash'])) {\r\n \t\t\t$filtered['password_hash'] = password_hash($filtered['password_hash'], PASSWORD_DEFAULT);\r\n \t\t}\r\n-\t\t$set = [];\r\n-\t\tforeach ($filtered as $k => $v) {\r\n-\t\t\t$set[] = \"$k = ?\";\r\n+\t\tif ($table === 'menu_items' && !isset($filtered['recipe']) && count($filtered) > 0) {\r\n+\t\t\t$filtered['recipe'] = 0;\r\n \t\t}\r\n \t\ttry {\r\n-\t\t\t$stmt = $pdo->prepare(\"UPDATE `$table` SET \".implode(', ', $set).\" WHERE $idField = ?\");\r\n-\t\t\t$stmt->execute(array_merge(array_values($filtered), [$id]));\r\n-\t\t\techo json_encode([\"message\" => \"Updated successfully\"]);\r\n+\t\t\t$filter_params = [$idField => 'eq.' . $id];\r\n+\t\t\t$result = $supabase->update($table, $filtered, $filter_params);\r\n+\t\t\tob_end_clean();\r\n+\t\t\tif (isset($result['error'])) {\r\n+\t\t\t\thttp_response_code(400);\r\n+\t\t\t\techo json_encode($result);\r\n+\t\t\t} else {\r\n+\t\t\t\techo json_encode([\"message\" => \"Updated successfully\"]);\r\n+\t\t\t}\r\n \t\t} catch (Exception $e) {\r\n-\t\t\tlog_php_error('PUT error: ' . $e->getMessage() . ' | Data: ' . json_encode($filtered));\r\n+\t\t\tlog_php_error('PUT error: ' . $e->getMessage());\r\n+\t\t\tob_end_clean();\r\n+\t\t\thttp_response_code(500);\r\n \t\t\techo json_encode([\"error\" => $e->getMessage()]);\r\n \t\t}\r\n \t\tbreak;\r\n+\r\n \tcase 'DELETE':\r\n \t\t$idField = in_array('id', $COLUMNS) ? 'id' : 'key';\r\n \t\tif (!isset($data[$idField])) {\r\n-\t\t\techo json_encode([\"error\" => \"Missing id/key for delete\"]); exit;\r\n+\t\t\tob_end_clean();\r\n+\t\t\techo json_encode([\"error\" => \"Missing id/key for delete\"]); \r\n+\t\t\texit;\r\n \t\t}\r\n \t\ttry {\r\n-\t\t\t$stmt = $pdo->prepare(\"DELETE FROM `$table` WHERE $idField = ?\");\r\n-\t\t\t$stmt->execute([$data[$idField]]);\r\n-\t\t\techo json_encode([\"message\" => \"Deleted successfully\"]);\r\n+\t\t\t$filter_params = [$idField => 'eq.' . $data[$idField]];\r\n+\t\t\t$result = $supabase->delete($table, $filter_params);\r\n+\t\t\tob_end_clean();\r\n+\t\t\tif (isset($result['error'])) {\r\n+\t\t\t\thttp_response_code(400);\r\n+\t\t\t\techo json_encode($result);\r\n+\t\t\t} else {\r\n+\t\t\t\techo json_encode([\"message\" => \"Deleted successfully\"]);\r\n+\t\t\t}\r\n \t\t} catch (Exception $e) {\r\n-\t\t\tlog_php_error('DELETE error: ' . $e->getMessage() . ' | ID: ' . $data[$idField]);\r\n+\t\t\tlog_php_error('DELETE error: ' . $e->getMessage());\r\n+\t\t\tob_end_clean();\r\n+\t\t\thttp_response_code(500);\r\n \t\t\techo json_encode([\"error\" => $e->getMessage()]);\r\n \t\t}\r\n \t\tbreak;\r\n+\r\n \tdefault:\r\n \t\tlog_php_error('Unsupported method: ' . $method);\r\n+\t\tob_end_clean();\r\n+\t\thttp_response_code(405);\r\n \t\techo json_encode([\"error\" => \"Unsupported method\"]);\r\n }\r\n ?>\r\n"
                },
                {
                    "date": 1771859677558,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -52,9 +52,9 @@\n \r\n // Table whitelist and columns\r\n $TABLES = [\r\n \t'roles' => ['id', 'name', 'permissions'],\r\n-\t'users' => ['id', 'full_name', 'username', 'password_hash', 'role_id', 'status', 'last_login', 'created_at', 'updated_at', 'deleted_at'],\r\n+\t'users' => ['id', 'email' 'full_name', 'username', 'password_hash', 'role_id', 'status', 'last_login', 'created_at', 'updated_at', 'deleted_at'],\r\n \t'account_requests' => ['id', 'full_name', 'username', 'password_hash', 'requested_role_id', 'status', 'requested_at', 'reviewed_by', 'reviewed_at', 'notes'],\r\n \t'menu_categories' => ['id', 'name', 'description'],\r\n \t'menu_items' => ['id', 'name', 'category_id', 'description', 'recipe', 'price_reference', 'status', 'image_path', 'created_at', 'updated_at'],\r\n \t'ingredient_categories' => ['id', 'name'],\r\n"
                },
                {
                    "date": 1771860706682,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -52,10 +52,10 @@\n \r\n // Table whitelist and columns\r\n $TABLES = [\r\n \t'roles' => ['id', 'name', 'permissions'],\r\n-\t'users' => ['id', 'email' 'full_name', 'username', 'password_hash', 'role_id', 'status', 'last_login', 'created_at', 'updated_at', 'deleted_at'],\r\n-\t'account_requests' => ['id', 'full_name', 'username', 'password_hash', 'requested_role_id', 'status', 'requested_at', 'reviewed_by', 'reviewed_at', 'notes'],\r\n+\t'users' => ['id', 'email', 'full_name', 'username', 'password_hash', 'role_id', 'status', 'last_login', 'created_at', 'updated_at', 'deleted_at'],\r\n+\t'account_requests' => ['id', 'full_name', 'username', 'email', 'password_hash', 'requested_role_id', 'status', 'requested_at', 'reviewed_by', 'reviewed_at', 'notes'],\r\n \t'menu_categories' => ['id', 'name', 'description'],\r\n \t'menu_items' => ['id', 'name', 'category_id', 'description', 'recipe', 'price_reference', 'status', 'image_path', 'created_at', 'updated_at'],\r\n \t'ingredient_categories' => ['id', 'name'],\r\n \t'units' => ['id', 'name'],\r\n"
                },
                {
                    "date": 1772359264585,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -52,24 +52,29 @@\n \r\n // Table whitelist and columns\r\n $TABLES = [\r\n \t'roles' => ['id', 'name', 'permissions'],\r\n-\t'users' => ['id', 'email', 'full_name', 'username', 'password_hash', 'role_id', 'status', 'last_login', 'created_at', 'updated_at', 'deleted_at'],\r\n-\t'account_requests' => ['id', 'full_name', 'username', 'email', 'password_hash', 'requested_role_id', 'status', 'requested_at', 'reviewed_by', 'reviewed_at', 'notes'],\r\n+\t'users' => ['id', 'email', 'full_name', 'username', 'password_hash', 'role_id', 'status', 'last_login', 'created_at', 'updated_at', 'deleted_at', 'ip_address'],\r\n+\t'account_requests' => ['id', 'full_name', 'username', 'email', 'password_hash', 'requested_role_id', 'status', 'requested_at', 'reviewed_by', 'reviewed_at', 'notes', 'ip_address'],\r\n \t'menu_categories' => ['id', 'name', 'description'],\r\n \t'menu_items' => ['id', 'name', 'category_id', 'description', 'recipe', 'price_reference', 'status', 'image_path', 'created_at', 'updated_at'],\r\n \t'ingredient_categories' => ['id', 'name'],\r\n \t'units' => ['id', 'name'],\r\n-\t'ingredients' => ['id', 'name', 'category_id', 'unit_id', 'current_quantity', 'low_stock_threshold', 'status', 'created_at', 'updated_at'],\r\n+\t'ingredients' => ['id', 'name', 'category_id', 'unit_id', 'current_quantity', 'low_stock_threshold', 'status', 'expiry_date', 'created_at', 'updated_at'],\r\n \t'recipes' => ['id', 'menu_item_id', 'ingredient_id', 'qty_per_sale', 'unit_id'],\r\n-\t'sales' => ['id', 'receipt_no', 'sale_datetime', 'staff_id', 'total_items', 'notes', 'created_at'],\r\n-\t'sale_items' => ['id', 'sale_id', 'menu_item_id', 'quantity'],\r\n+\t'sales' => ['id', 'receipt_no', 'sale_datetime', 'staff_id', 'total_items', 'total_amount', 'notes', 'status', 'adjusted_total', 'adjusted_by', 'adjusted_at', 'adjustment_reason', 'created_at', 'customer_name', 'order_type', 'discount_amount', 'discount_percent', 'coupon_code', 'coupon_value', 'taxes', 'subtotal'],\r\n+\t'sale_items' => ['id', 'sale_id', 'menu_item_id', 'quantity', 'unit_price', 'item_name', 'category_name'],\r\n \t'inventory_transactions' => ['id', 'ingredient_id', 'change_qty', 'transaction_type', 'reason', 'performed_by', 'prev_qty', 'new_qty', 'timestamp'],\r\n \t'activity_logs' => ['id', 'user_id', 'role_label', 'action', 'reference', 'status', 'ip_address', 'created_at'],\r\n \t'requests_tbl' => ['id', 'type', 'requester_id', 'target_id', 'payload', 'status', 'created_at', 'handled_by', 'handled_at'],\r\n-\t'backups' => ['id', 'name', 'type', 'file_path', 'created_at', 'size'],\r\n+\t'backups' => ['id', 'filename', 'file_path', 'file_size', 'backup_type', 'includes_media', 'created_by', 'created_at'],\r\n+\t'backup_settings' => ['id', 'schedule', 'retention_count', 'include_media', 'updated_at'],\r\n \t'system_settings' => ['key', 'value', 'updated_at'],\r\n-\t'temporary_account_log' => ['id', 'activated_by', 'activated_at', 'deactivated_at', 'note']\r\n+\t'temp_accounts' => ['id', 'role_id', 'username', 'password_hash', 'ip_address', 'reason', 'created_by', 'created_at', 'expires_at', 'status'],\r\n+\t'account_lockout' => ['id', 'user_id', 'lockout_at'],\r\n+\t'login_attempts' => ['id', 'username', 'attempt_count', 'last_attempt_at'],\r\n+\t'notifications' => ['id', 'user_id', 'action_type', 'target_table', 'target_id', 'description', 'reason', 'is_read', 'created_at'],\r\n+\t'held_orders' => ['id', 'hold_ref', 'customer_name', 'order_type', 'items_json', 'subtotal', 'discount_amount', 'discount_percent', 'coupon_code', 'coupon_value', 'taxes', 'total_amount', 'staff_id', 'notes', 'created_at', 'expires_at', 'status', 'restored_at', 'restored_by']\r\n ];\r\n \r\n // Get table name from query string or body\r\n $table = $_GET['table'] ?? $data['table'] ?? null;\r\n"
                }
            ],
            "date": 1771488043962,
            "name": "Commit-0",
            "content": "<?php\r\n// CORS Headers\r\nheader(\"Access-Control-Allow-Origin: *\");\r\nheader(\"Content-Type: application/json\");\r\nheader(\"Access-Control-Allow-Methods: POST, GET, PUT, DELETE\");\r\nheader(\"Access-Control-Allow-Headers: Content-Type\");\r\n\r\n$host = '127.0.0.1';\r\n$db   = 'brew-cave_db';\r\n$user = 'root';\r\n$pass = '';\r\n\r\ntry {\r\n\t$pdo = new PDO(\"mysql:host=$host;dbname=$db;charset=utf8mb4\", $user, $pass);\r\n} catch (Exception $e) {\r\n\tdie(json_encode([\"error\" => $e->getMessage()]));\r\n}\r\n\r\n$method = $_SERVER['REQUEST_METHOD'];\r\n$data = json_decode(file_get_contents(\"php://input\"), true) ?: [];\r\n\r\n// Table and allowed columns (example: roles)\r\n$TABLE = 'roles';\r\n$COLUMNS = ['id', 'name', 'permissions'];\r\n\r\nswitch($method) {\r\n\tcase 'POST':\r\n\t\t$filtered = array_intersect_key($data, array_flip($COLUMNS));\r\n\t\t$keys = implode(', ', array_keys($filtered));\r\n\t\t$placeholders = implode(', ', array_fill(0, count($filtered), '?'));\r\n\t\t$stmt = $pdo->prepare(\"INSERT INTO $TABLE ($keys) VALUES ($placeholders)\");\r\n\t\t$stmt->execute(array_values($filtered));\r\n\t\techo json_encode([\"message\" => \"Added successfully\", \"id\" => $pdo->lastInsertId()]);\r\n\t\tbreak;\r\n\tcase 'GET':\r\n\t\t$sql = \"SELECT * FROM $TABLE\";\r\n\t\t// Optional: filter by query string\r\n\t\tif (!empty($_GET)) {\r\n\t\t\t$filters = array_intersect_key($_GET, array_flip($COLUMNS));\r\n\t\t\tif ($filters) {\r\n\t\t\t\t$where = [];\r\n\t\t\t\tforeach ($filters as $k => $v) {\r\n\t\t\t\t\t$where[] = \"$k = :$k\";\r\n\t\t\t\t}\r\n\t\t\t\t$sql .= \" WHERE \" . implode(' AND ', $where);\r\n\t\t\t}\r\n\t\t}\r\n\t\t$stmt = $pdo->prepare($sql);\r\n\t\tif (!empty($filters)) {\r\n\t\t\tforeach ($filters as $k => $v) {\r\n\t\t\t\t$stmt->bindValue(\":$k\", $v);\r\n\t\t\t}\r\n\t\t}\r\n\t\t$stmt->execute();\r\n\t\techo json_encode($stmt->fetchAll(PDO::FETCH_ASSOC));\r\n\t\tbreak;\r\n\tcase 'PUT':\r\n\t\tif (!isset($data['id'])) {\r\n\t\t\techo json_encode([\"error\" => \"Missing id for update\"]); exit;\r\n\t\t}\r\n\t\t$id = $data['id'];\r\n\t\tunset($data['id']);\r\n\t\t$filtered = array_intersect_key($data, array_flip($COLUMNS));\r\n\t\t$set = [];\r\n\t\tforeach ($filtered as $k => $v) {\r\n\t\t\t$set[] = \"$k = ?\";\r\n\t\t}\r\n\t\t$stmt = $pdo->prepare(\"UPDATE $TABLE SET \".implode(', ', $set).\" WHERE id = ?\");\r\n\t\t$stmt->execute(array_merge(array_values($filtered), [$id]));\r\n\t\techo json_encode([\"message\" => \"Updated successfully\"]);\r\n\t\tbreak;\r\n\tcase 'DELETE':\r\n\t\tif (!isset($data['id'])) {\r\n\t\t\techo json_encode([\"error\" => \"Missing id for delete\"]); exit;\r\n\t\t}\r\n\t\t$stmt = $pdo->prepare(\"DELETE FROM $TABLE WHERE id = ?\");\r\n\t\t$stmt->execute([$data['id']]);\r\n\t\techo json_encode([\"message\" => \"Deleted successfully\"]);\r\n\t\tbreak;\r\n\tdefault:\r\n\t\techo json_encode([\"error\" => \"Unsupported method\"]);\r\n}\r\n?>\r\n"
        }
    ]
}