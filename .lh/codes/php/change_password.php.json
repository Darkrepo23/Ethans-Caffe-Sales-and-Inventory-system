{
    "sourceFile": "codes/php/change_password.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1772359265021,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1772359265021,
            "name": "Commit-0",
            "content": "<?php\r\nheader(\"Access-Control-Allow-Origin: *\");\r\nheader(\"Content-Type: application/json\");\r\nheader(\"Access-Control-Allow-Methods: POST\");\r\nheader(\"Access-Control-Allow-Headers: Content-Type\");\r\n\r\nrequire_once 'supabase-api.php';\r\n\r\n// Only accept POST\r\nif ($_SERVER['REQUEST_METHOD'] !== 'POST') {\r\n    echo json_encode(['error' => 'Method not allowed']);\r\n    exit;\r\n}\r\n\r\n$data = json_decode(file_get_contents('php://input'), true);\r\n\r\n$userId = $data['user_id'] ?? null;\r\n$currentPassword = $data['current_password'] ?? '';\r\n$newPassword = $data['new_password'] ?? '';\r\n\r\n// Validation\r\nif (!$userId) {\r\n    echo json_encode(['error' => 'User ID is required']);\r\n    exit;\r\n}\r\n\r\nif (empty($currentPassword)) {\r\n    echo json_encode(['error' => 'Current password is required']);\r\n    exit;\r\n}\r\n\r\nif (empty($newPassword)) {\r\n    echo json_encode(['error' => 'New password is required']);\r\n    exit;\r\n}\r\n\r\nif (strlen($newPassword) < 6) {\r\n    echo json_encode(['error' => 'New password must be at least 6 characters']);\r\n    exit;\r\n}\r\n\r\ntry {\r\n    // Fetch user to verify current password\r\n    $user = $supabase->select('users', ['id' => 'eq.' . $userId]);\r\n    \r\n    if (empty($user) || isset($user['error'])) {\r\n        echo json_encode(['error' => 'User not found']);\r\n        exit;\r\n    }\r\n    \r\n    $user = $user[0];\r\n    \r\n    // Verify current password\r\n    if (!password_verify($currentPassword, $user['password_hash'])) {\r\n        echo json_encode(['error' => 'Current password is incorrect']);\r\n        exit;\r\n    }\r\n    \r\n    // Hash new password\r\n    $hashedPassword = password_hash($newPassword, PASSWORD_DEFAULT);\r\n    \r\n    // Update password\r\n    $result = $supabase->update('users', \r\n        [\r\n            'password_hash' => $hashedPassword,\r\n            'updated_at' => date('Y-m-d H:i:s')\r\n        ],\r\n        ['id' => 'eq.' . $userId]\r\n    );\r\n    \r\n    if (isset($result['error'])) {\r\n        echo json_encode(['error' => 'Failed to update password: ' . $result['error']]);\r\n        exit;\r\n    }\r\n    \r\n    echo json_encode(['success' => true, 'message' => 'Password changed successfully']);\r\n    \r\n} catch (Exception $e) {\r\n    echo json_encode(['error' => 'Server error: ' . $e->getMessage()]);\r\n}\r\n?>\r\n"
        }
    ]
}