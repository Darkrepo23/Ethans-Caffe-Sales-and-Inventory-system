{
    "sourceFile": "codes/php/session.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1772347294324,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1772347294324,
            "name": "Commit-0",
            "content": "<?php\r\n/**\r\n * Session Management API\r\n * Handles database-based session validation and user retrieval\r\n * \r\n * Actions:\r\n * - GET ?action=check - Check if user is logged in, return user data\r\n * - GET ?action=validate - Just validate session (returns boolean)\r\n * - POST ?action=refresh - Refresh session expiry\r\n */\r\n\r\nob_start();\r\n\r\nheader(\"Access-Control-Allow-Origin: *\");\r\nheader(\"Content-Type: application/json\");\r\nheader(\"Access-Control-Allow-Headers: Content-Type, Authorization\");\r\nheader(\"Access-Control-Allow-Methods: GET, POST, OPTIONS\");\r\nheader(\"Access-Control-Allow-Credentials: true\");\r\n\r\n// Handle preflight\r\nif ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {\r\n    http_response_code(200);\r\n    exit();\r\n}\r\n\r\nsession_start();\r\n\r\nrequire_once 'supabase-api.php';\r\n\r\n// Session configuration\r\ndefine('SESSION_DURATION_HOURS', 8); // Sessions last 8 hours\r\ndefine('SESSION_COOKIE_NAME', 'ethans_session');\r\n\r\n/**\r\n * Generate a secure random token\r\n */\r\nfunction generateSessionToken() {\r\n    return bin2hex(random_bytes(32));\r\n}\r\n\r\n/**\r\n * Get session token from cookie or header\r\n */\r\nfunction getSessionToken() {\r\n    // Check cookie first\r\n    if (isset($_COOKIE[SESSION_COOKIE_NAME])) {\r\n        return $_COOKIE[SESSION_COOKIE_NAME];\r\n    }\r\n    \r\n    // Check Authorization header\r\n    $headers = getallheaders();\r\n    if (isset($headers['Authorization'])) {\r\n        $auth = $headers['Authorization'];\r\n        if (strpos($auth, 'Bearer ') === 0) {\r\n            return substr($auth, 7);\r\n        }\r\n    }\r\n    \r\n    return null;\r\n}\r\n\r\n/**\r\n * Create a new session in the database\r\n */\r\nfunction createSession($supabase, $userId) {\r\n    $token = generateSessionToken();\r\n    $ip = $_SERVER['REMOTE_ADDR'] ?? '0.0.0.0';\r\n    $userAgent = substr($_SERVER['HTTP_USER_AGENT'] ?? 'Unknown', 0, 255);\r\n    $now = date('Y-m-d H:i:s');\r\n    $expiresAt = date('Y-m-d H:i:s', strtotime('+' . SESSION_DURATION_HOURS . ' hours'));\r\n    \r\n    $sessionData = [\r\n        'user_id' => $userId,\r\n        'session_token' => $token,\r\n        'ip_address' => $ip,\r\n        'user_agent' => $userAgent,\r\n        'created_at' => $now,\r\n        'expires_at' => $expiresAt,\r\n        'last_activity' => $now,\r\n        'is_active' => true\r\n    ];\r\n    \r\n    $result = $supabase->insert('user_sessions', $sessionData);\r\n    \r\n    if (isset($result['error'])) {\r\n        return ['error' => $result['error']];\r\n    }\r\n    \r\n    // Set cookie\r\n    $cookieExpiry = time() + (SESSION_DURATION_HOURS * 3600);\r\n    setcookie(SESSION_COOKIE_NAME, $token, [\r\n        'expires' => $cookieExpiry,\r\n        'path' => '/',\r\n        'secure' => isset($_SERVER['HTTPS']),\r\n        'httponly' => true,\r\n        'samesite' => 'Lax'\r\n    ]);\r\n    \r\n    return ['token' => $token, 'expires_at' => $expiresAt];\r\n}\r\n\r\n/**\r\n * Validate session and get user data\r\n */\r\nfunction validateSession($supabase, $token) {\r\n    if (!$token) {\r\n        return null;\r\n    }\r\n    \r\n    // Get session from database\r\n    $sessions = $supabase->select('user_sessions', [\r\n        'session_token' => 'eq.' . $token,\r\n        'is_active' => 'eq.true'\r\n    ]);\r\n    \r\n    if (!is_array($sessions) || isset($sessions['error']) || count($sessions) === 0) {\r\n        return null;\r\n    }\r\n    \r\n    $session = $sessions[0];\r\n    \r\n    // Check if expired\r\n    if (strtotime($session['expires_at']) < time()) {\r\n        // Mark session as inactive\r\n        $supabase->update('user_sessions', ['is_active' => false], ['id' => 'eq.' . $session['id']]);\r\n        return null;\r\n    }\r\n    \r\n    // Get user data\r\n    $user = $supabase->getUserById($session['user_id']);\r\n    \r\n    if (!$user) {\r\n        return null;\r\n    }\r\n    \r\n    // Update last activity\r\n    $supabase->update('user_sessions', [\r\n        'last_activity' => date('Y-m-d H:i:s')\r\n    ], ['id' => 'eq.' . $session['id']]);\r\n    \r\n    return [\r\n        'session' => $session,\r\n        'user' => $user\r\n    ];\r\n}\r\n\r\n/**\r\n * Destroy a session\r\n */\r\nfunction destroySession($supabase, $token) {\r\n    if (!$token) {\r\n        return false;\r\n    }\r\n    \r\n    // Mark session as inactive\r\n    $result = $supabase->update('user_sessions', [\r\n        'is_active' => false\r\n    ], ['session_token' => 'eq.' . $token]);\r\n    \r\n    // Clear cookie\r\n    setcookie(SESSION_COOKIE_NAME, '', [\r\n        'expires' => time() - 3600,\r\n        'path' => '/',\r\n        'secure' => isset($_SERVER['HTTPS']),\r\n        'httponly' => true,\r\n        'samesite' => 'Lax'\r\n    ]);\r\n    \r\n    // Destroy PHP session too\r\n    session_destroy();\r\n    \r\n    return true;\r\n}\r\n\r\n/**\r\n * Destroy all sessions for a user (logout everywhere)\r\n */\r\nfunction destroyAllUserSessions($supabase, $userId) {\r\n    return $supabase->update('user_sessions', [\r\n        'is_active' => false\r\n    ], ['user_id' => 'eq.' . $userId]);\r\n}\r\n\r\n// Get action\r\n$action = $_GET['action'] ?? 'check';\r\n$token = getSessionToken();\r\n\r\nswitch ($action) {\r\n    case 'check':\r\n        // Check session and return user data\r\n        $result = validateSession($supabase, $token);\r\n        \r\n        if (!$result) {\r\n            ob_end_clean();\r\n            http_response_code(401);\r\n            echo json_encode([\r\n                'authenticated' => false,\r\n                'error' => 'Not authenticated'\r\n            ]);\r\n            exit();\r\n        }\r\n        \r\n        ob_end_clean();\r\n        echo json_encode([\r\n            'authenticated' => true,\r\n            'user' => [\r\n                'id' => $result['user']['id'],\r\n                'username' => $result['user']['username'],\r\n                'full_name' => $result['user']['full_name'],\r\n                'role_id' => $result['user']['role_id'],\r\n                'role_name' => $result['user']['role_name'] ?? 'unknown',\r\n                'status' => $result['user']['status']\r\n            ],\r\n            'session' => [\r\n                'expires_at' => $result['session']['expires_at'],\r\n                'last_activity' => $result['session']['last_activity']\r\n            ]\r\n        ]);\r\n        break;\r\n        \r\n    case 'validate':\r\n        // Just check if authenticated\r\n        $result = validateSession($supabase, $token);\r\n        \r\n        ob_end_clean();\r\n        echo json_encode([\r\n            'authenticated' => $result !== null,\r\n            'role_id' => $result ? $result['user']['role_id'] : null\r\n        ]);\r\n        break;\r\n        \r\n    case 'refresh':\r\n        // Refresh session expiry\r\n        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {\r\n            ob_end_clean();\r\n            http_response_code(405);\r\n            echo json_encode(['error' => 'Method not allowed']);\r\n            exit();\r\n        }\r\n        \r\n        $result = validateSession($supabase, $token);\r\n        \r\n        if (!$result) {\r\n            ob_end_clean();\r\n            http_response_code(401);\r\n            echo json_encode(['error' => 'Not authenticated']);\r\n            exit();\r\n        }\r\n        \r\n        // Extend expiry\r\n        $newExpiry = date('Y-m-d H:i:s', strtotime('+' . SESSION_DURATION_HOURS . ' hours'));\r\n        $supabase->update('user_sessions', [\r\n            'expires_at' => $newExpiry,\r\n            'last_activity' => date('Y-m-d H:i:s')\r\n        ], ['id' => 'eq.' . $result['session']['id']]);\r\n        \r\n        // Update cookie expiry\r\n        $cookieExpiry = time() + (SESSION_DURATION_HOURS * 3600);\r\n        setcookie(SESSION_COOKIE_NAME, $token, [\r\n            'expires' => $cookieExpiry,\r\n            'path' => '/',\r\n            'secure' => isset($_SERVER['HTTPS']),\r\n            'httponly' => true,\r\n            'samesite' => 'Lax'\r\n        ]);\r\n        \r\n        ob_end_clean();\r\n        echo json_encode([\r\n            'success' => true,\r\n            'expires_at' => $newExpiry\r\n        ]);\r\n        break;\r\n        \r\n    default:\r\n        ob_end_clean();\r\n        http_response_code(400);\r\n        echo json_encode(['error' => 'Invalid action']);\r\n}\r\n?>\r\n"
        }
    ]
}